
<!DOCTYPE html>

<html>
<head>
 <title>New ZeroNet site!</title>
 <meta charset="utf-8">
 <meta http-equiv="content-type" content="text/html; charset=utf-8" />
 <base href="" target="_top" id="base">
 <script>base.href = document.location.href.replace("/media", "").replace("index.html", "").replace(/[&?]wrapper=False/, "").replace(/[&?]wrapper_nonce=[A-Za-z0-9]+/, "")</script>
</head>
<body>

<div id="warning" style='color: #CC3333; font-weight: bold'></div>
<div id="info"></div>
<div id="out"></div>
<a href="#" onclick="page.cmd('fileNeed', 'data/stats_optional.json.gz'); this.style.display = 'none'; return false;" id='need' style='display: none'>Request data/stats_optional.json.gz</a>

<script type="text/javascript" src="js/ZeroFrame.js"></script>
<script>

class Page extends ZeroFrame {
	setSiteInfo(site_info) {
		var out = document.getElementById("out")
		info.innerHTML =
			"Page address: " + site_info.address +
			"<br>- Peers: " + site_info.peers +
			"<br>- Size: " + site_info.settings.size +
			"<br>- Modified: " + (new Date(site_info.content.modified*1000))

		page.cmd("dbQuery", "SELECT COUNT(*) AS count FROM site_stat", function(res) {
			if (site_info.event)
				var event = site_info.event[0] + " " + site_info.event[1]
			else
				var event = ""
			var now = new Date().toLocaleString()
			out.innerHTML += "<br>" + now + " - [SITEINFO] " + event + " - DB size: " + res[0]["count"] + "rows"
		})
		page.cmd("fileList", 'data', function(res) {
			if (res.indexOf("stats_optional.json.gz") > -1)
				document.getElementById("need").style.display = "none"
			else
				document.getElementById("need").style.display = "inline"
		})
	}

	onOpenWebsocket() {
		this.cmd("serverInfo", [], function(server_info) {
			if (server_info.rev < 2180)
				document.getElementById('warning').innerHTML = 'This site requires ZeroNet rev2180. Your version: rev' + server_info.rev
		})
		this.cmd("siteInfo", [], function(site_info) {
			page.setSiteInfo(site_info)
		})
	}

	onRequest(cmd, message) {
		if (cmd == "setSiteInfo")
			this.setSiteInfo(message.params)
		else
			this.log("Unknown incoming message:", cmd)
	}
}
page = new Page()


loadScript = function(url, type, charset) {
	if (type===undefined) type = 'text/javascript';
    script = document.createElement('script');
    script.setAttribute('src', url);
    script.setAttribute('type', type);
    if (charset) script.setAttribute('charset', charset);
    document.body.append(script);
};
</script>

</body>
</html>