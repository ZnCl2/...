{"next_paste_id":1,"next_comment_id":0,"paste":[{"paste_id":0,"description":"","body":"\npackage main\n\nimport (\n\t\"fmt\"\n\t\"os\"\n\t\"path\"\n\t\"strings\"\n\t\"time\"\n\n\t\"net/http\"\n\t_ \"net/http/pprof\"\n\n\tl \"log\"\n\n\t\"github.com/G1itchZero/ZeroGo/server\"\n\t\"github.com/G1itchZero/ZeroGo/site_manager\"\n\t\"github.com/G1itchZero/ZeroGo/utils\"\n\tlog \"github.com/Sirupsen/logrus\"\n\t\"github.com/pkg/browser\"\n\t\"github.com/urfave/cli\"\n)\n\nconst VERSION string = \"0.1.0\"\n\nfunc main() {\n\tos.MkdirAll(utils.GetDataPath(), 0777)\n\tutils.CreateCerts()\n\tlog.SetLevel(log.ErrorLevel)\n\t// l.SetOutput(ioutil.Discard)\n\tlog.WithFields(log.Fields{\n\t\t\"id\": utils.GetPeerID(),\n\t}).Info(\"Your Peer ID\")\n\n\tapp := cli.NewApp()\n\tapp.Name = \"ZeroGo\"\n\tapp.Usage = \"ZeroNet gate\"\n\tapp.Version = VERSION\n\n\tapp.Flags = []cli.Flag{\n\t\tcli.BoolFlag{\n\t\t\tName:  \"debug\",\n\t\t\tUsage: \"enable debug mode\",\n\t\t},\n\t\tcli.BoolFlag{\n\t\t\tName:  \"no-tab\",\n\t\t\tUsage: \"dont open new tab\",\n\t\t},\n\t\tcli.IntFlag{\n\t\t\tName:  \"port\",\n\t\t\tValue: 43210,\n\t\t\tUsage: \"serving port\",\n\t\t},\n\t\tcli.StringFlag{\n\t\t\tName:  \"homepage\",\n\t\t\tValue: utils.ZN_HOMEPAGE,\n\t\t\tUsage: \"homepage\",\n\t\t},\n\t}\n\n\tsm := site_manager.NewSiteManager()\n\n\tapp.Commands = []cli.Command{\n\t\t{\n\t\t\tName:    \"download\",\n\t\t\tAliases: []string{\"d\"},\n\t\t\tUsage:   \"download site\",\n\t\t\tAction: func(c *cli.Context) error {\n\t\t\t\tif c.Bool(\"debug\") {\n\t\t\t\t\tlog.SetLevel(log.DebugLevel)\n\t\t\t\t}\n\t\t\t\taddress := c.Args().First()\n\t\t\t\tsm.Remove(address)\n\t\t\t\tsite := sm.Get(address)\n\t\t\t\tsite.Wait()\n\t\t\t\treturn nil\n\t\t\t},\n\t\t},\n\t}\n\n\tapp.Action = func(c *cli.Context) error {\n\t\tutils.SetDebug(c.Bool(\"debug\"))\n\t\tutils.SetHomepage(c.String(\"homepage\"))\n\n\t\thasMedia, _ := utils.Exists(path.Join(utils.GetDataPath(), utils.ZN_UPDATE))\n\n\t\tsync := make(chan int)\n\t\tif !hasMedia {\n\t\t\tgo func() {\n\t\t\t\tsite := sm.GetFiles(utils.ZN_UPDATE, func(filename string) bool {\n\t\t\t\t\treturn strings.HasPrefix(filename, utils.ZN_MEDIA)\n\t\t\t\t})\n\t\t\t\tsite.Wait()\n\t\t\t\tsync <- 0\n\t\t\t}()\n\t\t} else {\n\t\t\tgo func() {\n\t\t\t\tsync <- 0\n\t\t\t}()\n\t\t}\n\t\tnames := sm.GetFiles(utils.ZN_NAMES, func(filename string) bool {\n\t\t\treturn strings.HasPrefix(filename, \"data/names.json\")\n\t\t})\n\t\tnames.Wait()\n\t\tsm.Get(utils.ZN_ID)\n\t\t// ids.Wait()\n\t\t<-sync\n\t\tsm.LoadNames()\n\t\ts := server.NewServer(c.Int(\"port\"), sm)\n\t\tif c.Bool(\"debug\") {\n\t\t\tl.SetOutput(os.Stdout)\n\t\t\tlog.SetLevel(log.DebugLevel)\n\t\t\tgo func() {\n\t\t\t\tlog.Println(http.ListenAndServe(\"localhost:6060\", nil))\n\t\t\t}()\n\t\t}\n\t\tif !c.Bool(\"no-tab\") {\n\t\t\tgo func() {\n\t\t\t\ttime.Sleep(time.Second)\n\t\t\t\taddr := utils.ZN_HOMEPAGE\n\t\t\t\tif c.NArg() > 0 {\n\t\t\t\t\taddr = c.Args().First()\n\t\t\t\t}\n\t\t\t\tbrowser.OpenURL(fmt.Sprintf(\"http://127.0.0.1:%d/%s\", c.Int(\"port\"), addr))\n\t\t\t}()\n\t\t}\n\t\ts.Serve()\n\t\treturn nil\n\t}\n\n\tapp.Run(os.Args)\n}\n","language":"text/x-go","encrypted":false,"added":1483719075}],"comment":[]}