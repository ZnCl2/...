(function(){var e,t,n=function(e,t){return function(){return e.apply(t,arguments)}},r=function(e,t){function n(){this.constructor=e}for(var r in t)o.call(t,r)&&(e[r]=t[r]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e},o={}.hasOwnProperty;e=function(e){function o(){return this.updateUser=n(this.updateUser,this),this.route=n(this.route,this),this.onOpenWebsocket=n(this.onOpenWebsocket,this),this.loadAbout=n(this.loadAbout,this),this.doPublish=n(this.doPublish,this),this.publishPaste=n(this.publishPaste,this),this.loadRecent=n(this.loadRecent,this),this.deletePaste=n(this.deletePaste,this),this.showLoadedPaste=n(this.showLoadedPaste,this),this.loadPaste=n(this.loadPaste,this),this.init=n(this.init,this),o.__super__.constructor.apply(this,arguments)}return r(o,e),o.prototype.init=function(){return this.site_info=null,this.current_paste=null,this.size_current=null,this.size_max=null,window.addEventListener("load",function(e){return function(t){return document.getElementById("publish_button").addEventListener("click",function(t){return e.site_info.cert_user_id?e.publishPaste():(document.getElementById("newpaste").style.pointerEvents="auto",e.cmd("certSelect",[["zeroid.bit"]]))},!1),document.getElementById("delete_button").addEventListener("click",function(t){return e.cmd("wrapperConfirm",["Are you sure?","Delete"],function(t){return t?e.deletePaste():void 0})},!1),document.getElementById("clone_button").addEventListener("click",function(t){var n,r,o,i,a,d,s;if(document.getElementById("pasteview").style.display="none",document.getElementById("newpaste_description").value=e.current_paste.description,document.getElementById("newpaste_encryption").checked=e.current_paste.encrypted,e.initEditor(),editor.setValue(e.current_paste.body),"plaintext"!==e.current_paste.language&&"text/plain"!==e.current_paste.language)for(s=document.getElementById("select_language"),d=s.options,o=0,i=d.length;i>o;o++){if(a=d[o],a.value===e.current_paste.language){s.value=a.value,editor.setOption("mode",e.current_paste.language),r=CodeMirror.findModeByMIME(e.current_paste.language),r&&CodeMirror.autoLoadMode(editor,r.mode);break}if(n=CodeMirror.findModeByMIME(a.value),(null!=n?n.mode:void 0)===e.current_paste.language){s.value=a.value,editor.setOption("mode",a.value),CodeMirror.autoLoadMode(editor,e.current_paste.language);break}}return document.getElementById("newpaste").style.display="block"},!1),document.getElementById("select_language").addEventListener("change",function(e){var t;return editor.setOption("mode",e.target.value),t=CodeMirror.findModeByMIME(e.target.value),t?CodeMirror.autoLoadMode(editor,t.mode):void 0},!1),document.getElementById("select_tabwidth").addEventListener("change",function(e){return editor.setOption("tabSize",parseInt(e.target.value)),editor.setOption("indentUnit",parseInt(e.target.value))},!1)}}(this),!1)},o.prototype.initEditor=function(){return document.getElementById("newpaste").style.display="block",null!=window.editor?(editor.setValue(""),editor.setOption("mode","text/plain"),void(document.getElementById("select_language").value="text/plain")):(window.editor=CodeMirror.fromTextArea(document.getElementById("newpaste_editor"),{lineNumbers:!0,mode:null,theme:"default",matchBrackets:!0,tabSize:4,indentUnit:4,autofocus:!0}),window.editor_indent_space=!0,editor.setOption("extraKeys",{Tab:function(e){return editor_indent_space?e.replaceSelection(Array(e.getOption("indentUnit")+1).join(" ")):e.replaceSelection("	")}}),editor.on("changes",function(e){return function(e){return t.updateSize(encodeURIComponent(editor.getValue()).replace(/%../g,"x").length)}}(this)))},o.prototype.loadPaste=function(e,t){var n,r;return document.getElementById("newpaste").style.display="none",document.getElementById("pasteview_body").innerText="LOADING...",document.getElementById("delete_button").style.display="none",n=document.getElementById("pasteview"),r=(new Spinner).spin(n),n.style.display="block",this.cmd("dbQuery",["SELECT\n    description,\n    body,\n    language,\n    paste_creator_user.value AS creator_user_id,\n    added,\n    encrypted\nFROM paste\n    LEFT JOIN json AS paste_creator_json ON (paste_creator_json.json_id = paste.json_id)\n    LEFT JOIN json AS paste_creator_content\n        ON (paste_creator_content.directory = paste_creator_json.directory AND\n            paste_creator_content.file_name = 'content.json')\n    LEFT JOIN keyvalue\n        AS paste_creator_user ON (paste_creator_user.json_id = paste_creator_content.json_id\n            AND paste_creator_user.key = 'cert_user_id')\nWHERE\n    paste_creator_json.directory = '"+e+"' AND paste_id = "+t],function(e){return function(t){var n;return t.error?void(t.error.startsWith("no such column")?e.cmd("wrapperNotification",["error","Error (Your database schema may possibly out of sync. Wait for a while and try again.): "+t.error]):e.cmd("wrapperNotification",["error","Error: "+t.error])):0===t.length?void e.cmd("wrapperNotification",["error","This site database have to finish downloading before viewing this page. Try to wait and refresh this page. Else it can mean this paste does not exist."]):(n=t[0],e.current_paste={description:n.description,body:n.body,language:n.language,added:new Date(1e3*n.added),creator_user_id:n.creator_user_id,encrypted:n.encrypted||!1},r.stop(),document.getElementById("pasteview_size").textContent=(encodeURIComponent(e.current_paste.body).replace(/%../g,"x").length/1e3).toFixed(2),e.current_paste.encrypted?e.current_paste.creator_user_id===e.site_info.cert_user_id?e.cmd("eciesDecrypt",[e.current_paste.description],function(t){return e.current_paste.description=t,e.cmd("eciesDecrypt",[e.current_paste.body],function(t){return e.current_paste.body=t,"plaintext"===e.current_paste.language||/^(application|text)\//.test(e.current_paste.language)?(document.getElementById("pasteview_encrypted").style.display="inline",e.showLoadedPaste()):e.cmd("eciesDecrypt",[e.current_paste.language],function(t){return e.current_paste.language=t,document.getElementById("pasteview_encrypted").style.display="inline",e.showLoadedPaste()})})}):void e.cmd("wrapperNotification",["error","Private pastes are encrypted and can only be decrypted by creator."]):(document.getElementById("pasteview_encrypted").style.display="none",e.showLoadedPaste()))}}(this))},o.prototype.showLoadedPaste=function(){var e,t;return e=document.getElementById("pasteview_body"),e.textContent=this.current_paste.body,"plaintext"===this.current_paste.language||"text/plain"===this.current_paste.language?this.addLineNum(e):(e.setAttribute("data-lang",this.current_paste.language),t=CodeMirror.findModeByMIME(this.current_paste.language),t?CodeMirror.requireMode(t.mode,function(t){return function(){return CodeMirror.colorize([e]),t.addLineNum(e)}}(this)):CodeMirror.requireMode(this.current_paste.language,function(t){return function(){return CodeMirror.colorize([e]),t.addLineNum(e)}}(this))),this.site_info.cert_user_id&&"block"===document.getElementById("pasteview").style.display&&(this.current_paste.creator_user_id===this.site_info.cert_user_id?document.getElementById("delete_button").style.display="inline":document.getElementById("delete_button").style.display="none"),document.getElementById("pasteview_description").textContent=this.current_paste.description,document.getElementById("pasteview_user").textContent=this.current_paste.creator_user_id,document.getElementById("pasteview_user").href="?user_"+this.current_paste.creator_user_id,document.getElementById("pasteview_language").textContent=this.current_paste.language,document.getElementById("pasteview_added").textContent=this.current_paste.added.toLocaleString()},o.prototype.addLineNum=function(e){var t,n,r,o,i;for(r="",o=e.textContent.split(/\n/).length,t=n=1,i=o;i>=1?i>=n:n>=i;t=i>=1?++n:--n)r+="<span>"+t+"</span>";return e.innerHTML='<span class="line-num">'+r+"</span>"+e.innerHTML+'<span style="display:block;clear:both;"></span>'},o.prototype.deletePaste=function(){var e,t,n,r,o,i;return e=document.getElementById("delete_button"),e.style.pointerEvents="none",o=(new Spinner).spin(document.getElementById("pasteview")),(n=window.location.search.match(/^\?(1[a-zA-Z0-9]{26,33})_(\d+)&/))?(i=n[1],r=parseInt(n[2]),t="data/users/"+i+"/data.json",this.cmd("fileGet",{inner_path:t,required:!0},function(n){return function(i){var a,d,s,c,u;for(i=JSON.parse(i),u=i.paste,a=d=0,s=u.length;s>d;a=++d)if(c=u[a],c.paste_id===r){i.paste.splice(a,1);break}return n.cmd("fileWrite",[t,n.jsonEncode(i)],function(r){return"ok"!==r?(n.cmd("wrapperNotification",["error","Error: "+r.error]),e.style.pointerEvents="auto"):n.cmd("sitePublish",{inner_path:t},function(t){return o.stop(),"ok"===t?(n.cmd("wrapperNotification",["done","Sucessfully deleted"]),location.search="?"):(n.cmd("wrapperNotification",["error","Failed to delete: "+t.error]),e.style.pointerEvents="auto")})})}}(this))):(o.stop(),void this.cmd("wrapperNotification",["error","Failed to delete: wrong URL"]))},o.prototype.loadRecent=function(e,t,n){var r,o,i,a,d,s;return null==e&&(e=0),null==t&&(t=null),null==n&&(n=(new Date).getTime()/1e3),document.getElementById("newpaste").style.display="none",document.getElementById("pasteview").style.display="none",o=document.getElementById("recentview"),0===e&&((i=document.getElementById("recentview_next"))&&o.removeChild(i),s=document.createElement("h3"),t?s.appendChild(document.createTextNode("Pastes created by "+t)):s.appendChild(document.createTextNode("Recent pastes")),o.appendChild(s)),o.style.display="block",a=(new Spinner).spin(o),r=12,d=t?"SELECT\n    paste_id,\n    description,\n    body,\n    paste_creator_user.value AS creator_user_id,\n    paste_creator_content.directory AS creator_directory,\n    added,\n    language,\n    encrypted\nFROM paste\n    LEFT JOIN json AS paste_creator_json ON (paste_creator_json.json_id = paste.json_id)\n    LEFT JOIN json AS paste_creator_content\n        ON (paste_creator_content.directory = paste_creator_json.directory AND\n            paste_creator_content.file_name = 'content.json')\n    LEFT JOIN keyvalue\n        AS paste_creator_user ON (paste_creator_user.json_id = paste_creator_content.json_id\n            AND paste_creator_user.key = 'cert_user_id')\nWHERE paste_creator_user.value = '"+t+"' AND added <= "+n+"\nORDER BY added DESC\nLIMIT "+(r+1)+" OFFSET "+r*e:"SELECT\n    paste_id,\n    description,\n    body,\n    paste_creator_user.value AS creator_user_id,\n    paste_creator_content.directory AS creator_directory,\n    added,\n    language\nFROM paste\n    LEFT JOIN json AS paste_creator_json ON (paste_creator_json.json_id = paste.json_id)\n    LEFT JOIN json AS paste_creator_content\n        ON (paste_creator_content.directory = paste_creator_json.directory AND\n            paste_creator_content.file_name = 'content.json')\n    LEFT JOIN keyvalue\n        AS paste_creator_user ON (paste_creator_user.json_id = paste_creator_content.json_id\n            AND paste_creator_user.key = 'cert_user_id')\nWHERE encrypted IS NULL OR encrypted = 0 AND added <= "+n+"\nORDER BY added DESC\nLIMIT "+(r+1)+" OFFSET "+r*e,this.cmd("dbQuery",[d],function(d){return function(s){var c,u,p,l,_;if(s.error)return void(s.error.startsWith("no such column")?d.cmd("wrapperNotification",["error","Error (Your database schema may possibly out of sync. Wait for a while and try again.): "+s.error]):d.cmd("wrapperNotification",["error","Error: "+s.error]));for(u=s.length>r?s.slice(0,-1):s,c=document.createElement("div"),p=0,l=u.length;l>p;p++)_=u[p],d.add_snippet(c,_);return a.stop(),o.appendChild(c),s.length===r+1?(i=document.createElement("button"),i.style.textAlign="center",i.style.display="block",i.textContent="Load more pastes",i.addEventListener("click",function(r){return o.removeChild(r.target),d.loadRecent(e+1,t,n)},!1),o.appendChild(i)):void 0}}(this))},o.prototype.add_snippet=function(e,n){var r;return r=document.createElement("article"),r.classList.add("list"),n.encrypted?n.creator_user_id===t.site_info.cert_user_id?(e.appendChild(r),t.cmd("eciesDecrypt",[n.description],function(e){return function(e){return n.description=e,t.cmd("eciesDecrypt",[n.body],function(e){return n.body=e,"plaintext"===n.language||/^(application|text)\//.test(n.language)?t.add_snippet_2(r,n):t.cmd("eciesDecrypt",[n.language],function(e){return n.language=e,t.add_snippet_2(r,n)})})}}(this))):void 0:(e.appendChild(r),t.add_snippet_2(r,n))},o.prototype.add_snippet_2=function(e,n){var r,o,i,a,d,s,c,u;return o=document.createElement("header"),s=document.createElement("a"),s.appendChild(document.createTextNode(n.description+"\nby "+n.creator_user_id+"\n("+new Date(1e3*n.added).toLocaleString()+")")),s.href="?"+n.creator_directory+"_"+n.paste_id,o.appendChild(s),n.encrypted&&(a=document.createElement("span"),a.classList.add("enc-indicator"),i=document.createElement("img"),i.src="img/AJ_Padlock_Silhouette.svg",i.width=10,a.appendChild(i),a.appendChild(document.createTextNode("Private")),o.appendChild(a)),e.appendChild(o),u=document.createElement("pre"),u.style.overflowX="auto","plaintext"!==n.language&&"text/plain"!==n.language&&u.setAttribute("data-lang",n.language),c=n.body.match(/^(.*(?:\n.*){0,3})/m),c?(o=c[1],o.length>1e3&&(o=o.substr(0,1e3)+"...")):o="",u.appendChild(document.createTextNode(o)),r=document.createElement("code"),r.appendChild(u),e.appendChild(r),"plaintext"===n.language||"text/plain"===n.language?t.addLineNum(u):(u.style.display="none",(d=CodeMirror.findModeByMIME(n.language))?CodeMirror.requireMode(d.mode,function(e){return function(){return CodeMirror.colorize([u]),t.addLineNum(u),u.style.display="block"}}(this)):CodeMirror.requireMode(n.language,function(e){return function(){return CodeMirror.colorize([u]),t.addLineNum(u),u.style.display="block"}}(this)))},o.prototype.publishPaste=function(){var e,t,n,r;return e=editor.getValue(),""===e?void this.cmd("wrapperNotification",["error","You can't create empty paste."]):(t=document.getElementById("newpaste_description").value,r=editor.getOption("mode"),r||(r="text/plain"),n=document.getElementById("newpaste_encryption").checked,n?this.cmd("eciesEncrypt",[t],function(n){return function(o){return t=o,n.cmd("eciesEncrypt",[e],function(o){return e=o,n.cmd("eciesEncrypt",[r],function(o){return r=o,n.doPublish(e,t,r,!0)})})}}(this)):this.doPublish(e,t,r,!1))},o.prototype.doPublish=function(e,t,n,r){var o,i,a;return n||(n="text/plain"),o=document.getElementById("newpaste"),o.style.pointerEvents="none",a=(new Spinner).spin(o),i="data/users/"+this.site_info.auth_address+"/data.json",this.cmd("fileGet",{inner_path:i,required:!1},function(o){return function(d){var s,c,u,p;for(d=d?JSON.parse(d):{next_paste_id:0,next_comment_id:0,paste:[],comment:[]},p=d.paste,s=0,c=p.length;c>s;s++)u=p[s],"plaintext"===u.language&&(u.language="text/plain");return d.paste.push({paste_id:d.next_paste_id,description:t,body:e,language:n,encrypted:r,added:Math.floor((new Date).getTime()/1e3)}),d.next_paste_id++,o.cmd("fileWrite",[i,o.jsonEncode(d)],function(e){return"ok"!==e?("Site sign failed"===e.error?o.cmd("wrapperNotification",["error","Site sign failed. Possibly your post may have exceeded the size limit:"]):o.cmd("wrapperNotification",["error","Error: "+e.error]),document.getElementById("newpaste").style.pointerEvents="auto"):o.cmd("sitePublish",{inner_path:i},function(e){return"ok"===e?(a.stop(),window.location.search="?"+o.site_info.auth_address+"_"+(d.next_paste_id-1)):(o.cmd("wrapperNotification",["error","An error occured: "+e.error]),a.stop(),document.getElementById("newpaste").style.pointerEvents="auto")})})}}(this))},o.prototype.loadAbout=function(){return this.cmd("dbQuery",["SELECT count(*) FROM paste"],function(e){return function(t){return t.error?void e.cmd("wrapperNotification",["error","An error occured: "+t.error]):document.getElementById("stat_total").textContent=t[0]["count(*)"]}}(this)),this.cmd("dbQuery",["SELECT count(*) FROM paste WHERE encrypted = 1"],function(e){return function(t){return t.error?void e.cmd("wrapperNotification",["error","An error occured: "+t.error]):document.getElementById("stat_encrypted").textContent=t[0]["count(*)"]}}(this)),this.cmd("dbQuery",["SELECT count(*) FROM keyvalue WHERE key = 'cert_user_id'"],function(e){return function(t){return t.error?void e.cmd("wrapperNotification",["error","An error occured: "+t.error]):document.getElementById("stat_users").textContent=t[0]["count(*)"]}}(this)),document.getElementById("aboutview").style.display="block"},o.prototype.onOpenWebsocket=function(e){return this.cmd("siteInfo",{},function(e){return function(t){var n,r;return e.site_info=t,document.getElementById("title").textContent=e.site_info.content.title,e.updateUser(e.site_info.cert_user_id),(r=window.location.search.match(/^\?(1[a-zA-Z0-9]{26,33})_(\d+)&/))?e.loadPaste(r[1],r[2]):(r=window.location.search.match(/^\?recent&/))?e.loadRecent():(r=window.location.search.match(/^\?about&/))?e.loadAbout():(r=window.location.search.match(/^\?user_([A-Za-z0-9]+@[A-Za-z0-9-.]+)&/))?e.loadRecent(0,r[1]):(n="data/users/"+e.site_info.auth_address+"/content.json",e.cmd("fileRules",n,function(t){return t?(e.size_current=t.current_size,e.size_max=t.max_size,e.updateSize(0)):void 0}),e.initEditor())}}(this))},o.prototype.route=function(e,t){switch(e){case"setSiteInfo":return this.site_info=t.params,this.updateUser(this.site_info.cert_user_id)}},o.prototype.updateUser=function(e){var t;return e?(document.getElementById("publish_button").textContent="Create",document.getElementById("size_disp").style.display="block",t=document.getElementById("yourpastes_link"),t.href="?user_"+this.site_info.cert_user_id,t.style.display="inline-block","block"===document.getElementById("pasteview").style.display?document.getElementById("pasteview_user").textContent===e?document.getElementById("delete_button").style.display="inline":document.getElementById("delete_button").style.display="none":void 0):(document.getElementById("publish_button").textContent="Select user...",document.getElementById("size_disp").style.display="none",t=document.getElementById("yourpastes_link"),t.style.display="none")},o.prototype.updateSize=function(e){var t;return t=document.getElementById("size_current"),e>0?t.textContent=((this.size_current+e)/1e3).toFixed(2)+" ("+(this.size_current/1e3).toFixed(2)+" + approx. "+(e/1e3).toFixed(2)+")":t.textContent=""+(this.size_current/1e3).toFixed(2),e+this.size_current>this.size_max?t.style.color="red":t.style.color="black",document.getElementById("size_max").textContent=(this.size_max/1e3).toFixed(2)},o.prototype.jsonEncode=function(e){return btoa(unescape(encodeURIComponent(JSON.stringify(e))))},o}(ZeroFrame),t=new e}).call(this);