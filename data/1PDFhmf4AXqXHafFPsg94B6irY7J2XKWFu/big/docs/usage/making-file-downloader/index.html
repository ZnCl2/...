<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="referrer" content="no-referrer">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">

	<title>Making a File Downloader - ZeroMux</title>

        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet" crossorigin="anonymous">
        <link href="../../css/font-awesome-4.0.3.css" rel="stylesheet" crossorigin="anonymous">
        <link rel="stylesheet" href="../../css/highlight.css" crossorigin="anonymous">
        <link href="../../css/base.css" rel="stylesheet" crossorigin="anonymous">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <!-- Main title -->
            <a class="navbar-brand" href="../..">ZeroMux</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
            
            
                <li >
                    <a href="../..">Home</a>
                </li>
            
            
            
                <li class="dropdown active">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Usage <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        
<li >
    <a href="../">File Dependencies</a>
</li>

                    
                        
<li class="active">
    <a href="./">Making a File Downloader</a>
</li>

                    
                        
<li >
    <a href="../making-mp4-file-streaming-friendly/">Making an MP4 File Streaming Friendly</a>
</li>

                    
                    </ul>
                </li>
            
            
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                <li >
                    <a rel="next" href="../">
                        <i class="fa fa-arrow-left"></i> Previous
                    </a>
                </li>
                <li >
                    <a rel="prev" href="../making-mp4-file-streaming-friendly/">
                        Next <i class="fa fa-arrow-right"></i>
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#making-requests">Making requests</a></li>
        
    
        <li class="main "><a href="#all-in-one-api">All-in-one API</a></li>
        
            <li><a href="#registering-event-handlers">Registering Event Handlers</a></li>
        
            <li><a href="#handling-onjsonload">Handling onjsonload</a></li>
        
            <li><a href="#handling-onjsonerror">Handling onjsonerror</a></li>
        
            <li><a href="#handling-onadding">Handling onadding</a></li>
        
            <li><a href="#handling-onadded">Handling onadded</a></li>
        
            <li><a href="#handling-onpieceerror">Handling onpieceerror</a></li>
        
            <li><a href="#handling-onblobbuilding">Handling onblobbuilding</a></li>
        
            <li><a href="#handling-onfinish">Handling onfinish</a></li>
        
            <li><a href="#handling-onbuilderror">Handling onbuilderror</a></li>
        
            <li><a href="#passing-extra-parameters">Passing Extra Parameters</a></li>
        
            <li><a href="#start-downloading">Start Downloading</a></li>
        
    
        <li class="main "><a href="#next-steps">Next Steps</a></li>
        
    
    </ul>
</div></div>
            <div class="col-md-9" role="main">

<h2> Making a File Downloader </h2>

<p>A file downloader in ZeroNet works by downloading, verifying and concatenating file chunks.</p>
<h3 id="making-requests">Making requests</h3>
<p>To make making HTTP requests simpler, there is a <code>requestBinary</code> function in <code>utils.js</code>. It is defined as:</p>
<pre><code class="js">function requestBinary(url, responseType, callback, failure)
</code></pre>

<p>To use it, first you need to include this line in your page:</p>
<pre><code class="html">&lt;script src=&quot;utils.js&quot;&gt;&lt;/script&gt;
</code></pre>

<p>Then you can use it recursively:</p>
<pre><code class="js">function downloadChunks(pieces, index=0)
{
    if(index &gt; pieces.length - 1)
    {
        var blob = new Blob(pieces, {type: &quot;application/octet-stream&quot;});
        var blobUrl = URL.createObjectURL(blob);
        console.log(blobUrl);

        return;
    }

    var chunkUrl = &quot;files/yrc_op_mp4/&quot; + index + &quot;.dat&quot;;

    requestBinary(chunkUrl, &quot;arraybuffer&quot;, function(xmlHttp)
    {
        // callback
        pieces[index] = xmlHttp.response;

        downloadChunks(pieces, index+1);

    }, function(xmlHttp, error)
    {
        // failure callback
        console.error(error);
    });
}

downloadChunks(Array(54)); // We have altogether 54 pieces of a file.
</code></pre>

<h3 id="all-in-one-api">All-in-one API</h3>
<p>In fact, you don't even need to make HTTP requests by hand. There is a well-wrapped <code>download.js</code> that handles <strong>all three</strong> processes.</p>
<p>To use it, you need to include these lines in your page:</p>
<pre><code class="html">&lt;script src=&quot;asmcrypto.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;utils.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;reader.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;download.js&quot;&gt;&lt;/script&gt;

&lt;!-- !!!NOTE THAT You also need &quot;async-hash.js&quot; placed in the same folder. --&gt;
</code></pre>

<h4 id="registering-event-handlers">Registering Event Handlers</h4>
<p>This API reports progress by dispatching "events," but, to make code simpler, it does <strong>not</strong> use <strong>conventional</strong> event handling techniques. Instead, it calls back a designated function every time a specific action is taking place. Then <code>download.js</code> blocks and waits until the callback function returns.</p>
<p>Here is a sample code on registering these special event handlers.</p>
<pre><code class="js">// register event handlers

// initialize the list of events
var events = initEventObj();

// triggers when file.json is loaded or failed to load
events.onjsonload = jsonload;
events.onjsonerror = jsonerror;

// triggers when a file chunk is being added (being downloaded and verified),
// added, or failed to add to the internal buffer
events.onadding = adding;
events.onadded = added;
events.onpieceerror = pieceerror;

// triggers when the original big file is being build, built or failed to build.
events.onblobbuilding = blobbuilding;
events.onfinish = finish;
events.onbuilderror = builderror;

// You can specify a blob content type.
// If not set, it will use &quot;application/octet-stream&quot; as default value.
events.otherParams = {&quot;blobType&quot;: &quot;application/force-download&quot;};
</code></pre>

<h4 id="handling-onjsonload">Handling <code>onjsonload</code></h4>
<pre><code class="js">function jsonload(infoArgs)
{
    // infoArgs is defined as
    {&quot;bigFileInfo&quot;: bigFileInfo, &quot;filePartInfo&quot;: filePartInfo}
    // infoArgs has the same structure as file.json

    // For example, the number of file chunks is
    var nParts = infoArgs.filePartInfo.length;

    // the big file's name is
    var fileName = infoArgs.bigFileInfo[&quot;fileName&quot;];
}
</code></pre>

<h4 id="handling-onjsonerror">Handling <code>onjsonerror</code></h4>
<pre><code class="js">function jsonerror(error)
{
    // `error` is an error object
    console.error(error);
}
</code></pre>

<h4 id="handling-onadding">Handling <code>onadding</code></h4>
<pre><code class="js">function adding(index)
{
    // `index` is the index of the chunk that is being downloaded
    setBlockColor(progressBar, index, &quot;yellow&quot;);
    // change progress bar color
}
</code></pre>

<h4 id="handling-onadded">Handling <code>onadded</code></h4>
<pre><code class="js">function added(eventArgs)
{
    // eventArgs is defined as
    {&quot;index&quot;: index, &quot;pieceBytes&quot;: pieceBytes}

    var index = eventArgs[&quot;index&quot;];
    var bytes = eventArgs[&quot;pieceBytes&quot;];
    // pieceBytes is an ArrayBuffer that contains
    // the binary data of the chunk
}
</code></pre>

<h4 id="handling-onpieceerror">Handling <code>onpieceerror</code></h4>
<pre><code class="js">function pieceerror(index)
{
    // when a &quot;PieceError&quot; happens, download.js returns.

    // `index` is the index of the chunk that has an error
    setBlockColor(progressBar, index, &quot;red&quot;);
}
</code></pre>

<h4 id="handling-onblobbuilding">Handling <code>onblobbuilding</code></h4>
<pre><code class="js">function blobbuilding(e)
{
    // `e` is null
}
</code></pre>

<h4 id="handling-onfinish">Handling <code>onfinish</code></h4>
<pre><code class="js">function finish(blob)
{
    // `blob` contains the reassembled big file
    var url = URL.createObjectURL(blob);
}
</code></pre>

<h4 id="handling-onbuilderror">Handling <code>onbuilderror</code></h4>
<pre><code class="js">function builderror(e)
{
    // `e` is null
}
</code></pre>

<h4 id="passing-extra-parameters">Passing Extra Parameters</h4>
<p>A hack to pass extra parameters to an event handler is to <strong>generate</strong> an event handler.</p>
<pre><code class="js">var mediaSource = ...;
var sourceBuffer = ...;
// ...

var events = initEventObj();
events.onjsonload = generateOnJsonLoad(mediaSource, sourceBuffer); // call generator
// ...

function generateOnJsonLoad(mediaSource, sourceBuffer)
{
    var f = function(infoArgs)
    {
        jsonload(infoArgs, mediaSource, sourceBuffer);
    }
    return f;
}

function jsonload(infoArgs, mediaSource, sourceBuffer)
{
    // your event handler with extra parameters
}
</code></pre>

<h4 id="start-downloading">Start Downloading</h4>
<p>After registering event handlers, you can start downloading.</p>
<pre><code class="js">// start
downloadBigFile(&quot;files/yrc_op_mp4/file.json&quot;, events); // (jsonPath, events)
</code></pre>

<h3 id="next-steps">Next Steps</h3>
<p>Learn about how to make an MP4 file <strong>streaming friendly</strong> by reading the <a href="../making-mp4-file-streaming-friendly/">next page</a>.</p></div>
        </div>

        <footer class="col-md-12">
            <hr>
            
            <center>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</center>
        </footer>

        <script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script>
        <script>var base_url = '../..';</script>
        <script data-main="../../mkdocs/js/search.js" src="../../mkdocs/js/require.js"></script>
        <script src="../../js/base.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                            From here you can search these documents. Enter
                            your search terms below.
                        </p>
                        <form role="form">
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                            </div>
                        </form>
                        <div id="mkdocs-search-results"></div>
                    </div>
                    <div class="modal-footer">
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>