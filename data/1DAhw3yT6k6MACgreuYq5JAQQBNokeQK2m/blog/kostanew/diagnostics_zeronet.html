<!DOCTYPE html>
<html>

<head>
	<title>Диагностические средства ZeroNet</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<link rel="stylesheet" href="../../css/global.css">
</head>

<body>
	
<header>
  <a href="../../index.html"><img src="../../img/logo.png" width="55"></a><br>ChronCache	
</header>
	
<nav>
	<hr>
  <p><a href="../../blog.html">архив</a> <tt>|</tt> <a href="../../help.html">помощь</a> <tt>|</tt> <a href="/1Q9LVNLD1ghusGxpiwjYnVjPsxD5xGTGc7/donate/index.html">донат</a></p>
	<hr>
</nav>

<article>
	
<acide><p>Это резервная страница от 17.02.2019 / <a href="/1FMeSorqAS8Kq5E5XJpGGBJ8Qb2CxXhaYb/?Post:3">оригинал</a></p></acide>

<section>
	<h1>Диагностические средства ZeroNet</h1>
	<p>Недавно выяснилось, что большинство людей не в курсе о таких диагностических возможностях ZeroNet как Stats, Benchmark и т.д. Поэтому, я покопался в ядре и посмотрел что в нем вообще есть.</p>
	<p>Нашел еще 2-3 интересные штуки, но самый ЭПИК я осознал в конце. Оказалось, что владельцы прокси не отключают Stats плагин и уязвимы к (D)DOS из-за этого.</p>
	<p>Содержание:</p>
	<ul>
		<li>Инструменты ядра: Console, Debug, TestStream
		<li>Инструменты Stats: Benchmark, Stats, GcCollect
		<li>Уязвимость ZeroNet прокси
	</ul>
	<h3>Введение</h3>
	<p>Итак, в ZeroNet есть набор средств диагностики лежащих по текстовым адресам вида.</p>
	<div class="code"><code>http://127.0.0.1:43110/Console<br>http://127.0.0.1:43110/Debug<br>http://127.0.0.1:43110/TestStream<br>http://127.0.0.1:43110/Benchmark<br>http://127.0.0.1:43110/Stats<br>http://127.0.0.1:43110/GcCollect<br>http://127.0.0.1:43110/Dumpobj<br>http://127.0.0.1:43110/Listobj</code></div>
	<p>Обратите внимание, что это не .bit домены!</p>
	<p>Когда вы обращаетесь по любому адресу, запрос улетает в функцию route(path) объекта UiRequest. Если обращение идет не по адресу сайта и не по .bit домену, то происходит вызов функции вида actionXXXXX. Например, обращение по адресу Debug вызовет функцию actionDebug.</p>
	<p>Такой механизм очень здорово подходит для плагинов. Потому что позволяет делать не конфликтующие плагины, если адреса, по которым вызываются инструменты, не пересекаются. Плагин Stats работает как раз через этот механизм. Концепция полностью аналогична навешиванию на WebSocket, о котором я написал в конце <a href="/1FMeSorqAS8Kq5E5XJpGGBJ8Qb2CxXhaYb/?Post:2">этого поста</a>.</p>
	<p>Теперь рассмотрим какие инструменты входят в стандартный бандл.</p>
	<h3>Инструменты ядра</h3>
	<p>Тут совсем негусто. В основном, инструменты ядра нужны для отладки. Они требуют <a href="http://werkzeug.pocoo.org/" target="_blank">Werkzeug</a> и запуск с ключом <code>--debug</code> для правильной работы. Предназначение инструментов Console и Debug описано в <a href="https://zeronet.readthedocs.org/en/latest/site_development/getting_started/" target="_blank">официальной документации</a>.</p>
	<code>http://127.0.0.1:43110/Console</code>
	<p>Вызывает интерактивную Python консоль, если есть Werkzeug, иначе, просто вываливает ошибку. При выпадении ошибки видно некоторую полезную информацию: версию python, gevent, ZeroNet; плагины; используемые трекеры...</p>
	<code>http://127.0.0.1:43110/Debug</code>
	<p>Позволяет отлаживать последнюю выпавшую ошибку через механизм DebugHook. Как конкретно этот механизм работает внутри, я пока не понял, но его классы лежат в папке Debug.</p>
	<code>http://127.0.0.1:43110/TestStream</code>
	<p>Выводит "Hello!" с задержкой. Скорее всего, нужен чтобы убедиться, что взаимодействие с браузером вообще работает.</p>
	<h3>Инструменты Stats</h3>
	<p>А вот тут начинается самое интересное. Плагин Stats добавляет в ZeroNet три очень важных и интересных вызова;</p>
	<code>http://127.0.0.1:43110/Benchmark</code>
	<p>Тестирует производительность вашей системы для работы с ZeroNet. Ниже привожу полный дамп для моей системы:</p>
	<div class="code">
		<code>Benchmarking ZeroNet 0.3.6 (rev966) Python 2.7.9 (default, Apr 2 2015, 15:33:21) [GCC 4.9.2] on: linux2...

CryptBitcoin:
- hdPrivatekey x 10..........0.223s [x3.14: WOW]
- sign x 10..........0.113s [x3.09: WOW]
- openssl verify x 100..........0.177s [x2.10: Fast]
- pure-python verify x 10..........0.493s [x3.25: WOW]

CryptHash:
- sha256 5M x 10..........0.455s [x1.32: Fine]
- sha512 5M x 10..........0.290s [x2.07: Fast]
- os.urandom(256) x 100 000..........2.179s [x0.30: Sloooow]

Msgpack:
- pack 5K x 10 000..........0.449s [x1.74: Fast]
- unpack 5K x 10 000..........0.746s [x1.61: Fine]
- streaming unpack 5K x 10 000..........0.804s [x1.74: Fast]

Db:
- Open x 10..........2.855s [x0.05: Sloooow]
- Insert x 10 x 1000..........0.688s [x1.45: Fine]
- Buffered insert x 100 x 100..........0.975s [x1.33: Fine]
- Total rows in db: 20000
- Indexed query x 1000..........0.171s [x1.46: Fine]
- Not indexed query x 100..........0.296s [x2.03: Fast]
- Like query x 100..........0.787s [x2.29: Fast]

Done. Total: 12.40s</code>
	</div>
	<p>По данным с форумов и блога <a href="/blog.musickiller.bit/?Post:40">@musickiller</a>, показатели общего времени прохождения теста на ПК составляют от 5 до 20 секунд, на Android -- 90 и выше. Обратите внимание, что тест сильно грузит машину. При этом, его можно запустить много раз.</p>
	<code>http://127.0.0.1:43110/Stats</code>
	<p>Выводит данные о ваших соединениях с пирами и статистику по загруженным вами 0сайтам. Здесь можно посмотреть у каких пиров какая версия ZeroNet. А так же ту статистику, которые вы видите в правой боковой панели по 0сайту, для всех сайтов сразу.</p>
	<p>В режиме <code>--debug</code> так же пишет дополнительную информацию: объем занимаемой классами и объектами памяти; ошибки гринлетов (greenlet) и адреса подключения воркеров (workers); параметры cоединений по различным адресам, сокетам; данные о работе msgpack; загруженные модули python и пути до них. Многое из этого требует дальнейшего изучения.</p>
	<p>Прокомментирую термины, которые уже начал понимать. Гринлеты (greenlets) - это легковесные потоки, предоставляемые gevent. Они предоставляют конкурентное выполнение задач, более удобным способом, чем встроенные механизмы Python. К сожалению, для них работает GIL, а значит нет настоящего параллелизма. Воркеры (workers) - это элементы очереди задач ядра ZeroNet, именно эти штуки следят за загрузкой нужных файлов из пиров.</p>
	<code>http://127.0.0.1:43110/GcCollect</code>
	<p>Вызывает сборку мусора в ядре ZeroNet и возвращает сколько объектов было собрано. Эта команда работает даже без режима отладки.</p>
	<code>http://127.0.0.1:43110/Dumpobj<br>http://127.0.0.1:43110/Listobj</code>
	<p>Команды работающие только в режиме Debug. Должны выводить данные об объектах в памяти в определенном формате. Однако, у меня почему то не заработали. Возможно, я просто не дождался, так как в коде обеих функций используется команда <code>gc.get_objects()</code>.</p>
	<h3>Уязвимость ZeroNet прокси</h3>
	<p>Барабанная дробь. Владельцы прокси вообще не поняли что они позапускали, ни на одном из них плагин Stats не отключен. Любой может быстро стучаться извне на /Benchmark и положить сервер частыми запросами. Более того, серверы компрометируют таким образом свое оборудование и свои коннекты, что не очень хорошо. </p>
	<p>Используя список прокси от @eugenere, который лежит <a href="/148or6yKMeNV4qdmKyCtpaNiFAeU1cccCw/?Post:19">тут</a> я благополучно стырил с трех из них данные. Если такие данные кому то нужны для изучения без злого умысла, могу переслать лично.</p>
	<h3>В заключение</h3>
	<p>Некоторые вещи вообще непонятно как работают. Если у кого то получилось использовать их правильно, напишите в комментарии, пожалуйста. Так же в коде ядра есть еще более 10 функций вида actionXXXXXX, но мне кажется они должны использоваться по-другому, а не вызываться из адресной строки.</p>
</section>	
	
<hr><p>Комментарии:</p>
	
<section class="com">
	<div>
		<p><b>vlad20012:</b> <tt>(Mar 13, 2016)</tt><br>Ничего не знаю о GC в Python, зато отлично знаю в Java. Если смотреть с позиции Java - то здесь написан полный бред. Осюда вопрос - откуда инфа? Про Cron, например? Не сам ли, случаем, додумал? А то скорее всего это рекомендация выстрелить себе в ногу.</p>
	</div>
	<div>
		<p><b>kostanew:</b> <tt>(Mar 13, 2016)</tt><br><em><b>vlad20012:</b> ... здесь написан полный бред...</em><br>Очень хорошо подумал, действительно бред. Убрал.</p>
	</div>
	<div>
		<p><b>vlad20012:</b> <tt>(Mar 13, 2016)</tt><br>А инфа очень интересная, спасибо за статью</p>
	</div>
</section>
	
<p class="dr">Mar 13, 2016 / kostaNew</p>
	
</article>		
		
</body>
</html>