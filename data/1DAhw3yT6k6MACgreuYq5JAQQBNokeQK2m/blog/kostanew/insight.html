<!DOCTYPE html>
<html>

<head>
	<title>Немного инсайтов</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<link rel="stylesheet" href="../../css/global.css">
</head>

<body>
	
<header>
  <a href="../../index.html"><img src="../../img/logo.png" width="55"></a><br>ChronCache	
</header>
	
<nav>
	<hr>
  <p><a href="../../blog.html">архив</a> <tt>|</tt> <a href="../../help.html">помощь</a> <tt>|</tt> <a href="/1Q9LVNLD1ghusGxpiwjYnVjPsxD5xGTGc7/donate/index.html">донат</a></p>
	<hr>
</nav>

<article>
	
<acide><p>Это резервная страница от 17.02.2019 / <a href="/1FMeSorqAS8Kq5E5XJpGGBJ8Qb2CxXhaYb/?Post:2">оригинал</a></p></acide>

<section>
	<h1>Немного инсайтов</h1>
	<p>Так как с серьезными вещами все идет очень медленно, а документации и примеров страшно не хватает, то я решил написать про несколько "открытий". Надеюсь, это поможет некоторым лучше понять ZeroNet, если они на том же этапе, что и я.</p>
	<p>В этом посте:</p>
	<ul>
		<li>О шрифтах
		<li>О публикации зайта
		<li>Об опциональных файлах
		<li>Как писать плагины для ZeroNet
	</ul>
	<p><b>О шрифтах</b><br>На большинстве зайтов, основанных на стандартом шаблоне ZeroTalk и ZeroBlog, есть проблемы с отображением шрифтов. Русские буквы выглядят широкими, а английские маленькими. Это связано с тем, что в системе не стоят кириллические версии используемых шрифтов.</p>
	<p>Исправить это можно руками, скачав нужные семейства с Google Fonts и проставив все семейство в систему. Есть более продвинутые методы, но я к сожалению потерял описание, которое мне давали.</p>
	<p>Обычно проблемы вылазят на Ubuntu, со шрифтами Roboto и Tinos.</p>
	<p><b>О публикации зайта</b><br>К зайтам лучше относиться не как к веб страницам, а как к нативным приложениям Android или iOS. Когда вы публикуете приложение для Android, то вы его сначала подписываете, а потом засылаете на проверку в Google. Тут аналогично. Все действия делаются в 3 этапа.</p>
	<div class="code"><code>python zeronet.py siteCreate<br>python zeronet.py siteSign<br>python zeronet.py sitePublish</code></div>
	<p>Первая команда создает зайт. Она создаст папку с вашим зайтом, файл index.html и content.json внутри нее. Название этой папки, по сути, является открытым ключом зайта. Закрытый ключ будет выведен в консоль. НЕ ПОТЕРЯЙТЕ ЕГО! Иначе ваш зайт превратится из кареты в тыкву, которую будет невозможно выложить по тому же адресу.</p>
	<p>Вторая команда ну ОЧЕНЬ интеллектуальна. Ее главное предназначение это подписывать файл content.json. Однако, помимо этого, она записывает в content.json все лежащие в папке файлы. При этом тактично опуская временные файлы редактора, типа ogrizok_gedit.js~ и еще некоторый мусор. Так же, эта команда должна компилировать *.coffee скрипты, но к сожалению делает это только на Windows.</p>
	<p>Третья команда выкладывает зайт в открытый доступ. Для того что бы она сработала, вам требуется открытый порт 15441.</p>
	<p>Стоит отметить, что в формате <code>objectAction</code> есть еще несколько полезных команд для zeronet.py. Посмотреть их можно, используя ключ <code>--help</code>. А сам процесс публикации хорошо расписан в стандартной документации и презентации.</p>
	<p><b>Об опциональных файлах</b><br>В ноябре 2015 года в ZeroNet была добавлена возможность делать зайты с опциональными для загрузки файлами. К сожалению, в документации этот момент отразился настолько в <a href="https://zeronet.readthedocs.org/en/latest/site_development/content_json/#optional" target="_blank">хитром месте</a>, что многие так и не поняли как же этой возможностью воспользоваться.</p>
	<p>Тем не менее, все очень просто. Надо написать в content.json строку <code>"optional": "optional_files/.*"</code>. Тогда во время подписывания зайта, все файлы, попадающие под указанный шаблон (в данном случае содержимое папки optional_files), станут опциональными. Проверить это можно в content.json. Секция <code>"files"</code> декларирует обязательные для загрузки зайта файлы, а секция <code>"optional\_files"</code> опциональные.</p>
	<p>Посмотреть пример на опциональные файлы с проигрыванием музыки можно <a href="/1Lod6THUt6v6ebZdBF2voYMk2QfvLvPm4q">тут</a>, а его исходный код <a href="https://github.com/kostaNew/zeronet-audio-demo" target="_blank">тут</a>. Тег <code>&#60;audio src="audio/Little_Bits.mp3" preload="auto"></code> обращается к обязательному файлу и плеер гарантированно будет готов к проигрыванию при открытии зайта. Тэг <code>&#60;audio src="audio_optional/April_Kisses.mp3" preload="none"></code> не требует файла до нажатия кнопки play. Таким образом второй музыкальный файл не скачивается до запуска воспроизведения.</p>
	<p>Стоит отметить, что файлы можно загружать со стороны пользователя и делать их опциональными в папках с пользовательскими данными. Таким способом уже работает 0chan. Мне кажется, что появление большего количества зайтов с загружаемым пользовательским контентом, это дело времени, количества программистов и качества документации...</p>
	<p><b>Как писать плагины для ZeroNet</b></p>
	<p>А теперь мы подошли к самому интересному. Плагины для zeronet лежат в папке plugins и уже реализуют очень большой кусок логики. Плагин, по сути, является обычным питоновским модулем, который PluginManager дергает в определенное время и через механизм декораторов накладывает на код основного ядра. Отключенные плагины имеет префикс <code>disabled</code>. Плагины работающие только в режиме дебага, начинаются с <code>Debug</code>.</p>
	<p>Что бы сделать свой плагин нужно:</p>
	<ul>
		<li>Создать новую папку, например TestPlugin
		<li>Создать файлы <code>__init__.py</code> и <code>TestPlugin.py</code>
		<li>В <code>__init__.py</code> написать <code>import TestPlugin</code>
		<li>В <code>TestPlugin.py</code> написать импорт класса PluginManager: <code>from Plugin import PluginManager</code>
		<li>Определить класс плагина <code>class UiRequestPlugin(object):</code>
		<li>Определить в декораторе, на какой класс ядра он будет навешиваться. Например, навешивание на UiRequest: <code>@PluginManager.registerTo("UiRequest")</code>
	</ul>
	<p>Логика работы очень простая. Если что то вызывает определенный в <code>UiRequestPlugin</code> метод, а его нет в ядре, то вызовется метод плагина. Если же метод в ядре есть, то он вызван не будет, а будет вызван метод вашего плагина. Во втором случае, важно правильно вернуть управление в ядро. Например так: <code>return super(UiRequestPlugin, self).route(path)</code>. Некоторые функции, которые вы переписываете, могут быть итераторами, поэтому используйте <code>yield</code>, примеров на это в стандартном бандле куча.</p>
	<p>Код простого плагина, пишущего строку в лог, можно найти <a href="https://github.com/kostaNew/zeronet-plugin-demo" target="_blank">тут</a>.</p>
	<p>Если плагинов на один класс много, то они будут навешиваться по очереди. Навеситься можно не на все классы ядра, а только на те, у которых подписано <code>@PluginManager.acceptPlugins</code>. На данный момент таких классов девять.</p>
	<ul>
		<li>main.py<li>Config.py
		<li>File/FileRequest.py
		<li>User/User.py
		<li>User/UserManager.py
		<li>Ui/UiWebsocket.py
		<li>Ui/UiRequest.py
		<li>Site/Site.py
		<li>Site/SiteManager.py
	</ul>
	<p>Стоит особо отметить файл UiWebsocket.py. Все реквесты из ZeroFrame улетают в ее метод handleRequest. Этот метод обрабатывает логику responce запроса, потом отсеивает попытки позвать административные команды без прав (sitePause, siteResume, siteDelete, siteList, siteSetLimit, siteClone, channelJoinAllsite, serverUpdate, serverPortcheck, serverShutdown, certSet, configSet). И в конце вызывает в объекте UiWebsocket метод, который состоит из слова action и названия команды с большой буквы. Например: actionFileWrite. Таким образом к UiWebsocket можно написать 100500 плагинов и все они не будут конфликтовать, если использовать разные названия для вызываемых из UI методов.</p>
</section>	
	
<hr><p>Комментарии:</p>
	
<section class="com">
	<div>
		<p><b>gomzik:</b> <tt>(Mar 12, 2016)</tt><br>Хорошо!</p>
	</div>
	<div>
		<p><b>coolplay:</b> <tt>(Feb 28, 2018)</tt><br>a site clone<br><u>http://127.0.0.1:43110/1NLFg344SMHsMMNZayCYcTvY4RStC7ELWX/</u></p>
	</div>
</section>
	
<p class="dr">Mar 12, 2016 / kostaNew</p>
	
</article>		
		
</body>
</html>