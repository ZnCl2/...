(function(){var t,e=function(t,e){return function(){return t.apply(e,arguments)}},n=function(t,e){function n(){this.constructor=t}for(var o in e)i.call(e,o)&&(t[o]=e[o]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},i={}.hasOwnProperty;t=function(t){function i(){return this.createCert=e(this.createCert,this),this.write=e(this.write,this),this.update_posts=e(this.update_posts,this),this.onOpenWebsocket=e(this.onOpenWebsocket,this),i.__super__.constructor.apply(this,arguments)}return n(i,t),i.prototype.init=function(){return this.last_checked=0,this.site_info=null,this.nanasi=bitcoin.ECPair.fromWIF("L21fbJbceebx6B3bwMK2U46W1Un7peLqBtPjfyARZpxsME9rxWFz")},i.prototype.onOpenWebsocket=function(t){return this.cmd("siteInfo",{},function(t){return function(e){return t.site_info=e,t.site_info.cert_user_id?(document.getElementById("id_show").textContent=t.site_info.cert_user_id,document.getElementById("submit_button").textContent="書き込む"):void 0}}(this)),this.update_posts()},i.prototype.update_posts=function(){return this.cmd("dbQuery",["select\n    hash,\n    name,\n    time,\n    body,\n    keyvalue.value as cert_user_id\nfrom post\nleft join json as data on (data.json_id = post.json_id)\nleft join json as content on (content.directory = data.directory AND content.file_name = 'content.json')\nleft join keyvalue on (keyvalue.json_id = content.json_id AND keyvalue.key = 'cert_user_id')\nwhere time > "+this.last_checked+" order by time asc"],function(t){return function(e){var n,i,o,r,s,a,u;if(e.error)return void t.cmd("wrapperNotification",["error","Failed to query:"+e.error]);for(t.last_checked=(new Date).getTime(),a=document.getElementById("posts"),o=0,r=e.length;r>o;o++)u=e[o],console.log(JSON.stringify(u)),s=document.getElementById("post_base").cloneNode(!0),s.id="",i=s.getElementsByClassName("hash")[0],i.textContent=u.hash.slice(0,8),i.name=u.hash.slice(0,8),i.href="#"+u.hash.slice(0,8),s.getElementsByClassName("name")[0].textContent=u.name,s.getElementsByClassName("time")[0].textContent=new Date(u.time).toLocaleString(),n=s.getElementsByClassName("body")[0],n.textContent=u.body,n.innerHTML=n.innerHTML.replace(/&gt;&gt;([A-Za-z0-9+\/]{8})/g,'<a href="#$1">$&</a>'),s.getElementsByClassName("id")[0].textContent=u.cert_user_id,a.firstChild?a.insertBefore(s,a.firstChild):a.appendChild(s);return console.log("updated")}}(this))},i.prototype.route=function(t,e){var n;return"setSiteInfo"===t&&(this.site_info=e.params,n=document.getElementById("submit_button"),this.site_info.cert_user_id?n.textContent="書き込む":n.textContent="ID作成",document.getElementById("id_show").textContent=this.site_info.cert_user_id,this.site_info.event&&(console.log(this.site_info.event),"file_done"===this.site_info.event[0]&&this.site_info.event[1].match(/.*data\.json$/)))?this.update_posts():void 0},i.prototype.write=function(){var t,e;return this.site_info.cert_user_id?(e=document.getElementById("submit_button"),e.disabled=!0,t="data/users/"+this.site_info.auth_address+"/data.json",this.cmd("fileGet",{inner_path:t,required:!1},function(n){return function(i){var o,r,s,a;return i=i?JSON.parse(i):{post:[]},s=document.getElementById("name_input").value,""===s&&(s="名無しさん"),r={name:s,body:document.getElementById("body_input").value,time:(new Date).getTime()},a=new jsSHA("SHA-256","TEXT"),a.update(JSON.stringify([n.site_info.auth_address,r.name,r.body,r.time])),r.hash=a.getHash("B64"),i.post.push(r),o=unescape(encodeURIComponent(JSON.stringify(i,null,"	"))),n.cmd("fileWrite",[t,btoa(o)],function(i){return"ok"===i?n.cmd("sitePublish",{inner_path:t},function(t){return"ok"===t?(document.getElementById("body_input").value="",e.disabled=!1,n.update_posts()):n.cmd("wrapperNotification",["error","書き込めませんでした: "+t.error])}):n.cmd("wrapperNotification",["error","書き込めませんでした: "+i.error])})}}(this))):void this.createCert()},i.prototype.createCert=function(){var t;return t=bitcoin.message.sign(this.nanasi,this.site_info.auth_address+"#web/"+this.site_info.auth_address.slice(0,13)).toString("base64"),this.cmd("certAdd",["nanasi","web",this.site_info.auth_address.slice(0,13),t],function(t){return function(e){return e.error&&e.error.startsWith("You already")?t.cmd("certSelect",[["zeroid.bit","nanasi"]]):e.error?t.cmd("wrapperNotification",["error","IDの作成に失敗しました: "+e.error]):t.cmd("certSelect",[["zeroid.bit","nanasi"]])}}(this))},i.prototype.insertHash=function(t){var e;return e=document.getElementById("body_input"),e.value=e.value.slice(0,e.selectionStart)+(">>"+t.textContent+"\n")+e.value.slice(e.selectionStart),e.focus()},i}(ZeroFrame),window.Page=new t}).call(this);