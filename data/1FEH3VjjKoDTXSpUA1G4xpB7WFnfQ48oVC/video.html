<html>
<head>
 <title>KopyKate Search</title>
 <meta charset="utf-8">
 <meta http-equiv="content-type" content="text/html; charset=utf-8" />
 <base href="" target="_top" id="base">
 <script>base.href = document.location.href.replace("/media", "").replace("index.html", "").replace(/[&?]wrapper=False/, "").replace(/[&?]wrapper_nonce=[A-Za-z0-9]+/, "")</script>
 <script src="sql.js"></script>
 <script src="jquery-3.1.0.min.js"></script>
<script type="text/javascript" src="js/ZeroFrame.js"></script>
<script src="base64-binary.js"></script>
</head>
<body>

<a href="index.html">File</a>
 Video
 <a href="music.html">Music</a>
 <a href="site.html">Site</a>
 <a href="talk.html">Talk</a>
<br>

<span id="count">0</span> videos and counting<br>
<input type = "search" class = "searchbox" name = "search_input" id = "sr" placeholder = "Search..." required x-webkit-speech results = "10" autosave = "search_input" title = "Search Zeronet" role = "search" autofocus autocomplete = "true" tab-index = "1"/></input>
<button onclick="search()">Search</button>
<div id="out"></div>

<script>

class Page extends ZeroFrame
{
  onRequest(cmd, message) {
    if (cmd == "setSiteInfo")
      this.siteinfo = message.params;
    else
      this.log("Unknown incoming message:", cmd)
  }
}
var db = null
var searchterm = "hellozeronet";
var page = new Page();
//1uPLoaDwKzP6MCGoVzw48r4pxawRBdmQc - zeroupload
//18Pfr2oswXvD352BbJvo59gZ3GbdbipSzh - kopykate big
page.cmd("siteInfo", [], (function(page) {
  return function(site_info) {
            page.siteinfo = site_info
            console.log(page)
            if(page.siteinfo.settings.permissions.indexOf("Cors:18Pfr2oswXvD352BbJvo59gZ3GbdbipSzh") < 0)
            {
              page.cmd("corsPermission", "18Pfr2oswXvD352BbJvo59gZ3GbdbipSzh", function()
                {
                   page.cmd("fileGet",
                   {
                      "inner_path": 'cors-18Pfr2oswXvD352BbJvo59gZ3GbdbipSzh/data/users/zeroup.db',
                      "format": 'base64'
                    }, function(data) {
                    var uInt8Array = new Uint8Array(Base64Binary.decodeArrayBuffer(data));
                    db = new SQL.Database(uInt8Array);
                    //fetchfromdb(searchterm)
                    var cnt = db.exec(
                    'SELECT count(*) description FROM file LEFT JOIN json USING (json_id)');
                  count = cnt[0].values[0];
                    document.getElementById("count").innerHTML = count
                    });
                });
            }else
            {
              page.cmd("fileGet",
                 {
                    "inner_path": 'cors-18Pfr2oswXvD352BbJvo59gZ3GbdbipSzh/data/users/zeroup.db',
                    "format": 'base64'
                  }, function(data) {
                  var uInt8Array = new Uint8Array(Base64Binary.decodeArrayBuffer(data));
                  db = new SQL.Database(uInt8Array);
                  //fetchfromdb(searchterm)
                  var cnt = db.exec(
                    'SELECT count(*) FROM file LEFT JOIN json USING (json_id)');
                  count = cnt[0].values[0];
                    document.getElementById("count").innerHTML = count
                  });
            }
        }
})(page));

function fetchfromdb(query)
{
	limit = 30;
	if(db == null)
	{
		searchterm = query;
		return;
	}

	document.getElementById('out').innerHTML = "Query: "+query+"<br>";

	query = query.toLowerCase()

	//query = query.replace(/\./g, '')
	//var users = db.exec('SELECT json_id, directory, cert_user_id FROM json');
	//ZeroUP query
	var files = db.exec(
		'SELECT title, file.file_name as file, directory, cert_user_id, size, date_added, image_link, description FROM file LEFT JOIN json USING (json_id) WHERE file LIKE \'%'+query+'%\' OR title LIKE \'%'+query+'%\' OR cert_user_id LIKE \'%'+query+'%\' OR directory LIKE \'%'+query+'%\' ORDER BY date_added desc LIMIT 30');


	//console.log(files[0].values)

	var user = new Array();

	document.getElementById('out').innerHTML += files[0].values.length+" results<br>"

	for(i = 0; i < files[0].values.length; i++)
	{
		if(i > limit)
			break;
		file = files[0].values[i];
		dllink = "http://127.0.0.1:43110/18Pfr2oswXvD352BbJvo59gZ3GbdbipSzh/data/users/"+file[2]+"/"+file[1];
		filesize = (file[4]/1024/1024).toFixed(2);
		filedate = new Date(file[5]*1000);
    image_link = file[6]
    description = file[7]
    if (image_link == "img/video_empty.png")
      image_link = "http://127.0.0.1:43110/18Pfr2oswXvD352BbJvo59gZ3GbdbipSzh/img/video_empty.png"

		document.getElementById('out').innerHTML += i+". <a href='"+dllink+"'>"+file[0]+"</a><br>" + file[1]+ "<br>" + file[3]+" | "+file[2]+"<br>File Size: "+filesize+"mb, Date Uploaded: "+filedate.toLocaleString()+"<br><img width=200px src=\""+image_link+"\"</image><br>"+description+"<br><br>";
	}

	if(files[0].values.length >= limit)
		document.getElementById('out').innerHTML += ">"+limit+" results not displayed."
}
function search()
{
	fetchfromdb($("#sr").val())
}
document.getElementById('sr').onkeydown = function(e){
   if(e.keyCode == 13){
     search();
   }
};
</script>

</body>
</html>