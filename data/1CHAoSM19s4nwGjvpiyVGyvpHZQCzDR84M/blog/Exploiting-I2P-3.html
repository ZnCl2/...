<!DOCTYPE HTML>
<html>
<head>
  <meta charset='utf-8'>
  <meta name='viewport' content='width=device-width, initial-scale=1.0'>
  <title>Kevin Froman's blog - Exploiting I2P 3</title>
  <meta name='description' content='Kevin Froman's blog on security, programming, and other musings'>
  <meta name='author' content='Kevin Froman'>
  <link rel='icon' type='image/x-icon' href='/favicon.ico'>
  <link rel='stylesheet' href='theme.css'>
  <script src="https://widget.battleforthenet.com/widget.js" integrity="sha384-OzmvdVOIBjM9YAUmPdrxpGclC0fg2bTYlwv12prMWoF1y4osMdsZ1UvH1ufTqAQ3" crossorigin="anonymous"></script>
</head>
<body>
  <div id="wrapper">
    <h1 id='siteTitle'><a href='index.html'>Kevin Froman's blog</a></h1>
    
<div id='myIntro' class='center'>Blog on security, programming, & other musings</div>
    <div id='mainContent'><h2 id='postTitle'>Exploiting I2P 3</h2>
        <div id='postDate' class='center'>2017-01-20</div><p><em>This is part 3 in my series of exploits in I2P/related software, I recommend reading the <a href="/blog/stealing-your-I2P-email.html">1st</a> and <a href="/blog/exploiting-I2P-Bote.html">2nd</a> posts first</em>.</p>
<p>As I continued testing I2P software, I have discovered the most severe vulnerability yet, once again within I2P-Bote, a distributed email system for I2P.</p>
<p>Unable to find any more CSRF vulnerabilities, I decided to look for another common vulnerability, XSS (Cross-Site scripting), in which I found 2 critical issues.</p>
<p><img alt="i2p mascot" src="./images/i2p.png" /></p>
<h2>All user input is evil</h2>
<p>When developing any software, a developer should assume that the user is going to input the most, nonsensical, perhaps even evil input possible, and account for it. This is information security 101.</p>
<p>As I have mentioned before, I2P and much of its related software is potentially vulnerable to traditional browser exploits, such as XSS. In a browser context, a developer must be careful when any data supplied by a 3rd party is rendered to the page. A commonly overlooked vector is file names. Despite size &amp; character restrictions, a file name can easily contain malicious code.</p>
<h2>The XSS</h2>
<p>When Bote listed file names as email attachments, it did not use any sanitation, allowing for arbitrary HTML code to be injected into the user’s client when they open an email. While this in itself is dangerous, I was not happy with the restricted size of the payload.</p>
<p>(Bote also failed to sanitize its title tag &amp; another title area.)</p>
<h2>Increasing payload size with eval</h2>
<p>One thing that Bote did properly sanitize was the main message area; however, it occurred to me that I could still place code inside in the message and force it to execute using the eval() function in JavaScript, which executes a string as code.</p>
<p>I wrote a 1 liner to identify &amp; execute the message contents, with the malicious filename being as follows:</p>
<p><code>&lt;img style='display: none;' src=x onerror=eval(document.getElementsByClassName('show-email-value')[6].innerHTML)&gt;.bin</code></p>
<h2>Payload Concept</h2>
<p>The Bote back-end applied some formatting, so I used JSF*ck to encode a simple payload, with the deobfuscated version being:</p>
<pre>
var xhttp = new XMLHttpRequest();
xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
        alert(this.responseText);
    }
}
xhttp.open("GET", "http://127.0.0.1:7657/home", true);
xhttp.send();
</pre>

<p>This small payload demonstrates how XSS within I2P’s plugins can be used to exfiltrate a nonce from the I2P router page, allowing for an attacker to–among other things– install custom plugins into the user’s I2P client. Under most circumstances the plugin would have access to the user’s machine at the permission level I2P is running, and could in turn download additional malware.</p>
<h2>CSS Payload</h2>
<p>Although serious exploitation requires users to have JavaScript enabled, a full page link could have still been lain over the page using CSS, redirecting the user when they click anywhere to a malicious page.</p>
<h2>Fixing Bote</h2>
<p>I reported the vulnerability to str4d, who fixed the issues in a timely manner. We came to the conclusion that the best way to remedy the situation was to both sanitize all user input and also to implement a Content Security Policy header for stronger defense in depth.</p>
<p>I2P Bote version 0.4.5 addresses these issues.</p>
<h2>Conclusion</h2>
<ul>
<li>
<p>CSRF protection is pointless if there is an XSS vector on the origin</p>
</li>
<li>
<p>I2P plugins should run on a different port from the router, since otherwise same-origin restrictions do not apply.</p>
</li>
<li>
<p>All users should update to the current version, or at minimum disable JavaScript (it isn’t smart to have JavaScript enabled anyway).</p>
</li>
</ul>
<p>I would like to thank str4d again for his work on I2P &amp; I2P-Bote.</p><div class="center" style="margin-bottom: -25%; margin-top: 2em; border-radius: 5px; padding: 5px;"><span>Written by anonymous</span><br><br></div>
    </div>
  </div>
  <div id="footer">
    <footer>Powered by TinyGen<div id='socialLinks'><a class="socialLink" href="https://twitter.com/@beardog108"><img src="../images/twitter.png" alt="TWITTER"></a><a class="socialLink" href="https://github.com/beardog108"><img src="../images/github.png" alt="GITHUB"></a><a class="socialLink" href="beardog@firemail.cc"><img src="../images/email.png" alt="EMAIL"></a><a class="socialLink" href="https://keybase.io/beardog"><img src="../images/keybase.png" alt="KEYBASE"></a><a class="socialLink" href="feed.rss"><img src="../images/feed.png" alt="RSS feed"></a></div></footer>
  </div>
</body>
</html>
