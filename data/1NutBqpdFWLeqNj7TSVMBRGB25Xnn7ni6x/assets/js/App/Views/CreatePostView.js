/**
 * ojraskatzeronet v0.1.0
 * @author Otto J. Rask
 */
var app=app||{};app.CreatePostView=Backbone.View.extend({appinst:void 0,parentEl:void 0,templateSrc:void 0,template:void 0,initialize:function(t){"use strict";this.appinst=t.appinst,_.bindAll(this,"render","previewContent","onSubmit","createPost"),this.parentEl=document.getElementById("main"),this.templateSrc=this.appinst.site.cmd("fileGet","/src/js/App/templates/CreatePost.html",this.render)},render:function(t){"use strict";this.template=_.template(t);var e=document.createElement("div");e.innerHTML=this.template(),this.el=OZN.elFromString(this.template()),this.$el=$(this.el),this.$el.on("click",".submit",this.onSubmit),this.$el.on("keyup","textarea",this.previewContent),this.parentEl.appendChild(this.el)},previewContent:function(t){"use strict";var e=this.$el.find('textarea[id*="content"]'),i=this.$el.find("#post-preview");if(void 0==this.$el||!e.length||!i.length)return!1;var n=_.debounce(function(){i[0].innerHTML=markdown.toHTML(e[0].value)},750);n()},onSubmit:function(t){"use strict";t.preventDefault();var e=this.$el.find("#new-post-title"),i=this.$el.find("#new-post-content"),n=this.$el.find("#new-post-excerpt"),s=this.$el.find('[name="nickname"]'),a=function(){return this.appinst.site.cmd("wrapperNotification",["error","Invalid form values.",4e3]),!1}.bind(this);if(!e.val().length||!i.val().length||s.val().length)return a();var r=e.val(),o=i.val(),p=OZN.stripHTML(n.val()),l=OZN.sanitizeTitle(r),c={title:r,slug:l,content:void 0,excerpt:p,markdown:o,html:markdown.toHTML(o)};return this.initCreatePost(c),!1},initCreatePost:function(t){"use strict";var e=new Date,i=OZN.generatePostDateString(e);t.created_at=i;var n=this.appinst.posts.getHighestId();t.id=n+1,this.createPost(t)},createPost:function(t){"use strict";var e=this,i=t.slug+".md";e.appinst.site.cmd("fileGet","/content/posts.json",function(n){var s=JSON.parse(n);s.length&&_.each(s,function(t){i==t.content&&(i=i.replace(/\.md$/,"")+"-2.md")}),t.content=i,t.status="published";var a=new app.Post(t);e.appinst.site.cmd("fileWrite",["content/"+i,btoa(t.markdown)],function(t){"ok"==t?e.appinst.posts.add(a):e.appinst.site.cmd("wrapperNotification",["error","Could not write file: "+t])})})}});