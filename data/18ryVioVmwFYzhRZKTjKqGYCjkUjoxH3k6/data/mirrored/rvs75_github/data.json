{"cert_user_id": "rvs75@github", "next_topic_id": 2, "topic": [{"topic_id": 1604067781, "title": "Ui.UiServer Error 403: Invalid origin", "body": "### Step 1: Please describe your environment\r\n\r\n  * ZeroNet version: 0.6.5 r3870 (Ubuntu 18.04.4 LTS (GNU/Linux 4.15.0-46-generic x86_64)\r\n  * Operating system: WIndows 10\r\n  * Web browser: Firefox 72.0.2\r\n  * Tor status: always\r\n  * Opened port: yes\r\n  * Special configuration: Running ZeroNet on a Webserver\r\n\r\n### Step 2: Describe the problem:\r\n\r\nSince yesterday our open Zeronet Server did not work. At the Log file we find these error messages:\r\n\r\n```\r\n- Starting ZeroNet...\r\n[10:52:09] - Libsecpk256k1 loaded: CompiledLib in 0.036s\r\n[10:52:09] - Version: 0.7.1 r4206, Python 3.7.3 (default, Mar 27 2019, 22:11:17)\r\n[GCC 7.3.0], Gevent: 1.4.0\r\n[10:52:09] - Creating FileServer....\r\n[10:52:09] - Creating UiServer....\r\n[10:52:09] - Removing old SSL certs...\r\n[10:52:09] - Starting servers....\r\n[10:52:09] Ui.UiServer --------------------------------------\r\n[10:52:09] Ui.UiServer Web interface: http://*:43110/\r\n[10:52:09] Ui.UiServer --------------------------------------\r\n[10:52:10] PeerPortchecker Checking port 18567 (ipv4) using checkPortchecker result: {'ip': 'xxx.xxx.xxx.xxx', 'opened': True} in 0.790s\r\n[10:52:10] ConnServer Server port opened ipv4: True, ipv6: None\r\n[10:52:26] Ui.UiServer Added 127.0.0.1:43110 as allowed host\r\n\r\n[10:52:47] Ui.UiServer Error 403: Invalid origin: https://www.example.com\r\n[10:52:57] Ui.UiServer Error 403: Invalid origin: https://www.example.com\r\n[10:53:08] Ui.UiServer Error 403: Invalid origin: https://www.example.com\r\n[10:53:19] Ui.UiServer Error 403: Invalid origin: https://www.example.com\r\n[10:53:29] Ui.UiServer Error 403: Invalid origin: https://www.example.com\r\n\r\n```\r\n\r\nZeroNet is running behind a transparent proxy (apache2).\r\n\r\nAapche Config looks like that:\r\n\r\n```\r\n<IfModule mod_ssl.c>\r\n<VirtualHost *:443>\r\n\tServerName www.example.com\r\n\tServerAdmin webmaster@localhost\r\n\tDocumentRoot /var/www/html\r\n\r\n\tHeader add \"Access-Control-Allow-Origin\" \"*\"\r\n\r\n\tRewriteEngine on\r\n        RewriteCond %{HTTP:UPGRADE} ^WebSocket$ [NC]\r\n        RewriteCond %{HTTP:CONNECTION} Upgrade$ [NC]\r\n        RewriteRule .* ws://127.0.0.1:43110%{REQUEST_URI} [P]\r\n\t\r\n\r\n    \tProxyTimeout 3600\r\n    \tProxyPass /zerotalk http://127.0.0.1:43110/Talk.ZeroNetwork.bit\r\n    \tProxyPassReverse /zerotalk  http://127.0.0.1:43110/Talk.ZeroNetwork.bit\r\n\r\n    \tProxyPass /Websocket http://127.0.0.1:43110/\r\n    \tProxyPassReverse /Websocket http://127.0.0.1:43110/\r\n\r\n...\r\n</VirtualHost>\r\n</IfModule>\r\n```\r\n\r\n\r\n\r\n#### Steps to reproduce:\r\n\r\n  1. open a zn page\r\n \r\n\r\n#### Observed Results:\r\n\r\n  * What happened? This could be a screenshot, a description, log output (you can send log/debug.log file to hello@zeronet.io if necessary), etc.\r\n\r\n![grafik](https://user-images.githubusercontent.com/1433227/74144265-b6dd0000-4bfc-11ea-89e2-9c52cba222e1.png)\r\n\r\n\r\n\r\n#### Expected Results:\r\n\r\n  * What did you expect to happen?\r\n\r\nOpen a ZeroNet Page.\r\n", "parent_topic_uri": "1604062980_users_1Cy3ntkN2GN9MH6EaW6eHpi4YoRS2nK5Di", "added": 1581321886, "modified": 1581508406, "source_link": "https://github.com/HelloZeroNet/ZeroNet/issues/2420", "source_type": "github"}], "next_comment_id": 10, "comment": {"1604067781_mirrored_rvs75_github": [{"comment_id": 1, "body": "> \r\n> \r\n> > `Header add \"Access-Control-Allow-Origin\" \"*\"`\r\n> \r\n> This is unrelated to your problem but please don't do this. Disabling CORS allows all zites to steal proxy user's info, e.g. their private keys.\r\n\r\nOK, done.", "added": 1581332967, "modified": 1581332967, "source_link": "https://github.com/HelloZeroNet/ZeroNet/issues/2420#issuecomment-584139684", "source_type": "github"}, {"comment_id": 2, "body": "> \r\n> \r\n> This is likely non helpful, but try to check [this comment](https://github.com/HelloZeroNet/ZeroNet/issues/624#issuecomment-257161984). It shows an example of the Zeronet Apache virtualhost file.\r\n\r\nDid not help.", "added": 1581332984, "modified": 1581332984, "source_link": "https://github.com/HelloZeroNet/ZeroNet/issues/2420#issuecomment-584139805", "source_type": "github"}, {"comment_id": 3, "body": "The problem is here (UiRequest.py:711):\r\n\r\n```\r\n  if origin_host != host and origin_host not in self.server.allowed_ws_origins:\r\n    ws.send(json.dumps({\"error\": \"Invalid origin: %s\" % origin}))\r\n    return self.error403(\"Invalid origin: %s\" % origin)\r\n```\r\n\r\nI commented out these lines and it is running again.\r\nOf course it would be better to know how I can add my domain to the allowed_ws_origins.", "added": 1581335248, "modified": 1581335303, "source_link": "https://github.com/HelloZeroNet/ZeroNet/issues/2420#issuecomment-584157547", "source_type": "github"}, {"comment_id": 4, "body": "Yes I have. The same error message appears.", "added": 1581337059, "modified": 1581337059, "source_link": "https://github.com/HelloZeroNet/ZeroNet/issues/2420#issuecomment-584172489", "source_type": "github"}, {"comment_id": 5, "body": "I have my config here: /opt/ZeroBundle/ZeroNet/zeronet.conf\r\nHow can I check the config? \r\nIf I run \r\n\r\n> ./ZeroNet.sh getConfig \r\n\r\nmy var ui_host did not appears.", "added": 1581338266, "modified": 1581338280, "source_link": "https://github.com/HelloZeroNet/ZeroNet/issues/2420#issuecomment-584182594", "source_type": "github"}, {"comment_id": 6, "body": "Host: www.example.com\r\nOrigin: https://www.example.com", "added": 1581424836, "modified": 1581424836, "source_link": "https://github.com/HelloZeroNet/ZeroNet/issues/2420#issuecomment-584697540", "source_type": "github"}, {"comment_id": 7, "body": "So, yes I do", "added": 1581424854, "modified": 1581424854, "source_link": "https://github.com/HelloZeroNet/ZeroNet/issues/2420#issuecomment-584697699", "source_type": "github"}, {"comment_id": 8, "body": "I logged the python vars and now I know what's wrong:\r\n\r\n-\u00a0 origin_host: www.example.com\r\n-\u00a0 host: 127.0.0.1:43110\r\n\r\n> Try adding: Header set Host \"www.example.com\"\r\n\r\nDid not work.", "added": 1581486325, "modified": 1581487663, "source_link": "https://github.com/HelloZeroNet/ZeroNet/issues/2420#issuecomment-585095398", "source_type": "github"}, {"comment_id": 9, "body": "It works. This was the solution:\r\n\r\nProxyPreserveHost on\r\nProxyErrorOverride Off\r\n\r\nThanks\r\n", "added": 1581508396, "modified": 1581508396, "source_link": "https://github.com/HelloZeroNet/ZeroNet/issues/2420#issuecomment-585243017", "source_type": "github"}]}}