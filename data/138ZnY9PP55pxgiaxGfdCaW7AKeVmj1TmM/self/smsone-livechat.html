<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SmsOne LiveChat</title>
<link rel="stylesheet" href="https://stackedit.io/res-min/themes/base.css" />
<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body><div class="container"><p><div class="toc">
<ul>
<li><a href="#smsone-livechat">SmsOne LiveChat</a><ul>
<li><a href="#主要文件">主要文件</a><ul>
<li><a href="#scripts">Scripts</a></li>
<li><a href="#views">Views</a></li>
</ul>
</li>
<li><a href="#关联页面">关联页面</a><ul>
<li><a href="#资源引入">资源引入</a></li>
<li><a href="#livechat-menu-logo">LiveChat menu logo</a></li>
<li><a href="#communication-livechat-logo">Communication LiveChat logo</a></li>
<li><a href="#livechat-history">LiveChat History</a></li>
<li><a href="#communicationts">Communication.ts</a></li>
</ul>
</li>
<li><a href="#变量解释">变量解释</a></li>
<li><a href="#主要流程">主要流程</a><ul>
<li><a href="#inituserchannels">initUserChannels</a></li>
<li><a href="#new-user">new User</a></li>
<li><a href="#发起聊天">发起聊天</a></li>
<li><a href="#收到邀请">收到邀请</a></li>
<li><a href="#发送消息">发送消息</a></li>
<li><a href="#接收消息">接收消息</a></li>
</ul>
</li>
<li><a href="#一些问题">一些问题</a><ul>
<li><a href="#已读消息的问题">已读消息的问题</a><ul>
<li><a href="#一个特殊情况">一个特殊情况</a></li>
<li><a href="#lastmsgrawindex-更新速度">lastMsgRawIndex 更新速度</a></li>
</ul>
</li>
<li><a href="#请求图片地址的请求优化">请求图片地址的请求优化</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</p>



<h1 id="smsone-livechat">SmsOne LiveChat</h1>



<h2 id="主要文件">主要文件</h2>



<h3 id="scripts">Scripts</h3>

<p><code>Moon\Moon.Web.Client\Scripts\app\shared\chat\</code></p>

<ul>
<li><code>chat.ts</code> 主文件</li>
<li><code>chat_dto.ts</code> 定义了接口和枚举</li>
<li><code>chat_user.ts</code> User(左侧联系人)</li>
<li><code>chat_wo.ts</code> 右侧Wo信息</li>
<li><code>utils.ts</code> 自定义绑定和一些常用的方法</li>
<li><code>chat_history.ts</code> LiveChat History</li>
<li><code>twilio.d.ts</code> Twilio</li>
</ul>



<h3 id="views">Views</h3>

<p><code>Moon.Web.Client\Views\Shared\Chat\</code></p>

<ul>
<li><code>_Chat.cshtml</code> LiveChat 聊天窗口</li>
<li><code>_ChatHistoryPartial.cshtml</code> LiveChat History 分布页</li>
</ul>



<h2 id="关联页面">关联页面</h2>



<h3 id="资源引入">资源引入</h3>

<p><code>Moon\Moon.Web.Client\App_Start\BundleConfig.cs</code></p>



<pre class="prettyprint"><code class="language-javascript hljs "><span class="hljs-comment">//LiveChat 依赖</span>
<span class="hljs-comment">//54-58 行</span>
<span class="hljs-string">"~/Scripts/lib/twilio/twilio-common.min.js"</span>,
<span class="hljs-string">"~/Scripts/lib/twilio/twilio-chat.min.js"</span>,
<span class="hljs-string">"~/Scripts/lib/jQuery-emoji/jquery.mousewheel-3.0.6.min.js"</span>,
<span class="hljs-string">"~/Scripts/lib/jQuery-emoji/jquery.mCustomScrollbar.min.js"</span>,
<span class="hljs-string">"~/Scripts/lib/jQuery-emoji/jquery.emoji.js"</span>,

<span class="hljs-comment">//LiveChat js</span>
<span class="hljs-comment">//80-85 行</span>
<span class="hljs-string">"~/Scripts/app/shared/chat/utils.js"</span>,
<span class="hljs-string">"~/Scripts/app/shared/chat/chat_wo.js"</span>,
<span class="hljs-string">"~/Scripts/app/shared/chat/chat_user.js"</span>,
<span class="hljs-string">"~/Scripts/app/shared/chat/chat_dto.js"</span>,
<span class="hljs-string">"~/Scripts/app/shared/chat/chat.js"</span>

<span class="hljs-comment">//LiveChat History js</span>
<span class="hljs-comment">//174 行</span>
<span class="hljs-string">"~/Scripts/app/shared/chat/chat_history.js"</span></code></pre>

<p><code>C:\SMSONE\Moon\Moon.Web.Client\Views\Shared\_Layout.cshtml</code></p>

<p>html 引用</p>



<pre class="prettyprint"><code class="language-html hljs ">@Html.Partial("Chat/_Chat")</code></pre>



<h3 id="livechat-menu-logo">LiveChat menu logo</h3>

<p><code>Moon\Moon.Web.Client\Views\Shared\_UserPartial.cshtml</code></p>



<pre class="prettyprint"><code class="language-html hljs "><span class="hljs-tag">&lt;<span class="hljs-title">li</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"hidden-xs animated bounce"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">a</span> <span class="hljs-attribute">href</span>=<span class="hljs-value">"javascript:void(0);"</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"aiDraggable shake shake-chunk shake-constant"</span> <span class="hljs-attribute">data-bind</span>=<span class="hljs-value">"click: Moon.Chat.openChatDlg"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">i</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"fa fa-comments-o f18"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">i</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- ko if: liveChat.isLoading()--&gt;</span> Loading ...<span class="hljs-comment">&lt;!-- /ko --&gt;</span>
        <span class="hljs-comment">&lt;!-- ko if: liveChat.unReadMsgCount() != 0 &amp;&amp; !isNaN(liveChat.unReadMsgCount()) --&gt;</span>
        (<span class="hljs-comment">&lt;!-- ko text: liveChat.unReadMsgCount() --&gt;</span><span class="hljs-comment">&lt;!-- /ko --&gt;</span>)
        <span class="hljs-comment">&lt;!-- /ko --&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-title">a</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">li</span>&gt;</span></code></pre>



<h3 id="communication-livechat-logo">Communication LiveChat logo</h3>

<p><code>Moon\Moon.Web.Client\Views\Shared\Communication\_NewPartial.cshtml</code></p>

<p>联系人右侧 logo</p>



<pre class="prettyprint"><code class="language-html hljs "><span class="hljs-comment">&lt;!-- ko if: Moon.Utils.getUrlSegment(0) == 'simReactiveWo' || Moon.Utils.getUrlSegment(0) == 'simRecurringWo' || Moon.Utils.getUrlSegment(0) == 'reactiveWo'|| Moon.Utils.getUrlSegment(0) == 'recurringWo' --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">label</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"checkbox-inline"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">a</span>  <span class="hljs-attribute">class</span>=<span class="hljs-value">"text-primary"</span> <span class="hljs-attribute">data-bind</span>=<span class="hljs-value">"click: Moon.Chat.communicationOpen.bind($data), attr:{class: isOnline()? 'text-primary': ''}"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">i</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"fa fa-commenting-o f20"</span> <span class="hljs-attribute">aria-hidden</span>=<span class="hljs-value">"true"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">i</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-title">a</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">label</span>&gt;</span>
<span class="hljs-comment">&lt;!-- /ko--&gt;</span></code></pre>

<p>搜索联系人时 logo</p>



<pre class="prettyprint"><code class="language-html hljs "><span class="hljs-comment">&lt;!-- ko if: Moon.Utils.getUrlSegment(0) == 'simReactiveWo' || Moon.Utils.getUrlSegment(0) == 'simRecurringWo' || Moon.Utils.getUrlSegment(0) == 'reactiveWo'|| Moon.Utils.getUrlSegment(0) == 'recurringWo' --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">label</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"checkbox-inline"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">a</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"text-primary"</span> <span class="hljs-attribute">data-bind</span>=<span class="hljs-value">"click: Moon.Chat.communicationOpen.bind($data), attr:{class: isOnline()? 'text-primary': ''}"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">i</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"fa fa-commenting-o f20"</span> <span class="hljs-attribute">aria-hidden</span>=<span class="hljs-value">"true"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">i</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-title">a</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">label</span>&gt;</span>
<span class="hljs-comment">&lt;!-- /ko--&gt;</span></code></pre>



<h3 id="livechat-history">LiveChat History</h3>

<p><code>Moon\Moon.Web.Client\Views\Shared\Communication\_ListPartial.cshtml</code></p>



<pre class="prettyprint"><code class="language-html hljs "><span class="hljs-tag">&lt;<span class="hljs-title">a</span> <span class="hljs-attribute">href</span>=<span class="hljs-value">"javascript:void(0)"</span> <span class="hljs-attribute">data-toggle</span>=<span class="hljs-value">"modal"</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"text-link f14 ml10"</span> <span class="hljs-attribute">data-target</span>=<span class="hljs-value">"#livechartHistory"</span> <span class="hljs-attribute">data-bind</span>=<span class="hljs-value">"click: $parent.renderChatHistory.bind($parent), attr: { 'data-target': $parent.util.getElementId('#livechartHistory'), 'id': $parent.util.getElementId('showLiveChatHistoryBtn')}"</span>&gt;</span>
    Live Chat History
<span class="hljs-tag">&lt;/<span class="hljs-title">a</span>&gt;</span></code></pre>

<p><code>Moon\Moon.Web.Client\Views\Shared\Communication\_CommunicationOverviewPartial.cshtml</code>  LiveChatHistory 分布页引用</p>



<h3 id="communicationts">Communication.ts</h3>

<p><code>Moon\Moon.Web.client\Scripts\app\shared\communication\communication.ts</code></p>

<p><code>chatHistoryContext</code> 在 <code>communication</code> 中被实例化.</p>



<pre class="prettyprint"><code class="language-javascript hljs ">public chatHistoryContext: Moon.Chat.ChatHistory;

self.chatHistoryContext = <span class="hljs-keyword">new</span> Moon.Chat.ChatHistory()

public renderChatHistory() {
    <span class="hljs-keyword">let</span> options = {
        refType: <span class="hljs-keyword">this</span>.options.refType,
        refId: <span class="hljs-keyword">this</span>.options.refId
    };
    <span class="hljs-keyword">this</span>.chatHistoryContext.render(options);
}
</code></pre>



<h2 id="变量解释">变量解释</h2>

<p><code>chat.ts</code></p>

<ul>
<li><code>channel</code> 频道，是聊天双方的一个通道，保存在 Twilio 服务器上，可以进行创建、删除、获取、更新等操作。<a href="https://media.twiliocdn.com/sdk/js/chat/releases/0.12.0/docs/Channel.html">关于channel</a></li>
<li><code>channel</code> 有 <code>attributes</code> 自定义属性，可以在里面添加任意的内容，在 LiveChat 中实现了 <code>IChannelAttribute</code>接口。</li>
<li><code>currentChatUser</code> 保存 LiveChat 左侧面板中当前选中的联系人。</li>
<li><code>token</code> 当前登录用户的信息</li>
<li><code>client</code> Twilio 中 Cient 的实例 <a href="https://media.twiliocdn.com/sdk/js/chat/releases/0.12.0/docs/Client.html">关于Client</a></li>
<li><code>users</code> 保存所有的联系人，每个联系人都是一个 <code>chatUser</code> 类。</li>
<li><code>channelInvited</code> 一个保存了所有发送过邀请的<code>channel.uniqueName</code> 的数组，防止收到邀请事件时重复添加联系人。</li>
<li><code>botVisible</code> 聊天界面的状态 <code>true</code>打开，<code>false</code>关闭</li>
<li><code>isClickMoreMsg</code> Click More　按钮的显示状态</li>
<li><code>unReadMsgCount</code> 未读消息总数</li>
<li><code>chatMessage</code> 当前 user 的 message</li>
<li><code>displayMessage</code> 显示的 message</li>
</ul>

<p><code>chat_user.ts</code></p>

<ul>
<li><code>channel</code> 当前 user 所在频道</li>
<li><code>isTyping</code> 输入状态</li>
<li><code>isOnline</code> 在线状态</li>
<li><code>group</code> 当前 user 所在分组</li>
<li><code>sessionId</code> LiveChat History 中的会话Id</li>
<li><code>isGetSession</code> session 获取状态</li>
<li><code>isDelete</code> user channel 状态</li>
<li><code>isMeDelete</code> 是否当前用户删除</li>
<li><code>lastMsgTime</code> 最后一条 Message 的时间</li>
<li><code>lastMsgIndex</code> 最后一条 Message 的索引</li>
<li><code>lastMsgRawIndex</code> 最后一条已读 Message 的索引</li>
<li><code>unReadMsg</code> 此user 未读消息数量</li>
<li><code>hasPrevPage</code> Message 是否有下一页</li>
</ul>



<h2 id="主要流程">主要流程</h2>

<p><code>Chat.ts</code></p>



<div class="flow-chart"><svg height="417" version="1.1" width="212.59375" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="overflow: hidden; position: relative; top: -0.578125px;"><desc style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">Created with Raphaël 2.1.2</desc><defs style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path><marker id="raphael-marker-endblock33-obj10" markerHeight="3" markerWidth="3" orient="auto" refX="1.5" refY="1.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#raphael-marker-block" transform="rotate(180 1.5 1.5) scale(0.6,0.6)" stroke-width="1.6667" fill="black" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></use></marker><marker id="raphael-marker-endblock33-obj11" markerHeight="3" markerWidth="3" orient="auto" refX="1.5" refY="1.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#raphael-marker-block" transform="rotate(180 1.5 1.5) scale(0.6,0.6)" stroke-width="1.6667" fill="black" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></use></marker><marker id="raphael-marker-endblock33-obj12" markerHeight="3" markerWidth="3" orient="auto" refX="1.5" refY="1.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#raphael-marker-block" transform="rotate(180 1.5 1.5) scale(0.6,0.6)" stroke-width="1.6667" fill="black" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></use></marker><marker id="raphael-marker-endblock33-obj13" markerHeight="3" markerWidth="3" orient="auto" refX="1.5" refY="1.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#raphael-marker-block" transform="rotate(180 1.5 1.5) scale(0.6,0.6)" stroke-width="1.6667" fill="black" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></use></marker></defs><rect x="0" y="0" width="99.453125" height="39" rx="20" ry="20" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" stroke-width="2" class="flowchart" id="st" transform="matrix(1,0,0,1,57.5703,4)"></rect><text x="10" y="19.5" text-anchor="start" font-family="sans-serif" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" id="stt" class="flowchartt" font-weight="normal" transform="matrix(1,0,0,1,57.5703,4)"><tspan style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" dy="5.5">LiveChat init</tspan></text><rect x="0" y="0" width="169.265625" height="39" rx="0" ry="0" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" stroke-width="2" class="flowchart" id="themAndTwilio" transform="matrix(1,0,0,1,22.6641,97)"></rect><text x="10" y="19.5" text-anchor="start" font-family="sans-serif" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" id="themAndTwiliot" class="flowchartt" font-weight="normal" transform="matrix(1,0,0,1,22.6641,97)"><tspan style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" dy="5.5">初始化主题 &amp; initTwilio</tspan></text><rect x="0" y="0" width="180.953125" height="39" rx="0" ry="0" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" stroke-width="2" class="flowchart" id="initSubscribe" transform="matrix(1,0,0,1,16.8203,190)"></rect><text x="10" y="19.5" text-anchor="start" font-family="sans-serif" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" id="initSubscribet" class="flowchartt" font-weight="normal" transform="matrix(1,0,0,1,16.8203,190)"><tspan style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" dy="5.5">initSubscribe 初始化监听</tspan></text><rect x="0" y="0" width="206.59375" height="39" rx="0" ry="0" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" stroke-width="2" class="flowchart" id="initUserChannels" transform="matrix(1,0,0,1,4,283)"></rect><text x="10" y="19.5" text-anchor="start" font-family="sans-serif" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" id="initUserChannelst" class="flowchartt" font-weight="normal" transform="matrix(1,0,0,1,4,283)"><tspan style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" dy="5.5">initUserChannels 初始化频道</tspan><tspan dy="18" x="10" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></tspan></text><rect x="0" y="0" width="44.421875" height="39" rx="20" ry="20" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" stroke-width="2" class="flowchart" id="e" transform="matrix(1,0,0,1,85.0859,376)"></rect><text x="10" y="19.5" text-anchor="start" font-family="sans-serif" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" id="et" class="flowchartt" font-weight="normal" transform="matrix(1,0,0,1,85.0859,376)"><tspan style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" dy="5.5">End</tspan></text><path fill="none" stroke="#000000" d="M107.296875,43C107.296875,43,107.296875,82.65409994125366,107.296875,94.00043908460066" stroke-width="2" marker-end="url(#raphael-marker-endblock33-obj10)" font-family="sans-serif" font-weight="normal" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;"></path><path fill="none" stroke="#000000" d="M107.296875,136C107.296875,136,107.296875,175.65409994125366,107.296875,187.00043908460066" stroke-width="2" marker-end="url(#raphael-marker-endblock33-obj11)" font-family="sans-serif" font-weight="normal" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;"></path><path fill="none" stroke="#000000" d="M107.296875,229C107.296875,229,107.296875,268.65409994125366,107.296875,280.00043908460066" stroke-width="2" marker-end="url(#raphael-marker-endblock33-obj12)" font-family="sans-serif" font-weight="normal" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;"></path><path fill="none" stroke="#000000" d="M107.296875,322C107.296875,322,107.296875,361.65409994125366,107.296875,373.00043908460066" stroke-width="2" marker-end="url(#raphael-marker-endblock33-obj13)" font-family="sans-serif" font-weight="normal" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;"></path></svg></div>



<h3 id="inituserchannels">initUserChannels</h3>



<div class="flow-chart"><svg height="510" version="1.1" width="461.734375" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="overflow: hidden; position: relative; top: -0.359375px;"><desc style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">Created with Raphaël 2.1.2</desc><defs style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><marker id="raphael-marker-endblock33-obj26" markerHeight="3" markerWidth="3" orient="auto" refX="1.5" refY="1.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#raphael-marker-block" transform="rotate(180 1.5 1.5) scale(0.6,0.6)" stroke-width="1.6667" fill="black" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></use></marker><marker id="raphael-marker-endblock33-obj27" markerHeight="3" markerWidth="3" orient="auto" refX="1.5" refY="1.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#raphael-marker-block" transform="rotate(180 1.5 1.5) scale(0.6,0.6)" stroke-width="1.6667" fill="black" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></use></marker><marker id="raphael-marker-endblock33-obj28" markerHeight="3" markerWidth="3" orient="auto" refX="1.5" refY="1.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#raphael-marker-block" transform="rotate(180 1.5 1.5) scale(0.6,0.6)" stroke-width="1.6667" fill="black" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></use></marker><marker id="raphael-marker-endblock33-obj29" markerHeight="3" markerWidth="3" orient="auto" refX="1.5" refY="1.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#raphael-marker-block" transform="rotate(180 1.5 1.5) scale(0.6,0.6)" stroke-width="1.6667" fill="black" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></use></marker><marker id="raphael-marker-endblock33-obj30" markerHeight="3" markerWidth="3" orient="auto" refX="1.5" refY="1.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#raphael-marker-block" transform="rotate(180 1.5 1.5) scale(0.6,0.6)" stroke-width="1.6667" fill="black" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></use></marker></defs><rect x="0" y="0" width="128.265625" height="39" rx="20" ry="20" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" stroke-width="2" class="flowchart" id="st" transform="matrix(1,0,0,1,167.7344,4)"></rect><text x="10" y="19.5" text-anchor="start" font-family="sans-serif" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" id="stt" class="flowchartt" font-weight="normal" transform="matrix(1,0,0,1,167.7344,4)"><tspan style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" dy="5.5">initUserChannels</tspan></text><rect x="0" y="0" width="450" height="39" rx="0" ry="0" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" stroke-width="2" class="flowchart" id="setUserChannelsToCache" transform="matrix(1,0,0,1,6.8672,97)"></rect><text x="10" y="19.5" text-anchor="start" font-family="sans-serif" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" id="setUserChannelsToCachet" class="flowchartt" font-weight="normal" transform="matrix(1,0,0,1,6.8672,97)"><tspan style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" dy="5.5">setUserChannelsToCache 获取所有频道并保存到 cache.allChannels</tspan></text><rect x="0" y="0" width="296.96875" height="39" rx="0" ry="0" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" stroke-width="2" class="flowchart" id="filterChannel" transform="matrix(1,0,0,1,83.3828,190)"></rect><text x="10" y="19.5" text-anchor="start" font-family="sans-serif" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" id="filterChannelt" class="flowchartt" font-weight="normal" transform="matrix(1,0,0,1,83.3828,190)"><tspan style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" dy="5.5">filter channel.attributes.woId 筛选有效频道</tspan></text><rect x="0" y="0" width="455.734375" height="39" rx="0" ry="0" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" stroke-width="2" class="flowchart" id="foreach" transform="matrix(1,0,0,1,4,283)"></rect><text x="10" y="19.5" text-anchor="start" font-family="sans-serif" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" id="foreacht" class="flowchartt" font-weight="normal" transform="matrix(1,0,0,1,4,283)"><tspan style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" dy="5.5">foreach allchannels,并通过channel new ChatUser 然后 Push 到 Users</tspan></text><rect x="0" y="0" width="292.78125" height="39" rx="0" ry="0" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" stroke-width="2" class="flowchart" id="currentChatUser" transform="matrix(1,0,0,1,85.4766,376)"></rect><text x="10" y="19.5" text-anchor="start" font-family="sans-serif" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" id="currentChatUsert" class="flowchartt" font-weight="normal" transform="matrix(1,0,0,1,85.4766,376)"><tspan style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" dy="5.5">将 currentChatUser 设置成 Users 的第一个</tspan><tspan dy="18" x="10" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></tspan></text><rect x="0" y="0" width="44.421875" height="39" rx="20" ry="20" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" stroke-width="2" class="flowchart" id="e" transform="matrix(1,0,0,1,209.6563,469)"></rect><text x="10" y="19.5" text-anchor="start" font-family="sans-serif" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" id="et" class="flowchartt" font-weight="normal" transform="matrix(1,0,0,1,209.6563,469)"><tspan style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" dy="5.5">End</tspan></text><path fill="none" stroke="#000000" d="M231.8671875,43C231.8671875,43,231.8671875,82.65409994125366,231.8671875,94.00043908460066" stroke-width="2" marker-end="url(#raphael-marker-endblock33-obj26)" font-family="sans-serif" font-weight="normal" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;"></path><path fill="none" stroke="#000000" d="M231.8671875,136C231.8671875,136,231.8671875,175.65409994125366,231.8671875,187.00043908460066" stroke-width="2" marker-end="url(#raphael-marker-endblock33-obj27)" font-family="sans-serif" font-weight="normal" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;"></path><path fill="none" stroke="#000000" d="M231.8671875,229C231.8671875,229,231.8671875,268.65409994125366,231.8671875,280.00043908460066" stroke-width="2" marker-end="url(#raphael-marker-endblock33-obj28)" font-family="sans-serif" font-weight="normal" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;"></path><path fill="none" stroke="#000000" d="M231.8671875,322C231.8671875,322,231.8671875,361.65409994125366,231.8671875,373.00043908460066" stroke-width="2" marker-end="url(#raphael-marker-endblock33-obj29)" font-family="sans-serif" font-weight="normal" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;"></path><path fill="none" stroke="#000000" d="M231.8671875,415C231.8671875,415,231.8671875,454.65409994125366,231.8671875,466.00043908460066" stroke-width="2" marker-end="url(#raphael-marker-endblock33-obj30)" font-family="sans-serif" font-weight="normal" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;"></path></svg></div>



<h3 id="new-user">new User</h3>

<p>通过构造函数 <code>new ChatUser(channle)</code> 需要一个 channel 作为参数</p>



<div class="flow-chart"><svg height="510" version="1.1" width="545.875" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="overflow: hidden; position: relative; top: -0.9375px;"><desc style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">Created with Raphaël 2.1.2</desc><defs style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><marker id="raphael-marker-endblock33-obj43" markerHeight="3" markerWidth="3" orient="auto" refX="1.5" refY="1.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#raphael-marker-block" transform="rotate(180 1.5 1.5) scale(0.6,0.6)" stroke-width="1.6667" fill="black" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></use></marker><marker id="raphael-marker-endblock33-obj44" markerHeight="3" markerWidth="3" orient="auto" refX="1.5" refY="1.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#raphael-marker-block" transform="rotate(180 1.5 1.5) scale(0.6,0.6)" stroke-width="1.6667" fill="black" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></use></marker><marker id="raphael-marker-endblock33-obj45" markerHeight="3" markerWidth="3" orient="auto" refX="1.5" refY="1.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#raphael-marker-block" transform="rotate(180 1.5 1.5) scale(0.6,0.6)" stroke-width="1.6667" fill="black" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></use></marker><marker id="raphael-marker-endblock33-obj46" markerHeight="3" markerWidth="3" orient="auto" refX="1.5" refY="1.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#raphael-marker-block" transform="rotate(180 1.5 1.5) scale(0.6,0.6)" stroke-width="1.6667" fill="black" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></use></marker><marker id="raphael-marker-endblock33-obj47" markerHeight="3" markerWidth="3" orient="auto" refX="1.5" refY="1.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#raphael-marker-block" transform="rotate(180 1.5 1.5) scale(0.6,0.6)" stroke-width="1.6667" fill="black" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></use></marker></defs><rect x="0" y="0" width="128.265625" height="39" rx="20" ry="20" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" stroke-width="2" class="flowchart" id="st" transform="matrix(1,0,0,1,209.8047,4)"></rect><text x="10" y="19.5" text-anchor="start" font-family="sans-serif" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" id="stt" class="flowchartt" font-weight="normal" transform="matrix(1,0,0,1,209.8047,4)"><tspan style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" dy="5.5">initUserChannels</tspan></text><rect x="0" y="0" width="349.25" height="39" rx="0" ry="0" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" stroke-width="2" class="flowchart" id="saveChannel" transform="matrix(1,0,0,1,99.3125,97)"></rect><text x="10" y="19.5" text-anchor="start" font-family="sans-serif" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" id="saveChannelt" class="flowchartt" font-weight="normal" transform="matrix(1,0,0,1,99.3125,97)"><tspan style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" dy="5.5">将接收到的 channel 保存到将要实例化的 ChatUser</tspan></text><rect x="0" y="0" width="523.09375" height="39" rx="0" ry="0" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" stroke-width="2" class="flowchart" id="initchannel" transform="matrix(1,0,0,1,12.3906,190)"></rect><text x="10" y="19.5" text-anchor="start" font-family="sans-serif" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" id="initchannelt" class="flowchartt" font-weight="normal" transform="matrix(1,0,0,1,12.3906,190)"><tspan style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" dy="5.5">initchannel 初始化频道,进行 join initMessage initGroup 和添加事件监听等操作</tspan></text><rect x="0" y="0" width="539.875" height="39" rx="0" ry="0" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" stroke-width="2" class="flowchart" id="initUserInfo" transform="matrix(1,0,0,1,4,283)"></rect><text x="10" y="19.5" text-anchor="start" font-family="sans-serif" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" id="initUserInfot" class="flowchartt" font-weight="normal" transform="matrix(1,0,0,1,4,283)"><tspan style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" dy="5.5">initUserInfo 初始化User, 将频道的自定义属性attributes里的字段赋值到 ChatUser</tspan></text><rect x="0" y="0" width="320.203125" height="39" rx="0" ry="0" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" stroke-width="2" class="flowchart" id="newWoInfo" transform="matrix(1,0,0,1,113.8359,376)"></rect><text x="10" y="19.5" text-anchor="start" font-family="sans-serif" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" id="newWoInfot" class="flowchartt" font-weight="normal" transform="matrix(1,0,0,1,113.8359,376)"><tspan style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" dy="5.5">new WoInfo ,在 ChatUser 内实例化 woInfo 对象</tspan><tspan dy="18" x="10" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></tspan></text><rect x="0" y="0" width="44.421875" height="39" rx="20" ry="20" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" stroke-width="2" class="flowchart" id="e" transform="matrix(1,0,0,1,251.7266,469)"></rect><text x="10" y="19.5" text-anchor="start" font-family="sans-serif" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" id="et" class="flowchartt" font-weight="normal" transform="matrix(1,0,0,1,251.7266,469)"><tspan style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" dy="5.5">End</tspan></text><path fill="none" stroke="#000000" d="M273.9375,43C273.9375,43,273.9375,82.65409994125366,273.9375,94.00043908460066" stroke-width="2" marker-end="url(#raphael-marker-endblock33-obj43)" font-family="sans-serif" font-weight="normal" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;"></path><path fill="none" stroke="#000000" d="M273.9375,136C273.9375,136,273.9375,175.65409994125366,273.9375,187.00043908460066" stroke-width="2" marker-end="url(#raphael-marker-endblock33-obj44)" font-family="sans-serif" font-weight="normal" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;"></path><path fill="none" stroke="#000000" d="M273.9375,229C273.9375,229,273.9375,268.65409994125366,273.9375,280.00043908460066" stroke-width="2" marker-end="url(#raphael-marker-endblock33-obj45)" font-family="sans-serif" font-weight="normal" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;"></path><path fill="none" stroke="#000000" d="M273.9375,322C273.9375,322,273.9375,361.65409994125366,273.9375,373.00043908460066" stroke-width="2" marker-end="url(#raphael-marker-endblock33-obj46)" font-family="sans-serif" font-weight="normal" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;"></path><path fill="none" stroke="#000000" d="M273.9375,415C273.9375,415,273.9375,454.65409994125366,273.9375,466.00043908460066" stroke-width="2" marker-end="url(#raphael-marker-endblock33-obj47)" font-family="sans-serif" font-weight="normal" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;"></path></svg></div>



<h3 id="发起聊天">发起聊天</h3>

<p><img style="margin-left:55px;" src="http://ofl97l8av.bkt.clouddn.com/17-7-7/1.png" alt="此处输入图片的描述" title=""> <br>
<img src="http://ofl97l8av.bkt.clouddn.com/17-7-7/2.png" alt="此处输入图片的描述" title=""></p>



<h3 id="收到邀请">收到邀请</h3>

<p>当<code>channel</code>内有用户向当前用户发送邀请会触发 <code>client.on("channelInvited", (channel) =&gt; { ... }</code> 事件 <br>
<img src="http://ofl97l8av.bkt.clouddn.com/17-7-7/4.png" alt="此处输入图片的描述" title=""></p>



<h3 id="发送消息">发送消息</h3>

<p>聊天界面输入框绑定了<code>pressEnter</code>自定义绑定，在<code>utils.ts</code>文件中。</p>

<p><img src="http://ofl97l8av.bkt.clouddn.com/17-7-7/21.png" style="margin-left:-8px;" alt="此处输入图片的描述" title=""> <br>
<img src="http://ofl97l8av.bkt.clouddn.com/17-7-7/22.png" alt="此处输入图片的描述" title=""></p>



<h3 id="接收消息">接收消息</h3>

<p>当<code>channel</code>内有新的消息时，会触发 <code>channel.on("messageAdded", msg =&gt; { ... }</code> 事件.</p>

<p><code>messageAdded</code>事件的监听在 <code>ChatUser</code>类中.</p>

<p><img src="http://ofl97l8av.bkt.clouddn.com/17-7-7/31.png" style="margin-left:1px;" alt="此处输入图片的描述" title=""> <br>
<img src="http://ofl97l8av.bkt.clouddn.com/17-7-7/32.png" alt="此处输入图片的描述" title=""></p>



<h2 id="一些问题">一些问题</h2>



<h3 id="已读消息的问题">已读消息的问题</h3>

<p>通过 <code>channel.lastConsumedMessageIndex</code> 可获取到最后一条 <strong>已读 Message</strong> 的 Index. <br>
通过 <code>message.index</code> 能获取当前 Message 的 Index.</p>

<p>未读消息通过计算最后一条<strong>已读消息</strong>的索引 <code>lastMsgRawIndex</code> 和<strong>最后一条消息</strong>的索引 <code>lastMsgIndex</code> 的差值。</p>



<h4 id="一个特殊情况">一个特殊情况</h4>

<p>当 create 一个 channel 没有任何 Message 时，<code>lastMsgRawIndex == null</code> ，由于没有 Message 获取不到 <code>lastMsgIndex</code> ,所以设置 <code>lastMsgIndex(-1)</code> and <code>lastMsgRawIndex(-1)</code> 得到 <code>unReadMsg = 0</code></p>



<h4 id="lastmsgrawindex-更新速度">lastMsgRawIndex 更新速度</h4>

<p><code>lastMsgRawIndex</code> 需要通过 <code>channel.updateLastConsumedMessageIndex(Number)</code> 方法主动更新，更新速度极慢！</p>

<p><strong>如图</strong>需要将近 5s 时间 <br>
<img src="http://ofl97l8av.bkt.clouddn.com/17-7-6/64403537.jpg" alt="updateLastConsumedMessageIndex" title=""></p>

<p>目前系统 LiveChat 仅在 <code>new ChatUser initMessage()</code>时获取一次 <code>lastMsgRawIndex</code> ，并保存在 <strong>Local Storage</strong>，向 Twilio 更新时同步更新到 Local Storage，再次获取时首先从 Local Storage 拿，拿不到再通过 <code>channel.updateLastConsumedMessageIndex(Number)</code> 方法获取。</p>

<p><code>utils.ts</code> 中有 <code>setRawMsgIndex()</code> 方法更新 <code>lastMsgRawIndex</code></p>



<h3 id="请求图片地址的请求优化">请求图片地址的请求优化</h3>

<p>由于当前消息显示的机制，导致每次有新消息时都会刷新所有消息列表，如果聊天过程中发送图片，会引起每次刷新消息列表时会重新请求图片地址。 <br>
<img src="http://ofl97l8av.bkt.clouddn.com/17-7-6/73939931.jpg" alt="" title=""></p></div></body>
</html>