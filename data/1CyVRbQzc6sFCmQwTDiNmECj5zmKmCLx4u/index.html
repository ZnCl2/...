<!DOCTYPE html>

<html>
<head>
 <title>ZeroTalk</title>
 <meta charset="utf-8">
 <meta http-equiv="content-type" content="text/html; charset=utf-8" />
 <link rel="stylesheet" href="css/all.css" />
 <base href="" target="_top" id="base">
 <script>
 setTimeout(function() {
 	base.href = document.location.href.replace("/media", "").replace("index.html", "").replace(/([&?])wrapper=False/, "$1").replace(/&$/, "") // Fix urls
 }, 100) // 100ms later, to workaround double js download in chrome
 </script>
 <!-- PX-VIDEO CSS -->
<link rel="stylesheet" href="css/px-video.css" />

<style>
/*** for "disabling" anchor buttons ***/
a.disabled { display: none;/*** color:gray; cursor: not-allowed;***/}

/*** for video demo only ***/
#wrapper {
  width: 640px;
  margin: 1em auto;
  font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
}
#brand a,
p a {
  border: 1px #fff dotted;
}
#brand a:focus,
p a:focus {
  border: 1px #999 dotted;
  outline: none;
}
p {
  padding-top: 1em;
}
</style>
</head>
<body>

<!-- editbar -->
<div class="editbg"></div>
<div class="editbar bottombar">
 <ul class="markdown-help">
  <li># H1</li>
  <li>## H2</li>
  <li>### H3</li>
  <li><i>_italic_</i></li>
  <li><b>**bold**</b></li>
  <li>~~<s>strikethrough</s>~~</li>
  <li>- Lists</li>
  <li>1. Numbered lists</li>
  <li>[Links](http://www.zeronet.io)</li>
  <li>[References][1]<br>[1]: Can be used</li>
  <li>![image alt](img/logo.png)</li>
  <li>Inline <code>`code`</code></li>
  <li><code>```python<br>print "Code block"<br>```</code></li>
  <li>&gt; Quotes</li>
  <li>--- Horizontal rule</li>
 </ul>
 <a href="#Markdown+help" class="icon-help">?</a> Editing: <span class="object">Post:21.body</span> <a href="#Save" class="button save">Save</a> <a href="#Delete" class="button button-delete button-outline delete">Delete</a> <a href="#Cancel" class="cancel">Cancel</a>
</div>
<!-- EOF editbar -->


<!-- Head -->
<div class="head">
 <a class='logo nolink' href="?Home">Zer0<br>Vid</a>
</div>
<!-- EOF Head -->


<!-- Page: Main -->
<div class="center topics-list">
 <h1 class="topics-title">Newest videos</h1>

 <!-- New Topic -->
 <a href="#New+topic" class="topic-new-link nolink"> + Add video</a>
 <a href="#Clone+site" class="clone-site-link nolink"> + Clone this page</a>
 <div class="topic topic-new" style="display: none">
  <a href="#" class="image nolink"><div class="icon icon-topic-chat"></div></a>
  <h4>Please note only the owner of this page can add videos.  If you would like to add your own videos please click "clone this page" above.  <smalll>If this doesn't work you need to either add the "ADMIN" permission to this site in data/sites.json or clone this page from the ZeroHello homepage<br />You will also proably need to set the --size_limit option to something quite large or publishing videos will fail.</smalll></h4>
  <h2 class="title"><input type="text" id="topic_title" class="text" placeholder="Video title"></h2>
  <div class="body"><textarea id="topic_body" placeholder="Video description"></textarea></div>
    <h2 class="title"><input type="file" id="topic_video_file" class="text"><input type="hidden" id="filename"></h2><br /><button id="convert" style="display:none;">..loading..</button><br /><div id="vidproccessing" style="display:none;"><input type="checkbox" id="showhideoutput" />
    Show/hide ffmpeg output<pre id="output" style="display:none;">Loading JavaScript files (it may take a minute)</pre><img id="image-loader" src="img/loading.gif" /></div><br /><div id="fileinfo"></div>
  <div class="info" id="addvideoinfo" style="display:none;"><a class="user_name user_name-my certselect" href="#Change+user" title='Change user'>user_name</a> &#9473; <span class="added">new video</span></div>
  <a href="#Add+new+topic" class="button button-submit disabled" id="addvideolink">Add new video</a>
  


  <div style="clear: both"></div>
 </div>
 <!-- EOF New Topic -->

 <div class="topics-loading"><img src="img/load.gif" id="image-loader" />Loading...</div>
 <div class="topics">

  <!-- Template: Topic -->
  <div class="topic template">
   <div class="dot">&bullet;</div>
   <a href="#" class="image nolink"><div class="icon icon-topic-chat thumb"></div></a>
   <h2 class="title"><a href="#" class="title-link">Title</a></h2>
   <div class="video_file"></div>
   <div class="body">Body</div>
   <a href="#" class="link"><div class="icon icon-link"></div> <span class="link-url"></span></a>
   <div class="info">
    <a class="score" href="#Upvote">
     <span class="score-inactive"> <span class="icon-up">^</span><span class="score-num">1</span> </span>
     <span class="score-active"> <span class="icon-up">^</span><span class="score-num">2</span> </span>
    </a>
    <a href="#" class="comment-num"></a> 
    <span class="added">added</span>
     &#9473; submitted by <span class="user_name">user_name</span>
   </div>
  </div>
  <!-- EOF Template: Topic main -->

 </div>

</div>
<!-- EOF Page: Main -->


<!-- Page: Topic -->
<div class="center topics-full">

 <h1 class="topic-title"><span class='parent-link'><a href='?Main'>Main</a> &rsaquo;</span> <span class='parent-link'><a href='?Main'>ZeroNet news</a> &rsaquo; </span> <span class="parent-link">How did you find ZeroNet?</span></h1>

 <div class="topic topic-full">
  <a href="#" class="image nolink"><div class="icon icon-topic-chat"></div></a>
  <h2 class="title"><a href="#" class="title-link">Title</a></h2>
  <div class="px-video-container" id="myvid">
  <div class="px-video-img-captions-container">
    <div class="px-video-captions hide"></div>
    <video width="640" height="360" poster="img/poster_PayPal_Austin2.jpg" id="video_elem" controls>

    </video>
  </div><!-- end container for captions and video -->
  <div class="px-video-controls"></div>
</div><!-- end video container -->
  <div class="body">Body</div>
  <div class="info">
    <a class="score" href="#Upvote">
     <span class="score-inactive"> <span class="icon-up">^</span><span class="score-num">?</span> </span>
     <span class="score-active"> <span class="icon-up">^</span><span class="score-num">0</span> </span>
    </a>
   <span class="user_name">username</span> posted <span class="added">added</span>
  </div>
 </div>

 <!-- New comment -->
 <div class="comment comment-new">
  <div class="info"><a class="user_name user_name-my certselect" href="#Change+user" title='Change user'>user_name</a> &#9473; <span class="added">new comment</span></div>
  <div class="body">
   <a class="button button-submit button-certselect certselect" href="#Change+user"><div class='icon-profile'></div>Sign in as...</a>
   <textarea id="comment_body"></textarea>
   <a href="#Submit+comment" class="button button-submit button-submit-form">Submit comment</a>
   <div style='float: right; margin-top: -6px'>
    <div class="user-size user-size-used">Used space: 22k/100k</div>
    <div class="user-size">Used space: 22k/100k</div>
   </div>
   <div style="clear: both"></div>
  </div>
 </div>
<!-- Comments -->
 <div class="comments center">

  <!-- Template: Comment -->
  <div class="comment template">
   <div class="info">
    <span class="user_name">user_name</span>
    &#9473; 
    <span class="added">added</span>
    <a class="score" href="#Upvote">
     <span class="score-inactive"> <span class="icon-up">^</span><span class="score-num">1</span> </span>
     <span class="score-active"> <span class="icon-up">^</span><span class="score-num">2</span> </span>
    </a>
    <a href="#Reply" class="reply"><div class="icon icon-reply"></div> <span class="reply-text">Reply</span></a>
   </div>
   <div class="body">Body</div>
  </div>
  <!-- EOF Template: Comment -->
 </div>

</div>
<div class="center">created by tshabs.  apologies for the very hacky code, ill fix it when i build a time machine</div>
<!-- EOF Page: Topic -->


 

  <script type='text/javascript'>

var worker;
var sampleImageData;
var sampleVideoData;
var outputElement;
var filesElement;
var filenameHiddenElement;
var running = false;
var isWorkerLoaded = false;
var isSupported = (function() {
  return document.querySelector && window.URL && window.Worker;
})();

function isReady() {
  return !running && isWorkerLoaded && sampleImageData && sampleVideoData;
}

function startRunning() {
  document.querySelector("#image-loader").style.visibility = "visible";
  outputElement.className = "";
  //filesElement.innerHTML = "";
  running = true;
}
function stopRunning() {
  document.querySelector("#image-loader").style.visibility = "hidden";
  running = false;
}

function retrieveSampleImage() {
  var oReq = new XMLHttpRequest();
  oReq.open("GET", "bigbuckbunny.jpg", true);
  oReq.responseType = "arraybuffer";

  oReq.onload = function (oEvent) {
    var arrayBuffer = oReq.response;
    if (arrayBuffer) {
      sampleImageData = new Uint8Array(arrayBuffer);
    }
  };

  oReq.send(null);
}

function loadffmpeg() {
  var oReq = new XMLHttpRequest();
  oReq.open("GET", "ffmpegnn.txt", true);
  oReq.responseType = "blob";

  oReq.onload = function (oEvent) {
    var arrayBuffer = oReq.response;
    if (arrayBuffer) {
      ffmpegready(new Blob([arrayBuffer]));//new Uint8Array(arrayBuffer));
    }
  };

  oReq.send(null);
}

function retrieveSampleVideo(videofiledata) {
  // var oReq = new XMLHttpRequest();
  // oReq.open("GET", "input.webm", true);
  // oReq.responseType = "arraybuffer";

  // oReq.onload = function (oEvent) {
  //   var arrayBuffer = oReq.response;
  //   if (arrayBuffer) {
  //     sampleVideoData = new Uint8Array(arrayBuffer);
  //   }
  // };

  // oReq.send(null);
  sampleVideoData = videofiledata;
}

function parseArguments(text) {
  text = text.replace(/\s+/g, ' ');
  var args = [];
  // Allow double quotes to not split args.
  text.split('"').forEach(function(t, i) {
    t = t.trim();
    if ((i % 2) === 1) {
      args.push(t);
    } else {
      args = args.concat(t.split(" "));
    }
  });
  return args;
}


function runCommand(text) {
  console.log("RUN COMMAND");
  var args = parseArguments(text);
    console.log("ARG");
    console.log(args);
console.log(text);
  if (isReady()) {
    console.log("READY START RUNNING");
    startRunning();
    var args = parseArguments(text);
    console.log("ARG");
    console.log(args);
    worker.postMessage({
      type: "command",
      arguments: args,
      files: [
        {
          "name": "input.jpeg",
          "data": sampleImageData
        },
        {
          "name": "input.mp4",
          "data": sampleVideoData
        }
      ]
    });
  }

}
function endsWith(str, suffix) {
    return str.indexOf(suffix, str.length - suffix.length) !== -1;
}

function getDownloadLink(fileData, fileName) {
  if (fileName.match(/\.jpeg|\.gif|\.jpg|\.png/)) {
    var outputfilename = filenameHiddenElement.value;
    var outputfilenewname = outputfilename.substr(0, outputfilename.lastIndexOf('.')) || outputfilename;
    if (endsWith(fileName, 'thumb.jpeg')){
      //thumbnail generated so set button for poster generate

      convertElement.setAttribute("data-command", '-i input.mp4 -ss 00:10 -vframes 1 -r 1 -s 640x360 -f image2 -vf fps=fps=1,showinfo -an '+outputfilenewname+'_poster.jpeg');
      convertElement.textContent = "Generate Video Poster";
    }else{

    //poster generated so set button for video conversion
    //convertElement.setAttribute("data-command", '-i input.mp4  -b:v 1000k -vcodec libx264 -strict -2 "'+filenameHiddenElement.value+'"');
    convertElement.setAttribute("data-command", '-i input.mp4  -b:v 1000k -vcodec libx264 -acodec aac -strict -2 '+outputfilenewname+'.mp4');
    
    convertElement.textContent = "Convert Video";
    //runCommand("-i input.mp4  -b:v 1000k -vcodec libx264 -strict -2 output.mp4");");
    }
    var blob = new Blob([fileData]);
    var src = window.URL.createObjectURL(blob);
    var img = document.createElement('img');

    img.src = src;
    return img;
  }
  else {
    //enable the form submit link
    //outputElement.addClass('disabled');

    outputElement.style.display = 'none';
    
    $('#showhideoutput').addClass('disabled');
    document.getElementById('showhideoutput').style.display = 'none';

    convertElement.textContent = "Conversion Completed :)"
    $('#addvideolink').removeClass('disabled');
    document.getElementById('addvideolink').style.display = 'block';
    $('#addvideoinfo').removeClass('disabled');
    document.getElementById('addvideoinfo').style.display = 'block';
    //sign and publish (so the added files are visible)
    Page.cmd("sitePublish", "stored");
  
    // Page.cmd("sitePublish", [privatekey], function (res) { output.value = "fileWrite "+file.name+" result:"+res+"\n" });

    // @cmd "sitePublish", [privatekey], (res) =>
    //     $(".publishbar .button").removeClass("loading")
    //     @log "Publish result:", res

    return true;
  }
}

function initWorker() {
     loadffmpeg();

   }
    
  function _arrayBufferToBase64( buffer ) {
    var binary = '';
    var bytes = new Uint8Array( buffer );
    var len = bytes.byteLength;
    for (var i = 0; i < len; i++) {
        binary += String.fromCharCode( bytes[ i ] );
    }
    return window.btoa( binary );
}

   function ffmpegready(ffmpegblob){
console.log("ffmpeg ready with blob");
var ffmpegblobURL = window.URL.createObjectURL(ffmpegblob);
     var blob = new Blob(['importScripts("'+ffmpegblobURL+'"); var now = Date.now; function print(text) { postMessage({ "type" : "stdout", "data" : text }); } onmessage = function(event) {    var message = event.data;    if (message.type === "command") {      var Module = {       print: print,       printErr: print,       files: message.files || [],       arguments: message.arguments || [],       TOTAL_MEMORY: 268435456     };      postMessage({       "type" : "start",       "data" : Module.arguments.join(" ")     });      postMessage({       "type" : "stdout",       "data" : "Received command: " +                 Module.arguments.join(" ") +                 ((Module.TOTAL_MEMORY) ? ".  Processing with " + Module.TOTAL_MEMORY + " bits." : "")     });      var time = now();     var result = ffmpeg_run(Module);      var totalTime = now() - time;     postMessage({       "type" : "stdout",       "data" : "Finished processing (took " + totalTime + "ms)"     });      postMessage({       "type" : "done",       "data" : result,       "time" : totalTime     });   } };  postMessage({   "type" : "ready" });']);


var blobURL = window.URL.createObjectURL(blob);
  convertElement.textContent = 'ffmpeg loaded ... starting worker';
  filesElement.setAttribute('disabled', 'disabled');

  worker = new Worker(blobURL);
  worker.onmessage = function (event) {
    var message = event.data;
    if (message.type == "ready") {
      isWorkerLoaded = true;
      //worker is ready
      outputElement.textContent = '';

      convertElement.textContent = 'Create Thumbnail';

    
    

  // Obtain a blob URL reference to our worker 'file'.

        //runCommand("-i input.webm  -b 1500k -vcodec libx264 -vpre slow -vpre baseline   -strict -2 output.mp4");
    document.querySelector("#convert").addEventListener("click", function() {
    this.textContent = '..please wait..';
    
    runCommand(this.getAttribute("data-command"));

    //s.textContent = 'Converting video (this might take some time)';
    // runCommand("-i input.mp4  -b:v 1000k -vcodec libx264 -strict -2 "+theFile.name);
  });

      // worker.postMessage({
      //   type: "command",
      //   arguments: ["-help"]
      // });
    } else if (message.type == "stdout") {
      outputElement.textContent += message.data + "\n";
    } else if (message.type == "start") {
      outputElement.textContent = "Worker has received command\n";
    } else if (message.type == "done") {
      stopRunning();
      var buffers = message.data;
      if (buffers.length) {
        outputElement.className = "closed";
      }
      buffers.forEach(function(file) {
        getDownloadLink(file.data, file.name);
        console.log("write to file");
        console.log(file.name);
        Page.cmd("fileWrite", ["videos/"+file.name, _arrayBufferToBase64(file.data)], function (res) { output.value = "fileWrite "+file.name+" result:"+res+"\n" });
      });
    }
  };
}


 document.addEventListener("DOMContentLoaded", function() {
filesElement = document.querySelector("#topic_video_file");
outputElement = document.querySelector("#output");
convertElement = document.querySelector("#convert");
filenameHiddenElement = document.querySelector("#filename"); 
vidproccessingElement = document.querySelector("#vidproccessing"); 


document.getElementById('showhideoutput').onchange = function() {
    document.getElementById('output').style.display = this.checked ? 'block' : 'none';
};


console.log("docuement is ready");
  function _base64ToArrayBuffer(base64) {
      var binary_string =  window.atob(base64.split(',')[1]);
      var len = binary_string.length;
      var bytes = new Uint8Array( len );
      for (var i = 0; i < len; i++)        {
          bytes[i] = binary_string.charCodeAt(i);
      }
      return bytes;
  }


  function handleFileSelect(evt) {
    var files = evt.target.files; // FileList object
    console.log(files);

document.getElementById('convert').style.display = 'block';
    // Loop through the FileList and render image files as thumbnails.
    for (var i = 0, f; f = files[i]; i++) {

      // Only process image files.
      // if (!f.type.match('image.*')) {
      //   continue;
      // }

      var reader = new FileReader();

      // Closure to capture the file information.
      reader.onload = (function(theFile) {
        return function(e) {
          // Render thumbnail.

          //  console.log(e.target);
          //  console.log(theFile);
          // var span = document.createElement('span');
          // span.innerHTML = ['File Name: ', theFile.name, ' loaded'].join('');
          // document.getElementById('fileinfo').insertBefore(span, null);
          filenameHiddenElement.value = theFile.name.replace(/ /g,"_");


          vidproccessingElement.style.display = 'block';

          initWorker();

          //sampleVideoData = _base64ToArrayBuffer(e.target.result);
          retrieveSampleImage();
          retrieveSampleVideo(_base64ToArrayBuffer(e.target.result));

  console.log(_base64ToArrayBuffer(e.target.result));

          //var u = document.createElement('p');
          var outputfilename = filenameHiddenElement.value;
          var outputfilenewname = outputfilename.substr(0, outputfilename.lastIndexOf('.')) || outputfilename;
          convertElement.setAttribute("data-command", "-i input.mp4 -ss 00:10 -vframes 1 -r 1 -s 48x48 -f image2 -vf fps=fps=1,showinfo -an "+outputfilenewname+"_thumb.jpeg");
          
          //ilesElement.appendChild(u);

        };
      })(f);

      // Read in the image file as a data URL.
      reader.readAsDataURL(f);
    }
  }

  document.getElementById('topic_video_file').addEventListener('change', handleFileSelect, false);

 });
// document.addEventListener("DOMContentLoaded", function() {

 
//   initWorker();
//   retrieveSampleVideo();
//   retrieveSampleImage();

//   var inputElement = document.querySelector("#input");
//   outputElement = document.querySelector("#output");
//   filesElement = document.querySelector("#files");


//   document.querySelector("#run").addEventListener("click", function() {
//     runCommand(inputElement.value);
//   });


// });
  </script>

<script type="text/javascript" src="js/all.js" async></script>

</body>
</html>