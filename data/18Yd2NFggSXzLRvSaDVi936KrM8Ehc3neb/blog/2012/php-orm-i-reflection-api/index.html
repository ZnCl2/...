<!DOCTYPE HTML>
<html lang="ru">
    <head>
      <meta http-equiv="Content-type" content="text/html; charset=utf-8"/>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <title>18Yd2NFggSXzLRvSaDVi936KrM8Ehc3neb</title>
      <link rel="stylesheet" href="/18Yd2NFggSXzLRvSaDVi936KrM8Ehc3neb/css/main.css"/>
      <link rel="shortcut icon" type="image/x-icon" href="/18Yd2NFggSXzLRvSaDVi936KrM8Ehc3neb/i/favicon.ico"/>
      <link href="/18Yd2NFggSXzLRvSaDVi936KrM8Ehc3neb/rss.xml" title="Akademic's blog" type="application/rss+xml" rel="alternate"/>
    </head>
    <body>
        <header><h1><a href="/18Yd2NFggSXzLRvSaDVi936KrM8Ehc3neb" rel="home">akademic.name</a></h1></header>
        <main class="content">
            
<article>
    <h1>PHP ORM и Reflection API</h1> <time>04.04.2012</time>
	<p>Последнее время по-тихоньку развиваю новую объектную модель для нашего фреймворка на работе.
Старые объекты довольно громоздки, получение/запись свойств ведётся через методы get/set.
Как-то так:</p>

<pre><code>$obj = new ObjectFabric( $object_name );
$obj-&gt;set( 'title', 'Название' );
$obj-&gt;get( 'title' );
</code></pre>

<p>Свойства объекта наполняются через БД.
Так было довольно ничего, пока на фреймворке делались только сайты.
Сайты обычно довольно маленькие. Даже информационные порталы маленькие. Собираются из стандартных модулей.
Да и удобно имея доступ только в админку поправить что надо быстренько.</p>

<p>А последнее время стало утомлять так писать, особенно, когда у объекта много свойств.
К тому же в PHP5 перестала работать фабрика-конструктор. И код стал ещё чуть менее наглядным.</p>

<p>Мне всегда нравились модели в django. Жаль что в PHP так писать нельзя. Но что-то подобное изобразить хотелось.</p>

<h2>Что хотелось:</h2>

<ol>
<li>$obj = new object_name();</li>
<li>$obj-&gt;title = &lsquo;Название&rsquo;;</li>
<li>Чтобы модель задавалась целиком в php-файле</li>
<li>Чтобы не надо было сложно конфигурировать модель - минимум кода</li>
<li>Чтобы это всё хозяйство было совместимо с текущей структурой БД</li>
<li>Я не боюсь SQL поэтому никаких извращений, его скрывающих</li>
</ol>

<h2>Как получилось</h2>

<pre><code>class model_news extends Model {
    protected $_table = 'news';
    protected $_columns = array(
        'title' =&gt; '',
        'desc' =&gt; '',
        'date' =&gt; ''
    );
}
</code></pre>

<ol>
<li>Модель задаётся классом наследником от класса Model</li>
<li>Для модели указываются поля в таблице БД.</li>
<li>Значения в массиве _columns можно использовать как дефолтные</li>
<li>Определены магические методы __get и __set</li>
<li>В конструктор можно передавать ID записи в БД, массив, объект и кусок sql, чтобы подгрузить одну запись по условию</li>
<li>Методы load, save и delete</li>
</ol>

<p>Такие модели я использовал для построения очень простого API с поддержкой версий.
Очень понравилось:</p>

<pre><code>$news = new model_news();
$news-&gt;title = 'Новость 1';
$news-&gt;desc = 'Подробное описание';
$news-&gt;date = date( 'Y-m-d' );
$news-&gt;save();
</code></pre>

<pre><code>//или
$news = new model_news( 5 );
</code></pre>

<pre><code>//или
$news = new model_news( '`date` = &quot;2012-04-04&quot;' );
</code></pre>

<p>Красота. Но&hellip;</p>

<h2>Не всё так радостно в проектах побольше</h2>

<p>Если есть пользовательский ввод, то хорошо бы его валидировать.
Прикольно было бы построить форму автоматически.
В старом фреймворке это есть как бы громоздко оно ни было, но я уже привык и это проще, чем сделать руками.</p>

<p>И вот сейчас я прямо скажем в тупике.
Для реализации валидации и генерации форм надо вводить больше информации о свойствах объекта, но при этом не хочется писать адские конфиги.
Да и в базе хранить это всё как раньше не дело.</p>

<p>Ну допустим, я даже соглашусь на адские конфиги модели, когда мне действительно это нужно, но для простых моделей я хочу оставить как есть.</p>

<p>Потому как уже есть куча production кода с текущей реализацией моделей и его ломать я не хочу.</p>

<p>Резюмируя вышеизложенное:
1. Надо оставить всё как было
1. Но иметь возможность легко подключать фичи, когда они нужны.</p>

<h2>Использование Reflection API</h2>

<p>В Reflection API есть такая штука:</p>

<p><code>ReflectionProperty::getDocComment</code></p>

<p>Позволяет получить phpDoc у свойства класса.
А в phpDoc можно вписать нужную информацию, когда понадобится.</p>

<p>Я выбрал такой формат:</p>

<pre><code>/**
* @var type - для обозначения типа (типы имеются свои внутри фреймворка, отличаются от типо языков программирования
* @req &lt;req_param&gt; - для обозначения обязательных параметров
* @regexp - для добавления произвольного RegExp для валидации
*/
</code></pre>

<p>Это позволит сделать дефолтную валидацию по типам данных или регулярным выражениям.
А также вполне можно по такому описанию строить формы.</p>

<p>Единственное что меня беспокоит, так это то, что комментарии к коду становятся частью логики работы. Это очень плохо.</p>

<p>В реализации, правда, Reflection по сути только заполняет массивы по этим комментариям. Можно их заполнить и ручками. Но это уже не так приятно.</p>

<p>В-общем пока ещё думаю, надо на чём-нибудь маленьком обкатать текущую реализацию.</p>

    
    <span class="next_blog_post">
    <a href="/18Yd2NFggSXzLRvSaDVi936KrM8Ehc3neb/blog/2012/invision-power-board/index.html" rel="next">Invision Power Board</a>
    </span>
	
	
    <span class="prev_blog_post">
    <a href="/18Yd2NFggSXzLRvSaDVi936KrM8Ehc3neb/blog/2012/php54-i-htmlspecialchars/index.html" rel="previous">PHP5.4 и htmlspecialchars</a>
    </span>
	
</article>

        </main>
        <footer>
        Будьте внимательны, многое из того, что написано в этом блоге, является личным мнением автора и не претендует на истину.
        <img src="/18Yd2NFggSXzLRvSaDVi936KrM8Ehc3neb/i/yopiright.jpg" width="12" height="12"/> 2008
        </footer>
    </body>
</html>
