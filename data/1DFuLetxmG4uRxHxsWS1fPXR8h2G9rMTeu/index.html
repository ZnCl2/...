
<!DOCTYPE html>

<html>
<head>
 <title>New ZeroNet site!</title>
 <meta charset="utf-8">
 <meta http-equiv="content-type" content="text/html; charset=utf-8" />
 <base href="" target="_top" id="base">
 <script>base.href = document.location.href.replace("/media", "").replace("index.html", "").replace(/[&?]wrapper=False/, "").replace(/[&?]wrapper_nonce=[A-Za-z0-9]+/, "")</script>
</head>
<body>
    <style>
        * { font-family: monospace; line-height: 1.5em; font-size: 13px; vertical-align: middle; }
        body { background-color: white; }
        input#message { padding: 5px; width: 50%;  }
        input#send { height: 34px; margin-left: -2px; }
        ul { padding: 0px; }
        li { list-style-type: none; border-top: 1px solid #eee; padding: 5px 0px; }
        li:nth-child(odd) { background-color: #F9FAFD; }
        li b { color: #3F51B5; }
    </style>

<!-- <div id="out"></div>

<script type="text/javascript" src="js/ZeroFrame.js"></script>
<script>

class Page extends ZeroFrame {
	setSiteInfo(site_info) {
		var out = document.getElementById("out")
		out.innerHTML =
			"Page address: " + site_info.address +
			"<br>- Peers: " + site_info.peers +
			"<br>- Size: " + site_info.settings.size +
			"<br>- Modified: " + (new Date(site_info.content.modified*1000))
	}

	onOpenWebsocket() {
		this.cmd("siteInfo", [], function(site_info) {
			page.setSiteInfo(site_info)
		})
	}

	onRequest(cmd, message) {
		if (cmd == "setSiteInfo")
			this.setSiteInfo(message.params)
		else
			this.log("Unknown incoming message:", cmd)
	}
}
page = new Page()
</script> -->
<a href="#Select+user" id="select_user" onclick="return page.selectUser()">Select user</a>
<input type="text" id="message" onkeypress="if (event.KeyCode == 13) page.sendMessage()"/>
<input type="button" id="send" value="发送" onclick="return page.sendMessage()"/>

<ul id="messages">
  <li>欢迎来到ZeroChat！</li>
</ul>
<script type="text/javascript" src="js/ZeroFrame.js"></script>
<script>
  class ZeroChat extends ZeroFrame{
    addMessage(username, message){
      var message_escaped = message.replace(/</g, "&lt;").replace(/>/g,"&gt;")
      this.messages.innerHTML += "<li><b>" + username + "</b>: " + message_escaped + "</li>"
    }

    onOpenWebsocket(){
      this.messages = document.getElementById("messages")
      this.addMessage("System", "Ready to call ZeroFrame API!")
      this.cmd("siteInfo", {}, (site_info) => {
        if(site_info.cert_user_id){
          document.getElementById("select_user").innerText = site_info.cert_user_id

        }
        this.site_info = site_info
      })
      this.loadMessage()
    }

    selectUser(){
      this.cmd("certSelect", {accepted_domains: ["zeroid.bit"]})
      return false
    }

    onRequest(cmd, message){
      if(cmd == "setSiteInfo"){
        if (message.params.cert_user_id){
          document.getElementById("select_user").innerHTML = message.params.cert_user_id
        }else{
          document.getElementById("select_user").innerHTML = "Select user"
        }
        this.site_info = message.params

        if(message.params.event[0] == "file_done"){
          this.loadMessage()
        }
      }
    }

    sendMessage(){
      if (!this.site_info.cert_user_id){
        this.cmd("wrapperNotification", ["info", "Please, select your account"])
        return false
      }

      var data_inner_path = "data/users/" + this.site_info.auth_address + "/data.json" 
      var content_inner_path = "data/users/" + this.site_info.auth_address + "/content.json"

      this.cmd("fileGet", {"inner_path": data_inner_path, "required":false}, (data)=>{
        if(data){
          data = JSON.parse(data)
        }else{
          data = {"message":[]}
        }

        data.message.push({
          "body":document.getElementById("message").value,
          "data_added": Date.now()
        })

        var json_raw = unescape(encodeURIComponent(JSON.stringify(data, undefined, '\t')))

        this.cmd("fileWrite", [data_inner_path, btoa(json_raw)], (res)=>{
          if(res == "ok"){
            document.getElementById("message").value = ""
            this.cmd("siteSign", {"inner_path": content_inner_path}, (res)=>{
              this.cmd("sitePublish", {"inner_path":content_inner_path, "sign":false})
            })
          }else{
            this.cmd("wrapperNotification", ["error", "File write error: #{res}"])
          }
        })

        this.cmd("siteSign", {"inner_path":content_inner_path}, (res)=>{
          this.loadMessage()
        })
      })

      return false
    }

    loadMessage(){
      this.cmd("dbQuery", ["SELECT * FROM message LEFT JOIN json USING (json_id) ORDER BY date_added DESC"], (message)=>{
        document.getElementById("messages").innerHTML = ""
        for(var i=0; i < message.length; i++){
          this.addMessage(message[i].cert_user_id, message[i].body)
        }
      })
    }
  }

  page= new ZeroChat()
</script>
</body>
</html>