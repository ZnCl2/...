<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Python Persistence mmap.page</title>
    <link rel="stylesheet" href="/16XMwj6YRNqRHWbmSD8oxYUZCKfM1uzwP9/assets/css/style.css">
    <link rel="alternate" type="application/rss+xml" href="/16XMwj6YRNqRHWbmSD8oxYUZCKfM1uzwP9/rss.xml">
    <link rel="alternate" type="application/git+http" href="https://github.com/weakish/weakish.github.com.git"/>
</head>
<body>
  <div class="container-lg px-3 my-5 markdown-body">

    <h1><a href="/16XMwj6YRNqRHWbmSD8oxYUZCKfM1uzwP9/">mmap.page</a></h1>
    <h1 id="python-persistence">
        
        
          Python Persistence
        
        
      </h1>
    
      <h2 id="tltr">
        
        
          tl;tr <a href="#tltr" class="anchor-hash" title="link to this heading">#</a>
        
        
      </h2>
<p>If we care about compatibility with different Python versions,
use <code>cPickle</code> with binary protocol and <code>fast</code> option.</p>
<p>Otherwise just use marshal.</p>
    
      <h2 id="performance">
        
        
          Performance <a href="#performance" class="anchor-hash" title="link to this heading">#</a>
        
        
      </h2>
<p>A benchmark of marshal, pickle, json, capnp for python 2.7 on my machine.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">timeit</span>

<span class="n">md</span> <span class="o">=</span> <span class="s">"marshal.dumps({'people': [{'name': 'Alice'}]})"</span>
<span class="n">im</span> <span class="o">=</span> <span class="s">'import marshal'</span>

<span class="n">p</span> <span class="n">d</span><span class="o">=</span> <span class="s">"pickle.dumps({'people': [{'name': 'Alice'}]})"</span>

<span class="n">ip</span> <span class="o">=</span> <span class="s">'import cPickle as pickle'</span>

<span class="n">jd</span> <span class="o">=</span> <span class="s">"json.dumps({'people': [{'name': 'Alice'}]})"</span>
<span class="n">ij</span> <span class="o">=</span> <span class="s">'import json'</span>

<span class="n">cd</span> <span class="o">=</span> <span class="s">"bm_capnp.AddressBook.new_message(people=[{'name': 'Alice'}])"</span>
<span class="n">ic</span> <span class="o">=</span> <span class="s">'import capnp; import bm_capnp'</span>

<span class="k">def</span> <span class="nf">benchmark</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">timeit</span><span class="o">.</span><span class="n">timeit</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>

<span class="c1"># Benchmarking
</span><span class="n">m</span> <span class="o">=</span> <span class="n">benchmark</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="n">im</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">benchmark</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="n">ip</span><span class="p">)</span>
<span class="n">j</span> <span class="o">=</span> <span class="n">benchmark</span><span class="p">(</span><span class="n">jd</span><span class="p">,</span> <span class="n">ij</span><span class="p">)</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">benchmark</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>

<span class="c1"># Output result
</span><span class="n">output</span> <span class="o">=</span> <span class="s">"{name}: {time}"</span><span class="o">.</span><span class="nb">format</span>

<span class="n">output</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'marshal'</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">m</span><span class="p">)</span>
<span class="n">output</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'(c)pickle'</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
<span class="n">output</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'json'</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">j</span><span class="p">)</span>
<span class="n">output</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">"Cap'n Proto"</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
</code></pre></div></div>
<p>Cap'n Proto requires an additional schema file:</p>
<pre><code class="language-capnp">>@0x934efea7f017fff0;

struct Person {
  name @0 :Text;
}

struct AddressBook {
  people @0 :List(Person);
}
</code></pre>
<p>Result:</p>
<pre><code>marshal: 0.08457612991333008
(c)pickle: 0.31447696685791016
json: 0.7639560699462891
Cap'n proto: 0.4193081855773926
</code></pre>
<p>So marshal seems the fastest on my machine.</p>
<p>However, with binary protocol and <code>fast</code> option,
<code>cPickle</code> is mostly as fast as <code>marshal</code>.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">md</span> <span class="o">=</span> <span class="s">'marshal.dumps([1, 2, 3])'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">im</span> <span class="o">=</span> <span class="s">'import marshal'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">pd</span> <span class="o">=</span> <span class="s">'fp.dump([1, 2, 3])'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">ip</span> <span class="o">=</span> <span class="s">"import cPickle; fp = cPickle.Pickler(open('/tmp/1', 'wb'), 2); fp.fast = 1"</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">timeit</span><span class="o">.</span><span class="n">timeit</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
<span class="mf">0.012997150421142578</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">timeit</span><span class="o">.</span><span class="n">timeit</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
<span class="mf">0.017292022705078125</span>
</code></pre></div></div>
    
      <h2 id="compatibility">
        
        
          Compatibility <a href="#compatibility" class="anchor-hash" title="link to this heading">#</a>
        
        
      </h2>
    
      <h3 id="compatibility-with-different-python-versions">
        
        
          Compatibility with different Python versions <a href="#compatibility-with-different-python-versions" class="anchor-hash" title="link to this heading">#</a>
        
        
      </h3>
<p>Marshal is for internal usage (<code>.pyc</code>).
So its format may be modified on future versions of Python.
Currently (up to Python 3.4.3), there are 4 versions of <code>marshal</code>.
The current version can be viewed via <code>marshal.version</code>.</p>
    
      <h3 id="compatibility-with-other-languages">
        
        
          Compatibility with other languages <a href="#compatibility-with-other-languages" class="anchor-hash" title="link to this heading">#</a>
        
        
      </h3>
<p>Implemented in other languages:</p>
<ul>
<li>Ruby: <a href="http://github.com/daeken/RMarshal">RMarshal</a></li>
<li>Go: <a href="https://github.com/hambster/gopymarshal">gopymarshal</a></li>
<li>Perl: (read-only) https://github.com/gitpan/Python-Serialise-Marshal</li>
</ul>
    
      <h2 id="export-to-json">
        
        
          Export to JSON <a href="#export-to-json" class="anchor-hash" title="link to this heading">#</a>
        
        
      </h2>
<p>To communicate with other programs,
we can export to JSON.</p>
<p>On Python 2.7+, the <code>json</code> module from <code>stdlib</code>
is <a href="http://stackoverflow.com/a/15440843">fast in encoding and decoding JSON</a>.
No need to use other modules.</p>
    <div class="footer border-top border-gray-light mt-5 pt-3 text-gray">
      <div style="display: flex; justify-content: space-between; align-items: flex-start">
        <form id="site-search" action="https://duckduckgo.com/html/" method="get">
          <input name="q" type="search" value="site:mmap.page " required pattern="site:mmap\.page\s.+">
          <input type="submit" value="&#x1F50D;" title="search through site content via DuckDuckGo">
        </form>
        <p>
          <a href="mailto:weakish@gmail.com" title="weakish@gmail.com"><img src="https://icongr.am/feather/mail.svg" alt="Feather Icon Mail"></a>
          <a href="https://savannah.nongnu.org/people/viewgpg.php?user_id=65699" title="2414 AEA0 EA48 5263 9697  F1BA 55F6 EEC2 EA3F 0A87"><img src="https://icongr.am/feather/key.svg" alt="Feather Icon Key"></a>
          <a href="https://github.com/weakish/" title="GitHub"><img src="https://icongr.am/feather/github.svg" alt="Feather Icon Github"></a>
          <a href="https://www.instagram.com/jakukyo/" title="Instagram"><img src="https://icongr.am/feather/instagram.svg" alt="Feather Icon Instagram"></a>
          <a href="https://twitter.com/weakish" title="Twitter"><img src="https://icongr.am/feather/twitter.svg" alt="Feather Icon Twitter"></a>
          <a href="/16XMwj6YRNqRHWbmSD8oxYUZCKfM1uzwP9/rss.xml" title="RSS 2.0 Feed"><img src="https://icongr.am/feather/rss.svg" alt="Feather Icon RSS"></a>
          <a href="/16XMwj6YRNqRHWbmSD8oxYUZCKfM1uzwP9/uses/" title="uses"><img src="https://icongr.am/feather/book-open.svg" alt="Feather Icon Book Open"></a>
          
          
          <a href="/Me.ZeroNetwork.bit/?Profile/12h51ug6CcntU2aiBjhP8Ns2e5VypbWWtv/1GnJD7CXskmG8GywMbTvbP12wneCFW9XzR/weakish@zeroid.bit" title="ZeroMe"><img src="/16XMwj6YRNqRHWbmSD8oxYUZCKfM1uzwP9/assets/images/zeronet_logo.svg" alt="ZeroNet Logo" width="32" height="32"></a>
        </p>
      </div>
        <p>
        Permission to use, copy, modify, and/or distribute this site for any purpose with or without fee is hereby granted.
        This site is provided "as is" without express or implied warranty.
        </p>
        <p>
        This site does not use cookies or tracking codes.
        The hosting service provider (<a href="https://pages.github.com/">GitHub Pages</a>) probably collects server logs,
        but I do not have access to them.
        </p>
        <p>
        Site source is <a href="https://github.com/weakish/weakish.github.com/">available</a>
        and feedback is <a href="https://github.com/weakish/weakish.github.com/issues">welcome</a>.
        </p>
        <noscript>
        <p>
        This site does not use JavaScript.
        </p>
        </noscript>
    </div>
  </div>
</body>
</html>
