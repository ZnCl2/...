
<!DOCTYPE html>

<html>
<head>
 <title>Maker ZeroChat</title>
 <meta charset="utf-8">
 <meta http-equiv="content-type" content="text/html; charset=utf-8" />
 <base href="" target="_top" id="base">
 <script>base.href = document.location.href.replace("/media", "").replace("index.html", "").replace(/[&?]wrapper=False/, "").replace(/[&?]wrapper_nonce=[A-Za-z0-9]+/, "")</script>
 <style>
  * { font-family: monospace; line-height: 1.5em; font-size: 13px; vertical-align: middle; }
  body { background-color: white; }
  input#message { padding: 5px; width: 50%;  }
  input#send { height: 34px; margin-left: -2px; }
  ul { padding: 0px; }
  li { list-style-type: none; border-top: 1px solid #eee; padding: 5px 0px; }
  li:nth-child(odd) { background-color: #F9FAFD; }
  li b { color: #3F51B5; }
</style>
</head>
<body>

    <a href="#Select+user" id="select_user" onclick='return page.selectUser()'>Select user</a>:
    <input type="text" id="message" onkeypress="if (event.keyCode == 13) page.sendMessage()">
    <input type="button" id="send" value="Send!" onclick='return page.sendMessage()'/>
    <ul id="messages">
        <li>Welcome to ZeroChat!</li>
    </ul>
    <script type="text/javascript" src="js/ZeroFrame.js"></script>

<script>

class ZeroChat extends ZeroFrame {
    addMessage(username, message) {
        var message_escaped = message.replace(/</g, "&lt;").replace(/>/g, "&gt;")
        this.messages.innerHTML += "<li><b>" + username + "</b>: " + message_escaped + "</li>"
    }

    onOpenWebsocket () {
        this.messages = document.getElementById("messages")
        this.addMessage("System", "Ready to call ZeroFrame API!")

        this.cmd("siteInfo", {}, (site_info) => {
            if (site_info.cert_user_id) {
                document.getElementById("select_user").innerText = site_info.cert_user_id
            }
            this.site_info = site_info
        })

        this.loadMessages()
    }

    selectUser () {
        this.cmd("certSelect", {accepted_domains: ["zeroid.bit"]})
        return false
    }

    onRequest (cmd,message) {
        if(cmd === "setSiteInfo") {
            if(message.params.cert_user_id) {
                document.getElementById("select_user").innerHTML = message.params.cert_user_id
            } else {
                document.getElementById("select_user").innerHTML = "Select user"
            }
            this.site_info = message.params

            if (message.params.event[0] === 'file_done') {
              this.loadMessages()
            }
        }
    }

    sendMessage () {
        if (!this.site_info.cert_user_id) {
            this.cmd("wrapperNotification", ["info", "Please, select your account."])
            return false
        }

        var data_inner_path = "data/users/" + this.site_info.auth_address + "/data.json"
        var content_inner_path = "data/users/" + this.site_info.auth_address + "/content.json"

        this.cmd("fileGet", {"inner_path" : data_inner_path, "required": false}, (data) => {
            if (data) {
                data = JSON.parse(data)
            } else {
                data = { "message": [] }
            }
            data.message.push({
                "body": document.getElementById("message").value,
                "date_added": Date.now()
            })

            var json_raw = unescape(encodeURIComponent(JSON.stringify(data, undefined, '\t')))

            this.cmd("fileWrite", [data_inner_path, btoa(json_raw)], (res) => {
                if (res === "ok") {
                    document.getElementById("message").value = ""
                    this.cmd("siteSign", {"inner_path": content_inner_path}, (res) => {
                        this.loadMessages()
                        this.cmd("sitePublish", {"inner_path": content_inner_path, "sign": false})
                    })
                } else {
                    this.cmd("wrapperNotification", ["error", "File write error: #{res}"])
                }
            })
        })
        return false
    }

    loadMessages () {
      this.cmd("dbQuery", ["SELECT * FROM message LEFT JOIN json USING (json_id) ORDER BY date_added DESC"], (messages) => {
        document.getElementById("messages").innerHTML = ""
        for (var i = 0; i < messages.length; i++) {
          this.addMessage(messages[i].cert_user_id, messages[i].body)
        }
      })
    }
}

page = new ZeroChat()

</script>

</body>
</html>
