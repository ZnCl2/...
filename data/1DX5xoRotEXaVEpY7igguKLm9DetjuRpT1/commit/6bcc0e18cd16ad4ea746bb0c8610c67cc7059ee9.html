<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Realigned source code, reply to comments, blockquote style, ratelimit updates - 0git - 0git - a list of git repositories on ZeroNet
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="0git.git Atom Feed" href="../atom.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>0git</h1><span class="desc">0git - a list of git repositories on ZeroNet
</span></td></tr><tr class="url"><td></td><td>git clone <a href="http://127.0.0.1:43110/0git.bit/0git.git">http://127.0.0.1:43110/0git.bit/0git.git</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/6bcc0e18cd16ad4ea746bb0c8610c67cc7059ee9.html">6bcc0e18cd16ad4ea746bb0c8610c67cc7059ee9</a>
<b>parent</b> <a href="../commit/d0756ba40bd5ff9ac725aed4289edc37a6a53b12.html">d0756ba40bd5ff9ac725aed4289edc37a6a53b12</a>
<b>Author:</b> HelloZeroNet &lt;<a href="mailto:hello@noloop.me">hello@noloop.me</a>&gt;
<b>Date:</b>   Tue Mar  3 02:58:49 +0100

Realigned source code, reply to comments, blockquote style, ratelimit updates

<b>Diffstat:</b>
<table><tr><td><a href="#h0">content.json</a></td><td> | </td><td class="num">28</td><td><span class="i">++++++++++++++</span><span class="d">--------------</span></td></tr>
<tr><td><a href="#h1">css/ZeroTalk.css</a></td><td> | </td><td class="num">5</td><td><span class="i">+++++</span><span class="d"></span></td></tr>
<tr><td><a href="#h2">css/all.css</a></td><td> | </td><td class="num">5</td><td><span class="i">+++++</span><span class="d"></span></td></tr>
<tr><td><a href="#h3">index.html</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td><a href="#h4">js/TopicList.coffee</a></td><td> | </td><td class="num">192</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td><a href="#h5">js/TopicShow.coffee</a></td><td> | </td><td class="num">123</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td><a href="#h6">js/ZeroTalk.coffee</a></td><td> | </td><td class="num">393</td><td><span class="i">++++</span><span class="d">---------------------------------------------------------------------------</span></td></tr>
<tr><td><a href="#h7">js/all.js</a></td><td> | </td><td class="num">1198</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">----------------------------------</span></td></tr>
<tr><td><a href="#h8">js/lib/LimitRate.coffee</a></td><td> | </td><td class="num">7</td><td><span class="i"></span><span class="d">-------</span></td></tr>
<tr><td><a href="#h9">js/lib/ZeroFrame.coffee</a></td><td> | </td><td class="num">73</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------</span></td></tr>
<tr><td><a href="#h10">js/utils/Class.coffee</a></td><td> | </td><td class="num">24</td><td><span class="i">++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td><a href="#h11">js/utils/InlineEditor.coffee</a></td><td> | </td><td class="num">160</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td><a href="#h12">js/utils/LimitRate.coffee</a></td><td> | </td><td class="num">7</td><td><span class="i">+++++++</span><span class="d"></span></td></tr>
<tr><td><a href="#h13">js/utils/Text.coffee</a></td><td> | </td><td class="num">26</td><td><span class="i">++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td><a href="#h14">js/utils/Time.coffee</a></td><td> | </td><td class="num">36</td><td><span class="i">++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td><a href="#h15">js/utils/ZeroFrame.coffee</a></td><td> | </td><td class="num">73</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
</table>16 files changed, 1365 insertions(+), 987 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/content.json.html">content.json</a> b/<a href="../file/content.json.html">content.json</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -4,9 +4,9 @@
</a>   &quot;description&quot;: &quot;Decentralized forum demo&quot;, 
   &quot;files&quot;: {
     &quot;css/all.css&quot;: {
<a href="#h0-0-3" id="h0-0-3" class="d">-      &quot;sha1&quot;: &quot;c76ae52f1cd57383b1e1877db5e910116e5c9bb1&quot;, 
</a><a href="#h0-0-4" id="h0-0-4" class="d">-      &quot;sha512&quot;: &quot;808cd96cedfcabb3e15a7697adb72336dfdcee255b732dcc1e4b5ca74946f8b3&quot;, 
</a><a href="#h0-0-5" id="h0-0-5" class="d">-      &quot;size&quot;: 144206
</a><a href="#h0-0-6" id="h0-0-6" class="i">+      &quot;sha1&quot;: &quot;eaee15bceb86b802a3c05cabd4a81ae6885583e3&quot;, 
</a><a href="#h0-0-7" id="h0-0-7" class="i">+      &quot;sha512&quot;: &quot;8d626adb43427910e1c49a05b5a4bbee8bb14c6e6a0de5ced84e9c173470b549&quot;, 
</a><a href="#h0-0-8" id="h0-0-8" class="i">+      &quot;size&quot;: 144524
</a>     }, 
     &quot;img/loading.gif&quot;: {
       &quot;sha1&quot;: &quot;a669dbd8a577f6957656fc88ba4960b93fcd23d9&quot;, 
<a href="#h0-1" id="h0-1" class="h">@@ -14,14 +14,14 @@
</a>       &quot;size&quot;: 723
     }, 
     &quot;index.html&quot;: {
<a href="#h0-1-3" id="h0-1-3" class="d">-      &quot;sha1&quot;: &quot;4d4845aabe3badf09fbabc7a4ed4513f527fa624&quot;, 
</a><a href="#h0-1-4" id="h0-1-4" class="d">-      &quot;sha512&quot;: &quot;4fd418533d81c2f58e021dd4703cac54717ad1aaa80a03172f7f6e5577e82124&quot;, 
</a><a href="#h0-1-5" id="h0-1-5" class="d">-      &quot;size&quot;: 4668
</a><a href="#h0-1-6" id="h0-1-6" class="i">+      &quot;sha1&quot;: &quot;ab17450cfa19878f47d7b3574cc659812b6c381d&quot;, 
</a><a href="#h0-1-7" id="h0-1-7" class="i">+      &quot;sha512&quot;: &quot;6beddd119daee5715957c0cdcdfe090114fc398ba81cc61b802202616576be33&quot;, 
</a><a href="#h0-1-8" id="h0-1-8" class="i">+      &quot;size&quot;: 4690
</a>     }, 
     &quot;js/all.js&quot;: {
<a href="#h0-1-11" id="h0-1-11" class="d">-      &quot;sha1&quot;: &quot;b09dfa9fccd3a44f94d726c62509972f6b9a73dd&quot;, 
</a><a href="#h0-1-12" id="h0-1-12" class="d">-      &quot;sha512&quot;: &quot;57fdb291741cc163eb53cbd3ba5cd233f291ea8f58efc2ea0372497eaa796190&quot;, 
</a><a href="#h0-1-13" id="h0-1-13" class="d">-      &quot;size&quot;: 204536
</a><a href="#h0-1-14" id="h0-1-14" class="i">+      &quot;sha1&quot;: &quot;64ac85351952cc5a24db6fa623cf491a2aa8c329&quot;, 
</a><a href="#h0-1-15" id="h0-1-15" class="i">+      &quot;sha512&quot;: &quot;5c692e5b97b88a3c3a18d3a04044f6fc4536d665725470ce2a5e25f5d3f504bc&quot;, 
</a><a href="#h0-1-16" id="h0-1-16" class="i">+      &quot;size&quot;: 209307
</a>     }
   }, 
   &quot;ignore&quot;: &quot;((js|css)/(?!all.(js|css))|data/users/.*)&quot;, 
<a href="#h0-2" id="h0-2" class="h">@@ -33,17 +33,17 @@
</a>       &quot;signers_required&quot;: 1
     }
   }, 
<a href="#h0-2-3" id="h0-2-3" class="d">-  &quot;modified&quot;: 1424538722.421, 
</a><a href="#h0-2-4" id="h0-2-4" class="i">+  &quot;modified&quot;: 1425250514.245, 
</a>   &quot;sign&quot;: [
<a href="#h0-2-6" id="h0-2-6" class="d">-    28115098796321225525469683774674563020683626206006934530558881859210766320163, 
</a><a href="#h0-2-7" id="h0-2-7" class="d">-    85669531735706364241730694951554730240181994225982173396151007166538171566242
</a><a href="#h0-2-8" id="h0-2-8" class="i">+    66207809463890109912286135964736777909555344423812490854027447069127926424527, 
</a><a href="#h0-2-9" id="h0-2-9" class="i">+    10233740391543917105537258017234721770504840294794623397728938704813203974703
</a>   ], 
   &quot;signers_sign&quot;: &quot;HKNDz9IUHcBc/l2Jm2Bl70XQDL9HYHhJ2hUdg8AMyunACLgxyXBr7EW1/ME4hGkaFZSFmIxlInmxH+BrMVXbnLw=&quot;, 
   &quot;signs&quot;: {
<a href="#h0-2-13" id="h0-2-13" class="d">-    &quot;1TaLk3zM7ZRskJvrh3ZNCDVGXvkJusPKQ&quot;: &quot;HFmfecFh0MtVJJ+M9jWbyYQaDqqE4s4UK5ePyJ0ER0NBac8+ln9sy3N8iGrHKT+0LKq8xpbzaXV6nGUqPcqfRu4=&quot;
</a><a href="#h0-2-14" id="h0-2-14" class="i">+    &quot;1TaLk3zM7ZRskJvrh3ZNCDVGXvkJusPKQ&quot;: &quot;HJKBfWTis/3rFdArpoky3VVBp0HArqxZYVYJTtgmcOm6UCSv5Zrdyfzt4bmec1xzpPquHZ2QaQ/EI3wnLQKPAqI=&quot;
</a>   }, 
   &quot;signs_required&quot;: 1, 
   &quot;title&quot;: &quot;ZeroTalk&quot;, 
   &quot;viewport&quot;: &quot;width=device-width, initial-scale=1.0&quot;, 
<a href="#h0-2-19" id="h0-2-19" class="d">-  &quot;zeronet_version&quot;: &quot;0.2.3&quot;
</a><a href="#h0-2-20" id="h0-2-20" class="i">+  &quot;zeronet_version&quot;: &quot;0.2.5&quot;
</a> } 
\ No newline at end of file
<b>diff --git a/<a id="h1" href="../file/css/ZeroTalk.css.html">css/ZeroTalk.css</a> b/<a href="../file/css/ZeroTalk.css.html">css/ZeroTalk.css</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -123,11 +123,16 @@ input.text:focus, textarea:focus { border-color: #5FC0EA; outline: none; backgro
</a> .comments { margin-bottom: 60px }
 .comment { background-color: white; padding: 15px 25px; margin: 1px }
 .comment .username { font-size: 14px }
<a href="#h1-0-3" id="h1-0-3" class="i">+.comment .added { color: #AAA }
</a> .comment .info { font-size: 12px; color: #AAA; margin-bottom: 7px }
 .comment .body { line-height: 1.5em }
 .comment .body p { margin-top: 0.5em; margin-bottom: 0.5em }
 .comment .body.editor { margin-top: 0.5em !important; margin-bottom: 0.5em !important }
 .comment .body h1, .comment .body h2, .comment .body h3 { font-size: 110% }
<a href="#h1-0-9" id="h1-0-9" class="i">+.comment .body blockquote { padding: 1px 15px; border-left: 2px solid #E7E7E7; margin: 0px; margin-top: 30px }
</a><a href="#h1-0-10" id="h1-0-10" class="i">+.comment .body blockquote:first-child { margin-top: 0px }
</a><a href="#h1-0-11" id="h1-0-11" class="i">+.comment .body blockquote p { margin: 0px; color: #999; font-size: 90% }
</a><a href="#h1-0-12" id="h1-0-12" class="i">+.comment .body blockquote a { color: #333 }
</a> 
 .comment-new { margin-bottom: 5px }
 .comment-new .button-submit { }
<b>diff --git a/<a id="h2" href="../file/css/all.css.html">css/all.css</a> b/<a href="../file/css/all.css.html">css/all.css</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -170,11 +170,16 @@ input.text:focus, textarea:focus { border-color: #5FC0EA; outline: none; backgro
</a> .comments { margin-bottom: 60px }
 .comment { background-color: white; padding: 15px 25px; margin: 1px }
 .comment .username { font-size: 14px }
<a href="#h2-0-3" id="h2-0-3" class="i">+.comment .added { color: #AAA }
</a> .comment .info { font-size: 12px; color: #AAA; margin-bottom: 7px }
 .comment .body { line-height: 1.5em }
 .comment .body p { margin-top: 0.5em; margin-bottom: 0.5em }
 .comment .body.editor { margin-top: 0.5em !important; margin-bottom: 0.5em !important }
 .comment .body h1, .comment .body h2, .comment .body h3 { font-size: 110% }
<a href="#h2-0-9" id="h2-0-9" class="i">+.comment .body blockquote { padding: 1px 15px; border-left: 2px solid #E7E7E7; margin: 0px; margin-top: 30px }
</a><a href="#h2-0-10" id="h2-0-10" class="i">+.comment .body blockquote:first-child { margin-top: 0px }
</a><a href="#h2-0-11" id="h2-0-11" class="i">+.comment .body blockquote p { margin: 0px; color: #999; font-size: 90% }
</a><a href="#h2-0-12" id="h2-0-12" class="i">+.comment .body blockquote a { color: #333 }
</a> 
 .comment-new { margin-bottom: 5px }
 .comment-new .button-submit { }
<b>diff --git a/<a id="h3" href="../file/index.html.html">index.html</a> b/<a href="../file/index.html.html">index.html</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -122,7 +122,7 @@
</a> 
   &lt;!-- Template: Comment --&gt;
   &lt;div class=&quot;comment template&quot;&gt;
<a href="#h3-0-3" id="h3-0-3" class="d">-   &lt;div class=&quot;info&quot;&gt;&lt;span class=&quot;username&quot;&gt;username&lt;/span&gt; &amp;#9473; &lt;span class=&quot;added&quot;&gt;added&lt;/span&gt;&lt;/div&gt;
</a><a href="#h3-0-4" id="h3-0-4" class="i">+   &lt;div class=&quot;info&quot;&gt;&lt;span class=&quot;username&quot;&gt;username&lt;/span&gt; &amp;#9473; &lt;a class=&quot;added&quot; href=&quot;#Reply&quot; title=&quot;Reply&quot;&gt;added&lt;/a&gt;&lt;/div&gt;
</a>    &lt;div class=&quot;body&quot;&gt;Body&lt;/div&gt;
   &lt;/div&gt;
   &lt;!-- EOF Template: Comment --&gt;
<b>diff --git a/<a id="h4" href="../file/js/TopicList.coffee.html">js/TopicList.coffee</a> b/<a href="../file/js/TopicList.coffee.html">js/TopicList.coffee</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -0,0 +1,191 @@
</a><a href="#h4-0-0" id="h4-0-0" class="i">+class TopicList extends Class
</a><a href="#h4-0-1" id="h4-0-1" class="i">+	constructor: -&gt;
</a><a href="#h4-0-2" id="h4-0-2" class="i">+		@thread_sorter = null
</a><a href="#h4-0-3" id="h4-0-3" class="i">+
</a><a href="#h4-0-4" id="h4-0-4" class="i">+
</a><a href="#h4-0-5" id="h4-0-5" class="i">+	actionList: -&gt;
</a><a href="#h4-0-6" id="h4-0-6" class="i">+		$(&quot;.topics-loading&quot;).cssLater(&quot;top&quot;, &quot;0px&quot;, 200)
</a><a href="#h4-0-7" id="h4-0-7" class="i">+		@loadTopics(&quot;noanim&quot;)
</a><a href="#h4-0-8" id="h4-0-8" class="i">+
</a><a href="#h4-0-9" id="h4-0-9" class="i">+		# Show create new topic form
</a><a href="#h4-0-10" id="h4-0-10" class="i">+		$(&quot;.topic-new-link&quot;).on &quot;click&quot;, =&gt;
</a><a href="#h4-0-11" id="h4-0-11" class="i">+			$(&quot;.topic-new&quot;).fancySlideDown()
</a><a href="#h4-0-12" id="h4-0-12" class="i">+			$(&quot;.topic-new-link&quot;).slideUp()
</a><a href="#h4-0-13" id="h4-0-13" class="i">+			return false
</a><a href="#h4-0-14" id="h4-0-14" class="i">+
</a><a href="#h4-0-15" id="h4-0-15" class="i">+		# Create new topic
</a><a href="#h4-0-16" id="h4-0-16" class="i">+		$(&quot;.topic-new .button-submit&quot;).on &quot;click&quot;, =&gt;
</a><a href="#h4-0-17" id="h4-0-17" class="i">+			if Page.user_name_db[Page.site_info.auth_address] # Check if user exits
</a><a href="#h4-0-18" id="h4-0-18" class="i">+				@buttonCreateTopic()
</a><a href="#h4-0-19" id="h4-0-19" class="i">+			else
</a><a href="#h4-0-20" id="h4-0-20" class="i">+				Page.cmd &quot;wrapperNotification&quot;, [&quot;info&quot;, &quot;Please, request access before posting.&quot;]
</a><a href="#h4-0-21" id="h4-0-21" class="i">+			return false
</a><a href="#h4-0-22" id="h4-0-22" class="i">+
</a><a href="#h4-0-23" id="h4-0-23" class="i">+
</a><a href="#h4-0-24" id="h4-0-24" class="i">+	loadTopics: (type=&quot;normal&quot;, cb=false) -&gt;
</a><a href="#h4-0-25" id="h4-0-25" class="i">+		@logStart &quot;Loadtopics&quot;
</a><a href="#h4-0-26" id="h4-0-26" class="i">+		Page.cmd &quot;fileQuery&quot;, [&quot;data/users/*/data.json&quot;, &quot;topics&quot;], (topics) =&gt;
</a><a href="#h4-0-27" id="h4-0-27" class="i">+			topics.sort (a, b) -&gt; # Sort by date
</a><a href="#h4-0-28" id="h4-0-28" class="i">+				return a.added - b.added
</a><a href="#h4-0-29" id="h4-0-29" class="i">+			last_elem = null
</a><a href="#h4-0-30" id="h4-0-30" class="i">+
</a><a href="#h4-0-31" id="h4-0-31" class="i">+			for topic in topics
</a><a href="#h4-0-32" id="h4-0-32" class="i">+				topic_address = topic.topic_id + &quot;_&quot; + Page.user_id_db[topic.inner_path]
</a><a href="#h4-0-33" id="h4-0-33" class="i">+				elem = $(&quot;#topic_&quot;+topic_address)
</a><a href="#h4-0-34" id="h4-0-34" class="i">+				if elem.length == 0 # Create if not exits yet
</a><a href="#h4-0-35" id="h4-0-35" class="i">+					elem = $(&quot;.topics-list .topic.template&quot;).clone().removeClass(&quot;template&quot;).attr(&quot;id&quot;, &quot;topic_&quot;+topic_address)
</a><a href="#h4-0-36" id="h4-0-36" class="i">+					if type != &quot;noanim&quot;
</a><a href="#h4-0-37" id="h4-0-37" class="i">+						elem.cssSlideDown()
</a><a href="#h4-0-38" id="h4-0-38" class="i">+				@applyTopicData(elem, topic)
</a><a href="#h4-0-39" id="h4-0-39" class="i">+
</a><a href="#h4-0-40" id="h4-0-40" class="i">+				if last_elem # Add after last elem
</a><a href="#h4-0-41" id="h4-0-41" class="i">+					last_elem.after(elem)
</a><a href="#h4-0-42" id="h4-0-42" class="i">+				else # Add to top
</a><a href="#h4-0-43" id="h4-0-43" class="i">+					elem.prependTo(&quot;.topics&quot;)
</a><a href="#h4-0-44" id="h4-0-44" class="i">+			$(&quot;body&quot;).css({&quot;overflow&quot;: &quot;auto&quot;, &quot;height&quot;: &quot;auto&quot;}) # Auto height body
</a><a href="#h4-0-45" id="h4-0-45" class="i">+
</a><a href="#h4-0-46" id="h4-0-46" class="i">+			# Hide loading
</a><a href="#h4-0-47" id="h4-0-47" class="i">+
</a><a href="#h4-0-48" id="h4-0-48" class="i">+			if parseInt($(&quot;.topics-loading&quot;).css(&quot;top&quot;)) &gt; -30 # Loading visible, animate it
</a><a href="#h4-0-49" id="h4-0-49" class="i">+				$(&quot;.topics-loading&quot;).css(&quot;top&quot;, &quot;-30px&quot;)
</a><a href="#h4-0-50" id="h4-0-50" class="i">+			else
</a><a href="#h4-0-51" id="h4-0-51" class="i">+				$(&quot;.topics-loading&quot;).remove()
</a><a href="#h4-0-52" id="h4-0-52" class="i">+
</a><a href="#h4-0-53" id="h4-0-53" class="i">+			@logEnd &quot;Loadtopics&quot;
</a><a href="#h4-0-54" id="h4-0-54" class="i">+
</a><a href="#h4-0-55" id="h4-0-55" class="i">+			Page.addInlineEditors()
</a><a href="#h4-0-56" id="h4-0-56" class="i">+
</a><a href="#h4-0-57" id="h4-0-57" class="i">+			if Page.site_info.tasks == 0 # No tasks active, sort it now
</a><a href="#h4-0-58" id="h4-0-58" class="i">+				@loadTopicsStat(type)
</a><a href="#h4-0-59" id="h4-0-59" class="i">+			else # Workers active, wait 100ms before sort
</a><a href="#h4-0-60" id="h4-0-60" class="i">+				clearInterval(@thread_sorter)
</a><a href="#h4-0-61" id="h4-0-61" class="i">+				@thread_sorter = setTimeout (=&gt;
</a><a href="#h4-0-62" id="h4-0-62" class="i">+					@loadTopicsStat(type)
</a><a href="#h4-0-63" id="h4-0-63" class="i">+				), 100
</a><a href="#h4-0-64" id="h4-0-64" class="i">+
</a><a href="#h4-0-65" id="h4-0-65" class="i">+
</a><a href="#h4-0-66" id="h4-0-66" class="i">+			if cb then cb()
</a><a href="#h4-0-67" id="h4-0-67" class="i">+
</a><a href="#h4-0-68" id="h4-0-68" class="i">+
</a><a href="#h4-0-69" id="h4-0-69" class="i">+	# Load all user data to fill last comments
</a><a href="#h4-0-70" id="h4-0-70" class="i">+	loadTopicsStat: (type=&quot;normal&quot;) =&gt;
</a><a href="#h4-0-71" id="h4-0-71" class="i">+		s = (+ new Date)
</a><a href="#h4-0-72" id="h4-0-72" class="i">+		Page.cmd &quot;fileQuery&quot;, [&quot;data/users/*/data.json&quot;, &quot;&quot;], (users) =&gt;
</a><a href="#h4-0-73" id="h4-0-73" class="i">+			$(&quot;.topics&quot;).css(&quot;opacity&quot;, 1)
</a><a href="#h4-0-74" id="h4-0-74" class="i">+			stats = []
</a><a href="#h4-0-75" id="h4-0-75" class="i">+			# Analyze user data files
</a><a href="#h4-0-76" id="h4-0-76" class="i">+			for user in users
</a><a href="#h4-0-77" id="h4-0-77" class="i">+				for topic in user.topics
</a><a href="#h4-0-78" id="h4-0-78" class="i">+					user_id = Page.user_id_db[user.inner_path]
</a><a href="#h4-0-79" id="h4-0-79" class="i">+					topic_address = &quot;#{topic.topic_id}_#{user_id}&quot;
</a><a href="#h4-0-80" id="h4-0-80" class="i">+					if not stats[topic_address]?
</a><a href="#h4-0-81" id="h4-0-81" class="i">+						stats[topic_address] = {&quot;comments&quot;: 0, &quot;last&quot;: {&quot;added&quot;: topic.added}}
</a><a href="#h4-0-82" id="h4-0-82" class="i">+
</a><a href="#h4-0-83" id="h4-0-83" class="i">+				for topic_address, comments of user[&quot;comments&quot;]
</a><a href="#h4-0-84" id="h4-0-84" class="i">+					topic_address = topic_address.replace(&quot;@&quot;, &quot;_&quot;)
</a><a href="#h4-0-85" id="h4-0-85" class="i">+					for comment in comments
</a><a href="#h4-0-86" id="h4-0-86" class="i">+						stats[topic_address] ?= {&quot;comments&quot;: 0, &quot;last&quot;: null}
</a><a href="#h4-0-87" id="h4-0-87" class="i">+						last = stats[topic_address][&quot;last&quot;]
</a><a href="#h4-0-88" id="h4-0-88" class="i">+						stats[topic_address][&quot;comments&quot;] += 1
</a><a href="#h4-0-89" id="h4-0-89" class="i">+						if not last or comment[&quot;added&quot;] &gt; last[&quot;added&quot;]
</a><a href="#h4-0-90" id="h4-0-90" class="i">+							comment[&quot;auth_address&quot;] = user[&quot;inner_path&quot;]
</a><a href="#h4-0-91" id="h4-0-91" class="i">+							stats[topic_address][&quot;last&quot;] = comment
</a><a href="#h4-0-92" id="h4-0-92" class="i">+
</a><a href="#h4-0-93" id="h4-0-93" class="i">+			# Set html elements
</a><a href="#h4-0-94" id="h4-0-94" class="i">+			for topic_address, stat of stats
</a><a href="#h4-0-95" id="h4-0-95" class="i">+				if stat.comments &gt; 0
</a><a href="#h4-0-96" id="h4-0-96" class="i">+					$(&quot;#topic_#{topic_address} .comment-num&quot;).text &quot;#{stat.comments} comment&quot;
</a><a href="#h4-0-97" id="h4-0-97" class="i">+					$(&quot;#topic_#{topic_address} .added&quot;).text &quot;last &quot;+Time.since(stat[&quot;last&quot;][&quot;added&quot;])
</a><a href="#h4-0-98" id="h4-0-98" class="i">+
</a><a href="#h4-0-99" id="h4-0-99" class="i">+
</a><a href="#h4-0-100" id="h4-0-100" class="i">+			# Sort topics
</a><a href="#h4-0-101" id="h4-0-101" class="i">+			topics = ([topic_address, stat.last.added] for topic_address, stat of stats)
</a><a href="#h4-0-102" id="h4-0-102" class="i">+			topics.sort (a, b) -&gt; # Sort by date
</a><a href="#h4-0-103" id="h4-0-103" class="i">+				return a[1] - b[1]
</a><a href="#h4-0-104" id="h4-0-104" class="i">+
</a><a href="#h4-0-105" id="h4-0-105" class="i">+			for topic in topics
</a><a href="#h4-0-106" id="h4-0-106" class="i">+				topic_address = topic[0]
</a><a href="#h4-0-107" id="h4-0-107" class="i">+				elem = $(&quot;#topic_#{topic_address}&quot;)
</a><a href="#h4-0-108" id="h4-0-108" class="i">+				elem.prependTo &quot;.topics&quot;
</a><a href="#h4-0-109" id="h4-0-109" class="i">+				# Visited
</a><a href="#h4-0-110" id="h4-0-110" class="i">+				visited = Page.local_storage[&quot;topic.#{topic_address}.visited&quot;]
</a><a href="#h4-0-111" id="h4-0-111" class="i">+				if not visited
</a><a href="#h4-0-112" id="h4-0-112" class="i">+					elem.addClass(&quot;visit-none&quot;)
</a><a href="#h4-0-113" id="h4-0-113" class="i">+				else if visited &lt; topic[1]
</a><a href="#h4-0-114" id="h4-0-114" class="i">+					elem.addClass(&quot;visit-newcomment&quot;)
</a><a href="#h4-0-115" id="h4-0-115" class="i">+
</a><a href="#h4-0-116" id="h4-0-116" class="i">+			@log &quot;Topics stats loaded in&quot;, (+ new Date)-s
</a><a href="#h4-0-117" id="h4-0-117" class="i">+
</a><a href="#h4-0-118" id="h4-0-118" class="i">+
</a><a href="#h4-0-119" id="h4-0-119" class="i">+	applyTopicData: (elem, topic, type=&quot;normal&quot;) -&gt;
</a><a href="#h4-0-120" id="h4-0-120" class="i">+		title_hash = topic.title.replace(/[#,&quot;&apos;?&amp; ]/g, &quot;+&quot;).replace(/[+]+/g, &quot;+&quot;).replace(/[+]+$/, &quot;&quot;)
</a><a href="#h4-0-121" id="h4-0-121" class="i">+		user_id = Page.user_id_db[topic.inner_path]
</a><a href="#h4-0-122" id="h4-0-122" class="i">+		$(&quot;.title .title-link&quot;, elem).text(topic.title)
</a><a href="#h4-0-123" id="h4-0-123" class="i">+		$(&quot;.title .title-link, a.image, .comment-num&quot;, elem).attr(&quot;href&quot;, &quot;?Topic:#{topic.topic_id}@#{user_id}/#{title_hash}&quot;)
</a><a href="#h4-0-124" id="h4-0-124" class="i">+
</a><a href="#h4-0-125" id="h4-0-125" class="i">+		# Get links in body
</a><a href="#h4-0-126" id="h4-0-126" class="i">+		body = topic.body
</a><a href="#h4-0-127" id="h4-0-127" class="i">+		match = topic.body.match /http[s]{0,1}:\/\/[^&quot;&apos;, $]+/
</a><a href="#h4-0-128" id="h4-0-128" class="i">+		if match # Link type topic
</a><a href="#h4-0-129" id="h4-0-129" class="i">+			url = match[0]
</a><a href="#h4-0-130" id="h4-0-130" class="i">+			if type != &quot;full&quot; then body = body.replace /http[s]{0,1}:\/\/[^&quot;&apos; $]+/g, &quot;&quot; # Remove links
</a><a href="#h4-0-131" id="h4-0-131" class="i">+			$(&quot;.image .icon&quot;, elem).removeClass(&quot;icon-topic-chat&quot;).addClass(&quot;icon-topic-link&quot;)
</a><a href="#h4-0-132" id="h4-0-132" class="i">+			$(&quot;.link&quot;, elem).css(&quot;display&quot;, &quot;&quot;).attr &quot;href&quot;, url.replace(/http:\/\/(127.0.0.1|localhost):43110/, &quot;&quot;)
</a><a href="#h4-0-133" id="h4-0-133" class="i">+			$(&quot;.link .link-url&quot;, elem).text(url)
</a><a href="#h4-0-134" id="h4-0-134" class="i">+		else # Normal type topic
</a><a href="#h4-0-135" id="h4-0-135" class="i">+			$(&quot;.image .icon&quot;, elem).removeClass(&quot;icon-topic-link&quot;).addClass(&quot;icon-topic-chat&quot;)
</a><a href="#h4-0-136" id="h4-0-136" class="i">+			$(&quot;.link&quot;, elem).css(&quot;display&quot;, &quot;none&quot;)
</a><a href="#h4-0-137" id="h4-0-137" class="i">+
</a><a href="#h4-0-138" id="h4-0-138" class="i">+		if type == &quot;full&quot; # Markdon syntax at topic page
</a><a href="#h4-0-139" id="h4-0-139" class="i">+			$(&quot;.body&quot;, elem).html Text.toMarked(body, {&quot;sanitize&quot;: true})
</a><a href="#h4-0-140" id="h4-0-140" class="i">+		else
</a><a href="#h4-0-141" id="h4-0-141" class="i">+			$(&quot;.body&quot;, elem).text body
</a><a href="#h4-0-142" id="h4-0-142" class="i">+
</a><a href="#h4-0-143" id="h4-0-143" class="i">+		username = Page.user_name_db[topic.inner_path]
</a><a href="#h4-0-144" id="h4-0-144" class="i">+		$(&quot;.username&quot;, elem).text(username)
</a><a href="#h4-0-145" id="h4-0-145" class="i">+		$(&quot;.added&quot;, elem).text Time.since(topic.added)
</a><a href="#h4-0-146" id="h4-0-146" class="i">+
</a><a href="#h4-0-147" id="h4-0-147" class="i">+		# My topic
</a><a href="#h4-0-148" id="h4-0-148" class="i">+		if topic.inner_path == Page.site_info.auth_address
</a><a href="#h4-0-149" id="h4-0-149" class="i">+			$(elem).attr(&quot;data-object&quot;, &quot;Topic:#{topic.topic_id}@#{user_id}&quot;).attr(&quot;data-deletable&quot;, &quot;yes&quot;)
</a><a href="#h4-0-150" id="h4-0-150" class="i">+			$(&quot;.title .title-link&quot;, elem).attr(&quot;data-editable&quot;, &quot;title&quot;).data(&quot;content&quot;, topic.title)
</a><a href="#h4-0-151" id="h4-0-151" class="i">+			$(&quot;.body&quot;, elem).attr(&quot;data-editable&quot;, &quot;body&quot;).data(&quot;content&quot;, topic.body)
</a><a href="#h4-0-152" id="h4-0-152" class="i">+
</a><a href="#h4-0-153" id="h4-0-153" class="i">+
</a><a href="#h4-0-154" id="h4-0-154" class="i">+	buttonCreateTopic: -&gt;
</a><a href="#h4-0-155" id="h4-0-155" class="i">+		if not Page.hasOpenPort() then return false
</a><a href="#h4-0-156" id="h4-0-156" class="i">+
</a><a href="#h4-0-157" id="h4-0-157" class="i">+		title = $(&quot;.topic-new #topic_title&quot;).val()
</a><a href="#h4-0-158" id="h4-0-158" class="i">+		body = $(&quot;.topic-new #topic_body&quot;).val()
</a><a href="#h4-0-159" id="h4-0-159" class="i">+		#if not body then return $(&quot;.topic-new #topic_body&quot;).focus()
</a><a href="#h4-0-160" id="h4-0-160" class="i">+		if not title then return $(&quot;.topic-new #topic_title&quot;).focus()
</a><a href="#h4-0-161" id="h4-0-161" class="i">+
</a><a href="#h4-0-162" id="h4-0-162" class="i">+		$(&quot;.topic-new .button-submit&quot;).addClass(&quot;loading&quot;)
</a><a href="#h4-0-163" id="h4-0-163" class="i">+		inner_path = &quot;data/users/#{Page.site_info.auth_address}/data.json&quot;
</a><a href="#h4-0-164" id="h4-0-164" class="i">+		Page.cmd &quot;fileGet&quot;, [inner_path], (data) =&gt;
</a><a href="#h4-0-165" id="h4-0-165" class="i">+			data = JSON.parse(data)
</a><a href="#h4-0-166" id="h4-0-166" class="i">+			data.topics.push {
</a><a href="#h4-0-167" id="h4-0-167" class="i">+				&quot;topic_id&quot;: data.next_topic_id,
</a><a href="#h4-0-168" id="h4-0-168" class="i">+				&quot;title&quot;: title,
</a><a href="#h4-0-169" id="h4-0-169" class="i">+				&quot;body&quot;: body,
</a><a href="#h4-0-170" id="h4-0-170" class="i">+				&quot;added&quot;: Time.timestamp()
</a><a href="#h4-0-171" id="h4-0-171" class="i">+			}
</a><a href="#h4-0-172" id="h4-0-172" class="i">+			data.next_topic_id += 1
</a><a href="#h4-0-173" id="h4-0-173" class="i">+			Page.writePublish inner_path, Page.jsonEncode(data), (res) =&gt;
</a><a href="#h4-0-174" id="h4-0-174" class="i">+				$(&quot;.topic-new .button-submit&quot;).removeClass(&quot;loading&quot;)
</a><a href="#h4-0-175" id="h4-0-175" class="i">+				if res == true
</a><a href="#h4-0-176" id="h4-0-176" class="i">+					@log &quot;File written&quot;
</a><a href="#h4-0-177" id="h4-0-177" class="i">+					$(&quot;.topic-new&quot;).slideUp()
</a><a href="#h4-0-178" id="h4-0-178" class="i">+					$(&quot;.topic-new-link&quot;).slideDown()
</a><a href="#h4-0-179" id="h4-0-179" class="i">+					setTimeout (=&gt;
</a><a href="#h4-0-180" id="h4-0-180" class="i">+						@loadTopics()
</a><a href="#h4-0-181" id="h4-0-181" class="i">+					), 600
</a><a href="#h4-0-182" id="h4-0-182" class="i">+					$(&quot;.topic-new #topic_body&quot;).val(&quot;&quot;)
</a><a href="#h4-0-183" id="h4-0-183" class="i">+					$(&quot;.topic-new #topic_title&quot;).val(&quot;&quot;)
</a><a href="#h4-0-184" id="h4-0-184" class="i">+
</a><a href="#h4-0-185" id="h4-0-185" class="i">+				else
</a><a href="#h4-0-186" id="h4-0-186" class="i">+					Page.cmd &quot;wrapperNotification&quot;, [&quot;error&quot;, &quot;File write error: #{res}&quot;]
</a><a href="#h4-0-187" id="h4-0-187" class="i">+
</a><a href="#h4-0-188" id="h4-0-188" class="i">+
</a><a href="#h4-0-189" id="h4-0-189" class="i">+
</a><a href="#h4-0-190" id="h4-0-190" class="i">+window.TopicList = new TopicList()</a><a href="#h4-0-191" id="h4-0-191" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h5" href="../file/js/TopicShow.coffee.html">js/TopicShow.coffee</a> b/<a href="../file/js/TopicShow.coffee.html">js/TopicShow.coffee</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -0,0 +1,123 @@
</a><a href="#h5-0-0" id="h5-0-0" class="i">+class TopicShow extends Class
</a><a href="#h5-0-1" id="h5-0-1" class="i">+	actionShow: (topic_id, topic_user_id) -&gt;
</a><a href="#h5-0-2" id="h5-0-2" class="i">+		@topic_id = topic_id
</a><a href="#h5-0-3" id="h5-0-3" class="i">+		@topic_user_id = topic_user_id
</a><a href="#h5-0-4" id="h5-0-4" class="i">+
</a><a href="#h5-0-5" id="h5-0-5" class="i">+		@loadTopic()
</a><a href="#h5-0-6" id="h5-0-6" class="i">+		@loadComments(&quot;noanim&quot;)
</a><a href="#h5-0-7" id="h5-0-7" class="i">+
</a><a href="#h5-0-8" id="h5-0-8" class="i">+		$(&quot;.comment-new .button-submit&quot;).on &quot;click&quot;, =&gt;
</a><a href="#h5-0-9" id="h5-0-9" class="i">+			if Page.user_name_db[Page.site_info.auth_address] # Check if user exits
</a><a href="#h5-0-10" id="h5-0-10" class="i">+				@buttonComment()
</a><a href="#h5-0-11" id="h5-0-11" class="i">+			else
</a><a href="#h5-0-12" id="h5-0-12" class="i">+				Page.cmd &quot;wrapperNotification&quot;, [&quot;info&quot;, &quot;Please, request access before posting.&quot;]
</a><a href="#h5-0-13" id="h5-0-13" class="i">+			return false
</a><a href="#h5-0-14" id="h5-0-14" class="i">+
</a><a href="#h5-0-15" id="h5-0-15" class="i">+
</a><a href="#h5-0-16" id="h5-0-16" class="i">+	loadTopic: (cb=false)-&gt;
</a><a href="#h5-0-17" id="h5-0-17" class="i">+		topic_user_address = Page.user_address_db[@topic_user_id]
</a><a href="#h5-0-18" id="h5-0-18" class="i">+		# Load topic data
</a><a href="#h5-0-19" id="h5-0-19" class="i">+		Page.cmd &quot;fileQuery&quot;, [&quot;data/users/#{topic_user_address}/data.json&quot;, &quot;topics.topic_id=#{@topic_id}&quot;], (topic) =&gt;
</a><a href="#h5-0-20" id="h5-0-20" class="i">+			topic = topic[0]
</a><a href="#h5-0-21" id="h5-0-21" class="i">+			topic[&quot;inner_path&quot;] = topic_user_address # add user address
</a><a href="#h5-0-22" id="h5-0-22" class="i">+			TopicList.applyTopicData($(&quot;.topic-full&quot;), topic, &quot;full&quot;)
</a><a href="#h5-0-23" id="h5-0-23" class="i">+			$(&quot;.topic-full&quot;).css(&quot;opacity&quot;, 1)
</a><a href="#h5-0-24" id="h5-0-24" class="i">+			#$(&quot;.username-my&quot;).text(@user_name_db[user_address])
</a><a href="#h5-0-25" id="h5-0-25" class="i">+			$(&quot;body&quot;).addClass(&quot;page-topic&quot;)
</a><a href="#h5-0-26" id="h5-0-26" class="i">+
</a><a href="#h5-0-27" id="h5-0-27" class="i">+			if cb then cb()
</a><a href="#h5-0-28" id="h5-0-28" class="i">+
</a><a href="#h5-0-29" id="h5-0-29" class="i">+
</a><a href="#h5-0-30" id="h5-0-30" class="i">+	loadComments: (type=&quot;normal&quot;, cb=false) -&gt;
</a><a href="#h5-0-31" id="h5-0-31" class="i">+		topic_address = @topic_id+&quot;@&quot;+@topic_user_id
</a><a href="#h5-0-32" id="h5-0-32" class="i">+
</a><a href="#h5-0-33" id="h5-0-33" class="i">+		# Update visited info
</a><a href="#h5-0-34" id="h5-0-34" class="i">+		Page.local_storage[&quot;topic.#{@topic_id}_#{@topic_user_id}.visited&quot;] = Time.timestamp()
</a><a href="#h5-0-35" id="h5-0-35" class="i">+		Page.cmd &quot;wrapperSetLocalStorage&quot;, Page.local_storage
</a><a href="#h5-0-36" id="h5-0-36" class="i">+
</a><a href="#h5-0-37" id="h5-0-37" class="i">+		# Load comments
</a><a href="#h5-0-38" id="h5-0-38" class="i">+		Page.cmd &quot;fileQuery&quot;, [&quot;data/users/*/data.json&quot;, &quot;comments.#{topic_address}&quot;], (comments) =&gt;
</a><a href="#h5-0-39" id="h5-0-39" class="i">+			comments.sort (a, b) -&gt; # Sort by date desc
</a><a href="#h5-0-40" id="h5-0-40" class="i">+				return b.added - a.added
</a><a href="#h5-0-41" id="h5-0-41" class="i">+
</a><a href="#h5-0-42" id="h5-0-42" class="i">+			for comment in comments
</a><a href="#h5-0-43" id="h5-0-43" class="i">+				user_id = Page.user_id_db[comment.inner_path]
</a><a href="#h5-0-44" id="h5-0-44" class="i">+				comment_address = &quot;#{comment.comment_id}_#{user_id}&quot;
</a><a href="#h5-0-45" id="h5-0-45" class="i">+				elem = $(&quot;#comment_&quot;+comment_address)
</a><a href="#h5-0-46" id="h5-0-46" class="i">+				if elem.length == 0 # Create if not exits
</a><a href="#h5-0-47" id="h5-0-47" class="i">+					elem = $(&quot;.comment.template&quot;).clone().removeClass(&quot;template&quot;).attr(&quot;id&quot;, &quot;comment_&quot;+comment_address).data(&quot;topic_address&quot;, topic_address)
</a><a href="#h5-0-48" id="h5-0-48" class="i">+					if type != &quot;noanim&quot;
</a><a href="#h5-0-49" id="h5-0-49" class="i">+						elem.cssSlideDown()
</a><a href="#h5-0-50" id="h5-0-50" class="i">+					$(&quot;.added&quot;, elem).on &quot;click&quot;, (e) =&gt; # Reply link
</a><a href="#h5-0-51" id="h5-0-51" class="i">+						return @buttonReply $(e.target).parents(&quot;.comment&quot;)
</a><a href="#h5-0-52" id="h5-0-52" class="i">+				@applyCommentData(elem, comment)
</a><a href="#h5-0-53" id="h5-0-53" class="i">+				elem.appendTo(&quot;.comments&quot;)
</a><a href="#h5-0-54" id="h5-0-54" class="i">+
</a><a href="#h5-0-55" id="h5-0-55" class="i">+			$(&quot;body&quot;).css({&quot;overflow&quot;: &quot;auto&quot;, &quot;height&quot;: &quot;auto&quot;})
</a><a href="#h5-0-56" id="h5-0-56" class="i">+
</a><a href="#h5-0-57" id="h5-0-57" class="i">+			Page.addInlineEditors()
</a><a href="#h5-0-58" id="h5-0-58" class="i">+
</a><a href="#h5-0-59" id="h5-0-59" class="i">+			if cb then cb()
</a><a href="#h5-0-60" id="h5-0-60" class="i">+
</a><a href="#h5-0-61" id="h5-0-61" class="i">+
</a><a href="#h5-0-62" id="h5-0-62" class="i">+	# Update elem based on data of comment dict
</a><a href="#h5-0-63" id="h5-0-63" class="i">+	applyCommentData: (elem, comment) -&gt;
</a><a href="#h5-0-64" id="h5-0-64" class="i">+		username = Page.user_name_db[comment.inner_path]
</a><a href="#h5-0-65" id="h5-0-65" class="i">+		$(&quot;.body&quot;, elem).html Text.toMarked(comment.body, {&quot;sanitize&quot;: true})
</a><a href="#h5-0-66" id="h5-0-66" class="i">+		$(&quot;.username&quot;, elem).text(username).css(&quot;color&quot;: Text.toColor(username))
</a><a href="#h5-0-67" id="h5-0-67" class="i">+		$(&quot;.added&quot;, elem).text(Time.since(comment.added))
</a><a href="#h5-0-68" id="h5-0-68" class="i">+		# elem.css(&quot;border-left&quot;, &quot;2px solid #{@textToColor(username)}&quot;)
</a><a href="#h5-0-69" id="h5-0-69" class="i">+
</a><a href="#h5-0-70" id="h5-0-70" class="i">+
</a><a href="#h5-0-71" id="h5-0-71" class="i">+		# My comment
</a><a href="#h5-0-72" id="h5-0-72" class="i">+		if comment.inner_path == Page.site_info.auth_address
</a><a href="#h5-0-73" id="h5-0-73" class="i">+			user_id = Page.user_id_db[comment.inner_path]
</a><a href="#h5-0-74" id="h5-0-74" class="i">+			comment_id = elem.attr(&quot;id&quot;).replace(&quot;comment_&quot;, &quot;&quot;).replace(/_.*$/, &quot;&quot;)
</a><a href="#h5-0-75" id="h5-0-75" class="i">+			topic_address = elem.data(&quot;topic_address&quot;)
</a><a href="#h5-0-76" id="h5-0-76" class="i">+			$(elem).attr(&quot;data-object&quot;, &quot;Comment:#{comment_id}@#{topic_address}&quot;).attr(&quot;data-deletable&quot;, &quot;yes&quot;)
</a><a href="#h5-0-77" id="h5-0-77" class="i">+			$(&quot;.body&quot;, elem).attr(&quot;data-editable&quot;, &quot;body&quot;).data(&quot;content&quot;, comment.body)
</a><a href="#h5-0-78" id="h5-0-78" class="i">+
</a><a href="#h5-0-79" id="h5-0-79" class="i">+
</a><a href="#h5-0-80" id="h5-0-80" class="i">+	buttonComment: -&gt;
</a><a href="#h5-0-81" id="h5-0-81" class="i">+		if not Page.hasOpenPort() then return false
</a><a href="#h5-0-82" id="h5-0-82" class="i">+
</a><a href="#h5-0-83" id="h5-0-83" class="i">+		body = $(&quot;.comment-new #comment_body&quot;).val()
</a><a href="#h5-0-84" id="h5-0-84" class="i">+		if not body then $(&quot;.comment-new #comment_body&quot;).focus()
</a><a href="#h5-0-85" id="h5-0-85" class="i">+		topic_address = @topic_id+&quot;@&quot;+@topic_user_id
</a><a href="#h5-0-86" id="h5-0-86" class="i">+
</a><a href="#h5-0-87" id="h5-0-87" class="i">+		$(&quot;.comment-new .button-submit&quot;).addClass(&quot;loading&quot;)
</a><a href="#h5-0-88" id="h5-0-88" class="i">+		inner_path = &quot;data/users/#{Page.site_info.auth_address}/data.json&quot;
</a><a href="#h5-0-89" id="h5-0-89" class="i">+		Page.cmd &quot;fileGet&quot;, [inner_path], (data) =&gt;
</a><a href="#h5-0-90" id="h5-0-90" class="i">+			data = JSON.parse(data)
</a><a href="#h5-0-91" id="h5-0-91" class="i">+			data.comments[topic_address] ?= []
</a><a href="#h5-0-92" id="h5-0-92" class="i">+			data.comments[topic_address].push {
</a><a href="#h5-0-93" id="h5-0-93" class="i">+				&quot;comment_id&quot;: data.next_message_id, 
</a><a href="#h5-0-94" id="h5-0-94" class="i">+				&quot;body&quot;: body,
</a><a href="#h5-0-95" id="h5-0-95" class="i">+				&quot;added&quot;: Time.timestamp()
</a><a href="#h5-0-96" id="h5-0-96" class="i">+			}
</a><a href="#h5-0-97" id="h5-0-97" class="i">+			data.next_message_id += 1
</a><a href="#h5-0-98" id="h5-0-98" class="i">+			Page.writePublish inner_path, Page.jsonEncode(data), (res) =&gt;
</a><a href="#h5-0-99" id="h5-0-99" class="i">+				$(&quot;.comment-new .button-submit&quot;).removeClass(&quot;loading&quot;)
</a><a href="#h5-0-100" id="h5-0-100" class="i">+				if res == true
</a><a href="#h5-0-101" id="h5-0-101" class="i">+					@log &quot;File written&quot;
</a><a href="#h5-0-102" id="h5-0-102" class="i">+					@loadComments()
</a><a href="#h5-0-103" id="h5-0-103" class="i">+					$(&quot;.comment-new #comment_body&quot;).val(&quot;&quot;)
</a><a href="#h5-0-104" id="h5-0-104" class="i">+
</a><a href="#h5-0-105" id="h5-0-105" class="i">+
</a><a href="#h5-0-106" id="h5-0-106" class="i">+	buttonReply: (elem) -&gt;
</a><a href="#h5-0-107" id="h5-0-107" class="i">+		@log &quot;Reply to&quot;, elem
</a><a href="#h5-0-108" id="h5-0-108" class="i">+		username = $(&quot;.username&quot;, elem).text()
</a><a href="#h5-0-109" id="h5-0-109" class="i">+		post_id = elem.attr(&quot;id&quot;)
</a><a href="#h5-0-110" id="h5-0-110" class="i">+		body_add = &quot;&gt; [#{username}](\##{post_id}): &quot;
</a><a href="#h5-0-111" id="h5-0-111" class="i">+		body_add+= $(&quot;.body&quot;, elem).text().trim(&quot;\n&quot;).replace(/\n/g, &quot;\n&gt; &quot;)
</a><a href="#h5-0-112" id="h5-0-112" class="i">+		body_add+= &quot;\n\n&quot;
</a><a href="#h5-0-113" id="h5-0-113" class="i">+
</a><a href="#h5-0-114" id="h5-0-114" class="i">+
</a><a href="#h5-0-115" id="h5-0-115" class="i">+		$(&quot;.comment-new #comment_body&quot;).val( $(&quot;.comment-new #comment_body&quot;).val()+body_add )
</a><a href="#h5-0-116" id="h5-0-116" class="i">+
</a><a href="#h5-0-117" id="h5-0-117" class="i">+		$(&quot;.comment-new #comment_body&quot;).trigger(&quot;input&quot;).focus() # Autosize
</a><a href="#h5-0-118" id="h5-0-118" class="i">+
</a><a href="#h5-0-119" id="h5-0-119" class="i">+		return false
</a><a href="#h5-0-120" id="h5-0-120" class="i">+
</a><a href="#h5-0-121" id="h5-0-121" class="i">+
</a><a href="#h5-0-122" id="h5-0-122" class="i">+window.TopicShow = new TopicShow()
</a><b>diff --git a/<a id="h6" href="../file/js/ZeroTalk.coffee.html">js/ZeroTalk.coffee</a> b/<a href="../file/js/ZeroTalk.coffee.html">js/ZeroTalk.coffee</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -11,8 +11,6 @@ class ZeroTalk extends ZeroFrame
</a> 
 		@user_max_size = null # Max total file size allowed to user
 
<a href="#h6-0-3" id="h6-0-3" class="d">-		@thread_sorter = null
</a><a href="#h6-0-4" id="h6-0-4" class="d">-
</a> 		# Autoexpand
 		for textarea in $(&quot;textarea&quot;)
 			@autoExpand $(textarea)
<a href="#h6-1" id="h6-1" class="h">@@ -30,11 +28,6 @@ class ZeroTalk extends ZeroFrame
</a> 			return false
 
 
<a href="#h6-1-3" id="h6-1-3" class="d">-	# All page content loaded
</a><a href="#h6-1-4" id="h6-1-4" class="d">-	pageLoaded: -&gt;
</a><a href="#h6-1-5" id="h6-1-5" class="d">-		$(&quot;body&quot;).addClass(&quot;loaded&quot;) # Back/forward button keep position support
</a><a href="#h6-1-6" id="h6-1-6" class="d">-
</a><a href="#h6-1-7" id="h6-1-7" class="d">-
</a> 	# Wrapper websocket connection ready
 	onOpenWebsocket: (e) =&gt;
 		@cmd &quot;wrapperSetViewport&quot;, &quot;width=device-width, initial-scale=1.0&quot;
<a href="#h6-2" id="h6-2" class="h">@@ -55,259 +48,19 @@ class ZeroTalk extends ZeroFrame
</a> 				@cmd &quot;wrapperNotification&quot;, [&quot;error&quot;, &quot;ZeroTalk requires ZeroNet 0.2.0, please update!&quot;]
 
 
<a href="#h6-2-3" id="h6-2-3" class="i">+	# All page content loaded
</a><a href="#h6-2-4" id="h6-2-4" class="i">+	onPageLoaded: -&gt;
</a><a href="#h6-2-5" id="h6-2-5" class="i">+		$(&quot;body&quot;).addClass(&quot;loaded&quot;) # Back/forward button keep position support
</a><a href="#h6-2-6" id="h6-2-6" class="i">+
</a><a href="#h6-2-7" id="h6-2-7" class="i">+
</a> 	routeUrl: (url) -&gt;
 		@log &quot;Routing url:&quot;, url
 		if match = url.match /Topic:([0-9]+)@([0-9]+)/
 			$(&quot;body&quot;).addClass(&quot;page-topic&quot;)
<a href="#h6-2-12" id="h6-2-12" class="d">-			@pageTopic parseInt(match[1]), parseInt(match[2])
</a><a href="#h6-2-13" id="h6-2-13" class="i">+			TopicShow.actionShow parseInt(match[1]), parseInt(match[2])
</a> 		else
 			$(&quot;body&quot;).addClass(&quot;page-main&quot;)
<a href="#h6-2-16" id="h6-2-16" class="d">-			@pageMain()
</a><a href="#h6-2-17" id="h6-2-17" class="d">-
</a><a href="#h6-2-18" id="h6-2-18" class="d">-
</a><a href="#h6-2-19" id="h6-2-19" class="d">-	# - Pages -
</a><a href="#h6-2-20" id="h6-2-20" class="d">-
</a><a href="#h6-2-21" id="h6-2-21" class="d">-
</a><a href="#h6-2-22" id="h6-2-22" class="d">-	pageMain: -&gt;
</a><a href="#h6-2-23" id="h6-2-23" class="d">-		$(&quot;.topics-loading&quot;).cssLater(&quot;top&quot;, &quot;0px&quot;, 200)
</a><a href="#h6-2-24" id="h6-2-24" class="d">-		@loadTopics(&quot;noanim&quot;)
</a><a href="#h6-2-25" id="h6-2-25" class="d">-
</a><a href="#h6-2-26" id="h6-2-26" class="d">-		# Show create new topic form
</a><a href="#h6-2-27" id="h6-2-27" class="d">-		$(&quot;.topic-new-link&quot;).on &quot;click&quot;, =&gt;
</a><a href="#h6-2-28" id="h6-2-28" class="d">-			$(&quot;.topic-new&quot;).fancySlideDown()
</a><a href="#h6-2-29" id="h6-2-29" class="d">-			$(&quot;.topic-new-link&quot;).slideUp()
</a><a href="#h6-2-30" id="h6-2-30" class="d">-			return false
</a><a href="#h6-2-31" id="h6-2-31" class="d">-
</a><a href="#h6-2-32" id="h6-2-32" class="d">-		# Create new topic
</a><a href="#h6-2-33" id="h6-2-33" class="d">-		$(&quot;.topic-new .button-submit&quot;).on &quot;click&quot;, =&gt;
</a><a href="#h6-2-34" id="h6-2-34" class="d">-			if @user_name_db[@site_info.auth_address] # Check if user exits
</a><a href="#h6-2-35" id="h6-2-35" class="d">-				@buttonCreateTopic()
</a><a href="#h6-2-36" id="h6-2-36" class="d">-			else
</a><a href="#h6-2-37" id="h6-2-37" class="d">-				@cmd &quot;wrapperNotification&quot;, [&quot;info&quot;, &quot;Please, request access before posting.&quot;]
</a><a href="#h6-2-38" id="h6-2-38" class="d">-			return false
</a><a href="#h6-2-39" id="h6-2-39" class="d">-
</a><a href="#h6-2-40" id="h6-2-40" class="d">-
</a><a href="#h6-2-41" id="h6-2-41" class="d">-
</a><a href="#h6-2-42" id="h6-2-42" class="d">-	loadTopics: (type=&quot;normal&quot;, cb=false) -&gt;
</a><a href="#h6-2-43" id="h6-2-43" class="d">-		s = (+ new Date)
</a><a href="#h6-2-44" id="h6-2-44" class="d">-		@cmd &quot;fileQuery&quot;, [&quot;data/users/*/data.json&quot;, &quot;topics&quot;], (topics) =&gt;
</a><a href="#h6-2-45" id="h6-2-45" class="d">-			topics.sort (a, b) -&gt; # Sort by date
</a><a href="#h6-2-46" id="h6-2-46" class="d">-				return a.added - b.added
</a><a href="#h6-2-47" id="h6-2-47" class="d">-			last_elem = null
</a><a href="#h6-2-48" id="h6-2-48" class="d">-
</a><a href="#h6-2-49" id="h6-2-49" class="d">-			for topic in topics
</a><a href="#h6-2-50" id="h6-2-50" class="d">-				topic_address = topic.topic_id + &quot;_&quot; + @user_id_db[topic.inner_path]
</a><a href="#h6-2-51" id="h6-2-51" class="d">-				elem = $(&quot;#topic_&quot;+topic_address)
</a><a href="#h6-2-52" id="h6-2-52" class="d">-				if elem.length == 0 # Create if not exits yet
</a><a href="#h6-2-53" id="h6-2-53" class="d">-					elem = $(&quot;.topics-list .topic.template&quot;).clone().removeClass(&quot;template&quot;).attr(&quot;id&quot;, &quot;topic_&quot;+topic_address)
</a><a href="#h6-2-54" id="h6-2-54" class="d">-					if type != &quot;noanim&quot;
</a><a href="#h6-2-55" id="h6-2-55" class="d">-						elem.cssSlideDown()
</a><a href="#h6-2-56" id="h6-2-56" class="d">-				@applyTopicData(elem, topic)
</a><a href="#h6-2-57" id="h6-2-57" class="d">-
</a><a href="#h6-2-58" id="h6-2-58" class="d">-				if last_elem # Add after last elem
</a><a href="#h6-2-59" id="h6-2-59" class="d">-					last_elem.after(elem)
</a><a href="#h6-2-60" id="h6-2-60" class="d">-				else # Add to top
</a><a href="#h6-2-61" id="h6-2-61" class="d">-					elem.prependTo(&quot;.topics&quot;)
</a><a href="#h6-2-62" id="h6-2-62" class="d">-			$(&quot;body&quot;).css({&quot;overflow&quot;: &quot;auto&quot;, &quot;height&quot;: &quot;auto&quot;}) # Auto height body
</a><a href="#h6-2-63" id="h6-2-63" class="d">-
</a><a href="#h6-2-64" id="h6-2-64" class="d">-			# Hide loading
</a><a href="#h6-2-65" id="h6-2-65" class="d">-
</a><a href="#h6-2-66" id="h6-2-66" class="d">-			if parseInt($(&quot;.topics-loading&quot;).css(&quot;top&quot;)) &gt; -30 # Loading visible, animate it
</a><a href="#h6-2-67" id="h6-2-67" class="d">-				$(&quot;.topics-loading&quot;).css(&quot;top&quot;, &quot;-30px&quot;)
</a><a href="#h6-2-68" id="h6-2-68" class="d">-			else
</a><a href="#h6-2-69" id="h6-2-69" class="d">-				$(&quot;.topics-loading&quot;).remove()
</a><a href="#h6-2-70" id="h6-2-70" class="d">-
</a><a href="#h6-2-71" id="h6-2-71" class="d">-			@log &quot;Topics loaded in&quot;, (+ new Date)-s
</a><a href="#h6-2-72" id="h6-2-72" class="d">-
</a><a href="#h6-2-73" id="h6-2-73" class="d">-			@addInlineEditors()
</a><a href="#h6-2-74" id="h6-2-74" class="d">-
</a><a href="#h6-2-75" id="h6-2-75" class="d">-			if @site_info.tasks == 0 # No tasks active, sort it now
</a><a href="#h6-2-76" id="h6-2-76" class="d">-				@loadTopicsStat(type)
</a><a href="#h6-2-77" id="h6-2-77" class="d">-			else # Workers active, wait 100ms before sort
</a><a href="#h6-2-78" id="h6-2-78" class="d">-				clearInterval(@thread_sorter)
</a><a href="#h6-2-79" id="h6-2-79" class="d">-				@thread_sorter = setTimeout (=&gt;
</a><a href="#h6-2-80" id="h6-2-80" class="d">-					@loadTopicsStat(type)
</a><a href="#h6-2-81" id="h6-2-81" class="d">-				), 100
</a><a href="#h6-2-82" id="h6-2-82" class="d">-
</a><a href="#h6-2-83" id="h6-2-83" class="d">-
</a><a href="#h6-2-84" id="h6-2-84" class="d">-			if cb then cb()
</a><a href="#h6-2-85" id="h6-2-85" class="d">-
</a><a href="#h6-2-86" id="h6-2-86" class="d">-
</a><a href="#h6-2-87" id="h6-2-87" class="d">-	# Load all user data to fill last comments
</a><a href="#h6-2-88" id="h6-2-88" class="d">-	loadTopicsStat: (type=&quot;normal&quot;) =&gt;
</a><a href="#h6-2-89" id="h6-2-89" class="d">-		s = (+ new Date)
</a><a href="#h6-2-90" id="h6-2-90" class="d">-		@cmd &quot;fileQuery&quot;, [&quot;data/users/*/data.json&quot;, &quot;&quot;], (users) =&gt;
</a><a href="#h6-2-91" id="h6-2-91" class="d">-			$(&quot;.topics&quot;).css(&quot;opacity&quot;, 1)
</a><a href="#h6-2-92" id="h6-2-92" class="d">-			stats = []
</a><a href="#h6-2-93" id="h6-2-93" class="d">-			# Analyze user data files
</a><a href="#h6-2-94" id="h6-2-94" class="d">-			for user in users
</a><a href="#h6-2-95" id="h6-2-95" class="d">-				for topic in user.topics
</a><a href="#h6-2-96" id="h6-2-96" class="d">-					user_id = @user_id_db[user.inner_path]
</a><a href="#h6-2-97" id="h6-2-97" class="d">-					topic_address = &quot;#{topic.topic_id}_#{user_id}&quot;
</a><a href="#h6-2-98" id="h6-2-98" class="d">-					if not stats[topic_address]?
</a><a href="#h6-2-99" id="h6-2-99" class="d">-						stats[topic_address] = {&quot;comments&quot;: 0, &quot;last&quot;: {&quot;added&quot;: topic.added}}
</a><a href="#h6-2-100" id="h6-2-100" class="d">-
</a><a href="#h6-2-101" id="h6-2-101" class="d">-				for topic_address, comments of user[&quot;comments&quot;]
</a><a href="#h6-2-102" id="h6-2-102" class="d">-					topic_address = topic_address.replace(&quot;@&quot;, &quot;_&quot;)
</a><a href="#h6-2-103" id="h6-2-103" class="d">-					for comment in comments
</a><a href="#h6-2-104" id="h6-2-104" class="d">-						stats[topic_address] ?= {&quot;comments&quot;: 0, &quot;last&quot;: null}
</a><a href="#h6-2-105" id="h6-2-105" class="d">-						last = stats[topic_address][&quot;last&quot;]
</a><a href="#h6-2-106" id="h6-2-106" class="d">-						stats[topic_address][&quot;comments&quot;] += 1
</a><a href="#h6-2-107" id="h6-2-107" class="d">-						if not last or comment[&quot;added&quot;] &gt; last[&quot;added&quot;]
</a><a href="#h6-2-108" id="h6-2-108" class="d">-							comment[&quot;auth_address&quot;] = user[&quot;inner_path&quot;]
</a><a href="#h6-2-109" id="h6-2-109" class="d">-							stats[topic_address][&quot;last&quot;] = comment
</a><a href="#h6-2-110" id="h6-2-110" class="d">-
</a><a href="#h6-2-111" id="h6-2-111" class="d">-			# Set html elements
</a><a href="#h6-2-112" id="h6-2-112" class="d">-			for topic_address, stat of stats
</a><a href="#h6-2-113" id="h6-2-113" class="d">-				if stat.comments &gt; 0
</a><a href="#h6-2-114" id="h6-2-114" class="d">-					$(&quot;#topic_#{topic_address} .comment-num&quot;).text &quot;#{stat.comments} comment&quot;
</a><a href="#h6-2-115" id="h6-2-115" class="d">-					$(&quot;#topic_#{topic_address} .added&quot;).text &quot;last &quot;+@formatSince(stat[&quot;last&quot;][&quot;added&quot;])
</a><a href="#h6-2-116" id="h6-2-116" class="d">-
</a><a href="#h6-2-117" id="h6-2-117" class="d">-
</a><a href="#h6-2-118" id="h6-2-118" class="d">-			# Sort topics
</a><a href="#h6-2-119" id="h6-2-119" class="d">-			topics = ([topic_address, stat.last.added] for topic_address, stat of stats)
</a><a href="#h6-2-120" id="h6-2-120" class="d">-			topics.sort (a, b) -&gt; # Sort by date
</a><a href="#h6-2-121" id="h6-2-121" class="d">-				return a[1] - b[1]
</a><a href="#h6-2-122" id="h6-2-122" class="d">-
</a><a href="#h6-2-123" id="h6-2-123" class="d">-			for topic in topics
</a><a href="#h6-2-124" id="h6-2-124" class="d">-				topic_address = topic[0]
</a><a href="#h6-2-125" id="h6-2-125" class="d">-				elem = $(&quot;#topic_#{topic_address}&quot;)
</a><a href="#h6-2-126" id="h6-2-126" class="d">-				elem.prependTo &quot;.topics&quot;
</a><a href="#h6-2-127" id="h6-2-127" class="d">-				# Visited
</a><a href="#h6-2-128" id="h6-2-128" class="d">-				visited = @local_storage[&quot;topic.#{topic_address}.visited&quot;]
</a><a href="#h6-2-129" id="h6-2-129" class="d">-				if not visited
</a><a href="#h6-2-130" id="h6-2-130" class="d">-					elem.addClass(&quot;visit-none&quot;)
</a><a href="#h6-2-131" id="h6-2-131" class="d">-				else if visited &lt; topic[1]
</a><a href="#h6-2-132" id="h6-2-132" class="d">-					elem.addClass(&quot;visit-newcomment&quot;)
</a><a href="#h6-2-133" id="h6-2-133" class="d">-
</a><a href="#h6-2-134" id="h6-2-134" class="d">-			@log &quot;Topics stats loaded in&quot;, (+ new Date)-s
</a><a href="#h6-2-135" id="h6-2-135" class="d">-
</a><a href="#h6-2-136" id="h6-2-136" class="d">-
</a><a href="#h6-2-137" id="h6-2-137" class="d">-
</a><a href="#h6-2-138" id="h6-2-138" class="d">-	pageTopic: (topic_id, topic_user_id) -&gt;
</a><a href="#h6-2-139" id="h6-2-139" class="d">-		@topic_id = topic_id
</a><a href="#h6-2-140" id="h6-2-140" class="d">-		@topic_user_id = topic_user_id
</a><a href="#h6-2-141" id="h6-2-141" class="d">-
</a><a href="#h6-2-142" id="h6-2-142" class="d">-		@loadTopic()
</a><a href="#h6-2-143" id="h6-2-143" class="d">-		@loadComments(&quot;noanim&quot;)
</a><a href="#h6-2-144" id="h6-2-144" class="d">-
</a><a href="#h6-2-145" id="h6-2-145" class="d">-		$(&quot;.comment-new .button-submit&quot;).on &quot;click&quot;, =&gt;
</a><a href="#h6-2-146" id="h6-2-146" class="d">-			if @user_name_db[@site_info.auth_address] # Check if user exits
</a><a href="#h6-2-147" id="h6-2-147" class="d">-				@buttonComment()
</a><a href="#h6-2-148" id="h6-2-148" class="d">-			else
</a><a href="#h6-2-149" id="h6-2-149" class="d">-				@cmd &quot;wrapperNotification&quot;, [&quot;info&quot;, &quot;Please, request access before posting.&quot;]
</a><a href="#h6-2-150" id="h6-2-150" class="d">-			return false
</a><a href="#h6-2-151" id="h6-2-151" class="d">-
</a><a href="#h6-2-152" id="h6-2-152" class="d">-
</a><a href="#h6-2-153" id="h6-2-153" class="d">-	loadTopic: (cb=false)-&gt;
</a><a href="#h6-2-154" id="h6-2-154" class="d">-		topic_user_address = @user_address_db[@topic_user_id]
</a><a href="#h6-2-155" id="h6-2-155" class="d">-		# Load topic data
</a><a href="#h6-2-156" id="h6-2-156" class="d">-		@cmd &quot;fileQuery&quot;, [&quot;data/users/#{topic_user_address}/data.json&quot;, &quot;topics.topic_id=#{@topic_id}&quot;], (topic) =&gt;
</a><a href="#h6-2-157" id="h6-2-157" class="d">-			topic = topic[0]
</a><a href="#h6-2-158" id="h6-2-158" class="d">-			topic[&quot;inner_path&quot;] = topic_user_address # add user address
</a><a href="#h6-2-159" id="h6-2-159" class="d">-			@applyTopicData($(&quot;.topic-full&quot;), topic, &quot;full&quot;)
</a><a href="#h6-2-160" id="h6-2-160" class="d">-			$(&quot;.topic-full&quot;).css(&quot;opacity&quot;, 1)
</a><a href="#h6-2-161" id="h6-2-161" class="d">-			#$(&quot;.username-my&quot;).text(@user_name_db[user_address])
</a><a href="#h6-2-162" id="h6-2-162" class="d">-			$(&quot;body&quot;).addClass(&quot;page-topic&quot;)
</a><a href="#h6-2-163" id="h6-2-163" class="d">-
</a><a href="#h6-2-164" id="h6-2-164" class="d">-			if cb then cb()
</a><a href="#h6-2-165" id="h6-2-165" class="d">-
</a><a href="#h6-2-166" id="h6-2-166" class="d">-
</a><a href="#h6-2-167" id="h6-2-167" class="d">-	loadComments: (type=&quot;normal&quot;, cb=false) -&gt;
</a><a href="#h6-2-168" id="h6-2-168" class="d">-		topic_address = @topic_id+&quot;@&quot;+@topic_user_id
</a><a href="#h6-2-169" id="h6-2-169" class="d">-
</a><a href="#h6-2-170" id="h6-2-170" class="d">-		# Update visited info
</a><a href="#h6-2-171" id="h6-2-171" class="d">-		@local_storage[&quot;topic.#{@topic_id}_#{@topic_user_id}.visited&quot;] = @timestamp()
</a><a href="#h6-2-172" id="h6-2-172" class="d">-		@cmd &quot;wrapperSetLocalStorage&quot;, @local_storage
</a><a href="#h6-2-173" id="h6-2-173" class="d">-
</a><a href="#h6-2-174" id="h6-2-174" class="d">-		# Load comments
</a><a href="#h6-2-175" id="h6-2-175" class="d">-		@cmd &quot;fileQuery&quot;, [&quot;data/users/*/data.json&quot;, &quot;comments.#{topic_address}&quot;], (comments) =&gt;
</a><a href="#h6-2-176" id="h6-2-176" class="d">-			comments.sort (a, b) -&gt; # Sort by date desc
</a><a href="#h6-2-177" id="h6-2-177" class="d">-				return b.added - a.added
</a><a href="#h6-2-178" id="h6-2-178" class="d">-
</a><a href="#h6-2-179" id="h6-2-179" class="d">-			for comment in comments
</a><a href="#h6-2-180" id="h6-2-180" class="d">-				comment_address = &quot;#{comment.comment_id}_#{comment.inner_path}&quot;
</a><a href="#h6-2-181" id="h6-2-181" class="d">-				elem = $(&quot;#comment_&quot;+comment_address)
</a><a href="#h6-2-182" id="h6-2-182" class="d">-				if elem.length == 0# Create if not exits
</a><a href="#h6-2-183" id="h6-2-183" class="d">-					elem = $(&quot;.comment.template&quot;).clone().removeClass(&quot;template&quot;).attr(&quot;id&quot;, &quot;comment_&quot;+comment_address).data(&quot;topic_address&quot;, topic_address)
</a><a href="#h6-2-184" id="h6-2-184" class="d">-					if type != &quot;noanim&quot;
</a><a href="#h6-2-185" id="h6-2-185" class="d">-						elem.cssSlideDown()
</a><a href="#h6-2-186" id="h6-2-186" class="d">-				@applyCommentData(elem, comment)
</a><a href="#h6-2-187" id="h6-2-187" class="d">-				elem.appendTo(&quot;.comments&quot;)
</a><a href="#h6-2-188" id="h6-2-188" class="d">-
</a><a href="#h6-2-189" id="h6-2-189" class="d">-			$(&quot;body&quot;).css({&quot;overflow&quot;: &quot;auto&quot;, &quot;height&quot;: &quot;auto&quot;})
</a><a href="#h6-2-190" id="h6-2-190" class="d">-
</a><a href="#h6-2-191" id="h6-2-191" class="d">-			@addInlineEditors()
</a><a href="#h6-2-192" id="h6-2-192" class="d">-
</a><a href="#h6-2-193" id="h6-2-193" class="d">-			if cb then cb()
</a><a href="#h6-2-194" id="h6-2-194" class="d">-
</a><a href="#h6-2-195" id="h6-2-195" class="d">-
</a><a href="#h6-2-196" id="h6-2-196" class="d">-	# - EOF Pages -
</a><a href="#h6-2-197" id="h6-2-197" class="d">-
</a><a href="#h6-2-198" id="h6-2-198" class="d">-
</a><a href="#h6-2-199" id="h6-2-199" class="d">-	# Update elem based on data of topic dict
</a><a href="#h6-2-200" id="h6-2-200" class="d">-	applyTopicData: (elem, topic, type=&quot;normal&quot;) -&gt;
</a><a href="#h6-2-201" id="h6-2-201" class="d">-		title_hash = topic.title.replace(/[#,&quot;&apos;?&amp; ]/g, &quot;+&quot;).replace(/[+]+/g, &quot;+&quot;).replace(/[+]+$/, &quot;&quot;)
</a><a href="#h6-2-202" id="h6-2-202" class="d">-		user_id = @user_id_db[topic.inner_path]
</a><a href="#h6-2-203" id="h6-2-203" class="d">-		$(&quot;.title .title-link&quot;, elem).text(topic.title)
</a><a href="#h6-2-204" id="h6-2-204" class="d">-		$(&quot;.title .title-link, a.image, .comment-num&quot;, elem).attr(&quot;href&quot;, &quot;?Topic:#{topic.topic_id}@#{user_id}/#{title_hash}&quot;)
</a><a href="#h6-2-205" id="h6-2-205" class="d">-
</a><a href="#h6-2-206" id="h6-2-206" class="d">-		# Get links in body
</a><a href="#h6-2-207" id="h6-2-207" class="d">-		body = topic.body
</a><a href="#h6-2-208" id="h6-2-208" class="d">-		match = topic.body.match /http[s]{0,1}:\/\/[^&quot;&apos;, $]+/
</a><a href="#h6-2-209" id="h6-2-209" class="d">-		if match # Link type topic
</a><a href="#h6-2-210" id="h6-2-210" class="d">-			if type != &quot;full&quot; then body = body.replace /http[s]{0,1}:\/\/[^&quot;&apos; $]+/g, &quot;&quot; # Remove links
</a><a href="#h6-2-211" id="h6-2-211" class="d">-			$(&quot;.image .icon&quot;, elem).removeClass(&quot;icon-topic-chat&quot;).addClass(&quot;icon-topic-link&quot;)
</a><a href="#h6-2-212" id="h6-2-212" class="d">-			$(&quot;.link&quot;, elem).css(&quot;display&quot;, &quot;&quot;).attr(&quot;href&quot;, match[0])
</a><a href="#h6-2-213" id="h6-2-213" class="d">-			$(&quot;.link .link-url&quot;, elem).text(match[0])
</a><a href="#h6-2-214" id="h6-2-214" class="d">-		else # Normal type topic
</a><a href="#h6-2-215" id="h6-2-215" class="d">-			$(&quot;.image .icon&quot;, elem).removeClass(&quot;icon-topic-link&quot;).addClass(&quot;icon-topic-chat&quot;)
</a><a href="#h6-2-216" id="h6-2-216" class="d">-			$(&quot;.link&quot;, elem).css(&quot;display&quot;, &quot;none&quot;)
</a><a href="#h6-2-217" id="h6-2-217" class="d">-
</a><a href="#h6-2-218" id="h6-2-218" class="d">-		if type == &quot;full&quot; # Markdon syntax at topic page
</a><a href="#h6-2-219" id="h6-2-219" class="d">-			$(&quot;.body&quot;, elem).html marked(body, {&quot;sanitize&quot;: true})
</a><a href="#h6-2-220" id="h6-2-220" class="d">-		else
</a><a href="#h6-2-221" id="h6-2-221" class="d">-			$(&quot;.body&quot;, elem).text body
</a><a href="#h6-2-222" id="h6-2-222" class="d">-
</a><a href="#h6-2-223" id="h6-2-223" class="d">-		username = @user_name_db[topic.inner_path]
</a><a href="#h6-2-224" id="h6-2-224" class="d">-		$(&quot;.username&quot;, elem).text(username)
</a><a href="#h6-2-225" id="h6-2-225" class="d">-		$(&quot;.added&quot;, elem).text @formatSince(topic.added)
</a><a href="#h6-2-226" id="h6-2-226" class="d">-
</a><a href="#h6-2-227" id="h6-2-227" class="d">-		# My topic
</a><a href="#h6-2-228" id="h6-2-228" class="d">-		if topic.inner_path == @site_info.auth_address
</a><a href="#h6-2-229" id="h6-2-229" class="d">-			$(elem).attr(&quot;data-object&quot;, &quot;Topic:#{topic.topic_id}@#{user_id}&quot;).attr(&quot;data-deletable&quot;, &quot;yes&quot;)
</a><a href="#h6-2-230" id="h6-2-230" class="d">-			$(&quot;.title .title-link&quot;, elem).attr(&quot;data-editable&quot;, &quot;title&quot;).data(&quot;content&quot;, topic.title)
</a><a href="#h6-2-231" id="h6-2-231" class="d">-			$(&quot;.body&quot;, elem).attr(&quot;data-editable&quot;, &quot;body&quot;).data(&quot;content&quot;, topic.body)
</a><a href="#h6-2-232" id="h6-2-232" class="d">-
</a><a href="#h6-2-233" id="h6-2-233" class="d">-
</a><a href="#h6-2-234" id="h6-2-234" class="d">-	textToColor: (text) =&gt;
</a><a href="#h6-2-235" id="h6-2-235" class="d">-		hash = 0
</a><a href="#h6-2-236" id="h6-2-236" class="d">-		for i in [0..text.length-1]
</a><a href="#h6-2-237" id="h6-2-237" class="d">-			hash = text.charCodeAt(i) + ((hash &lt;&lt; 5) - hash)
</a><a href="#h6-2-238" id="h6-2-238" class="d">-		color = &apos;#&apos;
</a><a href="#h6-2-239" id="h6-2-239" class="d">-		return &quot;hsl(&quot; + (hash % 360) + &quot;,30%,50%)&quot;;
</a><a href="#h6-2-240" id="h6-2-240" class="d">-		for i in [0..2]
</a><a href="#h6-2-241" id="h6-2-241" class="d">-			value = (hash &gt;&gt; (i * 8)) &amp; 0xFF
</a><a href="#h6-2-242" id="h6-2-242" class="d">-			color += (&apos;00&apos; + value.toString(16)).substr(-2)
</a><a href="#h6-2-243" id="h6-2-243" class="d">-		return color
</a><a href="#h6-2-244" id="h6-2-244" class="d">-
</a><a href="#h6-2-245" id="h6-2-245" class="d">-
</a><a href="#h6-2-246" id="h6-2-246" class="d">-	# Update elem based on data of comment dict
</a><a href="#h6-2-247" id="h6-2-247" class="d">-	applyCommentData: (elem, comment) -&gt;
</a><a href="#h6-2-248" id="h6-2-248" class="d">-		username = @user_name_db[comment.inner_path]
</a><a href="#h6-2-249" id="h6-2-249" class="d">-		$(&quot;.body&quot;, elem).html(marked(comment.body, {&quot;sanitize&quot;: true}))
</a><a href="#h6-2-250" id="h6-2-250" class="d">-		$(&quot;.username&quot;, elem).text(username).css(&quot;color&quot;: @textToColor(username))
</a><a href="#h6-2-251" id="h6-2-251" class="d">-		$(&quot;.added&quot;, elem).text @formatSince(comment.added)
</a><a href="#h6-2-252" id="h6-2-252" class="d">-		# elem.css(&quot;border-left&quot;, &quot;2px solid #{@textToColor(username)}&quot;)
</a><a href="#h6-2-253" id="h6-2-253" class="d">-
</a><a href="#h6-2-254" id="h6-2-254" class="d">-
</a><a href="#h6-2-255" id="h6-2-255" class="d">-		# My comment
</a><a href="#h6-2-256" id="h6-2-256" class="d">-		if comment.inner_path == @site_info.auth_address
</a><a href="#h6-2-257" id="h6-2-257" class="d">-			user_id = @user_id_db[comment.inner_path]
</a><a href="#h6-2-258" id="h6-2-258" class="d">-			comment_id = elem.attr(&quot;id&quot;).replace(&quot;comment_&quot;, &quot;&quot;).replace(/_.*$/, &quot;&quot;)
</a><a href="#h6-2-259" id="h6-2-259" class="d">-			topic_address = elem.data(&quot;topic_address&quot;)
</a><a href="#h6-2-260" id="h6-2-260" class="d">-			$(elem).attr(&quot;data-object&quot;, &quot;Comment:#{comment_id}@#{topic_address}&quot;).attr(&quot;data-deletable&quot;, &quot;yes&quot;)
</a><a href="#h6-2-261" id="h6-2-261" class="d">-			$(&quot;.body&quot;, elem).attr(&quot;data-editable&quot;, &quot;body&quot;).data(&quot;content&quot;, comment.body)
</a><a href="#h6-2-262" id="h6-2-262" class="i">+			TopicList.actionList()
</a> 
 
 	addInlineEditors: -&gt;
<a href="#h6-3" id="h6-3" class="h">@@ -377,10 +130,10 @@ class ZeroTalk extends ZeroFrame
</a> 						elem.fancySlideUp()
 					else # Update
 						if type == &quot;Topic&quot;
<a href="#h6-3-3" id="h6-3-3" class="d">-							if $(&quot;body&quot;).hasClass(&quot;page-main&quot;) then @loadTopics &quot;normal&quot;, ( -&gt; if cb then cb(true) )
</a><a href="#h6-3-4" id="h6-3-4" class="d">-							if $(&quot;body&quot;).hasClass(&quot;page-topic&quot;) then @loadTopic ( -&gt; if cb then cb(true) )
</a><a href="#h6-3-5" id="h6-3-5" class="i">+							if $(&quot;body&quot;).hasClass(&quot;page-main&quot;) then TopicList.loadTopics &quot;normal&quot;, ( -&gt; if cb then cb(true) )
</a><a href="#h6-3-6" id="h6-3-6" class="i">+							if $(&quot;body&quot;).hasClass(&quot;page-topic&quot;) then TopicShow.loadTopic ( -&gt; if cb then cb(true) )
</a> 						if type == &quot;Comment&quot;
<a href="#h6-3-8" id="h6-3-8" class="d">-							@loadComments &quot;normal&quot;, ( -&gt; if cb then cb(true) )
</a><a href="#h6-3-9" id="h6-3-9" class="i">+							TopicShow.loadComments &quot;normal&quot;, ( -&gt; if cb then cb(true) )
</a> 				else
 					if cb then cb(false)
 
<a href="#h6-4" id="h6-4" class="h">@@ -409,7 +162,7 @@ class ZeroTalk extends ZeroFrame
</a> 				$(&quot;.button.signup&quot;).removeClass(&quot;loading&quot;) 
 
 			$(&quot;.head-user.registered&quot;).css(&quot;display&quot;, &quot;&quot;)
<a href="#h6-4-3" id="h6-4-3" class="d">-			$(&quot;.username-my&quot;).text(user_name).css(&quot;color&quot;, @textToColor(user_name))
</a><a href="#h6-4-4" id="h6-4-4" class="i">+			$(&quot;.username-my&quot;).text(user_name).css(&quot;color&quot;, Text.toColor(user_name))
</a> 			@cmd &quot;fileGet&quot;, [&quot;data/users/#{address}/content.json&quot;], (content) =&gt;
 				content = JSON.parse(content)
 				sum = 0
<a href="#h6-5" id="h6-5" class="h">@@ -425,7 +178,7 @@ class ZeroTalk extends ZeroFrame
</a> 
 
 	buttonSignup: -&gt;
<a href="#h6-5-3" id="h6-5-3" class="d">-		if not @needOpenPort() then return false
</a><a href="#h6-5-4" id="h6-5-4" class="i">+		if not @hasOpenPort() then return false
</a> 
 		@cmd &quot;wrapperPrompt&quot;, [&quot;Username you want to register:&quot;], (user_name) =&gt; # Prompt the username
 			$(&quot;.button.signup&quot;).addClass(&quot;loading&quot;) 
<a href="#h6-6" id="h6-6" class="h">@@ -437,68 +190,6 @@ class ZeroTalk extends ZeroFrame
</a> 					@cmd &quot;wrapperNotification&quot;, [&quot;error&quot;, &quot;Error: #{res.responseText}&quot;]
 
 
<a href="#h6-6-3" id="h6-6-3" class="d">-	buttonCreateTopic: -&gt;
</a><a href="#h6-6-4" id="h6-6-4" class="d">-		if not @needOpenPort() then return false
</a><a href="#h6-6-5" id="h6-6-5" class="d">-
</a><a href="#h6-6-6" id="h6-6-6" class="d">-		title = $(&quot;.topic-new #topic_title&quot;).val()
</a><a href="#h6-6-7" id="h6-6-7" class="d">-		body = $(&quot;.topic-new #topic_body&quot;).val()
</a><a href="#h6-6-8" id="h6-6-8" class="d">-		#if not body then return $(&quot;.topic-new #topic_body&quot;).focus()
</a><a href="#h6-6-9" id="h6-6-9" class="d">-		if not title then return $(&quot;.topic-new #topic_title&quot;).focus()
</a><a href="#h6-6-10" id="h6-6-10" class="d">-
</a><a href="#h6-6-11" id="h6-6-11" class="d">-		$(&quot;.topic-new .button-submit&quot;).addClass(&quot;loading&quot;)
</a><a href="#h6-6-12" id="h6-6-12" class="d">-		inner_path = &quot;data/users/#{@site_info.auth_address}/data.json&quot;
</a><a href="#h6-6-13" id="h6-6-13" class="d">-		@cmd &quot;fileGet&quot;, [inner_path], (data) =&gt;
</a><a href="#h6-6-14" id="h6-6-14" class="d">-			data = JSON.parse(data)
</a><a href="#h6-6-15" id="h6-6-15" class="d">-			data.topics.push {
</a><a href="#h6-6-16" id="h6-6-16" class="d">-				&quot;topic_id&quot;: data.next_topic_id,
</a><a href="#h6-6-17" id="h6-6-17" class="d">-				&quot;title&quot;: title,
</a><a href="#h6-6-18" id="h6-6-18" class="d">-				&quot;body&quot;: body,
</a><a href="#h6-6-19" id="h6-6-19" class="d">-				&quot;added&quot;: @timestamp()
</a><a href="#h6-6-20" id="h6-6-20" class="d">-			}
</a><a href="#h6-6-21" id="h6-6-21" class="d">-			data.next_topic_id += 1
</a><a href="#h6-6-22" id="h6-6-22" class="d">-			@writePublish inner_path, @jsonEncode(data), (res) =&gt;
</a><a href="#h6-6-23" id="h6-6-23" class="d">-				$(&quot;.topic-new .button-submit&quot;).removeClass(&quot;loading&quot;)
</a><a href="#h6-6-24" id="h6-6-24" class="d">-				if res == true
</a><a href="#h6-6-25" id="h6-6-25" class="d">-					@log &quot;File written&quot;
</a><a href="#h6-6-26" id="h6-6-26" class="d">-					$(&quot;.topic-new&quot;).slideUp()
</a><a href="#h6-6-27" id="h6-6-27" class="d">-					$(&quot;.topic-new-link&quot;).slideDown()
</a><a href="#h6-6-28" id="h6-6-28" class="d">-					setTimeout (=&gt;
</a><a href="#h6-6-29" id="h6-6-29" class="d">-						@loadTopics()
</a><a href="#h6-6-30" id="h6-6-30" class="d">-					), 600
</a><a href="#h6-6-31" id="h6-6-31" class="d">-					$(&quot;.topic-new #topic_body&quot;).val(&quot;&quot;)
</a><a href="#h6-6-32" id="h6-6-32" class="d">-					$(&quot;.topic-new #topic_title&quot;).val(&quot;&quot;)
</a><a href="#h6-6-33" id="h6-6-33" class="d">-
</a><a href="#h6-6-34" id="h6-6-34" class="d">-				else
</a><a href="#h6-6-35" id="h6-6-35" class="d">-					@cmd &quot;wrapperNotification&quot;, [&quot;error&quot;, &quot;File write error: #{res}&quot;]
</a><a href="#h6-6-36" id="h6-6-36" class="d">-
</a><a href="#h6-6-37" id="h6-6-37" class="d">-
</a><a href="#h6-6-38" id="h6-6-38" class="d">-	buttonComment: -&gt;
</a><a href="#h6-6-39" id="h6-6-39" class="d">-		if not @needOpenPort() then return false
</a><a href="#h6-6-40" id="h6-6-40" class="d">-
</a><a href="#h6-6-41" id="h6-6-41" class="d">-		body = $(&quot;.comment-new #comment_body&quot;).val()
</a><a href="#h6-6-42" id="h6-6-42" class="d">-		if not body then $(&quot;.comment-new #comment_body&quot;).focus()
</a><a href="#h6-6-43" id="h6-6-43" class="d">-		topic_address = @topic_id+&quot;@&quot;+@topic_user_id
</a><a href="#h6-6-44" id="h6-6-44" class="d">-
</a><a href="#h6-6-45" id="h6-6-45" class="d">-		$(&quot;.comment-new .button-submit&quot;).addClass(&quot;loading&quot;)
</a><a href="#h6-6-46" id="h6-6-46" class="d">-		inner_path = &quot;data/users/#{@site_info.auth_address}/data.json&quot;
</a><a href="#h6-6-47" id="h6-6-47" class="d">-		@cmd &quot;fileGet&quot;, [inner_path], (data) =&gt;
</a><a href="#h6-6-48" id="h6-6-48" class="d">-			data = JSON.parse(data)
</a><a href="#h6-6-49" id="h6-6-49" class="d">-			data.comments[topic_address] ?= []
</a><a href="#h6-6-50" id="h6-6-50" class="d">-			data.comments[topic_address].push {
</a><a href="#h6-6-51" id="h6-6-51" class="d">-				&quot;comment_id&quot;: data.next_message_id, 
</a><a href="#h6-6-52" id="h6-6-52" class="d">-				&quot;body&quot;: body,
</a><a href="#h6-6-53" id="h6-6-53" class="d">-				&quot;added&quot;: @timestamp()
</a><a href="#h6-6-54" id="h6-6-54" class="d">-			}
</a><a href="#h6-6-55" id="h6-6-55" class="d">-			data.next_message_id += 1
</a><a href="#h6-6-56" id="h6-6-56" class="d">-			@writePublish inner_path, @jsonEncode(data), (res) =&gt;
</a><a href="#h6-6-57" id="h6-6-57" class="d">-				$(&quot;.comment-new .button-submit&quot;).removeClass(&quot;loading&quot;)
</a><a href="#h6-6-58" id="h6-6-58" class="d">-				if res == true
</a><a href="#h6-6-59" id="h6-6-59" class="d">-					@log &quot;File written&quot;
</a><a href="#h6-6-60" id="h6-6-60" class="d">-					@loadComments()
</a><a href="#h6-6-61" id="h6-6-61" class="d">-					$(&quot;.comment-new #comment_body&quot;).val(&quot;&quot;)
</a><a href="#h6-6-62" id="h6-6-62" class="d">-
</a><a href="#h6-6-63" id="h6-6-63" class="d">-
</a><a href="#h6-6-64" id="h6-6-64" class="d">-
</a> 	jsonEncode: (obj) -&gt;
 		return btoa(unescape(encodeURIComponent(JSON.stringify(obj, undefined, &apos;\t&apos;))))
 
<a href="#h6-7" id="h6-7" class="h">@@ -517,51 +208,14 @@ class ZeroTalk extends ZeroFrame
</a> 					cb(res)
 
 					
<a href="#h6-7-3" id="h6-7-3" class="d">-	needOpenPort: -&gt;
</a><a href="#h6-7-4" id="h6-7-4" class="i">+	hasOpenPort: -&gt;
</a> 		if @server_info.ip_external 
 			return true
 		else # No port open
<a href="#h6-7-8" id="h6-7-8" class="d">-			@cmd &quot;wrapperNotification&quot;, [&quot;error&quot;, &quot;To signup please open port &lt;b&gt;#{@server_info.fileserver_port}&lt;/b&gt; on your router&quot;]
</a><a href="#h6-7-9" id="h6-7-9" class="i">+			@cmd &quot;wrapperNotification&quot;, [&quot;error&quot;, &quot;To publish new content please open port &lt;b&gt;#{@server_info.fileserver_port}&lt;/b&gt; on your router&quot;]
</a> 			return false
 
 
<a href="#h6-7-13" id="h6-7-13" class="d">-
</a><a href="#h6-7-14" id="h6-7-14" class="d">-
</a><a href="#h6-7-15" id="h6-7-15" class="d">-	# - Date -
</a><a href="#h6-7-16" id="h6-7-16" class="d">-
</a><a href="#h6-7-17" id="h6-7-17" class="d">-	formatSince: (time) -&gt;
</a><a href="#h6-7-18" id="h6-7-18" class="d">-		now = +(new Date)/1000
</a><a href="#h6-7-19" id="h6-7-19" class="d">-		secs = now - time
</a><a href="#h6-7-20" id="h6-7-20" class="d">-		if secs &lt; 60
</a><a href="#h6-7-21" id="h6-7-21" class="d">-			back = &quot;Just now&quot;
</a><a href="#h6-7-22" id="h6-7-22" class="d">-		else if secs &lt; 60*60
</a><a href="#h6-7-23" id="h6-7-23" class="d">-			back = &quot;#{Math.round(secs/60)} minutes ago&quot;
</a><a href="#h6-7-24" id="h6-7-24" class="d">-		else if secs &lt; 60*60*24
</a><a href="#h6-7-25" id="h6-7-25" class="d">-			back = &quot;#{Math.round(secs/60/60)} hours ago&quot;
</a><a href="#h6-7-26" id="h6-7-26" class="d">-		else if secs &lt; 60*60*24*3
</a><a href="#h6-7-27" id="h6-7-27" class="d">-			back = &quot;#{Math.round(secs/60/60/24)} days ago&quot;
</a><a href="#h6-7-28" id="h6-7-28" class="d">-		else
</a><a href="#h6-7-29" id="h6-7-29" class="d">-			back = &quot;on &quot;+@formatDate(time)
</a><a href="#h6-7-30" id="h6-7-30" class="d">-		back = back.replace(/1 ([a-z]+)s/, &quot;1 $1&quot;) # 1 days ago fix
</a><a href="#h6-7-31" id="h6-7-31" class="d">-		return back
</a><a href="#h6-7-32" id="h6-7-32" class="d">-
</a><a href="#h6-7-33" id="h6-7-33" class="d">-
</a><a href="#h6-7-34" id="h6-7-34" class="d">-	formatDate: (timestamp, format=&quot;short&quot;) -&gt;
</a><a href="#h6-7-35" id="h6-7-35" class="d">-		parts = (new Date(timestamp*1000)).toString().split(&quot; &quot;)
</a><a href="#h6-7-36" id="h6-7-36" class="d">-		if format == &quot;short&quot;
</a><a href="#h6-7-37" id="h6-7-37" class="d">-			display = parts.slice(1, 4)
</a><a href="#h6-7-38" id="h6-7-38" class="d">-		else
</a><a href="#h6-7-39" id="h6-7-39" class="d">-			display = parts.slice(1, 5)
</a><a href="#h6-7-40" id="h6-7-40" class="d">-		return display.join(&quot; &quot;).replace(/( [0-9]{4})/, &quot;,$1&quot;)
</a><a href="#h6-7-41" id="h6-7-41" class="d">-
</a><a href="#h6-7-42" id="h6-7-42" class="d">-
</a><a href="#h6-7-43" id="h6-7-43" class="d">-	timestamp: (date=&quot;&quot;) -&gt;
</a><a href="#h6-7-44" id="h6-7-44" class="d">-		if date == &quot;now&quot; or date == &quot;&quot;
</a><a href="#h6-7-45" id="h6-7-45" class="d">-			return parseInt(+(new Date)/1000)
</a><a href="#h6-7-46" id="h6-7-46" class="d">-		else
</a><a href="#h6-7-47" id="h6-7-47" class="d">-			return parseInt(Date.parse(date)/1000)
</a><a href="#h6-7-48" id="h6-7-48" class="d">-
</a><a href="#h6-7-49" id="h6-7-49" class="d">-
</a> 	# Route incoming requests
 	route: (cmd, message) -&gt;
 		if cmd == &quot;setSiteInfo&quot; # Site updated
<a href="#h6-8" id="h6-8" class="h">@@ -580,10 +234,10 @@ class ZeroTalk extends ZeroFrame
</a> 		if res.params.event and res.params.event[0] == &quot;file_done&quot; and res.params.event[1].match /.*users.*data.json$/  # Data changed
 			LimitRate (=&gt;
 				if $(&quot;body&quot;).hasClass(&quot;page-topic&quot;)
<a href="#h6-8-3" id="h6-8-3" class="d">-					@loadTopic()
</a><a href="#h6-8-4" id="h6-8-4" class="d">-					@loadComments()
</a><a href="#h6-8-5" id="h6-8-5" class="i">+					TopicShow.loadTopic()
</a><a href="#h6-8-6" id="h6-8-6" class="i">+					TopicShow.loadComments()
</a> 				if $(&quot;body&quot;).hasClass(&quot;page-main&quot;)
<a href="#h6-8-8" id="h6-8-8" class="d">-					@loadTopics()
</a><a href="#h6-8-9" id="h6-8-9" class="i">+					TopicList.loadTopics()
</a> 			), 500
 
 
<a href="#h6-9" id="h6-9" class="h">@@ -614,16 +268,5 @@ class ZeroTalk extends ZeroFrame
</a> 		if elem.height() &gt; 0 then elem.trigger &quot;input&quot;
 		else elem.height(&quot;48px&quot;)
 
<a href="#h6-9-3" id="h6-9-3" class="d">-		# Tab key support
</a><a href="#h6-9-4" id="h6-9-4" class="d">-		###
</a><a href="#h6-9-5" id="h6-9-5" class="d">-		elem.on &apos;keydown&apos;, (e) -&gt;
</a><a href="#h6-9-6" id="h6-9-6" class="d">-			if e.which == 9
</a><a href="#h6-9-7" id="h6-9-7" class="d">-				e.preventDefault()
</a><a href="#h6-9-8" id="h6-9-8" class="d">-				s = this.selectionStart
</a><a href="#h6-9-9" id="h6-9-9" class="d">-				val = elem.val()
</a><a href="#h6-9-10" id="h6-9-10" class="d">-				elem.val(val.substring(0,this.selectionStart) + &quot;\t&quot; + val.substring(this.selectionEnd))
</a><a href="#h6-9-11" id="h6-9-11" class="d">-				this.selectionEnd = s+1; 
</a><a href="#h6-9-12" id="h6-9-12" class="d">-		###
</a><a href="#h6-9-13" id="h6-9-13" class="d">-
</a> 
<a href="#h6-9-15" id="h6-9-15" class="d">-window.zero_talk = new ZeroTalk()
</a><a href="#h6-9-16" id="h6-9-16" class="i">+window.Page = new ZeroTalk()
</a><b>diff --git a/<a id="h7" href="../file/js/all.js.html">js/all.js</a> b/<a href="../file/js/all.js.html">js/all.js</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -10,142 +10,6 @@
</a> 
 
 
<a href="#h7-0-3" id="h7-0-3" class="d">-/* ---- data/1TaLk3zM7ZRskJvrh3ZNCDVGXvkJusPKQ/js/lib/LimitRate.coffee ---- */
</a><a href="#h7-0-4" id="h7-0-4" class="d">-
</a><a href="#h7-0-5" id="h7-0-5" class="d">-
</a><a href="#h7-0-6" id="h7-0-6" class="d">-(function() {
</a><a href="#h7-0-7" id="h7-0-7" class="d">-  var limits;
</a><a href="#h7-0-8" id="h7-0-8" class="d">-
</a><a href="#h7-0-9" id="h7-0-9" class="d">-  limits = {};
</a><a href="#h7-0-10" id="h7-0-10" class="d">-
</a><a href="#h7-0-11" id="h7-0-11" class="d">-  window.LimitRate = function(fn, interval) {
</a><a href="#h7-0-12" id="h7-0-12" class="d">-    if (!limits[fn]) {
</a><a href="#h7-0-13" id="h7-0-13" class="d">-      return limits[fn] = setTimeout((function() {
</a><a href="#h7-0-14" id="h7-0-14" class="d">-        fn();
</a><a href="#h7-0-15" id="h7-0-15" class="d">-        return delete limits[fn];
</a><a href="#h7-0-16" id="h7-0-16" class="d">-      }), interval);
</a><a href="#h7-0-17" id="h7-0-17" class="d">-    }
</a><a href="#h7-0-18" id="h7-0-18" class="d">-  };
</a><a href="#h7-0-19" id="h7-0-19" class="d">-
</a><a href="#h7-0-20" id="h7-0-20" class="d">-}).call(this);
</a><a href="#h7-0-21" id="h7-0-21" class="d">-
</a><a href="#h7-0-22" id="h7-0-22" class="d">-
</a><a href="#h7-0-23" id="h7-0-23" class="d">-
</a><a href="#h7-0-24" id="h7-0-24" class="d">-/* ---- data/1TaLk3zM7ZRskJvrh3ZNCDVGXvkJusPKQ/js/lib/ZeroFrame.coffee ---- */
</a><a href="#h7-0-25" id="h7-0-25" class="d">-
</a><a href="#h7-0-26" id="h7-0-26" class="d">-
</a><a href="#h7-0-27" id="h7-0-27" class="d">-(function() {
</a><a href="#h7-0-28" id="h7-0-28" class="d">-  var ZeroFrame,
</a><a href="#h7-0-29" id="h7-0-29" class="d">-    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
</a><a href="#h7-0-30" id="h7-0-30" class="d">-    __slice = [].slice;
</a><a href="#h7-0-31" id="h7-0-31" class="d">-
</a><a href="#h7-0-32" id="h7-0-32" class="d">-  ZeroFrame = (function() {
</a><a href="#h7-0-33" id="h7-0-33" class="d">-    function ZeroFrame(url) {
</a><a href="#h7-0-34" id="h7-0-34" class="d">-      this.onCloseWebsocket = __bind(this.onCloseWebsocket, this);
</a><a href="#h7-0-35" id="h7-0-35" class="d">-      this.onOpenWebsocket = __bind(this.onOpenWebsocket, this);
</a><a href="#h7-0-36" id="h7-0-36" class="d">-      this.route = __bind(this.route, this);
</a><a href="#h7-0-37" id="h7-0-37" class="d">-      this.onMessage = __bind(this.onMessage, this);
</a><a href="#h7-0-38" id="h7-0-38" class="d">-      this.url = url;
</a><a href="#h7-0-39" id="h7-0-39" class="d">-      this.waiting_cb = {};
</a><a href="#h7-0-40" id="h7-0-40" class="d">-      this.connect();
</a><a href="#h7-0-41" id="h7-0-41" class="d">-      this.next_message_id = 1;
</a><a href="#h7-0-42" id="h7-0-42" class="d">-      this.init();
</a><a href="#h7-0-43" id="h7-0-43" class="d">-    }
</a><a href="#h7-0-44" id="h7-0-44" class="d">-
</a><a href="#h7-0-45" id="h7-0-45" class="d">-    ZeroFrame.prototype.init = function() {
</a><a href="#h7-0-46" id="h7-0-46" class="d">-      return this;
</a><a href="#h7-0-47" id="h7-0-47" class="d">-    };
</a><a href="#h7-0-48" id="h7-0-48" class="d">-
</a><a href="#h7-0-49" id="h7-0-49" class="d">-    ZeroFrame.prototype.connect = function() {
</a><a href="#h7-0-50" id="h7-0-50" class="d">-      this.target = window.parent;
</a><a href="#h7-0-51" id="h7-0-51" class="d">-      window.addEventListener(&quot;message&quot;, this.onMessage, false);
</a><a href="#h7-0-52" id="h7-0-52" class="d">-      return this.cmd(&quot;innerReady&quot;);
</a><a href="#h7-0-53" id="h7-0-53" class="d">-    };
</a><a href="#h7-0-54" id="h7-0-54" class="d">-
</a><a href="#h7-0-55" id="h7-0-55" class="d">-    ZeroFrame.prototype.onMessage = function(e) {
</a><a href="#h7-0-56" id="h7-0-56" class="d">-      var cmd, message;
</a><a href="#h7-0-57" id="h7-0-57" class="d">-      message = e.data;
</a><a href="#h7-0-58" id="h7-0-58" class="d">-      cmd = message.cmd;
</a><a href="#h7-0-59" id="h7-0-59" class="d">-      if (cmd === &quot;response&quot;) {
</a><a href="#h7-0-60" id="h7-0-60" class="d">-        if (this.waiting_cb[message.to] != null) {
</a><a href="#h7-0-61" id="h7-0-61" class="d">-          return this.waiting_cb[message.to](message.result);
</a><a href="#h7-0-62" id="h7-0-62" class="d">-        } else {
</a><a href="#h7-0-63" id="h7-0-63" class="d">-          return this.log(&quot;Websocket callback not found:&quot;, message);
</a><a href="#h7-0-64" id="h7-0-64" class="d">-        }
</a><a href="#h7-0-65" id="h7-0-65" class="d">-      } else if (cmd === &quot;wrapperReady&quot;) {
</a><a href="#h7-0-66" id="h7-0-66" class="d">-        return this.cmd(&quot;innerReady&quot;);
</a><a href="#h7-0-67" id="h7-0-67" class="d">-      } else if (cmd === &quot;ping&quot;) {
</a><a href="#h7-0-68" id="h7-0-68" class="d">-        return this.response(message.id, &quot;pong&quot;);
</a><a href="#h7-0-69" id="h7-0-69" class="d">-      } else if (cmd === &quot;wrapperOpenedWebsocket&quot;) {
</a><a href="#h7-0-70" id="h7-0-70" class="d">-        return this.onOpenWebsocket();
</a><a href="#h7-0-71" id="h7-0-71" class="d">-      } else if (cmd === &quot;wrapperClosedWebsocket&quot;) {
</a><a href="#h7-0-72" id="h7-0-72" class="d">-        return this.onCloseWebsocket();
</a><a href="#h7-0-73" id="h7-0-73" class="d">-      } else {
</a><a href="#h7-0-74" id="h7-0-74" class="d">-        return this.route(cmd, message);
</a><a href="#h7-0-75" id="h7-0-75" class="d">-      }
</a><a href="#h7-0-76" id="h7-0-76" class="d">-    };
</a><a href="#h7-0-77" id="h7-0-77" class="d">-
</a><a href="#h7-0-78" id="h7-0-78" class="d">-    ZeroFrame.prototype.route = function(cmd, message) {
</a><a href="#h7-0-79" id="h7-0-79" class="d">-      return this.log(&quot;Unknown command&quot;, message);
</a><a href="#h7-0-80" id="h7-0-80" class="d">-    };
</a><a href="#h7-0-81" id="h7-0-81" class="d">-
</a><a href="#h7-0-82" id="h7-0-82" class="d">-    ZeroFrame.prototype.response = function(to, result) {
</a><a href="#h7-0-83" id="h7-0-83" class="d">-      return this.send({
</a><a href="#h7-0-84" id="h7-0-84" class="d">-        &quot;cmd&quot;: &quot;response&quot;,
</a><a href="#h7-0-85" id="h7-0-85" class="d">-        &quot;to&quot;: to,
</a><a href="#h7-0-86" id="h7-0-86" class="d">-        &quot;result&quot;: result
</a><a href="#h7-0-87" id="h7-0-87" class="d">-      });
</a><a href="#h7-0-88" id="h7-0-88" class="d">-    };
</a><a href="#h7-0-89" id="h7-0-89" class="d">-
</a><a href="#h7-0-90" id="h7-0-90" class="d">-    ZeroFrame.prototype.cmd = function(cmd, params, cb) {
</a><a href="#h7-0-91" id="h7-0-91" class="d">-      if (params == null) {
</a><a href="#h7-0-92" id="h7-0-92" class="d">-        params = {};
</a><a href="#h7-0-93" id="h7-0-93" class="d">-      }
</a><a href="#h7-0-94" id="h7-0-94" class="d">-      if (cb == null) {
</a><a href="#h7-0-95" id="h7-0-95" class="d">-        cb = null;
</a><a href="#h7-0-96" id="h7-0-96" class="d">-      }
</a><a href="#h7-0-97" id="h7-0-97" class="d">-      return this.send({
</a><a href="#h7-0-98" id="h7-0-98" class="d">-        &quot;cmd&quot;: cmd,
</a><a href="#h7-0-99" id="h7-0-99" class="d">-        &quot;params&quot;: params
</a><a href="#h7-0-100" id="h7-0-100" class="d">-      }, cb);
</a><a href="#h7-0-101" id="h7-0-101" class="d">-    };
</a><a href="#h7-0-102" id="h7-0-102" class="d">-
</a><a href="#h7-0-103" id="h7-0-103" class="d">-    ZeroFrame.prototype.send = function(message, cb) {
</a><a href="#h7-0-104" id="h7-0-104" class="d">-      if (cb == null) {
</a><a href="#h7-0-105" id="h7-0-105" class="d">-        cb = null;
</a><a href="#h7-0-106" id="h7-0-106" class="d">-      }
</a><a href="#h7-0-107" id="h7-0-107" class="d">-      message.id = this.next_message_id;
</a><a href="#h7-0-108" id="h7-0-108" class="d">-      this.next_message_id += 1;
</a><a href="#h7-0-109" id="h7-0-109" class="d">-      this.target.postMessage(message, &quot;*&quot;);
</a><a href="#h7-0-110" id="h7-0-110" class="d">-      if (cb) {
</a><a href="#h7-0-111" id="h7-0-111" class="d">-        return this.waiting_cb[message.id] = cb;
</a><a href="#h7-0-112" id="h7-0-112" class="d">-      }
</a><a href="#h7-0-113" id="h7-0-113" class="d">-    };
</a><a href="#h7-0-114" id="h7-0-114" class="d">-
</a><a href="#h7-0-115" id="h7-0-115" class="d">-    ZeroFrame.prototype.log = function() {
</a><a href="#h7-0-116" id="h7-0-116" class="d">-      var args;
</a><a href="#h7-0-117" id="h7-0-117" class="d">-      args = 1 &lt;= arguments.length ? __slice.call(arguments, 0) : [];
</a><a href="#h7-0-118" id="h7-0-118" class="d">-      return console.log.apply(console, [&quot;[ZeroFrame]&quot;].concat(__slice.call(args)));
</a><a href="#h7-0-119" id="h7-0-119" class="d">-    };
</a><a href="#h7-0-120" id="h7-0-120" class="d">-
</a><a href="#h7-0-121" id="h7-0-121" class="d">-    ZeroFrame.prototype.onOpenWebsocket = function() {
</a><a href="#h7-0-122" id="h7-0-122" class="d">-      return this.log(&quot;Websocket open&quot;);
</a><a href="#h7-0-123" id="h7-0-123" class="d">-    };
</a><a href="#h7-0-124" id="h7-0-124" class="d">-
</a><a href="#h7-0-125" id="h7-0-125" class="d">-    ZeroFrame.prototype.onCloseWebsocket = function() {
</a><a href="#h7-0-126" id="h7-0-126" class="d">-      return this.log(&quot;Websocket close&quot;);
</a><a href="#h7-0-127" id="h7-0-127" class="d">-    };
</a><a href="#h7-0-128" id="h7-0-128" class="d">-
</a><a href="#h7-0-129" id="h7-0-129" class="d">-    return ZeroFrame;
</a><a href="#h7-0-130" id="h7-0-130" class="d">-
</a><a href="#h7-0-131" id="h7-0-131" class="d">-  })();
</a><a href="#h7-0-132" id="h7-0-132" class="d">-
</a><a href="#h7-0-133" id="h7-0-133" class="d">-  window.ZeroFrame = ZeroFrame;
</a><a href="#h7-0-134" id="h7-0-134" class="d">-
</a><a href="#h7-0-135" id="h7-0-135" class="d">-}).call(this);
</a><a href="#h7-0-136" id="h7-0-136" class="d">-
</a><a href="#h7-0-137" id="h7-0-137" class="d">-
</a><a href="#h7-0-138" id="h7-0-138" class="d">-
</a> /* ---- data/1TaLk3zM7ZRskJvrh3ZNCDVGXvkJusPKQ/js/lib/highlight.pack.js ---- */
 
 
<a href="#h7-1" id="h7-1" class="h">@@ -875,7 +739,65 @@ jQuery.extend( jQuery.easing,
</a> 
 
 
<a href="#h7-1-3" id="h7-1-3" class="d">-/* ---- data/1TaLk3zM7ZRskJvrh3ZNCDVGXvkJusPKQ/js/InlineEditor.coffee ---- */
</a><a href="#h7-1-4" id="h7-1-4" class="i">+/* ---- data/1TaLk3zM7ZRskJvrh3ZNCDVGXvkJusPKQ/js/utils/Class.coffee ---- */
</a><a href="#h7-1-5" id="h7-1-5" class="i">+
</a><a href="#h7-1-6" id="h7-1-6" class="i">+
</a><a href="#h7-1-7" id="h7-1-7" class="i">+(function() {
</a><a href="#h7-1-8" id="h7-1-8" class="i">+  var Class,
</a><a href="#h7-1-9" id="h7-1-9" class="i">+    __slice = [].slice;
</a><a href="#h7-1-10" id="h7-1-10" class="i">+
</a><a href="#h7-1-11" id="h7-1-11" class="i">+  Class = (function() {
</a><a href="#h7-1-12" id="h7-1-12" class="i">+    function Class() {}
</a><a href="#h7-1-13" id="h7-1-13" class="i">+
</a><a href="#h7-1-14" id="h7-1-14" class="i">+    Class.prototype.trace = true;
</a><a href="#h7-1-15" id="h7-1-15" class="i">+
</a><a href="#h7-1-16" id="h7-1-16" class="i">+    Class.prototype.log = function() {
</a><a href="#h7-1-17" id="h7-1-17" class="i">+      var args;
</a><a href="#h7-1-18" id="h7-1-18" class="i">+      args = 1 &lt;= arguments.length ? __slice.call(arguments, 0) : [];
</a><a href="#h7-1-19" id="h7-1-19" class="i">+      if (!this.trace) {
</a><a href="#h7-1-20" id="h7-1-20" class="i">+        return;
</a><a href="#h7-1-21" id="h7-1-21" class="i">+      }
</a><a href="#h7-1-22" id="h7-1-22" class="i">+      if (typeof console === &apos;undefined&apos;) {
</a><a href="#h7-1-23" id="h7-1-23" class="i">+        return;
</a><a href="#h7-1-24" id="h7-1-24" class="i">+      }
</a><a href="#h7-1-25" id="h7-1-25" class="i">+      args.unshift(&quot;[&quot; + this.constructor.name + &quot;]&quot;);
</a><a href="#h7-1-26" id="h7-1-26" class="i">+      console.log.apply(console, args);
</a><a href="#h7-1-27" id="h7-1-27" class="i">+      return this;
</a><a href="#h7-1-28" id="h7-1-28" class="i">+    };
</a><a href="#h7-1-29" id="h7-1-29" class="i">+
</a><a href="#h7-1-30" id="h7-1-30" class="i">+    Class.prototype.logStart = function() {
</a><a href="#h7-1-31" id="h7-1-31" class="i">+      var args, name;
</a><a href="#h7-1-32" id="h7-1-32" class="i">+      name = arguments[0], args = 2 &lt;= arguments.length ? __slice.call(arguments, 1) : [];
</a><a href="#h7-1-33" id="h7-1-33" class="i">+      if (!this.trace) {
</a><a href="#h7-1-34" id="h7-1-34" class="i">+        return;
</a><a href="#h7-1-35" id="h7-1-35" class="i">+      }
</a><a href="#h7-1-36" id="h7-1-36" class="i">+      this.logtimers || (this.logtimers = {});
</a><a href="#h7-1-37" id="h7-1-37" class="i">+      this.logtimers[name] = +(new Date);
</a><a href="#h7-1-38" id="h7-1-38" class="i">+      if (args.length &gt; 0) {
</a><a href="#h7-1-39" id="h7-1-39" class="i">+        this.log.apply(this, [&quot;[&quot; + name + &quot;]&quot;].concat(__slice.call(args), [&quot;(started)&quot;]));
</a><a href="#h7-1-40" id="h7-1-40" class="i">+      }
</a><a href="#h7-1-41" id="h7-1-41" class="i">+      return this;
</a><a href="#h7-1-42" id="h7-1-42" class="i">+    };
</a><a href="#h7-1-43" id="h7-1-43" class="i">+
</a><a href="#h7-1-44" id="h7-1-44" class="i">+    Class.prototype.logEnd = function() {
</a><a href="#h7-1-45" id="h7-1-45" class="i">+      var args, ms, name;
</a><a href="#h7-1-46" id="h7-1-46" class="i">+      name = arguments[0], args = 2 &lt;= arguments.length ? __slice.call(arguments, 1) : [];
</a><a href="#h7-1-47" id="h7-1-47" class="i">+      ms = +(new Date) - this.logtimers[name];
</a><a href="#h7-1-48" id="h7-1-48" class="i">+      this.log.apply(this, [&quot;[&quot; + name + &quot;]&quot;].concat(__slice.call(args), [&quot;(Done in &quot; + ms + &quot;ms)&quot;]));
</a><a href="#h7-1-49" id="h7-1-49" class="i">+      return this;
</a><a href="#h7-1-50" id="h7-1-50" class="i">+    };
</a><a href="#h7-1-51" id="h7-1-51" class="i">+
</a><a href="#h7-1-52" id="h7-1-52" class="i">+    return Class;
</a><a href="#h7-1-53" id="h7-1-53" class="i">+
</a><a href="#h7-1-54" id="h7-1-54" class="i">+  })();
</a><a href="#h7-1-55" id="h7-1-55" class="i">+
</a><a href="#h7-1-56" id="h7-1-56" class="i">+  window.Class = Class;
</a><a href="#h7-1-57" id="h7-1-57" class="i">+
</a><a href="#h7-1-58" id="h7-1-58" class="i">+}).call(this);
</a><a href="#h7-1-59" id="h7-1-59" class="i">+
</a><a href="#h7-1-60" id="h7-1-60" class="i">+
</a><a href="#h7-1-61" id="h7-1-61" class="i">+
</a><a href="#h7-1-62" id="h7-1-62" class="i">+/* ---- data/1TaLk3zM7ZRskJvrh3ZNCDVGXvkJusPKQ/js/utils/InlineEditor.coffee ---- */
</a> 
 
 (function() {
<a href="#h7-2" id="h7-2" class="h">@@ -995,10 +917,10 @@ jQuery.extend( jQuery.easing,
</a>     InlineEditor.prototype.deleteObject = function() {
       var object_type;
       object_type = this.getObject(this.elem).data(&quot;object&quot;).split(&quot;:&quot;)[0];
<a href="#h7-2-3" id="h7-2-3" class="d">-      window.zero_talk.cmd(&quot;wrapperConfirm&quot;, [&quot;Are you sure you sure to delete this &quot; + object_type + &quot;?&quot;, &quot;Delete&quot;], (function(_this) {
</a><a href="#h7-2-4" id="h7-2-4" class="i">+      Page.cmd(&quot;wrapperConfirm&quot;, [&quot;Are you sure you sure to delete this &quot; + object_type + &quot;?&quot;, &quot;Delete&quot;], (function(_this) {
</a>         return function(confirmed) {
           $(&quot;.editbar .delete&quot;).addClass(&quot;loading&quot;);
<a href="#h7-2-7" id="h7-2-7" class="d">-          return _this.saveContent(_this.getObject(_this.elem), null, function() {
</a><a href="#h7-2-8" id="h7-2-8" class="i">+          return Page.saveContent(_this.getObject(_this.elem), null, function() {
</a>             return _this.stopEdit();
           });
         };
<a href="#h7-3" id="h7-3" class="h">@@ -1073,110 +995,269 @@ jQuery.extend( jQuery.easing,
</a> 
 
 
<a href="#h7-3-3" id="h7-3-3" class="d">-/* ---- data/1TaLk3zM7ZRskJvrh3ZNCDVGXvkJusPKQ/js/ZeroTalk.coffee ---- */
</a><a href="#h7-3-4" id="h7-3-4" class="i">+/* ---- data/1TaLk3zM7ZRskJvrh3ZNCDVGXvkJusPKQ/js/utils/LimitRate.coffee ---- */
</a> 
 
 (function() {
<a href="#h7-3-8" id="h7-3-8" class="d">-  var ZeroTalk,
</a><a href="#h7-3-9" id="h7-3-9" class="d">-    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
</a><a href="#h7-3-10" id="h7-3-10" class="d">-    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
</a><a href="#h7-3-11" id="h7-3-11" class="d">-    __hasProp = {}.hasOwnProperty;
</a><a href="#h7-3-12" id="h7-3-12" class="i">+  var limits;
</a> 
<a href="#h7-3-14" id="h7-3-14" class="d">-  ZeroTalk = (function(_super) {
</a><a href="#h7-3-15" id="h7-3-15" class="d">-    __extends(ZeroTalk, _super);
</a><a href="#h7-3-16" id="h7-3-16" class="i">+  limits = {};
</a> 
<a href="#h7-3-18" id="h7-3-18" class="d">-    function ZeroTalk() {
</a><a href="#h7-3-19" id="h7-3-19" class="d">-      this.setSiteinfo = __bind(this.setSiteinfo, this);
</a><a href="#h7-3-20" id="h7-3-20" class="d">-      this.actionSetSiteInfo = __bind(this.actionSetSiteInfo, this);
</a><a href="#h7-3-21" id="h7-3-21" class="d">-      this.saveContent = __bind(this.saveContent, this);
</a><a href="#h7-3-22" id="h7-3-22" class="d">-      this.getObject = __bind(this.getObject, this);
</a><a href="#h7-3-23" id="h7-3-23" class="d">-      this.getContent = __bind(this.getContent, this);
</a><a href="#h7-3-24" id="h7-3-24" class="d">-      this.textToColor = __bind(this.textToColor, this);
</a><a href="#h7-3-25" id="h7-3-25" class="d">-      this.loadTopicsStat = __bind(this.loadTopicsStat, this);
</a><a href="#h7-3-26" id="h7-3-26" class="d">-      this.onOpenWebsocket = __bind(this.onOpenWebsocket, this);
</a><a href="#h7-3-27" id="h7-3-27" class="d">-      return ZeroTalk.__super__.constructor.apply(this, arguments);
</a><a href="#h7-3-28" id="h7-3-28" class="i">+  window.LimitRate = function(fn, interval) {
</a><a href="#h7-3-29" id="h7-3-29" class="i">+    if (!limits[fn]) {
</a><a href="#h7-3-30" id="h7-3-30" class="i">+      return limits[fn] = setTimeout((function() {
</a><a href="#h7-3-31" id="h7-3-31" class="i">+        fn();
</a><a href="#h7-3-32" id="h7-3-32" class="i">+        return delete limits[fn];
</a><a href="#h7-3-33" id="h7-3-33" class="i">+      }), interval);
</a>     }
<a href="#h7-3-35" id="h7-3-35" class="i">+  };
</a> 
<a href="#h7-3-37" id="h7-3-37" class="d">-    ZeroTalk.prototype.init = function() {
</a><a href="#h7-3-38" id="h7-3-38" class="d">-      var textarea, _i, _len, _ref;
</a><a href="#h7-3-39" id="h7-3-39" class="d">-      this.log(&quot;inited!&quot;);
</a><a href="#h7-3-40" id="h7-3-40" class="d">-      this.site_info = null;
</a><a href="#h7-3-41" id="h7-3-41" class="d">-      this.server_info = null;
</a><a href="#h7-3-42" id="h7-3-42" class="d">-      this.local_storage = {};
</a><a href="#h7-3-43" id="h7-3-43" class="d">-      this.user_id_db = {};
</a><a href="#h7-3-44" id="h7-3-44" class="d">-      this.user_address_db = {};
</a><a href="#h7-3-45" id="h7-3-45" class="d">-      this.user_name_db = {};
</a><a href="#h7-3-46" id="h7-3-46" class="d">-      this.user_max_size = null;
</a><a href="#h7-3-47" id="h7-3-47" class="d">-      this.thread_sorter = null;
</a><a href="#h7-3-48" id="h7-3-48" class="d">-      _ref = $(&quot;textarea&quot;);
</a><a href="#h7-3-49" id="h7-3-49" class="d">-      for (_i = 0, _len = _ref.length; _i &lt; _len; _i++) {
</a><a href="#h7-3-50" id="h7-3-50" class="d">-        textarea = _ref[_i];
</a><a href="#h7-3-51" id="h7-3-51" class="d">-        this.autoExpand($(textarea));
</a><a href="#h7-3-52" id="h7-3-52" class="i">+}).call(this);
</a><a href="#h7-3-53" id="h7-3-53" class="i">+
</a><a href="#h7-3-54" id="h7-3-54" class="i">+
</a><a href="#h7-3-55" id="h7-3-55" class="i">+
</a><a href="#h7-3-56" id="h7-3-56" class="i">+/* ---- data/1TaLk3zM7ZRskJvrh3ZNCDVGXvkJusPKQ/js/utils/Text.coffee ---- */
</a><a href="#h7-3-57" id="h7-3-57" class="i">+
</a><a href="#h7-3-58" id="h7-3-58" class="i">+
</a><a href="#h7-3-59" id="h7-3-59" class="i">+(function() {
</a><a href="#h7-3-60" id="h7-3-60" class="i">+  var Text;
</a><a href="#h7-3-61" id="h7-3-61" class="i">+
</a><a href="#h7-3-62" id="h7-3-62" class="i">+  Text = (function() {
</a><a href="#h7-3-63" id="h7-3-63" class="i">+    function Text() {}
</a><a href="#h7-3-64" id="h7-3-64" class="i">+
</a><a href="#h7-3-65" id="h7-3-65" class="i">+    Text.prototype.toColor = function(text) {
</a><a href="#h7-3-66" id="h7-3-66" class="i">+      var color, hash, i, value, _i, _j, _ref;
</a><a href="#h7-3-67" id="h7-3-67" class="i">+      hash = 0;
</a><a href="#h7-3-68" id="h7-3-68" class="i">+      for (i = _i = 0, _ref = text.length - 1; 0 &lt;= _ref ? _i &lt;= _ref : _i &gt;= _ref; i = 0 &lt;= _ref ? ++_i : --_i) {
</a><a href="#h7-3-69" id="h7-3-69" class="i">+        hash = text.charCodeAt(i) + ((hash &lt;&lt; 5) - hash);
</a>       }
<a href="#h7-3-71" id="h7-3-71" class="d">-      $(&quot;.button.signup&quot;).on(&quot;click&quot;, (function(_this) {
</a><a href="#h7-3-72" id="h7-3-72" class="d">-        return function() {
</a><a href="#h7-3-73" id="h7-3-73" class="d">-          _this.buttonSignup();
</a><a href="#h7-3-74" id="h7-3-74" class="d">-          return false;
</a><a href="#h7-3-75" id="h7-3-75" class="d">-        };
</a><a href="#h7-3-76" id="h7-3-76" class="d">-      })(this));
</a><a href="#h7-3-77" id="h7-3-77" class="d">-      return $(&quot;.editbar .icon-help&quot;).on(&quot;click&quot;, (function(_this) {
</a><a href="#h7-3-78" id="h7-3-78" class="d">-        return function() {
</a><a href="#h7-3-79" id="h7-3-79" class="d">-          $(&quot;.editbar .markdown-help&quot;).css(&quot;display&quot;, &quot;block&quot;);
</a><a href="#h7-3-80" id="h7-3-80" class="d">-          $(&quot;.editbar .markdown-help&quot;).toggleClassLater(&quot;visible&quot;, 10);
</a><a href="#h7-3-81" id="h7-3-81" class="d">-          $(&quot;.editbar .icon-help&quot;).toggleClass(&quot;active&quot;);
</a><a href="#h7-3-82" id="h7-3-82" class="d">-          return false;
</a><a href="#h7-3-83" id="h7-3-83" class="d">-        };
</a><a href="#h7-3-84" id="h7-3-84" class="d">-      })(this));
</a><a href="#h7-3-85" id="h7-3-85" class="i">+      color = &apos;#&apos;;
</a><a href="#h7-3-86" id="h7-3-86" class="i">+      return &quot;hsl(&quot; + (hash % 360) + &quot;,30%,50%)&quot;;
</a><a href="#h7-3-87" id="h7-3-87" class="i">+      for (i = _j = 0; _j &lt;= 2; i = ++_j) {
</a><a href="#h7-3-88" id="h7-3-88" class="i">+        value = (hash &gt;&gt; (i * 8)) &amp; 0xFF;
</a><a href="#h7-3-89" id="h7-3-89" class="i">+        color += (&apos;00&apos; + value.toString(16)).substr(-2);
</a><a href="#h7-3-90" id="h7-3-90" class="i">+      }
</a><a href="#h7-3-91" id="h7-3-91" class="i">+      return color;
</a>     };
 
<a href="#h7-3-94" id="h7-3-94" class="d">-    ZeroTalk.prototype.pageLoaded = function() {
</a><a href="#h7-3-95" id="h7-3-95" class="d">-      return $(&quot;body&quot;).addClass(&quot;loaded&quot;);
</a><a href="#h7-3-96" id="h7-3-96" class="i">+    Text.prototype.toMarked = function(text, options) {
</a><a href="#h7-3-97" id="h7-3-97" class="i">+      if (options == null) {
</a><a href="#h7-3-98" id="h7-3-98" class="i">+        options = null;
</a><a href="#h7-3-99" id="h7-3-99" class="i">+      }
</a><a href="#h7-3-100" id="h7-3-100" class="i">+      text = marked(text, options);
</a><a href="#h7-3-101" id="h7-3-101" class="i">+      return this.fixLinks(text);
</a>     };
 
<a href="#h7-3-104" id="h7-3-104" class="d">-    ZeroTalk.prototype.onOpenWebsocket = function(e) {
</a><a href="#h7-3-105" id="h7-3-105" class="d">-      this.cmd(&quot;wrapperSetViewport&quot;, &quot;width=device-width, initial-scale=1.0&quot;);
</a><a href="#h7-3-106" id="h7-3-106" class="d">-      this.cmd(&quot;wrapperGetLocalStorage&quot;, [], (function(_this) {
</a><a href="#h7-3-107" id="h7-3-107" class="d">-        return function(res) {
</a><a href="#h7-3-108" id="h7-3-108" class="d">-          if (res == null) {
</a><a href="#h7-3-109" id="h7-3-109" class="d">-            res = {};
</a><a href="#h7-3-110" id="h7-3-110" class="d">-          }
</a><a href="#h7-3-111" id="h7-3-111" class="d">-          return _this.local_storage = res;
</a><a href="#h7-3-112" id="h7-3-112" class="d">-        };
</a><a href="#h7-3-113" id="h7-3-113" class="d">-      })(this));
</a><a href="#h7-3-114" id="h7-3-114" class="d">-      this.cmd(&quot;siteInfo&quot;, {}, (function(_this) {
</a><a href="#h7-3-115" id="h7-3-115" class="d">-        return function(site) {
</a><a href="#h7-3-116" id="h7-3-116" class="d">-          _this.setSiteinfo(site);
</a><a href="#h7-3-117" id="h7-3-117" class="d">-          return _this.loadUserDb(function() {
</a><a href="#h7-3-118" id="h7-3-118" class="d">-            _this.updateUserInfo();
</a><a href="#h7-3-119" id="h7-3-119" class="d">-            return _this.routeUrl(window.location.search.substring(1));
</a><a href="#h7-3-120" id="h7-3-120" class="d">-          });
</a><a href="#h7-3-121" id="h7-3-121" class="d">-        };
</a><a href="#h7-3-122" id="h7-3-122" class="d">-      })(this));
</a><a href="#h7-3-123" id="h7-3-123" class="d">-      return this.cmd(&quot;serverInfo&quot;, {}, (function(_this) {
</a><a href="#h7-3-124" id="h7-3-124" class="d">-        return function(ret) {
</a><a href="#h7-3-125" id="h7-3-125" class="d">-          var version;
</a><a href="#h7-3-126" id="h7-3-126" class="d">-          _this.server_info = ret;
</a><a href="#h7-3-127" id="h7-3-127" class="d">-          version = parseInt(_this.server_info.version.replace(/\./g, &quot;&quot;));
</a><a href="#h7-3-128" id="h7-3-128" class="d">-          if (version &lt; 20) {
</a><a href="#h7-3-129" id="h7-3-129" class="d">-            return _this.cmd(&quot;wrapperNotification&quot;, [&quot;error&quot;, &quot;ZeroTalk requires ZeroNet 0.2.0, please update!&quot;]);
</a><a href="#h7-3-130" id="h7-3-130" class="d">-          }
</a><a href="#h7-3-131" id="h7-3-131" class="d">-        };
</a><a href="#h7-3-132" id="h7-3-132" class="d">-      })(this));
</a><a href="#h7-3-133" id="h7-3-133" class="i">+    Text.prototype.fixLinks = function(text) {
</a><a href="#h7-3-134" id="h7-3-134" class="i">+      return text.replace(/href=&quot;http:\/\/(127.0.0.1|localhost):43110/g, &apos;href=&quot;&apos;);
</a>     };
 
<a href="#h7-3-137" id="h7-3-137" class="d">-    ZeroTalk.prototype.routeUrl = function(url) {
</a><a href="#h7-3-138" id="h7-3-138" class="d">-      var match;
</a><a href="#h7-3-139" id="h7-3-139" class="d">-      this.log(&quot;Routing url:&quot;, url);
</a><a href="#h7-3-140" id="h7-3-140" class="d">-      if (match = url.match(/Topic:([0-9]+)@([0-9]+)/)) {
</a><a href="#h7-3-141" id="h7-3-141" class="d">-        $(&quot;body&quot;).addClass(&quot;page-topic&quot;);
</a><a href="#h7-3-142" id="h7-3-142" class="d">-        return this.pageTopic(parseInt(match[1]), parseInt(match[2]));
</a><a href="#h7-3-143" id="h7-3-143" class="i">+    return Text;
</a><a href="#h7-3-144" id="h7-3-144" class="i">+
</a><a href="#h7-3-145" id="h7-3-145" class="i">+  })();
</a><a href="#h7-3-146" id="h7-3-146" class="i">+
</a><a href="#h7-3-147" id="h7-3-147" class="i">+  window.Text = new Text();
</a><a href="#h7-3-148" id="h7-3-148" class="i">+
</a><a href="#h7-3-149" id="h7-3-149" class="i">+}).call(this);
</a><a href="#h7-3-150" id="h7-3-150" class="i">+
</a><a href="#h7-3-151" id="h7-3-151" class="i">+
</a><a href="#h7-3-152" id="h7-3-152" class="i">+
</a><a href="#h7-3-153" id="h7-3-153" class="i">+/* ---- data/1TaLk3zM7ZRskJvrh3ZNCDVGXvkJusPKQ/js/utils/Time.coffee ---- */
</a><a href="#h7-3-154" id="h7-3-154" class="i">+
</a><a href="#h7-3-155" id="h7-3-155" class="i">+
</a><a href="#h7-3-156" id="h7-3-156" class="i">+(function() {
</a><a href="#h7-3-157" id="h7-3-157" class="i">+  var Time;
</a><a href="#h7-3-158" id="h7-3-158" class="i">+
</a><a href="#h7-3-159" id="h7-3-159" class="i">+  Time = (function() {
</a><a href="#h7-3-160" id="h7-3-160" class="i">+    function Time() {}
</a><a href="#h7-3-161" id="h7-3-161" class="i">+
</a><a href="#h7-3-162" id="h7-3-162" class="i">+    Time.prototype.since = function(time) {
</a><a href="#h7-3-163" id="h7-3-163" class="i">+      var back, now, secs;
</a><a href="#h7-3-164" id="h7-3-164" class="i">+      now = +(new Date) / 1000;
</a><a href="#h7-3-165" id="h7-3-165" class="i">+      secs = now - time;
</a><a href="#h7-3-166" id="h7-3-166" class="i">+      if (secs &lt; 60) {
</a><a href="#h7-3-167" id="h7-3-167" class="i">+        back = &quot;Just now&quot;;
</a><a href="#h7-3-168" id="h7-3-168" class="i">+      } else if (secs &lt; 60 * 60) {
</a><a href="#h7-3-169" id="h7-3-169" class="i">+        back = (Math.round(secs / 60)) + &quot; minutes ago&quot;;
</a><a href="#h7-3-170" id="h7-3-170" class="i">+      } else if (secs &lt; 60 * 60 * 24) {
</a><a href="#h7-3-171" id="h7-3-171" class="i">+        back = (Math.round(secs / 60 / 60)) + &quot; hours ago&quot;;
</a><a href="#h7-3-172" id="h7-3-172" class="i">+      } else if (secs &lt; 60 * 60 * 24 * 3) {
</a><a href="#h7-3-173" id="h7-3-173" class="i">+        back = (Math.round(secs / 60 / 60 / 24)) + &quot; days ago&quot;;
</a>       } else {
<a href="#h7-3-175" id="h7-3-175" class="d">-        $(&quot;body&quot;).addClass(&quot;page-main&quot;);
</a><a href="#h7-3-176" id="h7-3-176" class="d">-        return this.pageMain();
</a><a href="#h7-3-177" id="h7-3-177" class="i">+        back = &quot;on &quot; + this.date(time);
</a>       }
<a href="#h7-3-179" id="h7-3-179" class="i">+      back = back.replace(/1 ([a-z]+)s/, &quot;1 $1&quot;);
</a><a href="#h7-3-180" id="h7-3-180" class="i">+      return back;
</a>     };
 
<a href="#h7-3-183" id="h7-3-183" class="d">-    ZeroTalk.prototype.pageMain = function() {
</a><a href="#h7-3-184" id="h7-3-184" class="i">+    Time.prototype.date = function(timestamp, format) {
</a><a href="#h7-3-185" id="h7-3-185" class="i">+      var display, parts;
</a><a href="#h7-3-186" id="h7-3-186" class="i">+      if (format == null) {
</a><a href="#h7-3-187" id="h7-3-187" class="i">+        format = &quot;short&quot;;
</a><a href="#h7-3-188" id="h7-3-188" class="i">+      }
</a><a href="#h7-3-189" id="h7-3-189" class="i">+      parts = (new Date(timestamp * 1000)).toString().split(&quot; &quot;);
</a><a href="#h7-3-190" id="h7-3-190" class="i">+      if (format === &quot;short&quot;) {
</a><a href="#h7-3-191" id="h7-3-191" class="i">+        display = parts.slice(1, 4);
</a><a href="#h7-3-192" id="h7-3-192" class="i">+      } else {
</a><a href="#h7-3-193" id="h7-3-193" class="i">+        display = parts.slice(1, 5);
</a><a href="#h7-3-194" id="h7-3-194" class="i">+      }
</a><a href="#h7-3-195" id="h7-3-195" class="i">+      return display.join(&quot; &quot;).replace(/( [0-9]{4})/, &quot;,$1&quot;);
</a><a href="#h7-3-196" id="h7-3-196" class="i">+    };
</a><a href="#h7-3-197" id="h7-3-197" class="i">+
</a><a href="#h7-3-198" id="h7-3-198" class="i">+    Time.prototype.timestamp = function(date) {
</a><a href="#h7-3-199" id="h7-3-199" class="i">+      if (date == null) {
</a><a href="#h7-3-200" id="h7-3-200" class="i">+        date = &quot;&quot;;
</a><a href="#h7-3-201" id="h7-3-201" class="i">+      }
</a><a href="#h7-3-202" id="h7-3-202" class="i">+      if (date === &quot;now&quot; || date === &quot;&quot;) {
</a><a href="#h7-3-203" id="h7-3-203" class="i">+        return parseInt(+(new Date) / 1000);
</a><a href="#h7-3-204" id="h7-3-204" class="i">+      } else {
</a><a href="#h7-3-205" id="h7-3-205" class="i">+        return parseInt(Date.parse(date) / 1000);
</a><a href="#h7-3-206" id="h7-3-206" class="i">+      }
</a><a href="#h7-3-207" id="h7-3-207" class="i">+    };
</a><a href="#h7-3-208" id="h7-3-208" class="i">+
</a><a href="#h7-3-209" id="h7-3-209" class="i">+    return Time;
</a><a href="#h7-3-210" id="h7-3-210" class="i">+
</a><a href="#h7-3-211" id="h7-3-211" class="i">+  })();
</a><a href="#h7-3-212" id="h7-3-212" class="i">+
</a><a href="#h7-3-213" id="h7-3-213" class="i">+  window.Time = new Time;
</a><a href="#h7-3-214" id="h7-3-214" class="i">+
</a><a href="#h7-3-215" id="h7-3-215" class="i">+}).call(this);
</a><a href="#h7-3-216" id="h7-3-216" class="i">+
</a><a href="#h7-3-217" id="h7-3-217" class="i">+
</a><a href="#h7-3-218" id="h7-3-218" class="i">+
</a><a href="#h7-3-219" id="h7-3-219" class="i">+/* ---- data/1TaLk3zM7ZRskJvrh3ZNCDVGXvkJusPKQ/js/utils/ZeroFrame.coffee ---- */
</a><a href="#h7-3-220" id="h7-3-220" class="i">+
</a><a href="#h7-3-221" id="h7-3-221" class="i">+
</a><a href="#h7-3-222" id="h7-3-222" class="i">+(function() {
</a><a href="#h7-3-223" id="h7-3-223" class="i">+  var ZeroFrame,
</a><a href="#h7-3-224" id="h7-3-224" class="i">+    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
</a><a href="#h7-3-225" id="h7-3-225" class="i">+    __slice = [].slice;
</a><a href="#h7-3-226" id="h7-3-226" class="i">+
</a><a href="#h7-3-227" id="h7-3-227" class="i">+  ZeroFrame = (function() {
</a><a href="#h7-3-228" id="h7-3-228" class="i">+    function ZeroFrame(url) {
</a><a href="#h7-3-229" id="h7-3-229" class="i">+      this.onCloseWebsocket = __bind(this.onCloseWebsocket, this);
</a><a href="#h7-3-230" id="h7-3-230" class="i">+      this.onOpenWebsocket = __bind(this.onOpenWebsocket, this);
</a><a href="#h7-3-231" id="h7-3-231" class="i">+      this.route = __bind(this.route, this);
</a><a href="#h7-3-232" id="h7-3-232" class="i">+      this.onMessage = __bind(this.onMessage, this);
</a><a href="#h7-3-233" id="h7-3-233" class="i">+      this.url = url;
</a><a href="#h7-3-234" id="h7-3-234" class="i">+      this.waiting_cb = {};
</a><a href="#h7-3-235" id="h7-3-235" class="i">+      this.connect();
</a><a href="#h7-3-236" id="h7-3-236" class="i">+      this.next_message_id = 1;
</a><a href="#h7-3-237" id="h7-3-237" class="i">+      this.init();
</a><a href="#h7-3-238" id="h7-3-238" class="i">+    }
</a><a href="#h7-3-239" id="h7-3-239" class="i">+
</a><a href="#h7-3-240" id="h7-3-240" class="i">+    ZeroFrame.prototype.init = function() {
</a><a href="#h7-3-241" id="h7-3-241" class="i">+      return this;
</a><a href="#h7-3-242" id="h7-3-242" class="i">+    };
</a><a href="#h7-3-243" id="h7-3-243" class="i">+
</a><a href="#h7-3-244" id="h7-3-244" class="i">+    ZeroFrame.prototype.connect = function() {
</a><a href="#h7-3-245" id="h7-3-245" class="i">+      this.target = window.parent;
</a><a href="#h7-3-246" id="h7-3-246" class="i">+      window.addEventListener(&quot;message&quot;, this.onMessage, false);
</a><a href="#h7-3-247" id="h7-3-247" class="i">+      return this.cmd(&quot;innerReady&quot;);
</a><a href="#h7-3-248" id="h7-3-248" class="i">+    };
</a><a href="#h7-3-249" id="h7-3-249" class="i">+
</a><a href="#h7-3-250" id="h7-3-250" class="i">+    ZeroFrame.prototype.onMessage = function(e) {
</a><a href="#h7-3-251" id="h7-3-251" class="i">+      var cmd, message;
</a><a href="#h7-3-252" id="h7-3-252" class="i">+      message = e.data;
</a><a href="#h7-3-253" id="h7-3-253" class="i">+      cmd = message.cmd;
</a><a href="#h7-3-254" id="h7-3-254" class="i">+      if (cmd === &quot;response&quot;) {
</a><a href="#h7-3-255" id="h7-3-255" class="i">+        if (this.waiting_cb[message.to] != null) {
</a><a href="#h7-3-256" id="h7-3-256" class="i">+          return this.waiting_cb[message.to](message.result);
</a><a href="#h7-3-257" id="h7-3-257" class="i">+        } else {
</a><a href="#h7-3-258" id="h7-3-258" class="i">+          return this.log(&quot;Websocket callback not found:&quot;, message);
</a><a href="#h7-3-259" id="h7-3-259" class="i">+        }
</a><a href="#h7-3-260" id="h7-3-260" class="i">+      } else if (cmd === &quot;wrapperReady&quot;) {
</a><a href="#h7-3-261" id="h7-3-261" class="i">+        return this.cmd(&quot;innerReady&quot;);
</a><a href="#h7-3-262" id="h7-3-262" class="i">+      } else if (cmd === &quot;ping&quot;) {
</a><a href="#h7-3-263" id="h7-3-263" class="i">+        return this.response(message.id, &quot;pong&quot;);
</a><a href="#h7-3-264" id="h7-3-264" class="i">+      } else if (cmd === &quot;wrapperOpenedWebsocket&quot;) {
</a><a href="#h7-3-265" id="h7-3-265" class="i">+        return this.onOpenWebsocket();
</a><a href="#h7-3-266" id="h7-3-266" class="i">+      } else if (cmd === &quot;wrapperClosedWebsocket&quot;) {
</a><a href="#h7-3-267" id="h7-3-267" class="i">+        return this.onCloseWebsocket();
</a><a href="#h7-3-268" id="h7-3-268" class="i">+      } else {
</a><a href="#h7-3-269" id="h7-3-269" class="i">+        return this.route(cmd, message);
</a><a href="#h7-3-270" id="h7-3-270" class="i">+      }
</a><a href="#h7-3-271" id="h7-3-271" class="i">+    };
</a><a href="#h7-3-272" id="h7-3-272" class="i">+
</a><a href="#h7-3-273" id="h7-3-273" class="i">+    ZeroFrame.prototype.route = function(cmd, message) {
</a><a href="#h7-3-274" id="h7-3-274" class="i">+      return this.log(&quot;Unknown command&quot;, message);
</a><a href="#h7-3-275" id="h7-3-275" class="i">+    };
</a><a href="#h7-3-276" id="h7-3-276" class="i">+
</a><a href="#h7-3-277" id="h7-3-277" class="i">+    ZeroFrame.prototype.response = function(to, result) {
</a><a href="#h7-3-278" id="h7-3-278" class="i">+      return this.send({
</a><a href="#h7-3-279" id="h7-3-279" class="i">+        &quot;cmd&quot;: &quot;response&quot;,
</a><a href="#h7-3-280" id="h7-3-280" class="i">+        &quot;to&quot;: to,
</a><a href="#h7-3-281" id="h7-3-281" class="i">+        &quot;result&quot;: result
</a><a href="#h7-3-282" id="h7-3-282" class="i">+      });
</a><a href="#h7-3-283" id="h7-3-283" class="i">+    };
</a><a href="#h7-3-284" id="h7-3-284" class="i">+
</a><a href="#h7-3-285" id="h7-3-285" class="i">+    ZeroFrame.prototype.cmd = function(cmd, params, cb) {
</a><a href="#h7-3-286" id="h7-3-286" class="i">+      if (params == null) {
</a><a href="#h7-3-287" id="h7-3-287" class="i">+        params = {};
</a><a href="#h7-3-288" id="h7-3-288" class="i">+      }
</a><a href="#h7-3-289" id="h7-3-289" class="i">+      if (cb == null) {
</a><a href="#h7-3-290" id="h7-3-290" class="i">+        cb = null;
</a><a href="#h7-3-291" id="h7-3-291" class="i">+      }
</a><a href="#h7-3-292" id="h7-3-292" class="i">+      return this.send({
</a><a href="#h7-3-293" id="h7-3-293" class="i">+        &quot;cmd&quot;: cmd,
</a><a href="#h7-3-294" id="h7-3-294" class="i">+        &quot;params&quot;: params
</a><a href="#h7-3-295" id="h7-3-295" class="i">+      }, cb);
</a><a href="#h7-3-296" id="h7-3-296" class="i">+    };
</a><a href="#h7-3-297" id="h7-3-297" class="i">+
</a><a href="#h7-3-298" id="h7-3-298" class="i">+    ZeroFrame.prototype.send = function(message, cb) {
</a><a href="#h7-3-299" id="h7-3-299" class="i">+      if (cb == null) {
</a><a href="#h7-3-300" id="h7-3-300" class="i">+        cb = null;
</a><a href="#h7-3-301" id="h7-3-301" class="i">+      }
</a><a href="#h7-3-302" id="h7-3-302" class="i">+      message.id = this.next_message_id;
</a><a href="#h7-3-303" id="h7-3-303" class="i">+      this.next_message_id += 1;
</a><a href="#h7-3-304" id="h7-3-304" class="i">+      this.target.postMessage(message, &quot;*&quot;);
</a><a href="#h7-3-305" id="h7-3-305" class="i">+      if (cb) {
</a><a href="#h7-3-306" id="h7-3-306" class="i">+        return this.waiting_cb[message.id] = cb;
</a><a href="#h7-3-307" id="h7-3-307" class="i">+      }
</a><a href="#h7-3-308" id="h7-3-308" class="i">+    };
</a><a href="#h7-3-309" id="h7-3-309" class="i">+
</a><a href="#h7-3-310" id="h7-3-310" class="i">+    ZeroFrame.prototype.log = function() {
</a><a href="#h7-3-311" id="h7-3-311" class="i">+      var args;
</a><a href="#h7-3-312" id="h7-3-312" class="i">+      args = 1 &lt;= arguments.length ? __slice.call(arguments, 0) : [];
</a><a href="#h7-3-313" id="h7-3-313" class="i">+      return console.log.apply(console, [&quot;[ZeroFrame]&quot;].concat(__slice.call(args)));
</a><a href="#h7-3-314" id="h7-3-314" class="i">+    };
</a><a href="#h7-3-315" id="h7-3-315" class="i">+
</a><a href="#h7-3-316" id="h7-3-316" class="i">+    ZeroFrame.prototype.onOpenWebsocket = function() {
</a><a href="#h7-3-317" id="h7-3-317" class="i">+      return this.log(&quot;Websocket open&quot;);
</a><a href="#h7-3-318" id="h7-3-318" class="i">+    };
</a><a href="#h7-3-319" id="h7-3-319" class="i">+
</a><a href="#h7-3-320" id="h7-3-320" class="i">+    ZeroFrame.prototype.onCloseWebsocket = function() {
</a><a href="#h7-3-321" id="h7-3-321" class="i">+      return this.log(&quot;Websocket close&quot;);
</a><a href="#h7-3-322" id="h7-3-322" class="i">+    };
</a><a href="#h7-3-323" id="h7-3-323" class="i">+
</a><a href="#h7-3-324" id="h7-3-324" class="i">+    return ZeroFrame;
</a><a href="#h7-3-325" id="h7-3-325" class="i">+
</a><a href="#h7-3-326" id="h7-3-326" class="i">+  })();
</a><a href="#h7-3-327" id="h7-3-327" class="i">+
</a><a href="#h7-3-328" id="h7-3-328" class="i">+  window.ZeroFrame = ZeroFrame;
</a><a href="#h7-3-329" id="h7-3-329" class="i">+
</a><a href="#h7-3-330" id="h7-3-330" class="i">+}).call(this);
</a><a href="#h7-3-331" id="h7-3-331" class="i">+
</a><a href="#h7-3-332" id="h7-3-332" class="i">+
</a><a href="#h7-3-333" id="h7-3-333" class="i">+
</a><a href="#h7-3-334" id="h7-3-334" class="i">+/* ---- data/1TaLk3zM7ZRskJvrh3ZNCDVGXvkJusPKQ/js/TopicList.coffee ---- */
</a><a href="#h7-3-335" id="h7-3-335" class="i">+
</a><a href="#h7-3-336" id="h7-3-336" class="i">+
</a><a href="#h7-3-337" id="h7-3-337" class="i">+(function() {
</a><a href="#h7-3-338" id="h7-3-338" class="i">+  var TopicList,
</a><a href="#h7-3-339" id="h7-3-339" class="i">+    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
</a><a href="#h7-3-340" id="h7-3-340" class="i">+    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
</a><a href="#h7-3-341" id="h7-3-341" class="i">+    __hasProp = {}.hasOwnProperty;
</a><a href="#h7-3-342" id="h7-3-342" class="i">+
</a><a href="#h7-3-343" id="h7-3-343" class="i">+  TopicList = (function(_super) {
</a><a href="#h7-3-344" id="h7-3-344" class="i">+    __extends(TopicList, _super);
</a><a href="#h7-3-345" id="h7-3-345" class="i">+
</a><a href="#h7-3-346" id="h7-3-346" class="i">+    function TopicList() {
</a><a href="#h7-3-347" id="h7-3-347" class="i">+      this.loadTopicsStat = __bind(this.loadTopicsStat, this);
</a><a href="#h7-3-348" id="h7-3-348" class="i">+      this.thread_sorter = null;
</a><a href="#h7-3-349" id="h7-3-349" class="i">+    }
</a><a href="#h7-3-350" id="h7-3-350" class="i">+
</a><a href="#h7-3-351" id="h7-3-351" class="i">+    TopicList.prototype.actionList = function() {
</a>       $(&quot;.topics-loading&quot;).cssLater(&quot;top&quot;, &quot;0px&quot;, 200);
       this.loadTopics(&quot;noanim&quot;);
       $(&quot;.topic-new-link&quot;).on(&quot;click&quot;, (function(_this) {
<a href="#h7-4" id="h7-4" class="h">@@ -1188,26 +1269,25 @@ jQuery.extend( jQuery.easing,
</a>       })(this));
       return $(&quot;.topic-new .button-submit&quot;).on(&quot;click&quot;, (function(_this) {
         return function() {
<a href="#h7-4-3" id="h7-4-3" class="d">-          if (_this.user_name_db[_this.site_info.auth_address]) {
</a><a href="#h7-4-4" id="h7-4-4" class="i">+          if (Page.user_name_db[Page.site_info.auth_address]) {
</a>             _this.buttonCreateTopic();
           } else {
<a href="#h7-4-7" id="h7-4-7" class="d">-            _this.cmd(&quot;wrapperNotification&quot;, [&quot;info&quot;, &quot;Please, request access before posting.&quot;]);
</a><a href="#h7-4-8" id="h7-4-8" class="i">+            Page.cmd(&quot;wrapperNotification&quot;, [&quot;info&quot;, &quot;Please, request access before posting.&quot;]);
</a>           }
           return false;
         };
       })(this));
     };
 
<a href="#h7-4-15" id="h7-4-15" class="d">-    ZeroTalk.prototype.loadTopics = function(type, cb) {
</a><a href="#h7-4-16" id="h7-4-16" class="d">-      var s;
</a><a href="#h7-4-17" id="h7-4-17" class="i">+    TopicList.prototype.loadTopics = function(type, cb) {
</a>       if (type == null) {
         type = &quot;normal&quot;;
       }
       if (cb == null) {
         cb = false;
       }
<a href="#h7-4-24" id="h7-4-24" class="d">-      s = +(new Date);
</a><a href="#h7-4-25" id="h7-4-25" class="d">-      return this.cmd(&quot;fileQuery&quot;, [&quot;data/users/*/data.json&quot;, &quot;topics&quot;], (function(_this) {
</a><a href="#h7-4-26" id="h7-4-26" class="i">+      this.logStart(&quot;Loadtopics&quot;);
</a><a href="#h7-4-27" id="h7-4-27" class="i">+      return Page.cmd(&quot;fileQuery&quot;, [&quot;data/users/*/data.json&quot;, &quot;topics&quot;], (function(_this) {
</a>         return function(topics) {
           var elem, last_elem, topic, topic_address, _i, _len;
           topics.sort(function(a, b) {
<a href="#h7-5" id="h7-5" class="h">@@ -1216,7 +1296,7 @@ jQuery.extend( jQuery.easing,
</a>           last_elem = null;
           for (_i = 0, _len = topics.length; _i &lt; _len; _i++) {
             topic = topics[_i];
<a href="#h7-5-3" id="h7-5-3" class="d">-            topic_address = topic.topic_id + &quot;_&quot; + _this.user_id_db[topic.inner_path];
</a><a href="#h7-5-4" id="h7-5-4" class="i">+            topic_address = topic.topic_id + &quot;_&quot; + Page.user_id_db[topic.inner_path];
</a>             elem = $(&quot;#topic_&quot; + topic_address);
             if (elem.length === 0) {
               elem = $(&quot;.topics-list .topic.template&quot;).clone().removeClass(&quot;template&quot;).attr(&quot;id&quot;, &quot;topic_&quot; + topic_address);
<a href="#h7-6" id="h7-6" class="h">@@ -1240,9 +1320,9 @@ jQuery.extend( jQuery.easing,
</a>           } else {
             $(&quot;.topics-loading&quot;).remove();
           }
<a href="#h7-6-3" id="h7-6-3" class="d">-          _this.log(&quot;Topics loaded in&quot;, (+(new Date)) - s);
</a><a href="#h7-6-4" id="h7-6-4" class="d">-          _this.addInlineEditors();
</a><a href="#h7-6-5" id="h7-6-5" class="d">-          if (_this.site_info.tasks === 0) {
</a><a href="#h7-6-6" id="h7-6-6" class="i">+          _this.logEnd(&quot;Loadtopics&quot;);
</a><a href="#h7-6-7" id="h7-6-7" class="i">+          Page.addInlineEditors();
</a><a href="#h7-6-8" id="h7-6-8" class="i">+          if (Page.site_info.tasks === 0) {
</a>             _this.loadTopicsStat(type);
           } else {
             clearInterval(_this.thread_sorter);
<a href="#h7-7" id="h7-7" class="h">@@ -1257,13 +1337,13 @@ jQuery.extend( jQuery.easing,
</a>       })(this));
     };
 
<a href="#h7-7-3" id="h7-7-3" class="d">-    ZeroTalk.prototype.loadTopicsStat = function(type) {
</a><a href="#h7-7-4" id="h7-7-4" class="i">+    TopicList.prototype.loadTopicsStat = function(type) {
</a>       var s;
       if (type == null) {
         type = &quot;normal&quot;;
       }
       s = +(new Date);
<a href="#h7-7-10" id="h7-7-10" class="d">-      return this.cmd(&quot;fileQuery&quot;, [&quot;data/users/*/data.json&quot;, &quot;&quot;], (function(_this) {
</a><a href="#h7-7-11" id="h7-7-11" class="i">+      return Page.cmd(&quot;fileQuery&quot;, [&quot;data/users/*/data.json&quot;, &quot;&quot;], (function(_this) {
</a>         return function(users) {
           var comment, comments, elem, last, stat, stats, topic, topic_address, topics, user, user_id, visited, _i, _j, _k, _l, _len, _len1, _len2, _len3, _ref, _ref1;
           $(&quot;.topics&quot;).css(&quot;opacity&quot;, 1);
<a href="#h7-8" id="h7-8" class="h">@@ -1273,7 +1353,7 @@ jQuery.extend( jQuery.easing,
</a>             _ref = user.topics;
             for (_j = 0, _len1 = _ref.length; _j &lt; _len1; _j++) {
               topic = _ref[_j];
<a href="#h7-8-3" id="h7-8-3" class="d">-              user_id = _this.user_id_db[user.inner_path];
</a><a href="#h7-8-4" id="h7-8-4" class="i">+              user_id = Page.user_id_db[user.inner_path];
</a>               topic_address = topic.topic_id + &quot;_&quot; + user_id;
               if (stats[topic_address] == null) {
                 stats[topic_address] = {
<a href="#h7-9" id="h7-9" class="h">@@ -1309,7 +1389,7 @@ jQuery.extend( jQuery.easing,
</a>             stat = stats[topic_address];
             if (stat.comments &gt; 0) {
               $(&quot;#topic_&quot; + topic_address + &quot; .comment-num&quot;).text(stat.comments + &quot; comment&quot;);
<a href="#h7-9-3" id="h7-9-3" class="d">-              $(&quot;#topic_&quot; + topic_address + &quot; .added&quot;).text(&quot;last &quot; + _this.formatSince(stat[&quot;last&quot;][&quot;added&quot;]));
</a><a href="#h7-9-4" id="h7-9-4" class="i">+              $(&quot;#topic_&quot; + topic_address + &quot; .added&quot;).text(&quot;last &quot; + Time.since(stat[&quot;last&quot;][&quot;added&quot;]));
</a>             }
           }
           topics = (function() {
<a href="#h7-10" id="h7-10" class="h">@@ -1329,7 +1409,7 @@ jQuery.extend( jQuery.easing,
</a>             topic_address = topic[0];
             elem = $(&quot;#topic_&quot; + topic_address);
             elem.prependTo(&quot;.topics&quot;);
<a href="#h7-10-3" id="h7-10-3" class="d">-            visited = _this.local_storage[&quot;topic.&quot; + topic_address + &quot;.visited&quot;];
</a><a href="#h7-10-4" id="h7-10-4" class="i">+            visited = Page.local_storage[&quot;topic.&quot; + topic_address + &quot;.visited&quot;];
</a>             if (!visited) {
               elem.addClass(&quot;visit-none&quot;);
             } else if (visited &lt; topic[1]) {
<a href="#h7-11" id="h7-11" class="h">@@ -1339,157 +1419,373 @@ jQuery.extend( jQuery.easing,
</a>           return _this.log(&quot;Topics stats loaded in&quot;, (+(new Date)) - s);
         };
       })(this));
<a href="#h7-11-3" id="h7-11-3" class="d">-    };
</a><a href="#h7-11-4" id="h7-11-4" class="d">-
</a><a href="#h7-11-5" id="h7-11-5" class="d">-    ZeroTalk.prototype.pageTopic = function(topic_id, topic_user_id) {
</a><a href="#h7-11-6" id="h7-11-6" class="d">-      this.topic_id = topic_id;
</a><a href="#h7-11-7" id="h7-11-7" class="d">-      this.topic_user_id = topic_user_id;
</a><a href="#h7-11-8" id="h7-11-8" class="d">-      this.loadTopic();
</a><a href="#h7-11-9" id="h7-11-9" class="d">-      this.loadComments(&quot;noanim&quot;);
</a><a href="#h7-11-10" id="h7-11-10" class="d">-      return $(&quot;.comment-new .button-submit&quot;).on(&quot;click&quot;, (function(_this) {
</a><a href="#h7-11-11" id="h7-11-11" class="i">+    };
</a><a href="#h7-11-12" id="h7-11-12" class="i">+
</a><a href="#h7-11-13" id="h7-11-13" class="i">+    TopicList.prototype.applyTopicData = function(elem, topic, type) {
</a><a href="#h7-11-14" id="h7-11-14" class="i">+      var body, match, title_hash, url, user_id, username;
</a><a href="#h7-11-15" id="h7-11-15" class="i">+      if (type == null) {
</a><a href="#h7-11-16" id="h7-11-16" class="i">+        type = &quot;normal&quot;;
</a><a href="#h7-11-17" id="h7-11-17" class="i">+      }
</a><a href="#h7-11-18" id="h7-11-18" class="i">+      title_hash = topic.title.replace(/[#,&quot;&apos;?&amp; ]/g, &quot;+&quot;).replace(/[+]+/g, &quot;+&quot;).replace(/[+]+$/, &quot;&quot;);
</a><a href="#h7-11-19" id="h7-11-19" class="i">+      user_id = Page.user_id_db[topic.inner_path];
</a><a href="#h7-11-20" id="h7-11-20" class="i">+      $(&quot;.title .title-link&quot;, elem).text(topic.title);
</a><a href="#h7-11-21" id="h7-11-21" class="i">+      $(&quot;.title .title-link, a.image, .comment-num&quot;, elem).attr(&quot;href&quot;, &quot;?Topic:&quot; + topic.topic_id + &quot;@&quot; + user_id + &quot;/&quot; + title_hash);
</a><a href="#h7-11-22" id="h7-11-22" class="i">+      body = topic.body;
</a><a href="#h7-11-23" id="h7-11-23" class="i">+      match = topic.body.match(/http[s]{0,1}:\/\/[^&quot;&apos;, $]+/);
</a><a href="#h7-11-24" id="h7-11-24" class="i">+      if (match) {
</a><a href="#h7-11-25" id="h7-11-25" class="i">+        url = match[0];
</a><a href="#h7-11-26" id="h7-11-26" class="i">+        if (type !== &quot;full&quot;) {
</a><a href="#h7-11-27" id="h7-11-27" class="i">+          body = body.replace(/http[s]{0,1}:\/\/[^&quot;&apos; $]+/g, &quot;&quot;);
</a><a href="#h7-11-28" id="h7-11-28" class="i">+        }
</a><a href="#h7-11-29" id="h7-11-29" class="i">+        $(&quot;.image .icon&quot;, elem).removeClass(&quot;icon-topic-chat&quot;).addClass(&quot;icon-topic-link&quot;);
</a><a href="#h7-11-30" id="h7-11-30" class="i">+        $(&quot;.link&quot;, elem).css(&quot;display&quot;, &quot;&quot;).attr(&quot;href&quot;, url.replace(/http:\/\/(127.0.0.1|localhost):43110/, &quot;&quot;));
</a><a href="#h7-11-31" id="h7-11-31" class="i">+        $(&quot;.link .link-url&quot;, elem).text(url);
</a><a href="#h7-11-32" id="h7-11-32" class="i">+      } else {
</a><a href="#h7-11-33" id="h7-11-33" class="i">+        $(&quot;.image .icon&quot;, elem).removeClass(&quot;icon-topic-link&quot;).addClass(&quot;icon-topic-chat&quot;);
</a><a href="#h7-11-34" id="h7-11-34" class="i">+        $(&quot;.link&quot;, elem).css(&quot;display&quot;, &quot;none&quot;);
</a><a href="#h7-11-35" id="h7-11-35" class="i">+      }
</a><a href="#h7-11-36" id="h7-11-36" class="i">+      if (type === &quot;full&quot;) {
</a><a href="#h7-11-37" id="h7-11-37" class="i">+        $(&quot;.body&quot;, elem).html(Text.toMarked(body, {
</a><a href="#h7-11-38" id="h7-11-38" class="i">+          &quot;sanitize&quot;: true
</a><a href="#h7-11-39" id="h7-11-39" class="i">+        }));
</a><a href="#h7-11-40" id="h7-11-40" class="i">+      } else {
</a><a href="#h7-11-41" id="h7-11-41" class="i">+        $(&quot;.body&quot;, elem).text(body);
</a><a href="#h7-11-42" id="h7-11-42" class="i">+      }
</a><a href="#h7-11-43" id="h7-11-43" class="i">+      username = Page.user_name_db[topic.inner_path];
</a><a href="#h7-11-44" id="h7-11-44" class="i">+      $(&quot;.username&quot;, elem).text(username);
</a><a href="#h7-11-45" id="h7-11-45" class="i">+      $(&quot;.added&quot;, elem).text(Time.since(topic.added));
</a><a href="#h7-11-46" id="h7-11-46" class="i">+      if (topic.inner_path === Page.site_info.auth_address) {
</a><a href="#h7-11-47" id="h7-11-47" class="i">+        $(elem).attr(&quot;data-object&quot;, &quot;Topic:&quot; + topic.topic_id + &quot;@&quot; + user_id).attr(&quot;data-deletable&quot;, &quot;yes&quot;);
</a><a href="#h7-11-48" id="h7-11-48" class="i">+        $(&quot;.title .title-link&quot;, elem).attr(&quot;data-editable&quot;, &quot;title&quot;).data(&quot;content&quot;, topic.title);
</a><a href="#h7-11-49" id="h7-11-49" class="i">+        return $(&quot;.body&quot;, elem).attr(&quot;data-editable&quot;, &quot;body&quot;).data(&quot;content&quot;, topic.body);
</a><a href="#h7-11-50" id="h7-11-50" class="i">+      }
</a><a href="#h7-11-51" id="h7-11-51" class="i">+    };
</a><a href="#h7-11-52" id="h7-11-52" class="i">+
</a><a href="#h7-11-53" id="h7-11-53" class="i">+    TopicList.prototype.buttonCreateTopic = function() {
</a><a href="#h7-11-54" id="h7-11-54" class="i">+      var body, inner_path, title;
</a><a href="#h7-11-55" id="h7-11-55" class="i">+      if (!Page.hasOpenPort()) {
</a><a href="#h7-11-56" id="h7-11-56" class="i">+        return false;
</a><a href="#h7-11-57" id="h7-11-57" class="i">+      }
</a><a href="#h7-11-58" id="h7-11-58" class="i">+      title = $(&quot;.topic-new #topic_title&quot;).val();
</a><a href="#h7-11-59" id="h7-11-59" class="i">+      body = $(&quot;.topic-new #topic_body&quot;).val();
</a><a href="#h7-11-60" id="h7-11-60" class="i">+      if (!title) {
</a><a href="#h7-11-61" id="h7-11-61" class="i">+        return $(&quot;.topic-new #topic_title&quot;).focus();
</a><a href="#h7-11-62" id="h7-11-62" class="i">+      }
</a><a href="#h7-11-63" id="h7-11-63" class="i">+      $(&quot;.topic-new .button-submit&quot;).addClass(&quot;loading&quot;);
</a><a href="#h7-11-64" id="h7-11-64" class="i">+      inner_path = &quot;data/users/&quot; + Page.site_info.auth_address + &quot;/data.json&quot;;
</a><a href="#h7-11-65" id="h7-11-65" class="i">+      return Page.cmd(&quot;fileGet&quot;, [inner_path], (function(_this) {
</a><a href="#h7-11-66" id="h7-11-66" class="i">+        return function(data) {
</a><a href="#h7-11-67" id="h7-11-67" class="i">+          data = JSON.parse(data);
</a><a href="#h7-11-68" id="h7-11-68" class="i">+          data.topics.push({
</a><a href="#h7-11-69" id="h7-11-69" class="i">+            &quot;topic_id&quot;: data.next_topic_id,
</a><a href="#h7-11-70" id="h7-11-70" class="i">+            &quot;title&quot;: title,
</a><a href="#h7-11-71" id="h7-11-71" class="i">+            &quot;body&quot;: body,
</a><a href="#h7-11-72" id="h7-11-72" class="i">+            &quot;added&quot;: Time.timestamp()
</a><a href="#h7-11-73" id="h7-11-73" class="i">+          });
</a><a href="#h7-11-74" id="h7-11-74" class="i">+          data.next_topic_id += 1;
</a><a href="#h7-11-75" id="h7-11-75" class="i">+          return Page.writePublish(inner_path, Page.jsonEncode(data), function(res) {
</a><a href="#h7-11-76" id="h7-11-76" class="i">+            $(&quot;.topic-new .button-submit&quot;).removeClass(&quot;loading&quot;);
</a><a href="#h7-11-77" id="h7-11-77" class="i">+            if (res === true) {
</a><a href="#h7-11-78" id="h7-11-78" class="i">+              _this.log(&quot;File written&quot;);
</a><a href="#h7-11-79" id="h7-11-79" class="i">+              $(&quot;.topic-new&quot;).slideUp();
</a><a href="#h7-11-80" id="h7-11-80" class="i">+              $(&quot;.topic-new-link&quot;).slideDown();
</a><a href="#h7-11-81" id="h7-11-81" class="i">+              setTimeout((function() {
</a><a href="#h7-11-82" id="h7-11-82" class="i">+                return _this.loadTopics();
</a><a href="#h7-11-83" id="h7-11-83" class="i">+              }), 600);
</a><a href="#h7-11-84" id="h7-11-84" class="i">+              $(&quot;.topic-new #topic_body&quot;).val(&quot;&quot;);
</a><a href="#h7-11-85" id="h7-11-85" class="i">+              return $(&quot;.topic-new #topic_title&quot;).val(&quot;&quot;);
</a><a href="#h7-11-86" id="h7-11-86" class="i">+            } else {
</a><a href="#h7-11-87" id="h7-11-87" class="i">+              return Page.cmd(&quot;wrapperNotification&quot;, [&quot;error&quot;, &quot;File write error: &quot; + res]);
</a><a href="#h7-11-88" id="h7-11-88" class="i">+            }
</a><a href="#h7-11-89" id="h7-11-89" class="i">+          });
</a><a href="#h7-11-90" id="h7-11-90" class="i">+        };
</a><a href="#h7-11-91" id="h7-11-91" class="i">+      })(this));
</a><a href="#h7-11-92" id="h7-11-92" class="i">+    };
</a><a href="#h7-11-93" id="h7-11-93" class="i">+
</a><a href="#h7-11-94" id="h7-11-94" class="i">+    return TopicList;
</a><a href="#h7-11-95" id="h7-11-95" class="i">+
</a><a href="#h7-11-96" id="h7-11-96" class="i">+  })(Class);
</a><a href="#h7-11-97" id="h7-11-97" class="i">+
</a><a href="#h7-11-98" id="h7-11-98" class="i">+  window.TopicList = new TopicList();
</a><a href="#h7-11-99" id="h7-11-99" class="i">+
</a><a href="#h7-11-100" id="h7-11-100" class="i">+}).call(this);
</a><a href="#h7-11-101" id="h7-11-101" class="i">+
</a><a href="#h7-11-102" id="h7-11-102" class="i">+
</a><a href="#h7-11-103" id="h7-11-103" class="i">+
</a><a href="#h7-11-104" id="h7-11-104" class="i">+/* ---- data/1TaLk3zM7ZRskJvrh3ZNCDVGXvkJusPKQ/js/TopicShow.coffee ---- */
</a><a href="#h7-11-105" id="h7-11-105" class="i">+
</a><a href="#h7-11-106" id="h7-11-106" class="i">+
</a><a href="#h7-11-107" id="h7-11-107" class="i">+(function() {
</a><a href="#h7-11-108" id="h7-11-108" class="i">+  var TopicShow,
</a><a href="#h7-11-109" id="h7-11-109" class="i">+    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
</a><a href="#h7-11-110" id="h7-11-110" class="i">+    __hasProp = {}.hasOwnProperty;
</a><a href="#h7-11-111" id="h7-11-111" class="i">+
</a><a href="#h7-11-112" id="h7-11-112" class="i">+  TopicShow = (function(_super) {
</a><a href="#h7-11-113" id="h7-11-113" class="i">+    __extends(TopicShow, _super);
</a><a href="#h7-11-114" id="h7-11-114" class="i">+
</a><a href="#h7-11-115" id="h7-11-115" class="i">+    function TopicShow() {
</a><a href="#h7-11-116" id="h7-11-116" class="i">+      return TopicShow.__super__.constructor.apply(this, arguments);
</a><a href="#h7-11-117" id="h7-11-117" class="i">+    }
</a><a href="#h7-11-118" id="h7-11-118" class="i">+
</a><a href="#h7-11-119" id="h7-11-119" class="i">+    TopicShow.prototype.actionShow = function(topic_id, topic_user_id) {
</a><a href="#h7-11-120" id="h7-11-120" class="i">+      this.topic_id = topic_id;
</a><a href="#h7-11-121" id="h7-11-121" class="i">+      this.topic_user_id = topic_user_id;
</a><a href="#h7-11-122" id="h7-11-122" class="i">+      this.loadTopic();
</a><a href="#h7-11-123" id="h7-11-123" class="i">+      this.loadComments(&quot;noanim&quot;);
</a><a href="#h7-11-124" id="h7-11-124" class="i">+      return $(&quot;.comment-new .button-submit&quot;).on(&quot;click&quot;, (function(_this) {
</a><a href="#h7-11-125" id="h7-11-125" class="i">+        return function() {
</a><a href="#h7-11-126" id="h7-11-126" class="i">+          if (Page.user_name_db[Page.site_info.auth_address]) {
</a><a href="#h7-11-127" id="h7-11-127" class="i">+            _this.buttonComment();
</a><a href="#h7-11-128" id="h7-11-128" class="i">+          } else {
</a><a href="#h7-11-129" id="h7-11-129" class="i">+            Page.cmd(&quot;wrapperNotification&quot;, [&quot;info&quot;, &quot;Please, request access before posting.&quot;]);
</a><a href="#h7-11-130" id="h7-11-130" class="i">+          }
</a><a href="#h7-11-131" id="h7-11-131" class="i">+          return false;
</a><a href="#h7-11-132" id="h7-11-132" class="i">+        };
</a><a href="#h7-11-133" id="h7-11-133" class="i">+      })(this));
</a><a href="#h7-11-134" id="h7-11-134" class="i">+    };
</a><a href="#h7-11-135" id="h7-11-135" class="i">+
</a><a href="#h7-11-136" id="h7-11-136" class="i">+    TopicShow.prototype.loadTopic = function(cb) {
</a><a href="#h7-11-137" id="h7-11-137" class="i">+      var topic_user_address;
</a><a href="#h7-11-138" id="h7-11-138" class="i">+      if (cb == null) {
</a><a href="#h7-11-139" id="h7-11-139" class="i">+        cb = false;
</a><a href="#h7-11-140" id="h7-11-140" class="i">+      }
</a><a href="#h7-11-141" id="h7-11-141" class="i">+      topic_user_address = Page.user_address_db[this.topic_user_id];
</a><a href="#h7-11-142" id="h7-11-142" class="i">+      return Page.cmd(&quot;fileQuery&quot;, [&quot;data/users/&quot; + topic_user_address + &quot;/data.json&quot;, &quot;topics.topic_id=&quot; + this.topic_id], (function(_this) {
</a><a href="#h7-11-143" id="h7-11-143" class="i">+        return function(topic) {
</a><a href="#h7-11-144" id="h7-11-144" class="i">+          topic = topic[0];
</a><a href="#h7-11-145" id="h7-11-145" class="i">+          topic[&quot;inner_path&quot;] = topic_user_address;
</a><a href="#h7-11-146" id="h7-11-146" class="i">+          TopicList.applyTopicData($(&quot;.topic-full&quot;), topic, &quot;full&quot;);
</a><a href="#h7-11-147" id="h7-11-147" class="i">+          $(&quot;.topic-full&quot;).css(&quot;opacity&quot;, 1);
</a><a href="#h7-11-148" id="h7-11-148" class="i">+          $(&quot;body&quot;).addClass(&quot;page-topic&quot;);
</a><a href="#h7-11-149" id="h7-11-149" class="i">+          if (cb) {
</a><a href="#h7-11-150" id="h7-11-150" class="i">+            return cb();
</a><a href="#h7-11-151" id="h7-11-151" class="i">+          }
</a><a href="#h7-11-152" id="h7-11-152" class="i">+        };
</a><a href="#h7-11-153" id="h7-11-153" class="i">+      })(this));
</a><a href="#h7-11-154" id="h7-11-154" class="i">+    };
</a><a href="#h7-11-155" id="h7-11-155" class="i">+
</a><a href="#h7-11-156" id="h7-11-156" class="i">+    TopicShow.prototype.loadComments = function(type, cb) {
</a><a href="#h7-11-157" id="h7-11-157" class="i">+      var topic_address;
</a><a href="#h7-11-158" id="h7-11-158" class="i">+      if (type == null) {
</a><a href="#h7-11-159" id="h7-11-159" class="i">+        type = &quot;normal&quot;;
</a><a href="#h7-11-160" id="h7-11-160" class="i">+      }
</a><a href="#h7-11-161" id="h7-11-161" class="i">+      if (cb == null) {
</a><a href="#h7-11-162" id="h7-11-162" class="i">+        cb = false;
</a><a href="#h7-11-163" id="h7-11-163" class="i">+      }
</a><a href="#h7-11-164" id="h7-11-164" class="i">+      topic_address = this.topic_id + &quot;@&quot; + this.topic_user_id;
</a><a href="#h7-11-165" id="h7-11-165" class="i">+      Page.local_storage[&quot;topic.&quot; + this.topic_id + &quot;_&quot; + this.topic_user_id + &quot;.visited&quot;] = Time.timestamp();
</a><a href="#h7-11-166" id="h7-11-166" class="i">+      Page.cmd(&quot;wrapperSetLocalStorage&quot;, Page.local_storage);
</a><a href="#h7-11-167" id="h7-11-167" class="i">+      return Page.cmd(&quot;fileQuery&quot;, [&quot;data/users/*/data.json&quot;, &quot;comments.&quot; + topic_address], (function(_this) {
</a><a href="#h7-11-168" id="h7-11-168" class="i">+        return function(comments) {
</a><a href="#h7-11-169" id="h7-11-169" class="i">+          var comment, comment_address, elem, user_id, _i, _len;
</a><a href="#h7-11-170" id="h7-11-170" class="i">+          comments.sort(function(a, b) {
</a><a href="#h7-11-171" id="h7-11-171" class="i">+            return b.added - a.added;
</a><a href="#h7-11-172" id="h7-11-172" class="i">+          });
</a><a href="#h7-11-173" id="h7-11-173" class="i">+          for (_i = 0, _len = comments.length; _i &lt; _len; _i++) {
</a><a href="#h7-11-174" id="h7-11-174" class="i">+            comment = comments[_i];
</a><a href="#h7-11-175" id="h7-11-175" class="i">+            user_id = Page.user_id_db[comment.inner_path];
</a><a href="#h7-11-176" id="h7-11-176" class="i">+            comment_address = comment.comment_id + &quot;_&quot; + user_id;
</a><a href="#h7-11-177" id="h7-11-177" class="i">+            elem = $(&quot;#comment_&quot; + comment_address);
</a><a href="#h7-11-178" id="h7-11-178" class="i">+            if (elem.length === 0) {
</a><a href="#h7-11-179" id="h7-11-179" class="i">+              elem = $(&quot;.comment.template&quot;).clone().removeClass(&quot;template&quot;).attr(&quot;id&quot;, &quot;comment_&quot; + comment_address).data(&quot;topic_address&quot;, topic_address);
</a><a href="#h7-11-180" id="h7-11-180" class="i">+              if (type !== &quot;noanim&quot;) {
</a><a href="#h7-11-181" id="h7-11-181" class="i">+                elem.cssSlideDown();
</a><a href="#h7-11-182" id="h7-11-182" class="i">+              }
</a><a href="#h7-11-183" id="h7-11-183" class="i">+              $(&quot;.added&quot;, elem).on(&quot;click&quot;, function(e) {
</a><a href="#h7-11-184" id="h7-11-184" class="i">+                return _this.buttonReply($(e.target).parents(&quot;.comment&quot;));
</a><a href="#h7-11-185" id="h7-11-185" class="i">+              });
</a><a href="#h7-11-186" id="h7-11-186" class="i">+            }
</a><a href="#h7-11-187" id="h7-11-187" class="i">+            _this.applyCommentData(elem, comment);
</a><a href="#h7-11-188" id="h7-11-188" class="i">+            elem.appendTo(&quot;.comments&quot;);
</a><a href="#h7-11-189" id="h7-11-189" class="i">+          }
</a><a href="#h7-11-190" id="h7-11-190" class="i">+          $(&quot;body&quot;).css({
</a><a href="#h7-11-191" id="h7-11-191" class="i">+            &quot;overflow&quot;: &quot;auto&quot;,
</a><a href="#h7-11-192" id="h7-11-192" class="i">+            &quot;height&quot;: &quot;auto&quot;
</a><a href="#h7-11-193" id="h7-11-193" class="i">+          });
</a><a href="#h7-11-194" id="h7-11-194" class="i">+          Page.addInlineEditors();
</a><a href="#h7-11-195" id="h7-11-195" class="i">+          if (cb) {
</a><a href="#h7-11-196" id="h7-11-196" class="i">+            return cb();
</a><a href="#h7-11-197" id="h7-11-197" class="i">+          }
</a><a href="#h7-11-198" id="h7-11-198" class="i">+        };
</a><a href="#h7-11-199" id="h7-11-199" class="i">+      })(this));
</a><a href="#h7-11-200" id="h7-11-200" class="i">+    };
</a><a href="#h7-11-201" id="h7-11-201" class="i">+
</a><a href="#h7-11-202" id="h7-11-202" class="i">+    TopicShow.prototype.applyCommentData = function(elem, comment) {
</a><a href="#h7-11-203" id="h7-11-203" class="i">+      var comment_id, topic_address, user_id, username;
</a><a href="#h7-11-204" id="h7-11-204" class="i">+      username = Page.user_name_db[comment.inner_path];
</a><a href="#h7-11-205" id="h7-11-205" class="i">+      $(&quot;.body&quot;, elem).html(Text.toMarked(comment.body, {
</a><a href="#h7-11-206" id="h7-11-206" class="i">+        &quot;sanitize&quot;: true
</a><a href="#h7-11-207" id="h7-11-207" class="i">+      }));
</a><a href="#h7-11-208" id="h7-11-208" class="i">+      $(&quot;.username&quot;, elem).text(username).css({
</a><a href="#h7-11-209" id="h7-11-209" class="i">+        &quot;color&quot;: Text.toColor(username)
</a><a href="#h7-11-210" id="h7-11-210" class="i">+      });
</a><a href="#h7-11-211" id="h7-11-211" class="i">+      $(&quot;.added&quot;, elem).text(Time.since(comment.added));
</a><a href="#h7-11-212" id="h7-11-212" class="i">+      if (comment.inner_path === Page.site_info.auth_address) {
</a><a href="#h7-11-213" id="h7-11-213" class="i">+        user_id = Page.user_id_db[comment.inner_path];
</a><a href="#h7-11-214" id="h7-11-214" class="i">+        comment_id = elem.attr(&quot;id&quot;).replace(&quot;comment_&quot;, &quot;&quot;).replace(/_.*$/, &quot;&quot;);
</a><a href="#h7-11-215" id="h7-11-215" class="i">+        topic_address = elem.data(&quot;topic_address&quot;);
</a><a href="#h7-11-216" id="h7-11-216" class="i">+        $(elem).attr(&quot;data-object&quot;, &quot;Comment:&quot; + comment_id + &quot;@&quot; + topic_address).attr(&quot;data-deletable&quot;, &quot;yes&quot;);
</a><a href="#h7-11-217" id="h7-11-217" class="i">+        return $(&quot;.body&quot;, elem).attr(&quot;data-editable&quot;, &quot;body&quot;).data(&quot;content&quot;, comment.body);
</a><a href="#h7-11-218" id="h7-11-218" class="i">+      }
</a><a href="#h7-11-219" id="h7-11-219" class="i">+    };
</a><a href="#h7-11-220" id="h7-11-220" class="i">+
</a><a href="#h7-11-221" id="h7-11-221" class="i">+    TopicShow.prototype.buttonComment = function() {
</a><a href="#h7-11-222" id="h7-11-222" class="i">+      var body, inner_path, topic_address;
</a><a href="#h7-11-223" id="h7-11-223" class="i">+      if (!Page.hasOpenPort()) {
</a><a href="#h7-11-224" id="h7-11-224" class="i">+        return false;
</a><a href="#h7-11-225" id="h7-11-225" class="i">+      }
</a><a href="#h7-11-226" id="h7-11-226" class="i">+      body = $(&quot;.comment-new #comment_body&quot;).val();
</a><a href="#h7-11-227" id="h7-11-227" class="i">+      if (!body) {
</a><a href="#h7-11-228" id="h7-11-228" class="i">+        $(&quot;.comment-new #comment_body&quot;).focus();
</a><a href="#h7-11-229" id="h7-11-229" class="i">+      }
</a><a href="#h7-11-230" id="h7-11-230" class="i">+      topic_address = this.topic_id + &quot;@&quot; + this.topic_user_id;
</a><a href="#h7-11-231" id="h7-11-231" class="i">+      $(&quot;.comment-new .button-submit&quot;).addClass(&quot;loading&quot;);
</a><a href="#h7-11-232" id="h7-11-232" class="i">+      inner_path = &quot;data/users/&quot; + Page.site_info.auth_address + &quot;/data.json&quot;;
</a><a href="#h7-11-233" id="h7-11-233" class="i">+      return Page.cmd(&quot;fileGet&quot;, [inner_path], (function(_this) {
</a><a href="#h7-11-234" id="h7-11-234" class="i">+        return function(data) {
</a><a href="#h7-11-235" id="h7-11-235" class="i">+          var _base;
</a><a href="#h7-11-236" id="h7-11-236" class="i">+          data = JSON.parse(data);
</a><a href="#h7-11-237" id="h7-11-237" class="i">+          if ((_base = data.comments)[topic_address] == null) {
</a><a href="#h7-11-238" id="h7-11-238" class="i">+            _base[topic_address] = [];
</a><a href="#h7-11-239" id="h7-11-239" class="i">+          }
</a><a href="#h7-11-240" id="h7-11-240" class="i">+          data.comments[topic_address].push({
</a><a href="#h7-11-241" id="h7-11-241" class="i">+            &quot;comment_id&quot;: data.next_message_id,
</a><a href="#h7-11-242" id="h7-11-242" class="i">+            &quot;body&quot;: body,
</a><a href="#h7-11-243" id="h7-11-243" class="i">+            &quot;added&quot;: Time.timestamp()
</a><a href="#h7-11-244" id="h7-11-244" class="i">+          });
</a><a href="#h7-11-245" id="h7-11-245" class="i">+          data.next_message_id += 1;
</a><a href="#h7-11-246" id="h7-11-246" class="i">+          return Page.writePublish(inner_path, Page.jsonEncode(data), function(res) {
</a><a href="#h7-11-247" id="h7-11-247" class="i">+            $(&quot;.comment-new .button-submit&quot;).removeClass(&quot;loading&quot;);
</a><a href="#h7-11-248" id="h7-11-248" class="i">+            if (res === true) {
</a><a href="#h7-11-249" id="h7-11-249" class="i">+              _this.log(&quot;File written&quot;);
</a><a href="#h7-11-250" id="h7-11-250" class="i">+              _this.loadComments();
</a><a href="#h7-11-251" id="h7-11-251" class="i">+              return $(&quot;.comment-new #comment_body&quot;).val(&quot;&quot;);
</a><a href="#h7-11-252" id="h7-11-252" class="i">+            }
</a><a href="#h7-11-253" id="h7-11-253" class="i">+          });
</a><a href="#h7-11-254" id="h7-11-254" class="i">+        };
</a><a href="#h7-11-255" id="h7-11-255" class="i">+      })(this));
</a><a href="#h7-11-256" id="h7-11-256" class="i">+    };
</a><a href="#h7-11-257" id="h7-11-257" class="i">+
</a><a href="#h7-11-258" id="h7-11-258" class="i">+    TopicShow.prototype.buttonReply = function(elem) {
</a><a href="#h7-11-259" id="h7-11-259" class="i">+      var body_add, post_id, username;
</a><a href="#h7-11-260" id="h7-11-260" class="i">+      this.log(&quot;Reply to&quot;, elem);
</a><a href="#h7-11-261" id="h7-11-261" class="i">+      username = $(&quot;.username&quot;, elem).text();
</a><a href="#h7-11-262" id="h7-11-262" class="i">+      post_id = elem.attr(&quot;id&quot;);
</a><a href="#h7-11-263" id="h7-11-263" class="i">+      body_add = &quot;&gt; [&quot; + username + &quot;](\#&quot; + post_id + &quot;): &quot;;
</a><a href="#h7-11-264" id="h7-11-264" class="i">+      body_add += $(&quot;.body&quot;, elem).text().trim(&quot;\n&quot;).replace(/\n/g, &quot;\n&gt; &quot;);
</a><a href="#h7-11-265" id="h7-11-265" class="i">+      body_add += &quot;\n\n&quot;;
</a><a href="#h7-11-266" id="h7-11-266" class="i">+      $(&quot;.comment-new #comment_body&quot;).val($(&quot;.comment-new #comment_body&quot;).val() + body_add);
</a><a href="#h7-11-267" id="h7-11-267" class="i">+      $(&quot;.comment-new #comment_body&quot;).trigger(&quot;input&quot;).focus();
</a><a href="#h7-11-268" id="h7-11-268" class="i">+      return false;
</a><a href="#h7-11-269" id="h7-11-269" class="i">+    };
</a><a href="#h7-11-270" id="h7-11-270" class="i">+
</a><a href="#h7-11-271" id="h7-11-271" class="i">+    return TopicShow;
</a><a href="#h7-11-272" id="h7-11-272" class="i">+
</a><a href="#h7-11-273" id="h7-11-273" class="i">+  })(Class);
</a><a href="#h7-11-274" id="h7-11-274" class="i">+
</a><a href="#h7-11-275" id="h7-11-275" class="i">+  window.TopicShow = new TopicShow();
</a><a href="#h7-11-276" id="h7-11-276" class="i">+
</a><a href="#h7-11-277" id="h7-11-277" class="i">+}).call(this);
</a><a href="#h7-11-278" id="h7-11-278" class="i">+
</a><a href="#h7-11-279" id="h7-11-279" class="i">+
</a><a href="#h7-11-280" id="h7-11-280" class="i">+
</a><a href="#h7-11-281" id="h7-11-281" class="i">+/* ---- data/1TaLk3zM7ZRskJvrh3ZNCDVGXvkJusPKQ/js/ZeroTalk.coffee ---- */
</a><a href="#h7-11-282" id="h7-11-282" class="i">+
</a><a href="#h7-11-283" id="h7-11-283" class="i">+
</a><a href="#h7-11-284" id="h7-11-284" class="i">+(function() {
</a><a href="#h7-11-285" id="h7-11-285" class="i">+  var ZeroTalk,
</a><a href="#h7-11-286" id="h7-11-286" class="i">+    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
</a><a href="#h7-11-287" id="h7-11-287" class="i">+    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
</a><a href="#h7-11-288" id="h7-11-288" class="i">+    __hasProp = {}.hasOwnProperty;
</a><a href="#h7-11-289" id="h7-11-289" class="i">+
</a><a href="#h7-11-290" id="h7-11-290" class="i">+  ZeroTalk = (function(_super) {
</a><a href="#h7-11-291" id="h7-11-291" class="i">+    __extends(ZeroTalk, _super);
</a><a href="#h7-11-292" id="h7-11-292" class="i">+
</a><a href="#h7-11-293" id="h7-11-293" class="i">+    function ZeroTalk() {
</a><a href="#h7-11-294" id="h7-11-294" class="i">+      this.setSiteinfo = __bind(this.setSiteinfo, this);
</a><a href="#h7-11-295" id="h7-11-295" class="i">+      this.actionSetSiteInfo = __bind(this.actionSetSiteInfo, this);
</a><a href="#h7-11-296" id="h7-11-296" class="i">+      this.saveContent = __bind(this.saveContent, this);
</a><a href="#h7-11-297" id="h7-11-297" class="i">+      this.getObject = __bind(this.getObject, this);
</a><a href="#h7-11-298" id="h7-11-298" class="i">+      this.getContent = __bind(this.getContent, this);
</a><a href="#h7-11-299" id="h7-11-299" class="i">+      this.onOpenWebsocket = __bind(this.onOpenWebsocket, this);
</a><a href="#h7-11-300" id="h7-11-300" class="i">+      return ZeroTalk.__super__.constructor.apply(this, arguments);
</a><a href="#h7-11-301" id="h7-11-301" class="i">+    }
</a><a href="#h7-11-302" id="h7-11-302" class="i">+
</a><a href="#h7-11-303" id="h7-11-303" class="i">+    ZeroTalk.prototype.init = function() {
</a><a href="#h7-11-304" id="h7-11-304" class="i">+      var textarea, _i, _len, _ref;
</a><a href="#h7-11-305" id="h7-11-305" class="i">+      this.log(&quot;inited!&quot;);
</a><a href="#h7-11-306" id="h7-11-306" class="i">+      this.site_info = null;
</a><a href="#h7-11-307" id="h7-11-307" class="i">+      this.server_info = null;
</a><a href="#h7-11-308" id="h7-11-308" class="i">+      this.local_storage = {};
</a><a href="#h7-11-309" id="h7-11-309" class="i">+      this.user_id_db = {};
</a><a href="#h7-11-310" id="h7-11-310" class="i">+      this.user_address_db = {};
</a><a href="#h7-11-311" id="h7-11-311" class="i">+      this.user_name_db = {};
</a><a href="#h7-11-312" id="h7-11-312" class="i">+      this.user_max_size = null;
</a><a href="#h7-11-313" id="h7-11-313" class="i">+      _ref = $(&quot;textarea&quot;);
</a><a href="#h7-11-314" id="h7-11-314" class="i">+      for (_i = 0, _len = _ref.length; _i &lt; _len; _i++) {
</a><a href="#h7-11-315" id="h7-11-315" class="i">+        textarea = _ref[_i];
</a><a href="#h7-11-316" id="h7-11-316" class="i">+        this.autoExpand($(textarea));
</a><a href="#h7-11-317" id="h7-11-317" class="i">+      }
</a><a href="#h7-11-318" id="h7-11-318" class="i">+      $(&quot;.button.signup&quot;).on(&quot;click&quot;, (function(_this) {
</a><a href="#h7-11-319" id="h7-11-319" class="i">+        return function() {
</a><a href="#h7-11-320" id="h7-11-320" class="i">+          _this.buttonSignup();
</a><a href="#h7-11-321" id="h7-11-321" class="i">+          return false;
</a><a href="#h7-11-322" id="h7-11-322" class="i">+        };
</a><a href="#h7-11-323" id="h7-11-323" class="i">+      })(this));
</a><a href="#h7-11-324" id="h7-11-324" class="i">+      return $(&quot;.editbar .icon-help&quot;).on(&quot;click&quot;, (function(_this) {
</a>         return function() {
<a href="#h7-11-326" id="h7-11-326" class="d">-          if (_this.user_name_db[_this.site_info.auth_address]) {
</a><a href="#h7-11-327" id="h7-11-327" class="d">-            _this.buttonComment();
</a><a href="#h7-11-328" id="h7-11-328" class="d">-          } else {
</a><a href="#h7-11-329" id="h7-11-329" class="d">-            _this.cmd(&quot;wrapperNotification&quot;, [&quot;info&quot;, &quot;Please, request access before posting.&quot;]);
</a><a href="#h7-11-330" id="h7-11-330" class="d">-          }
</a><a href="#h7-11-331" id="h7-11-331" class="i">+          $(&quot;.editbar .markdown-help&quot;).css(&quot;display&quot;, &quot;block&quot;);
</a><a href="#h7-11-332" id="h7-11-332" class="i">+          $(&quot;.editbar .markdown-help&quot;).toggleClassLater(&quot;visible&quot;, 10);
</a><a href="#h7-11-333" id="h7-11-333" class="i">+          $(&quot;.editbar .icon-help&quot;).toggleClass(&quot;active&quot;);
</a>           return false;
         };
       })(this));
     };
 
<a href="#h7-11-339" id="h7-11-339" class="d">-    ZeroTalk.prototype.loadTopic = function(cb) {
</a><a href="#h7-11-340" id="h7-11-340" class="d">-      var topic_user_address;
</a><a href="#h7-11-341" id="h7-11-341" class="d">-      if (cb == null) {
</a><a href="#h7-11-342" id="h7-11-342" class="d">-        cb = false;
</a><a href="#h7-11-343" id="h7-11-343" class="d">-      }
</a><a href="#h7-11-344" id="h7-11-344" class="d">-      topic_user_address = this.user_address_db[this.topic_user_id];
</a><a href="#h7-11-345" id="h7-11-345" class="d">-      return this.cmd(&quot;fileQuery&quot;, [&quot;data/users/&quot; + topic_user_address + &quot;/data.json&quot;, &quot;topics.topic_id=&quot; + this.topic_id], (function(_this) {
</a><a href="#h7-11-346" id="h7-11-346" class="d">-        return function(topic) {
</a><a href="#h7-11-347" id="h7-11-347" class="d">-          topic = topic[0];
</a><a href="#h7-11-348" id="h7-11-348" class="d">-          topic[&quot;inner_path&quot;] = topic_user_address;
</a><a href="#h7-11-349" id="h7-11-349" class="d">-          _this.applyTopicData($(&quot;.topic-full&quot;), topic, &quot;full&quot;);
</a><a href="#h7-11-350" id="h7-11-350" class="d">-          $(&quot;.topic-full&quot;).css(&quot;opacity&quot;, 1);
</a><a href="#h7-11-351" id="h7-11-351" class="d">-          $(&quot;body&quot;).addClass(&quot;page-topic&quot;);
</a><a href="#h7-11-352" id="h7-11-352" class="d">-          if (cb) {
</a><a href="#h7-11-353" id="h7-11-353" class="d">-            return cb();
</a><a href="#h7-11-354" id="h7-11-354" class="i">+    ZeroTalk.prototype.onOpenWebsocket = function(e) {
</a><a href="#h7-11-355" id="h7-11-355" class="i">+      this.cmd(&quot;wrapperSetViewport&quot;, &quot;width=device-width, initial-scale=1.0&quot;);
</a><a href="#h7-11-356" id="h7-11-356" class="i">+      this.cmd(&quot;wrapperGetLocalStorage&quot;, [], (function(_this) {
</a><a href="#h7-11-357" id="h7-11-357" class="i">+        return function(res) {
</a><a href="#h7-11-358" id="h7-11-358" class="i">+          if (res == null) {
</a><a href="#h7-11-359" id="h7-11-359" class="i">+            res = {};
</a>           }
<a href="#h7-11-361" id="h7-11-361" class="i">+          return _this.local_storage = res;
</a>         };
       })(this));
<a href="#h7-11-364" id="h7-11-364" class="d">-    };
</a><a href="#h7-11-365" id="h7-11-365" class="d">-
</a><a href="#h7-11-366" id="h7-11-366" class="d">-    ZeroTalk.prototype.loadComments = function(type, cb) {
</a><a href="#h7-11-367" id="h7-11-367" class="d">-      var topic_address;
</a><a href="#h7-11-368" id="h7-11-368" class="d">-      if (type == null) {
</a><a href="#h7-11-369" id="h7-11-369" class="d">-        type = &quot;normal&quot;;
</a><a href="#h7-11-370" id="h7-11-370" class="d">-      }
</a><a href="#h7-11-371" id="h7-11-371" class="d">-      if (cb == null) {
</a><a href="#h7-11-372" id="h7-11-372" class="d">-        cb = false;
</a><a href="#h7-11-373" id="h7-11-373" class="d">-      }
</a><a href="#h7-11-374" id="h7-11-374" class="d">-      topic_address = this.topic_id + &quot;@&quot; + this.topic_user_id;
</a><a href="#h7-11-375" id="h7-11-375" class="d">-      this.local_storage[&quot;topic.&quot; + this.topic_id + &quot;_&quot; + this.topic_user_id + &quot;.visited&quot;] = this.timestamp();
</a><a href="#h7-11-376" id="h7-11-376" class="d">-      this.cmd(&quot;wrapperSetLocalStorage&quot;, this.local_storage);
</a><a href="#h7-11-377" id="h7-11-377" class="d">-      return this.cmd(&quot;fileQuery&quot;, [&quot;data/users/*/data.json&quot;, &quot;comments.&quot; + topic_address], (function(_this) {
</a><a href="#h7-11-378" id="h7-11-378" class="d">-        return function(comments) {
</a><a href="#h7-11-379" id="h7-11-379" class="d">-          var comment, comment_address, elem, _i, _len;
</a><a href="#h7-11-380" id="h7-11-380" class="d">-          comments.sort(function(a, b) {
</a><a href="#h7-11-381" id="h7-11-381" class="d">-            return b.added - a.added;
</a><a href="#h7-11-382" id="h7-11-382" class="d">-          });
</a><a href="#h7-11-383" id="h7-11-383" class="d">-          for (_i = 0, _len = comments.length; _i &lt; _len; _i++) {
</a><a href="#h7-11-384" id="h7-11-384" class="d">-            comment = comments[_i];
</a><a href="#h7-11-385" id="h7-11-385" class="d">-            comment_address = comment.comment_id + &quot;_&quot; + comment.inner_path;
</a><a href="#h7-11-386" id="h7-11-386" class="d">-            elem = $(&quot;#comment_&quot; + comment_address);
</a><a href="#h7-11-387" id="h7-11-387" class="d">-            if (elem.length === 0) {
</a><a href="#h7-11-388" id="h7-11-388" class="d">-              elem = $(&quot;.comment.template&quot;).clone().removeClass(&quot;template&quot;).attr(&quot;id&quot;, &quot;comment_&quot; + comment_address).data(&quot;topic_address&quot;, topic_address);
</a><a href="#h7-11-389" id="h7-11-389" class="d">-              if (type !== &quot;noanim&quot;) {
</a><a href="#h7-11-390" id="h7-11-390" class="d">-                elem.cssSlideDown();
</a><a href="#h7-11-391" id="h7-11-391" class="d">-              }
</a><a href="#h7-11-392" id="h7-11-392" class="d">-            }
</a><a href="#h7-11-393" id="h7-11-393" class="d">-            _this.applyCommentData(elem, comment);
</a><a href="#h7-11-394" id="h7-11-394" class="d">-            elem.appendTo(&quot;.comments&quot;);
</a><a href="#h7-11-395" id="h7-11-395" class="d">-          }
</a><a href="#h7-11-396" id="h7-11-396" class="d">-          $(&quot;body&quot;).css({
</a><a href="#h7-11-397" id="h7-11-397" class="d">-            &quot;overflow&quot;: &quot;auto&quot;,
</a><a href="#h7-11-398" id="h7-11-398" class="d">-            &quot;height&quot;: &quot;auto&quot;
</a><a href="#h7-11-399" id="h7-11-399" class="i">+      this.cmd(&quot;siteInfo&quot;, {}, (function(_this) {
</a><a href="#h7-11-400" id="h7-11-400" class="i">+        return function(site) {
</a><a href="#h7-11-401" id="h7-11-401" class="i">+          _this.setSiteinfo(site);
</a><a href="#h7-11-402" id="h7-11-402" class="i">+          return _this.loadUserDb(function() {
</a><a href="#h7-11-403" id="h7-11-403" class="i">+            _this.updateUserInfo();
</a><a href="#h7-11-404" id="h7-11-404" class="i">+            return _this.routeUrl(window.location.search.substring(1));
</a>           });
<a href="#h7-11-406" id="h7-11-406" class="d">-          _this.addInlineEditors();
</a><a href="#h7-11-407" id="h7-11-407" class="d">-          if (cb) {
</a><a href="#h7-11-408" id="h7-11-408" class="d">-            return cb();
</a><a href="#h7-11-409" id="h7-11-409" class="i">+        };
</a><a href="#h7-11-410" id="h7-11-410" class="i">+      })(this));
</a><a href="#h7-11-411" id="h7-11-411" class="i">+      return this.cmd(&quot;serverInfo&quot;, {}, (function(_this) {
</a><a href="#h7-11-412" id="h7-11-412" class="i">+        return function(ret) {
</a><a href="#h7-11-413" id="h7-11-413" class="i">+          var version;
</a><a href="#h7-11-414" id="h7-11-414" class="i">+          _this.server_info = ret;
</a><a href="#h7-11-415" id="h7-11-415" class="i">+          version = parseInt(_this.server_info.version.replace(/\./g, &quot;&quot;));
</a><a href="#h7-11-416" id="h7-11-416" class="i">+          if (version &lt; 20) {
</a><a href="#h7-11-417" id="h7-11-417" class="i">+            return _this.cmd(&quot;wrapperNotification&quot;, [&quot;error&quot;, &quot;ZeroTalk requires ZeroNet 0.2.0, please update!&quot;]);
</a>           }
         };
       })(this));
     };
 
<a href="#h7-11-423" id="h7-11-423" class="d">-    ZeroTalk.prototype.applyTopicData = function(elem, topic, type) {
</a><a href="#h7-11-424" id="h7-11-424" class="d">-      var body, match, title_hash, user_id, username;
</a><a href="#h7-11-425" id="h7-11-425" class="d">-      if (type == null) {
</a><a href="#h7-11-426" id="h7-11-426" class="d">-        type = &quot;normal&quot;;
</a><a href="#h7-11-427" id="h7-11-427" class="d">-      }
</a><a href="#h7-11-428" id="h7-11-428" class="d">-      title_hash = topic.title.replace(/[#,&quot;&apos;?&amp; ]/g, &quot;+&quot;).replace(/[+]+/g, &quot;+&quot;).replace(/[+]+$/, &quot;&quot;);
</a><a href="#h7-11-429" id="h7-11-429" class="d">-      user_id = this.user_id_db[topic.inner_path];
</a><a href="#h7-11-430" id="h7-11-430" class="d">-      $(&quot;.title .title-link&quot;, elem).text(topic.title);
</a><a href="#h7-11-431" id="h7-11-431" class="d">-      $(&quot;.title .title-link, a.image, .comment-num&quot;, elem).attr(&quot;href&quot;, &quot;?Topic:&quot; + topic.topic_id + &quot;@&quot; + user_id + &quot;/&quot; + title_hash);
</a><a href="#h7-11-432" id="h7-11-432" class="d">-      body = topic.body;
</a><a href="#h7-11-433" id="h7-11-433" class="d">-      match = topic.body.match(/http[s]{0,1}:\/\/[^&quot;&apos;, $]+/);
</a><a href="#h7-11-434" id="h7-11-434" class="d">-      if (match) {
</a><a href="#h7-11-435" id="h7-11-435" class="d">-        if (type !== &quot;full&quot;) {
</a><a href="#h7-11-436" id="h7-11-436" class="d">-          body = body.replace(/http[s]{0,1}:\/\/[^&quot;&apos; $]+/g, &quot;&quot;);
</a><a href="#h7-11-437" id="h7-11-437" class="d">-        }
</a><a href="#h7-11-438" id="h7-11-438" class="d">-        $(&quot;.image .icon&quot;, elem).removeClass(&quot;icon-topic-chat&quot;).addClass(&quot;icon-topic-link&quot;);
</a><a href="#h7-11-439" id="h7-11-439" class="d">-        $(&quot;.link&quot;, elem).css(&quot;display&quot;, &quot;&quot;).attr(&quot;href&quot;, match[0]);
</a><a href="#h7-11-440" id="h7-11-440" class="d">-        $(&quot;.link .link-url&quot;, elem).text(match[0]);
</a><a href="#h7-11-441" id="h7-11-441" class="d">-      } else {
</a><a href="#h7-11-442" id="h7-11-442" class="d">-        $(&quot;.image .icon&quot;, elem).removeClass(&quot;icon-topic-link&quot;).addClass(&quot;icon-topic-chat&quot;);
</a><a href="#h7-11-443" id="h7-11-443" class="d">-        $(&quot;.link&quot;, elem).css(&quot;display&quot;, &quot;none&quot;);
</a><a href="#h7-11-444" id="h7-11-444" class="d">-      }
</a><a href="#h7-11-445" id="h7-11-445" class="d">-      if (type === &quot;full&quot;) {
</a><a href="#h7-11-446" id="h7-11-446" class="d">-        $(&quot;.body&quot;, elem).html(marked(body, {
</a><a href="#h7-11-447" id="h7-11-447" class="d">-          &quot;sanitize&quot;: true
</a><a href="#h7-11-448" id="h7-11-448" class="d">-        }));
</a><a href="#h7-11-449" id="h7-11-449" class="d">-      } else {
</a><a href="#h7-11-450" id="h7-11-450" class="d">-        $(&quot;.body&quot;, elem).text(body);
</a><a href="#h7-11-451" id="h7-11-451" class="d">-      }
</a><a href="#h7-11-452" id="h7-11-452" class="d">-      username = this.user_name_db[topic.inner_path];
</a><a href="#h7-11-453" id="h7-11-453" class="d">-      $(&quot;.username&quot;, elem).text(username);
</a><a href="#h7-11-454" id="h7-11-454" class="d">-      $(&quot;.added&quot;, elem).text(this.formatSince(topic.added));
</a><a href="#h7-11-455" id="h7-11-455" class="d">-      if (topic.inner_path === this.site_info.auth_address) {
</a><a href="#h7-11-456" id="h7-11-456" class="d">-        $(elem).attr(&quot;data-object&quot;, &quot;Topic:&quot; + topic.topic_id + &quot;@&quot; + user_id).attr(&quot;data-deletable&quot;, &quot;yes&quot;);
</a><a href="#h7-11-457" id="h7-11-457" class="d">-        $(&quot;.title .title-link&quot;, elem).attr(&quot;data-editable&quot;, &quot;title&quot;).data(&quot;content&quot;, topic.title);
</a><a href="#h7-11-458" id="h7-11-458" class="d">-        return $(&quot;.body&quot;, elem).attr(&quot;data-editable&quot;, &quot;body&quot;).data(&quot;content&quot;, topic.body);
</a><a href="#h7-11-459" id="h7-11-459" class="d">-      }
</a><a href="#h7-11-460" id="h7-11-460" class="d">-    };
</a><a href="#h7-11-461" id="h7-11-461" class="d">-
</a><a href="#h7-11-462" id="h7-11-462" class="d">-    ZeroTalk.prototype.textToColor = function(text) {
</a><a href="#h7-11-463" id="h7-11-463" class="d">-      var color, hash, i, value, _i, _j, _ref;
</a><a href="#h7-11-464" id="h7-11-464" class="d">-      hash = 0;
</a><a href="#h7-11-465" id="h7-11-465" class="d">-      for (i = _i = 0, _ref = text.length - 1; 0 &lt;= _ref ? _i &lt;= _ref : _i &gt;= _ref; i = 0 &lt;= _ref ? ++_i : --_i) {
</a><a href="#h7-11-466" id="h7-11-466" class="d">-        hash = text.charCodeAt(i) + ((hash &lt;&lt; 5) - hash);
</a><a href="#h7-11-467" id="h7-11-467" class="d">-      }
</a><a href="#h7-11-468" id="h7-11-468" class="d">-      color = &apos;#&apos;;
</a><a href="#h7-11-469" id="h7-11-469" class="d">-      return &quot;hsl(&quot; + (hash % 360) + &quot;,30%,50%)&quot;;
</a><a href="#h7-11-470" id="h7-11-470" class="d">-      for (i = _j = 0; _j &lt;= 2; i = ++_j) {
</a><a href="#h7-11-471" id="h7-11-471" class="d">-        value = (hash &gt;&gt; (i * 8)) &amp; 0xFF;
</a><a href="#h7-11-472" id="h7-11-472" class="d">-        color += (&apos;00&apos; + value.toString(16)).substr(-2);
</a><a href="#h7-11-473" id="h7-11-473" class="d">-      }
</a><a href="#h7-11-474" id="h7-11-474" class="d">-      return color;
</a><a href="#h7-11-475" id="h7-11-475" class="i">+    ZeroTalk.prototype.onPageLoaded = function() {
</a><a href="#h7-11-476" id="h7-11-476" class="i">+      return $(&quot;body&quot;).addClass(&quot;loaded&quot;);
</a>     };
 
<a href="#h7-11-479" id="h7-11-479" class="d">-    ZeroTalk.prototype.applyCommentData = function(elem, comment) {
</a><a href="#h7-11-480" id="h7-11-480" class="d">-      var comment_id, topic_address, user_id, username;
</a><a href="#h7-11-481" id="h7-11-481" class="d">-      username = this.user_name_db[comment.inner_path];
</a><a href="#h7-11-482" id="h7-11-482" class="d">-      $(&quot;.body&quot;, elem).html(marked(comment.body, {
</a><a href="#h7-11-483" id="h7-11-483" class="d">-        &quot;sanitize&quot;: true
</a><a href="#h7-11-484" id="h7-11-484" class="d">-      }));
</a><a href="#h7-11-485" id="h7-11-485" class="d">-      $(&quot;.username&quot;, elem).text(username).css({
</a><a href="#h7-11-486" id="h7-11-486" class="d">-        &quot;color&quot;: this.textToColor(username)
</a><a href="#h7-11-487" id="h7-11-487" class="d">-      });
</a><a href="#h7-11-488" id="h7-11-488" class="d">-      $(&quot;.added&quot;, elem).text(this.formatSince(comment.added));
</a><a href="#h7-11-489" id="h7-11-489" class="d">-      if (comment.inner_path === this.site_info.auth_address) {
</a><a href="#h7-11-490" id="h7-11-490" class="d">-        user_id = this.user_id_db[comment.inner_path];
</a><a href="#h7-11-491" id="h7-11-491" class="d">-        comment_id = elem.attr(&quot;id&quot;).replace(&quot;comment_&quot;, &quot;&quot;).replace(/_.*$/, &quot;&quot;);
</a><a href="#h7-11-492" id="h7-11-492" class="d">-        topic_address = elem.data(&quot;topic_address&quot;);
</a><a href="#h7-11-493" id="h7-11-493" class="d">-        $(elem).attr(&quot;data-object&quot;, &quot;Comment:&quot; + comment_id + &quot;@&quot; + topic_address).attr(&quot;data-deletable&quot;, &quot;yes&quot;);
</a><a href="#h7-11-494" id="h7-11-494" class="d">-        return $(&quot;.body&quot;, elem).attr(&quot;data-editable&quot;, &quot;body&quot;).data(&quot;content&quot;, comment.body);
</a><a href="#h7-11-495" id="h7-11-495" class="i">+    ZeroTalk.prototype.routeUrl = function(url) {
</a><a href="#h7-11-496" id="h7-11-496" class="i">+      var match;
</a><a href="#h7-11-497" id="h7-11-497" class="i">+      this.log(&quot;Routing url:&quot;, url);
</a><a href="#h7-11-498" id="h7-11-498" class="i">+      if (match = url.match(/Topic:([0-9]+)@([0-9]+)/)) {
</a><a href="#h7-11-499" id="h7-11-499" class="i">+        $(&quot;body&quot;).addClass(&quot;page-topic&quot;);
</a><a href="#h7-11-500" id="h7-11-500" class="i">+        return TopicShow.actionShow(parseInt(match[1]), parseInt(match[2]));
</a><a href="#h7-11-501" id="h7-11-501" class="i">+      } else {
</a><a href="#h7-11-502" id="h7-11-502" class="i">+        $(&quot;body&quot;).addClass(&quot;page-main&quot;);
</a><a href="#h7-11-503" id="h7-11-503" class="i">+        return TopicList.actionList();
</a>       }
     };
 
<a href="#h7-12" id="h7-12" class="h">@@ -1595,14 +1891,14 @@ jQuery.extend( jQuery.easing,
</a>               } else {
                 if (type === &quot;Topic&quot;) {
                   if ($(&quot;body&quot;).hasClass(&quot;page-main&quot;)) {
<a href="#h7-12-3" id="h7-12-3" class="d">-                    _this.loadTopics(&quot;normal&quot;, (function() {
</a><a href="#h7-12-4" id="h7-12-4" class="i">+                    TopicList.loadTopics(&quot;normal&quot;, (function() {
</a>                       if (cb) {
                         return cb(true);
                       }
                     }));
                   }
                   if ($(&quot;body&quot;).hasClass(&quot;page-topic&quot;)) {
<a href="#h7-12-11" id="h7-12-11" class="d">-                    _this.loadTopic((function() {
</a><a href="#h7-12-12" id="h7-12-12" class="i">+                    TopicShow.loadTopic((function() {
</a>                       if (cb) {
                         return cb(true);
                       }
<a href="#h7-13" id="h7-13" class="h">@@ -1610,7 +1906,7 @@ jQuery.extend( jQuery.easing,
</a>                   }
                 }
                 if (type === &quot;Comment&quot;) {
<a href="#h7-13-3" id="h7-13-3" class="d">-                  return _this.loadComments(&quot;normal&quot;, (function() {
</a><a href="#h7-13-4" id="h7-13-4" class="i">+                  return TopicShow.loadComments(&quot;normal&quot;, (function() {
</a>                     if (cb) {
                       return cb(true);
                     }
<a href="#h7-14" id="h7-14" class="h">@@ -1665,7 +1961,7 @@ jQuery.extend( jQuery.easing,
</a>           $(&quot;.button.signup&quot;).removeClass(&quot;loading&quot;);
         }
         $(&quot;.head-user.registered&quot;).css(&quot;display&quot;, &quot;&quot;);
<a href="#h7-14-3" id="h7-14-3" class="d">-        $(&quot;.username-my&quot;).text(user_name).css(&quot;color&quot;, this.textToColor(user_name));
</a><a href="#h7-14-4" id="h7-14-4" class="i">+        $(&quot;.username-my&quot;).text(user_name).css(&quot;color&quot;, Text.toColor(user_name));
</a>         return this.cmd(&quot;fileGet&quot;, [&quot;data/users/&quot; + address + &quot;/content.json&quot;], (function(_this) {
           return function(content) {
             var details, relative_path, sum, _ref;
<a href="#h7-15" id="h7-15" class="h">@@ -1687,7 +1983,7 @@ jQuery.extend( jQuery.easing,
</a>     };
 
     ZeroTalk.prototype.buttonSignup = function() {
<a href="#h7-15-3" id="h7-15-3" class="d">-      if (!this.needOpenPort()) {
</a><a href="#h7-15-4" id="h7-15-4" class="i">+      if (!this.hasOpenPort()) {
</a>         return false;
       }
       return this.cmd(&quot;wrapperPrompt&quot;, [&quot;Username you want to register:&quot;], (function(_this) {
<a href="#h7-16" id="h7-16" class="h">@@ -1708,84 +2004,6 @@ jQuery.extend( jQuery.easing,
</a>       })(this));
     };
 
<a href="#h7-16-3" id="h7-16-3" class="d">-    ZeroTalk.prototype.buttonCreateTopic = function() {
</a><a href="#h7-16-4" id="h7-16-4" class="d">-      var body, inner_path, title;
</a><a href="#h7-16-5" id="h7-16-5" class="d">-      if (!this.needOpenPort()) {
</a><a href="#h7-16-6" id="h7-16-6" class="d">-        return false;
</a><a href="#h7-16-7" id="h7-16-7" class="d">-      }
</a><a href="#h7-16-8" id="h7-16-8" class="d">-      title = $(&quot;.topic-new #topic_title&quot;).val();
</a><a href="#h7-16-9" id="h7-16-9" class="d">-      body = $(&quot;.topic-new #topic_body&quot;).val();
</a><a href="#h7-16-10" id="h7-16-10" class="d">-      if (!title) {
</a><a href="#h7-16-11" id="h7-16-11" class="d">-        return $(&quot;.topic-new #topic_title&quot;).focus();
</a><a href="#h7-16-12" id="h7-16-12" class="d">-      }
</a><a href="#h7-16-13" id="h7-16-13" class="d">-      $(&quot;.topic-new .button-submit&quot;).addClass(&quot;loading&quot;);
</a><a href="#h7-16-14" id="h7-16-14" class="d">-      inner_path = &quot;data/users/&quot; + this.site_info.auth_address + &quot;/data.json&quot;;
</a><a href="#h7-16-15" id="h7-16-15" class="d">-      return this.cmd(&quot;fileGet&quot;, [inner_path], (function(_this) {
</a><a href="#h7-16-16" id="h7-16-16" class="d">-        return function(data) {
</a><a href="#h7-16-17" id="h7-16-17" class="d">-          data = JSON.parse(data);
</a><a href="#h7-16-18" id="h7-16-18" class="d">-          data.topics.push({
</a><a href="#h7-16-19" id="h7-16-19" class="d">-            &quot;topic_id&quot;: data.next_topic_id,
</a><a href="#h7-16-20" id="h7-16-20" class="d">-            &quot;title&quot;: title,
</a><a href="#h7-16-21" id="h7-16-21" class="d">-            &quot;body&quot;: body,
</a><a href="#h7-16-22" id="h7-16-22" class="d">-            &quot;added&quot;: _this.timestamp()
</a><a href="#h7-16-23" id="h7-16-23" class="d">-          });
</a><a href="#h7-16-24" id="h7-16-24" class="d">-          data.next_topic_id += 1;
</a><a href="#h7-16-25" id="h7-16-25" class="d">-          return _this.writePublish(inner_path, _this.jsonEncode(data), function(res) {
</a><a href="#h7-16-26" id="h7-16-26" class="d">-            $(&quot;.topic-new .button-submit&quot;).removeClass(&quot;loading&quot;);
</a><a href="#h7-16-27" id="h7-16-27" class="d">-            if (res === true) {
</a><a href="#h7-16-28" id="h7-16-28" class="d">-              _this.log(&quot;File written&quot;);
</a><a href="#h7-16-29" id="h7-16-29" class="d">-              $(&quot;.topic-new&quot;).slideUp();
</a><a href="#h7-16-30" id="h7-16-30" class="d">-              $(&quot;.topic-new-link&quot;).slideDown();
</a><a href="#h7-16-31" id="h7-16-31" class="d">-              setTimeout((function() {
</a><a href="#h7-16-32" id="h7-16-32" class="d">-                return _this.loadTopics();
</a><a href="#h7-16-33" id="h7-16-33" class="d">-              }), 600);
</a><a href="#h7-16-34" id="h7-16-34" class="d">-              $(&quot;.topic-new #topic_body&quot;).val(&quot;&quot;);
</a><a href="#h7-16-35" id="h7-16-35" class="d">-              return $(&quot;.topic-new #topic_title&quot;).val(&quot;&quot;);
</a><a href="#h7-16-36" id="h7-16-36" class="d">-            } else {
</a><a href="#h7-16-37" id="h7-16-37" class="d">-              return _this.cmd(&quot;wrapperNotification&quot;, [&quot;error&quot;, &quot;File write error: &quot; + res]);
</a><a href="#h7-16-38" id="h7-16-38" class="d">-            }
</a><a href="#h7-16-39" id="h7-16-39" class="d">-          });
</a><a href="#h7-16-40" id="h7-16-40" class="d">-        };
</a><a href="#h7-16-41" id="h7-16-41" class="d">-      })(this));
</a><a href="#h7-16-42" id="h7-16-42" class="d">-    };
</a><a href="#h7-16-43" id="h7-16-43" class="d">-
</a><a href="#h7-16-44" id="h7-16-44" class="d">-    ZeroTalk.prototype.buttonComment = function() {
</a><a href="#h7-16-45" id="h7-16-45" class="d">-      var body, inner_path, topic_address;
</a><a href="#h7-16-46" id="h7-16-46" class="d">-      if (!this.needOpenPort()) {
</a><a href="#h7-16-47" id="h7-16-47" class="d">-        return false;
</a><a href="#h7-16-48" id="h7-16-48" class="d">-      }
</a><a href="#h7-16-49" id="h7-16-49" class="d">-      body = $(&quot;.comment-new #comment_body&quot;).val();
</a><a href="#h7-16-50" id="h7-16-50" class="d">-      if (!body) {
</a><a href="#h7-16-51" id="h7-16-51" class="d">-        $(&quot;.comment-new #comment_body&quot;).focus();
</a><a href="#h7-16-52" id="h7-16-52" class="d">-      }
</a><a href="#h7-16-53" id="h7-16-53" class="d">-      topic_address = this.topic_id + &quot;@&quot; + this.topic_user_id;
</a><a href="#h7-16-54" id="h7-16-54" class="d">-      $(&quot;.comment-new .button-submit&quot;).addClass(&quot;loading&quot;);
</a><a href="#h7-16-55" id="h7-16-55" class="d">-      inner_path = &quot;data/users/&quot; + this.site_info.auth_address + &quot;/data.json&quot;;
</a><a href="#h7-16-56" id="h7-16-56" class="d">-      return this.cmd(&quot;fileGet&quot;, [inner_path], (function(_this) {
</a><a href="#h7-16-57" id="h7-16-57" class="d">-        return function(data) {
</a><a href="#h7-16-58" id="h7-16-58" class="d">-          var _base;
</a><a href="#h7-16-59" id="h7-16-59" class="d">-          data = JSON.parse(data);
</a><a href="#h7-16-60" id="h7-16-60" class="d">-          if ((_base = data.comments)[topic_address] == null) {
</a><a href="#h7-16-61" id="h7-16-61" class="d">-            _base[topic_address] = [];
</a><a href="#h7-16-62" id="h7-16-62" class="d">-          }
</a><a href="#h7-16-63" id="h7-16-63" class="d">-          data.comments[topic_address].push({
</a><a href="#h7-16-64" id="h7-16-64" class="d">-            &quot;comment_id&quot;: data.next_message_id,
</a><a href="#h7-16-65" id="h7-16-65" class="d">-            &quot;body&quot;: body,
</a><a href="#h7-16-66" id="h7-16-66" class="d">-            &quot;added&quot;: _this.timestamp()
</a><a href="#h7-16-67" id="h7-16-67" class="d">-          });
</a><a href="#h7-16-68" id="h7-16-68" class="d">-          data.next_message_id += 1;
</a><a href="#h7-16-69" id="h7-16-69" class="d">-          return _this.writePublish(inner_path, _this.jsonEncode(data), function(res) {
</a><a href="#h7-16-70" id="h7-16-70" class="d">-            $(&quot;.comment-new .button-submit&quot;).removeClass(&quot;loading&quot;);
</a><a href="#h7-16-71" id="h7-16-71" class="d">-            if (res === true) {
</a><a href="#h7-16-72" id="h7-16-72" class="d">-              _this.log(&quot;File written&quot;);
</a><a href="#h7-16-73" id="h7-16-73" class="d">-              _this.loadComments();
</a><a href="#h7-16-74" id="h7-16-74" class="d">-              return $(&quot;.comment-new #comment_body&quot;).val(&quot;&quot;);
</a><a href="#h7-16-75" id="h7-16-75" class="d">-            }
</a><a href="#h7-16-76" id="h7-16-76" class="d">-          });
</a><a href="#h7-16-77" id="h7-16-77" class="d">-        };
</a><a href="#h7-16-78" id="h7-16-78" class="d">-      })(this));
</a><a href="#h7-16-79" id="h7-16-79" class="d">-    };
</a><a href="#h7-16-80" id="h7-16-80" class="d">-
</a>     ZeroTalk.prototype.jsonEncode = function(obj) {
       return btoa(unescape(encodeURIComponent(JSON.stringify(obj, void 0, &apos;\t&apos;))));
     };
<a href="#h7-17" id="h7-17" class="h">@@ -1811,59 +2029,15 @@ jQuery.extend( jQuery.easing,
</a>       })(this));
     };
 
<a href="#h7-17-3" id="h7-17-3" class="d">-    ZeroTalk.prototype.needOpenPort = function() {
</a><a href="#h7-17-4" id="h7-17-4" class="i">+    ZeroTalk.prototype.hasOpenPort = function() {
</a>       if (this.server_info.ip_external) {
         return true;
       } else {
<a href="#h7-17-8" id="h7-17-8" class="d">-        this.cmd(&quot;wrapperNotification&quot;, [&quot;error&quot;, &quot;To signup please open port &lt;b&gt;&quot; + this.server_info.fileserver_port + &quot;&lt;/b&gt; on your router&quot;]);
</a><a href="#h7-17-9" id="h7-17-9" class="i">+        this.cmd(&quot;wrapperNotification&quot;, [&quot;error&quot;, &quot;To publish new content please open port &lt;b&gt;&quot; + this.server_info.fileserver_port + &quot;&lt;/b&gt; on your router&quot;]);
</a>         return false;
       }
     };
 
<a href="#h7-17-14" id="h7-17-14" class="d">-    ZeroTalk.prototype.formatSince = function(time) {
</a><a href="#h7-17-15" id="h7-17-15" class="d">-      var back, now, secs;
</a><a href="#h7-17-16" id="h7-17-16" class="d">-      now = +(new Date) / 1000;
</a><a href="#h7-17-17" id="h7-17-17" class="d">-      secs = now - time;
</a><a href="#h7-17-18" id="h7-17-18" class="d">-      if (secs &lt; 60) {
</a><a href="#h7-17-19" id="h7-17-19" class="d">-        back = &quot;Just now&quot;;
</a><a href="#h7-17-20" id="h7-17-20" class="d">-      } else if (secs &lt; 60 * 60) {
</a><a href="#h7-17-21" id="h7-17-21" class="d">-        back = (Math.round(secs / 60)) + &quot; minutes ago&quot;;
</a><a href="#h7-17-22" id="h7-17-22" class="d">-      } else if (secs &lt; 60 * 60 * 24) {
</a><a href="#h7-17-23" id="h7-17-23" class="d">-        back = (Math.round(secs / 60 / 60)) + &quot; hours ago&quot;;
</a><a href="#h7-17-24" id="h7-17-24" class="d">-      } else if (secs &lt; 60 * 60 * 24 * 3) {
</a><a href="#h7-17-25" id="h7-17-25" class="d">-        back = (Math.round(secs / 60 / 60 / 24)) + &quot; days ago&quot;;
</a><a href="#h7-17-26" id="h7-17-26" class="d">-      } else {
</a><a href="#h7-17-27" id="h7-17-27" class="d">-        back = &quot;on &quot; + this.formatDate(time);
</a><a href="#h7-17-28" id="h7-17-28" class="d">-      }
</a><a href="#h7-17-29" id="h7-17-29" class="d">-      back = back.replace(/1 ([a-z]+)s/, &quot;1 $1&quot;);
</a><a href="#h7-17-30" id="h7-17-30" class="d">-      return back;
</a><a href="#h7-17-31" id="h7-17-31" class="d">-    };
</a><a href="#h7-17-32" id="h7-17-32" class="d">-
</a><a href="#h7-17-33" id="h7-17-33" class="d">-    ZeroTalk.prototype.formatDate = function(timestamp, format) {
</a><a href="#h7-17-34" id="h7-17-34" class="d">-      var display, parts;
</a><a href="#h7-17-35" id="h7-17-35" class="d">-      if (format == null) {
</a><a href="#h7-17-36" id="h7-17-36" class="d">-        format = &quot;short&quot;;
</a><a href="#h7-17-37" id="h7-17-37" class="d">-      }
</a><a href="#h7-17-38" id="h7-17-38" class="d">-      parts = (new Date(timestamp * 1000)).toString().split(&quot; &quot;);
</a><a href="#h7-17-39" id="h7-17-39" class="d">-      if (format === &quot;short&quot;) {
</a><a href="#h7-17-40" id="h7-17-40" class="d">-        display = parts.slice(1, 4);
</a><a href="#h7-17-41" id="h7-17-41" class="d">-      } else {
</a><a href="#h7-17-42" id="h7-17-42" class="d">-        display = parts.slice(1, 5);
</a><a href="#h7-17-43" id="h7-17-43" class="d">-      }
</a><a href="#h7-17-44" id="h7-17-44" class="d">-      return display.join(&quot; &quot;).replace(/( [0-9]{4})/, &quot;,$1&quot;);
</a><a href="#h7-17-45" id="h7-17-45" class="d">-    };
</a><a href="#h7-17-46" id="h7-17-46" class="d">-
</a><a href="#h7-17-47" id="h7-17-47" class="d">-    ZeroTalk.prototype.timestamp = function(date) {
</a><a href="#h7-17-48" id="h7-17-48" class="d">-      if (date == null) {
</a><a href="#h7-17-49" id="h7-17-49" class="d">-        date = &quot;&quot;;
</a><a href="#h7-17-50" id="h7-17-50" class="d">-      }
</a><a href="#h7-17-51" id="h7-17-51" class="d">-      if (date === &quot;now&quot; || date === &quot;&quot;) {
</a><a href="#h7-17-52" id="h7-17-52" class="d">-        return parseInt(+(new Date) / 1000);
</a><a href="#h7-17-53" id="h7-17-53" class="d">-      } else {
</a><a href="#h7-17-54" id="h7-17-54" class="d">-        return parseInt(Date.parse(date) / 1000);
</a><a href="#h7-17-55" id="h7-17-55" class="d">-      }
</a><a href="#h7-17-56" id="h7-17-56" class="d">-    };
</a><a href="#h7-17-57" id="h7-17-57" class="d">-
</a>     ZeroTalk.prototype.route = function(cmd, message) {
       if (cmd === &quot;setSiteInfo&quot;) {
         return this.actionSetSiteInfo(message);
<a href="#h7-18" id="h7-18" class="h">@@ -1884,11 +2058,11 @@ jQuery.extend( jQuery.easing,
</a>         return LimitRate(((function(_this) {
           return function() {
             if ($(&quot;body&quot;).hasClass(&quot;page-topic&quot;)) {
<a href="#h7-18-3" id="h7-18-3" class="d">-              _this.loadTopic();
</a><a href="#h7-18-4" id="h7-18-4" class="d">-              _this.loadComments();
</a><a href="#h7-18-5" id="h7-18-5" class="i">+              TopicShow.loadTopic();
</a><a href="#h7-18-6" id="h7-18-6" class="i">+              TopicShow.loadComments();
</a>             }
             if ($(&quot;body&quot;).hasClass(&quot;page-main&quot;)) {
<a href="#h7-18-9" id="h7-18-9" class="d">-              return _this.loadTopics();
</a><a href="#h7-18-10" id="h7-18-10" class="i">+              return TopicList.loadTopics();
</a>             }
           };
         })(this)), 500);
<a href="#h7-19" id="h7-19" class="h">@@ -1927,22 +2101,12 @@ jQuery.extend( jQuery.easing,
</a>       } else {
         return elem.height(&quot;48px&quot;);
       }
<a href="#h7-19-3" id="h7-19-3" class="d">-
</a><a href="#h7-19-4" id="h7-19-4" class="d">-      /*
</a><a href="#h7-19-5" id="h7-19-5" class="d">-      		elem.on &apos;keydown&apos;, (e) -&gt;
</a><a href="#h7-19-6" id="h7-19-6" class="d">-      			if e.which == 9
</a><a href="#h7-19-7" id="h7-19-7" class="d">-      				e.preventDefault()
</a><a href="#h7-19-8" id="h7-19-8" class="d">-      				s = this.selectionStart
</a><a href="#h7-19-9" id="h7-19-9" class="d">-      				val = elem.val()
</a><a href="#h7-19-10" id="h7-19-10" class="d">-      				elem.val(val.substring(0,this.selectionStart) + &quot;\t&quot; + val.substring(this.selectionEnd))
</a><a href="#h7-19-11" id="h7-19-11" class="d">-      				this.selectionEnd = s+1;
</a><a href="#h7-19-12" id="h7-19-12" class="d">-       */
</a>     };
 
     return ZeroTalk;
 
   })(ZeroFrame);
 
<a href="#h7-19-19" id="h7-19-19" class="d">-  window.zero_talk = new ZeroTalk();
</a><a href="#h7-19-20" id="h7-19-20" class="i">+  window.Page = new ZeroTalk();
</a> 
 }).call(this);
<b>diff --git a/<a id="h8" href="../file/js/lib/LimitRate.coffee.html">js/lib/LimitRate.coffee</a> b/<a href="../file/js/lib/LimitRate.coffee.html">js/lib/LimitRate.coffee</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -1,7 +0,0 @@
</a><a href="#h8-0-0" id="h8-0-0" class="d">-limits = {}
</a><a href="#h8-0-1" id="h8-0-1" class="d">-window.LimitRate = (fn, interval) -&gt;
</a><a href="#h8-0-2" id="h8-0-2" class="d">-	if not limits[fn]
</a><a href="#h8-0-3" id="h8-0-3" class="d">-		limits[fn] = setTimeout (-&gt;
</a><a href="#h8-0-4" id="h8-0-4" class="d">-			fn()
</a><a href="#h8-0-5" id="h8-0-5" class="d">-			delete limits[fn]
</a><a href="#h8-0-6" id="h8-0-6" class="d">-		), interval
</a><b>diff --git a/<a id="h9" href="../file/js/lib/ZeroFrame.coffee.html">js/lib/ZeroFrame.coffee</a> b/<a href="../file/js/lib/ZeroFrame.coffee.html">js/lib/ZeroFrame.coffee</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -1,73 +0,0 @@
</a><a href="#h9-0-0" id="h9-0-0" class="d">-class ZeroFrame
</a><a href="#h9-0-1" id="h9-0-1" class="d">-	constructor: (url) -&gt;
</a><a href="#h9-0-2" id="h9-0-2" class="d">-		@url = url
</a><a href="#h9-0-3" id="h9-0-3" class="d">-		@waiting_cb = {}
</a><a href="#h9-0-4" id="h9-0-4" class="d">-		@connect()
</a><a href="#h9-0-5" id="h9-0-5" class="d">-		@next_message_id = 1
</a><a href="#h9-0-6" id="h9-0-6" class="d">-		@init()
</a><a href="#h9-0-7" id="h9-0-7" class="d">-
</a><a href="#h9-0-8" id="h9-0-8" class="d">-
</a><a href="#h9-0-9" id="h9-0-9" class="d">-	init: -&gt;
</a><a href="#h9-0-10" id="h9-0-10" class="d">-		@
</a><a href="#h9-0-11" id="h9-0-11" class="d">-
</a><a href="#h9-0-12" id="h9-0-12" class="d">-
</a><a href="#h9-0-13" id="h9-0-13" class="d">-	connect: -&gt;
</a><a href="#h9-0-14" id="h9-0-14" class="d">-		@target = window.parent
</a><a href="#h9-0-15" id="h9-0-15" class="d">-		window.addEventListener(&quot;message&quot;, @onMessage, false) 
</a><a href="#h9-0-16" id="h9-0-16" class="d">-		@cmd(&quot;innerReady&quot;)
</a><a href="#h9-0-17" id="h9-0-17" class="d">-
</a><a href="#h9-0-18" id="h9-0-18" class="d">-
</a><a href="#h9-0-19" id="h9-0-19" class="d">-	onMessage: (e) =&gt;
</a><a href="#h9-0-20" id="h9-0-20" class="d">-		message = e.data
</a><a href="#h9-0-21" id="h9-0-21" class="d">-		cmd = message.cmd
</a><a href="#h9-0-22" id="h9-0-22" class="d">-		if cmd == &quot;response&quot;
</a><a href="#h9-0-23" id="h9-0-23" class="d">-			if @waiting_cb[message.to]?
</a><a href="#h9-0-24" id="h9-0-24" class="d">-				@waiting_cb[message.to](message.result)
</a><a href="#h9-0-25" id="h9-0-25" class="d">-			else
</a><a href="#h9-0-26" id="h9-0-26" class="d">-				@log &quot;Websocket callback not found:&quot;, message
</a><a href="#h9-0-27" id="h9-0-27" class="d">-		else if cmd == &quot;wrapperReady&quot; # Wrapper inited later
</a><a href="#h9-0-28" id="h9-0-28" class="d">-			@cmd(&quot;innerReady&quot;)
</a><a href="#h9-0-29" id="h9-0-29" class="d">-		else if cmd == &quot;ping&quot;
</a><a href="#h9-0-30" id="h9-0-30" class="d">-			@response message.id, &quot;pong&quot;
</a><a href="#h9-0-31" id="h9-0-31" class="d">-		else if cmd == &quot;wrapperOpenedWebsocket&quot;
</a><a href="#h9-0-32" id="h9-0-32" class="d">-			@onOpenWebsocket()
</a><a href="#h9-0-33" id="h9-0-33" class="d">-		else if cmd == &quot;wrapperClosedWebsocket&quot;
</a><a href="#h9-0-34" id="h9-0-34" class="d">-			@onCloseWebsocket()
</a><a href="#h9-0-35" id="h9-0-35" class="d">-		else
</a><a href="#h9-0-36" id="h9-0-36" class="d">-			@route cmd, message
</a><a href="#h9-0-37" id="h9-0-37" class="d">-
</a><a href="#h9-0-38" id="h9-0-38" class="d">-
</a><a href="#h9-0-39" id="h9-0-39" class="d">-	route: (cmd, message) =&gt;
</a><a href="#h9-0-40" id="h9-0-40" class="d">-		@log &quot;Unknown command&quot;, message
</a><a href="#h9-0-41" id="h9-0-41" class="d">-
</a><a href="#h9-0-42" id="h9-0-42" class="d">-
</a><a href="#h9-0-43" id="h9-0-43" class="d">-	response: (to, result) -&gt;
</a><a href="#h9-0-44" id="h9-0-44" class="d">-		@send {&quot;cmd&quot;: &quot;response&quot;, &quot;to&quot;: to, &quot;result&quot;: result}
</a><a href="#h9-0-45" id="h9-0-45" class="d">-
</a><a href="#h9-0-46" id="h9-0-46" class="d">-
</a><a href="#h9-0-47" id="h9-0-47" class="d">-	cmd: (cmd, params={}, cb=null) -&gt;
</a><a href="#h9-0-48" id="h9-0-48" class="d">-		@send {&quot;cmd&quot;: cmd, &quot;params&quot;: params}, cb
</a><a href="#h9-0-49" id="h9-0-49" class="d">-
</a><a href="#h9-0-50" id="h9-0-50" class="d">-
</a><a href="#h9-0-51" id="h9-0-51" class="d">-	send: (message, cb=null) -&gt;
</a><a href="#h9-0-52" id="h9-0-52" class="d">-		message.id = @next_message_id
</a><a href="#h9-0-53" id="h9-0-53" class="d">-		@next_message_id += 1
</a><a href="#h9-0-54" id="h9-0-54" class="d">-		@target.postMessage(message, &quot;*&quot;)
</a><a href="#h9-0-55" id="h9-0-55" class="d">-		if cb
</a><a href="#h9-0-56" id="h9-0-56" class="d">-			@waiting_cb[message.id] = cb
</a><a href="#h9-0-57" id="h9-0-57" class="d">-
</a><a href="#h9-0-58" id="h9-0-58" class="d">-
</a><a href="#h9-0-59" id="h9-0-59" class="d">-	log: (args...) -&gt;
</a><a href="#h9-0-60" id="h9-0-60" class="d">-		console.log &quot;[ZeroFrame]&quot;, args...
</a><a href="#h9-0-61" id="h9-0-61" class="d">-
</a><a href="#h9-0-62" id="h9-0-62" class="d">-
</a><a href="#h9-0-63" id="h9-0-63" class="d">-	onOpenWebsocket: =&gt;
</a><a href="#h9-0-64" id="h9-0-64" class="d">-		@log &quot;Websocket open&quot;
</a><a href="#h9-0-65" id="h9-0-65" class="d">-
</a><a href="#h9-0-66" id="h9-0-66" class="d">-
</a><a href="#h9-0-67" id="h9-0-67" class="d">-	onCloseWebsocket: =&gt;
</a><a href="#h9-0-68" id="h9-0-68" class="d">-		@log &quot;Websocket close&quot;
</a><a href="#h9-0-69" id="h9-0-69" class="d">-
</a><a href="#h9-0-70" id="h9-0-70" class="d">-
</a><a href="#h9-0-71" id="h9-0-71" class="d">-
</a><a href="#h9-0-72" id="h9-0-72" class="d">-window.ZeroFrame = ZeroFrame
</a><b>diff --git a/<a id="h10" href="../file/js/utils/Class.coffee.html">js/utils/Class.coffee</a> b/<a href="../file/js/utils/Class.coffee.html">js/utils/Class.coffee</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -0,0 +1,23 @@
</a><a href="#h10-0-0" id="h10-0-0" class="i">+class Class
</a><a href="#h10-0-1" id="h10-0-1" class="i">+	trace: true
</a><a href="#h10-0-2" id="h10-0-2" class="i">+
</a><a href="#h10-0-3" id="h10-0-3" class="i">+	log: (args...) -&gt;
</a><a href="#h10-0-4" id="h10-0-4" class="i">+		return unless @trace
</a><a href="#h10-0-5" id="h10-0-5" class="i">+		return if typeof console is &apos;undefined&apos;
</a><a href="#h10-0-6" id="h10-0-6" class="i">+		args.unshift(&quot;[#{@.constructor.name}]&quot;)
</a><a href="#h10-0-7" id="h10-0-7" class="i">+		console.log(args...)
</a><a href="#h10-0-8" id="h10-0-8" class="i">+		@
</a><a href="#h10-0-9" id="h10-0-9" class="i">+		
</a><a href="#h10-0-10" id="h10-0-10" class="i">+	logStart: (name, args...) -&gt;
</a><a href="#h10-0-11" id="h10-0-11" class="i">+		return unless @trace
</a><a href="#h10-0-12" id="h10-0-12" class="i">+		@logtimers or= {}
</a><a href="#h10-0-13" id="h10-0-13" class="i">+		@logtimers[name] = +(new Date)
</a><a href="#h10-0-14" id="h10-0-14" class="i">+		@log &quot;[#{name}]&quot;, args..., &quot;(started)&quot; if args.length &gt; 0
</a><a href="#h10-0-15" id="h10-0-15" class="i">+		@
</a><a href="#h10-0-16" id="h10-0-16" class="i">+		
</a><a href="#h10-0-17" id="h10-0-17" class="i">+	logEnd: (name, args...) -&gt;
</a><a href="#h10-0-18" id="h10-0-18" class="i">+		ms = +(new Date)-@logtimers[name]
</a><a href="#h10-0-19" id="h10-0-19" class="i">+		@log &quot;[#{name}]&quot;, args..., &quot;(Done in #{ms}ms)&quot;
</a><a href="#h10-0-20" id="h10-0-20" class="i">+		@ 
</a><a href="#h10-0-21" id="h10-0-21" class="i">+
</a><a href="#h10-0-22" id="h10-0-22" class="i">+window.Class = Class</a><a href="#h10-0-23" id="h10-0-23" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h11" href="../file/js/utils/InlineEditor.coffee.html">js/utils/InlineEditor.coffee</a> b/<a href="../file/js/utils/InlineEditor.coffee.html">js/utils/InlineEditor.coffee</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -0,0 +1,159 @@
</a><a href="#h11-0-0" id="h11-0-0" class="i">+class InlineEditor
</a><a href="#h11-0-1" id="h11-0-1" class="i">+	constructor: (@elem, @getContent, @saveContent, @getObject) -&gt;
</a><a href="#h11-0-2" id="h11-0-2" class="i">+		@edit_button = $(&quot;&lt;a href=&apos;#Edit&apos; class=&apos;editable-edit&apos;&gt;&lt;/a&gt;&quot;)
</a><a href="#h11-0-3" id="h11-0-3" class="i">+		@edit_button.on &quot;click&quot;, @startEdit
</a><a href="#h11-0-4" id="h11-0-4" class="i">+		@elem.addClass(&quot;editable&quot;).before(@edit_button)
</a><a href="#h11-0-5" id="h11-0-5" class="i">+		@editor = null
</a><a href="#h11-0-6" id="h11-0-6" class="i">+		@elem.on &quot;mouseenter&quot;, (e) =&gt;
</a><a href="#h11-0-7" id="h11-0-7" class="i">+			@edit_button.css(&quot;opacity&quot;, &quot;1&quot;)
</a><a href="#h11-0-8" id="h11-0-8" class="i">+			# Keep in display
</a><a href="#h11-0-9" id="h11-0-9" class="i">+			scrolltop = $(window).scrollTop()
</a><a href="#h11-0-10" id="h11-0-10" class="i">+			top = @edit_button.offset().top-parseInt(@edit_button.css(&quot;margin-top&quot;))
</a><a href="#h11-0-11" id="h11-0-11" class="i">+			if scrolltop &gt; top
</a><a href="#h11-0-12" id="h11-0-12" class="i">+				@edit_button.css(&quot;margin-top&quot;, scrolltop-top+e.clientY-20)
</a><a href="#h11-0-13" id="h11-0-13" class="i">+			else
</a><a href="#h11-0-14" id="h11-0-14" class="i">+				@edit_button.css(&quot;margin-top&quot;, &quot;&quot;)
</a><a href="#h11-0-15" id="h11-0-15" class="i">+		@elem.on &quot;mouseleave&quot;, =&gt;
</a><a href="#h11-0-16" id="h11-0-16" class="i">+			@edit_button.css(&quot;opacity&quot;, &quot;&quot;)
</a><a href="#h11-0-17" id="h11-0-17" class="i">+
</a><a href="#h11-0-18" id="h11-0-18" class="i">+		if @elem.is(&quot;:hover&quot;) then @elem.trigger &quot;mouseenter&quot;
</a><a href="#h11-0-19" id="h11-0-19" class="i">+
</a><a href="#h11-0-20" id="h11-0-20" class="i">+
</a><a href="#h11-0-21" id="h11-0-21" class="i">+	startEdit: =&gt;
</a><a href="#h11-0-22" id="h11-0-22" class="i">+		@content_before = @elem.html() # Save current to restore on cancel
</a><a href="#h11-0-23" id="h11-0-23" class="i">+
</a><a href="#h11-0-24" id="h11-0-24" class="i">+		@editor = $(&quot;&lt;textarea class=&apos;editor&apos;&gt;&lt;/textarea&gt;&quot;)
</a><a href="#h11-0-25" id="h11-0-25" class="i">+		@editor.css(&quot;outline&quot;, &quot;10000px solid rgba(255,255,255,0)&quot;).cssLater(&quot;transition&quot;, &quot;outline 0.3s&quot;, 5).cssLater(&quot;outline&quot;, &quot;10000px solid rgba(255,255,255,0.9)&quot;, 10) # Animate other elements fadeout
</a><a href="#h11-0-26" id="h11-0-26" class="i">+		@editor.val @getContent(@elem, &quot;raw&quot;)
</a><a href="#h11-0-27" id="h11-0-27" class="i">+		@elem.after(@editor)
</a><a href="#h11-0-28" id="h11-0-28" class="i">+
</a><a href="#h11-0-29" id="h11-0-29" class="i">+		@elem.html [1..50].join(&quot;fill the width&quot;) # To make sure we span the editor as far as we can
</a><a href="#h11-0-30" id="h11-0-30" class="i">+		@copyStyle(@elem, @editor) # Copy elem style to editor
</a><a href="#h11-0-31" id="h11-0-31" class="i">+		@elem.html @content_before # Restore content
</a><a href="#h11-0-32" id="h11-0-32" class="i">+
</a><a href="#h11-0-33" id="h11-0-33" class="i">+		
</a><a href="#h11-0-34" id="h11-0-34" class="i">+		@autoExpand(@editor) # Set editor to autoexpand
</a><a href="#h11-0-35" id="h11-0-35" class="i">+		@elem.css(&quot;display&quot;, &quot;none&quot;) # Hide elem
</a><a href="#h11-0-36" id="h11-0-36" class="i">+
</a><a href="#h11-0-37" id="h11-0-37" class="i">+		if $(window).scrollTop() == 0 # Focus textfield if scroll on top
</a><a href="#h11-0-38" id="h11-0-38" class="i">+			@editor[0].selectionEnd = 0
</a><a href="#h11-0-39" id="h11-0-39" class="i">+			@editor.focus()
</a><a href="#h11-0-40" id="h11-0-40" class="i">+
</a><a href="#h11-0-41" id="h11-0-41" class="i">+		$(&quot;.editable-edit&quot;).css(&quot;display&quot;, &quot;none&quot;) # Hide all edit button until its not finished
</a><a href="#h11-0-42" id="h11-0-42" class="i">+
</a><a href="#h11-0-43" id="h11-0-43" class="i">+		$(&quot;.editbar&quot;).css(&quot;display&quot;, &quot;inline-block&quot;).addClassLater(&quot;visible&quot;, 10) 
</a><a href="#h11-0-44" id="h11-0-44" class="i">+		$(&quot;.publishbar&quot;).css(&quot;opacity&quot;, 0) # Hide publishbar
</a><a href="#h11-0-45" id="h11-0-45" class="i">+		$(&quot;.editbar .object&quot;).text @getObject(@elem).data(&quot;object&quot;)+&quot;.&quot;+@elem.data(&quot;editable&quot;)
</a><a href="#h11-0-46" id="h11-0-46" class="i">+		$(&quot;.editbar .button&quot;).removeClass(&quot;loading&quot;)
</a><a href="#h11-0-47" id="h11-0-47" class="i">+
</a><a href="#h11-0-48" id="h11-0-48" class="i">+		$(&quot;.editbar .save&quot;).off(&quot;click&quot;).on &quot;click&quot;, @saveEdit
</a><a href="#h11-0-49" id="h11-0-49" class="i">+		$(&quot;.editbar .delete&quot;).off(&quot;click&quot;).on &quot;click&quot;, @deleteObject
</a><a href="#h11-0-50" id="h11-0-50" class="i">+		$(&quot;.editbar .cancel&quot;).off(&quot;click&quot;).on &quot;click&quot;, @cancelEdit
</a><a href="#h11-0-51" id="h11-0-51" class="i">+
</a><a href="#h11-0-52" id="h11-0-52" class="i">+		# Deletable button show/hide
</a><a href="#h11-0-53" id="h11-0-53" class="i">+		if @getObject(@elem).data(&quot;deletable&quot;)
</a><a href="#h11-0-54" id="h11-0-54" class="i">+			$(&quot;.editbar .delete&quot;).css(&quot;display&quot;, &quot;&quot;).html(&quot;Delete &quot;+@getObject(@elem).data(&quot;object&quot;).split(&quot;:&quot;)[0])
</a><a href="#h11-0-55" id="h11-0-55" class="i">+		else
</a><a href="#h11-0-56" id="h11-0-56" class="i">+			$(&quot;.editbar .delete&quot;).css(&quot;display&quot;, &quot;none&quot;)
</a><a href="#h11-0-57" id="h11-0-57" class="i">+
</a><a href="#h11-0-58" id="h11-0-58" class="i">+		window.onbeforeunload = -&gt;
</a><a href="#h11-0-59" id="h11-0-59" class="i">+			return &apos;Your unsaved blog changes will be lost!&apos;
</a><a href="#h11-0-60" id="h11-0-60" class="i">+		
</a><a href="#h11-0-61" id="h11-0-61" class="i">+		return false
</a><a href="#h11-0-62" id="h11-0-62" class="i">+
</a><a href="#h11-0-63" id="h11-0-63" class="i">+
</a><a href="#h11-0-64" id="h11-0-64" class="i">+	stopEdit: =&gt;
</a><a href="#h11-0-65" id="h11-0-65" class="i">+		@editor.remove()
</a><a href="#h11-0-66" id="h11-0-66" class="i">+		@editor = null
</a><a href="#h11-0-67" id="h11-0-67" class="i">+		@elem.css(&quot;display&quot;, &quot;&quot;)
</a><a href="#h11-0-68" id="h11-0-68" class="i">+
</a><a href="#h11-0-69" id="h11-0-69" class="i">+		$(&quot;.editable-edit&quot;).css(&quot;display&quot;, &quot;&quot;) # Show edit buttons
</a><a href="#h11-0-70" id="h11-0-70" class="i">+
</a><a href="#h11-0-71" id="h11-0-71" class="i">+		$(&quot;.editbar&quot;).cssLater(&quot;display&quot;, &quot;none&quot;, 1000).removeClass(&quot;visible&quot;) # Hide editbar
</a><a href="#h11-0-72" id="h11-0-72" class="i">+		$(&quot;.publishbar&quot;).css(&quot;opacity&quot;, 1) # Show publishbar
</a><a href="#h11-0-73" id="h11-0-73" class="i">+
</a><a href="#h11-0-74" id="h11-0-74" class="i">+		window.onbeforeunload = null
</a><a href="#h11-0-75" id="h11-0-75" class="i">+
</a><a href="#h11-0-76" id="h11-0-76" class="i">+
</a><a href="#h11-0-77" id="h11-0-77" class="i">+	saveEdit: =&gt;
</a><a href="#h11-0-78" id="h11-0-78" class="i">+		content = @editor.val()
</a><a href="#h11-0-79" id="h11-0-79" class="i">+		$(&quot;.editbar .save&quot;).addClass(&quot;loading&quot;)
</a><a href="#h11-0-80" id="h11-0-80" class="i">+		@saveContent @elem, content, (content_html) =&gt;
</a><a href="#h11-0-81" id="h11-0-81" class="i">+			if content_html # File write ok
</a><a href="#h11-0-82" id="h11-0-82" class="i">+				$(&quot;.editbar .save&quot;).removeClass(&quot;loading&quot;)
</a><a href="#h11-0-83" id="h11-0-83" class="i">+				@stopEdit()
</a><a href="#h11-0-84" id="h11-0-84" class="i">+				if typeof content_html == &quot;string&quot; # Returned the new content
</a><a href="#h11-0-85" id="h11-0-85" class="i">+					@elem.html content_html
</a><a href="#h11-0-86" id="h11-0-86" class="i">+
</a><a href="#h11-0-87" id="h11-0-87" class="i">+				$(&apos;pre code&apos;).each (i, block) -&gt; # Higlight code blocks
</a><a href="#h11-0-88" id="h11-0-88" class="i">+					hljs.highlightBlock(block)
</a><a href="#h11-0-89" id="h11-0-89" class="i">+			else
</a><a href="#h11-0-90" id="h11-0-90" class="i">+				$(&quot;.editbar .save&quot;).removeClass(&quot;loading&quot;)
</a><a href="#h11-0-91" id="h11-0-91" class="i">+
</a><a href="#h11-0-92" id="h11-0-92" class="i">+		return false
</a><a href="#h11-0-93" id="h11-0-93" class="i">+
</a><a href="#h11-0-94" id="h11-0-94" class="i">+
</a><a href="#h11-0-95" id="h11-0-95" class="i">+	deleteObject: =&gt;
</a><a href="#h11-0-96" id="h11-0-96" class="i">+		object_type = @getObject(@elem).data(&quot;object&quot;).split(&quot;:&quot;)[0]
</a><a href="#h11-0-97" id="h11-0-97" class="i">+		Page.cmd &quot;wrapperConfirm&quot;, [&quot;Are you sure you sure to delete this #{object_type}?&quot;, &quot;Delete&quot;], (confirmed) =&gt; 
</a><a href="#h11-0-98" id="h11-0-98" class="i">+			$(&quot;.editbar .delete&quot;).addClass(&quot;loading&quot;)
</a><a href="#h11-0-99" id="h11-0-99" class="i">+			Page.saveContent @getObject(@elem), null, =&gt;
</a><a href="#h11-0-100" id="h11-0-100" class="i">+				@stopEdit()
</a><a href="#h11-0-101" id="h11-0-101" class="i">+		return false
</a><a href="#h11-0-102" id="h11-0-102" class="i">+
</a><a href="#h11-0-103" id="h11-0-103" class="i">+
</a><a href="#h11-0-104" id="h11-0-104" class="i">+	cancelEdit: =&gt;
</a><a href="#h11-0-105" id="h11-0-105" class="i">+		@stopEdit()
</a><a href="#h11-0-106" id="h11-0-106" class="i">+		@elem.html @content_before
</a><a href="#h11-0-107" id="h11-0-107" class="i">+
</a><a href="#h11-0-108" id="h11-0-108" class="i">+		$(&apos;pre code&apos;).each (i, block) -&gt; # Higlight code blocks
</a><a href="#h11-0-109" id="h11-0-109" class="i">+			hljs.highlightBlock(block)
</a><a href="#h11-0-110" id="h11-0-110" class="i">+
</a><a href="#h11-0-111" id="h11-0-111" class="i">+		return false
</a><a href="#h11-0-112" id="h11-0-112" class="i">+
</a><a href="#h11-0-113" id="h11-0-113" class="i">+
</a><a href="#h11-0-114" id="h11-0-114" class="i">+	copyStyle: (elem_from, elem_to) -&gt;
</a><a href="#h11-0-115" id="h11-0-115" class="i">+		elem_to.addClass(elem_from[0].className)
</a><a href="#h11-0-116" id="h11-0-116" class="i">+		from_style = getComputedStyle(elem_from[0])
</a><a href="#h11-0-117" id="h11-0-117" class="i">+
</a><a href="#h11-0-118" id="h11-0-118" class="i">+		elem_to.css
</a><a href="#h11-0-119" id="h11-0-119" class="i">+			fontFamily: 	from_style.fontFamily
</a><a href="#h11-0-120" id="h11-0-120" class="i">+			fontSize: 		from_style.fontSize
</a><a href="#h11-0-121" id="h11-0-121" class="i">+			fontWeight: 	from_style.fontWeight
</a><a href="#h11-0-122" id="h11-0-122" class="i">+			marginTop: 		from_style.marginTop
</a><a href="#h11-0-123" id="h11-0-123" class="i">+			marginRight: 	from_style.marginRight
</a><a href="#h11-0-124" id="h11-0-124" class="i">+			marginBottom: 	from_style.marginBottom
</a><a href="#h11-0-125" id="h11-0-125" class="i">+			marginLeft: 	from_style.marginLeft
</a><a href="#h11-0-126" id="h11-0-126" class="i">+			paddingTop: 	from_style.paddingTop
</a><a href="#h11-0-127" id="h11-0-127" class="i">+			paddingRight: 	from_style.paddingRight
</a><a href="#h11-0-128" id="h11-0-128" class="i">+			paddingBottom: 	from_style.paddingBottom
</a><a href="#h11-0-129" id="h11-0-129" class="i">+			paddingLeft: 	from_style.paddingLeft
</a><a href="#h11-0-130" id="h11-0-130" class="i">+			lineHeight: 	from_style.lineHeight
</a><a href="#h11-0-131" id="h11-0-131" class="i">+			textAlign: 		from_style.textAlign
</a><a href="#h11-0-132" id="h11-0-132" class="i">+			color: 			from_style.color
</a><a href="#h11-0-133" id="h11-0-133" class="i">+			letterSpacing: 	from_style.letterSpacing
</a><a href="#h11-0-134" id="h11-0-134" class="i">+
</a><a href="#h11-0-135" id="h11-0-135" class="i">+		if elem_from.innerWidth() &lt; 1000 # inline elems fix
</a><a href="#h11-0-136" id="h11-0-136" class="i">+			elem_to.css &quot;minWidth&quot;, elem_from.innerWidth()
</a><a href="#h11-0-137" id="h11-0-137" class="i">+
</a><a href="#h11-0-138" id="h11-0-138" class="i">+
</a><a href="#h11-0-139" id="h11-0-139" class="i">+	autoExpand: (elem) -&gt;
</a><a href="#h11-0-140" id="h11-0-140" class="i">+		editor = elem[0]
</a><a href="#h11-0-141" id="h11-0-141" class="i">+		# Autoexpand
</a><a href="#h11-0-142" id="h11-0-142" class="i">+		elem.height(1)
</a><a href="#h11-0-143" id="h11-0-143" class="i">+		elem.on &quot;input&quot;, -&gt;
</a><a href="#h11-0-144" id="h11-0-144" class="i">+			if editor.scrollHeight &gt; elem.height()
</a><a href="#h11-0-145" id="h11-0-145" class="i">+				elem.height(1).height(editor.scrollHeight + parseFloat(elem.css(&quot;borderTopWidth&quot;)) + parseFloat(elem.css(&quot;borderBottomWidth&quot;)))
</a><a href="#h11-0-146" id="h11-0-146" class="i">+		elem.trigger &quot;input&quot;
</a><a href="#h11-0-147" id="h11-0-147" class="i">+
</a><a href="#h11-0-148" id="h11-0-148" class="i">+		# Tab key support
</a><a href="#h11-0-149" id="h11-0-149" class="i">+		elem.on &apos;keydown&apos;, (e) -&gt;
</a><a href="#h11-0-150" id="h11-0-150" class="i">+			if e.which == 9
</a><a href="#h11-0-151" id="h11-0-151" class="i">+				e.preventDefault()
</a><a href="#h11-0-152" id="h11-0-152" class="i">+				s = this.selectionStart
</a><a href="#h11-0-153" id="h11-0-153" class="i">+				val = elem.val()
</a><a href="#h11-0-154" id="h11-0-154" class="i">+				elem.val(val.substring(0,this.selectionStart) + &quot;\t&quot; + val.substring(this.selectionEnd))
</a><a href="#h11-0-155" id="h11-0-155" class="i">+				this.selectionEnd = s+1; 
</a><a href="#h11-0-156" id="h11-0-156" class="i">+
</a><a href="#h11-0-157" id="h11-0-157" class="i">+ 
</a><a href="#h11-0-158" id="h11-0-158" class="i">+window.InlineEditor = InlineEditor</a><a href="#h11-0-159" id="h11-0-159" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h12" href="../file/js/utils/LimitRate.coffee.html">js/utils/LimitRate.coffee</a> b/<a href="../file/js/utils/LimitRate.coffee.html">js/utils/LimitRate.coffee</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -0,0 +1,7 @@
</a><a href="#h12-0-0" id="h12-0-0" class="i">+limits = {}
</a><a href="#h12-0-1" id="h12-0-1" class="i">+window.LimitRate = (fn, interval) -&gt;
</a><a href="#h12-0-2" id="h12-0-2" class="i">+	if not limits[fn]
</a><a href="#h12-0-3" id="h12-0-3" class="i">+		limits[fn] = setTimeout (-&gt;
</a><a href="#h12-0-4" id="h12-0-4" class="i">+			fn()
</a><a href="#h12-0-5" id="h12-0-5" class="i">+			delete limits[fn]
</a><a href="#h12-0-6" id="h12-0-6" class="i">+		), interval
</a><b>diff --git a/<a id="h13" href="../file/js/utils/Text.coffee.html">js/utils/Text.coffee</a> b/<a href="../file/js/utils/Text.coffee.html">js/utils/Text.coffee</a></b>
<a href="#h13-0" id="h13-0" class="h">@@ -0,0 +1,25 @@
</a><a href="#h13-0-0" id="h13-0-0" class="i">+class Text
</a><a href="#h13-0-1" id="h13-0-1" class="i">+	toColor: (text) -&gt;
</a><a href="#h13-0-2" id="h13-0-2" class="i">+		hash = 0
</a><a href="#h13-0-3" id="h13-0-3" class="i">+		for i in [0..text.length-1]
</a><a href="#h13-0-4" id="h13-0-4" class="i">+			hash = text.charCodeAt(i) + ((hash &lt;&lt; 5) - hash)
</a><a href="#h13-0-5" id="h13-0-5" class="i">+		color = &apos;#&apos;
</a><a href="#h13-0-6" id="h13-0-6" class="i">+		return &quot;hsl(&quot; + (hash % 360) + &quot;,30%,50%)&quot;;
</a><a href="#h13-0-7" id="h13-0-7" class="i">+		for i in [0..2]
</a><a href="#h13-0-8" id="h13-0-8" class="i">+			value = (hash &gt;&gt; (i * 8)) &amp; 0xFF
</a><a href="#h13-0-9" id="h13-0-9" class="i">+			color += (&apos;00&apos; + value.toString(16)).substr(-2)
</a><a href="#h13-0-10" id="h13-0-10" class="i">+		return color
</a><a href="#h13-0-11" id="h13-0-11" class="i">+
</a><a href="#h13-0-12" id="h13-0-12" class="i">+
</a><a href="#h13-0-13" id="h13-0-13" class="i">+	toMarked: (text, options=null) -&gt;
</a><a href="#h13-0-14" id="h13-0-14" class="i">+		text = marked(text, options)
</a><a href="#h13-0-15" id="h13-0-15" class="i">+		return @fixLinks text
</a><a href="#h13-0-16" id="h13-0-16" class="i">+
</a><a href="#h13-0-17" id="h13-0-17" class="i">+
</a><a href="#h13-0-18" id="h13-0-18" class="i">+	# Convert zeronet links to relaitve
</a><a href="#h13-0-19" id="h13-0-19" class="i">+	fixLinks: (text) -&gt;
</a><a href="#h13-0-20" id="h13-0-20" class="i">+		return text.replace(/href=&quot;http:\/\/(127.0.0.1|localhost):43110/g, &apos;href=&quot;&apos;)
</a><a href="#h13-0-21" id="h13-0-21" class="i">+
</a><a href="#h13-0-22" id="h13-0-22" class="i">+
</a><a href="#h13-0-23" id="h13-0-23" class="i">+
</a><a href="#h13-0-24" id="h13-0-24" class="i">+window.Text = new Text()</a><a href="#h13-0-25" id="h13-0-25" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h14" href="../file/js/utils/Time.coffee.html">js/utils/Time.coffee</a> b/<a href="../file/js/utils/Time.coffee.html">js/utils/Time.coffee</a></b>
<a href="#h14-0" id="h14-0" class="h">@@ -0,0 +1,35 @@
</a><a href="#h14-0-0" id="h14-0-0" class="i">+class Time
</a><a href="#h14-0-1" id="h14-0-1" class="i">+	since: (time) -&gt;
</a><a href="#h14-0-2" id="h14-0-2" class="i">+		now = +(new Date)/1000
</a><a href="#h14-0-3" id="h14-0-3" class="i">+		secs = now - time
</a><a href="#h14-0-4" id="h14-0-4" class="i">+		if secs &lt; 60
</a><a href="#h14-0-5" id="h14-0-5" class="i">+			back = &quot;Just now&quot;
</a><a href="#h14-0-6" id="h14-0-6" class="i">+		else if secs &lt; 60*60
</a><a href="#h14-0-7" id="h14-0-7" class="i">+			back = &quot;#{Math.round(secs/60)} minutes ago&quot;
</a><a href="#h14-0-8" id="h14-0-8" class="i">+		else if secs &lt; 60*60*24
</a><a href="#h14-0-9" id="h14-0-9" class="i">+			back = &quot;#{Math.round(secs/60/60)} hours ago&quot;
</a><a href="#h14-0-10" id="h14-0-10" class="i">+		else if secs &lt; 60*60*24*3
</a><a href="#h14-0-11" id="h14-0-11" class="i">+			back = &quot;#{Math.round(secs/60/60/24)} days ago&quot;
</a><a href="#h14-0-12" id="h14-0-12" class="i">+		else
</a><a href="#h14-0-13" id="h14-0-13" class="i">+			back = &quot;on &quot;+@date(time)
</a><a href="#h14-0-14" id="h14-0-14" class="i">+		back = back.replace(/1 ([a-z]+)s/, &quot;1 $1&quot;) # 1 days ago fix
</a><a href="#h14-0-15" id="h14-0-15" class="i">+		return back
</a><a href="#h14-0-16" id="h14-0-16" class="i">+
</a><a href="#h14-0-17" id="h14-0-17" class="i">+
</a><a href="#h14-0-18" id="h14-0-18" class="i">+	date: (timestamp, format=&quot;short&quot;) -&gt;
</a><a href="#h14-0-19" id="h14-0-19" class="i">+		parts = (new Date(timestamp*1000)).toString().split(&quot; &quot;)
</a><a href="#h14-0-20" id="h14-0-20" class="i">+		if format == &quot;short&quot;
</a><a href="#h14-0-21" id="h14-0-21" class="i">+			display = parts.slice(1, 4)
</a><a href="#h14-0-22" id="h14-0-22" class="i">+		else
</a><a href="#h14-0-23" id="h14-0-23" class="i">+			display = parts.slice(1, 5)
</a><a href="#h14-0-24" id="h14-0-24" class="i">+		return display.join(&quot; &quot;).replace(/( [0-9]{4})/, &quot;,$1&quot;)
</a><a href="#h14-0-25" id="h14-0-25" class="i">+
</a><a href="#h14-0-26" id="h14-0-26" class="i">+
</a><a href="#h14-0-27" id="h14-0-27" class="i">+	timestamp: (date=&quot;&quot;) -&gt;
</a><a href="#h14-0-28" id="h14-0-28" class="i">+		if date == &quot;now&quot; or date == &quot;&quot;
</a><a href="#h14-0-29" id="h14-0-29" class="i">+			return parseInt(+(new Date)/1000)
</a><a href="#h14-0-30" id="h14-0-30" class="i">+		else
</a><a href="#h14-0-31" id="h14-0-31" class="i">+			return parseInt(Date.parse(date)/1000)
</a><a href="#h14-0-32" id="h14-0-32" class="i">+
</a><a href="#h14-0-33" id="h14-0-33" class="i">+
</a><a href="#h14-0-34" id="h14-0-34" class="i">+window.Time = new Time</a><a href="#h14-0-35" id="h14-0-35" class="i">+
\ No newline at end of file
</a><b>diff --git a/<a id="h15" href="../file/js/utils/ZeroFrame.coffee.html">js/utils/ZeroFrame.coffee</a> b/<a href="../file/js/utils/ZeroFrame.coffee.html">js/utils/ZeroFrame.coffee</a></b>
<a href="#h15-0" id="h15-0" class="h">@@ -0,0 +1,73 @@
</a><a href="#h15-0-0" id="h15-0-0" class="i">+class ZeroFrame
</a><a href="#h15-0-1" id="h15-0-1" class="i">+	constructor: (url) -&gt;
</a><a href="#h15-0-2" id="h15-0-2" class="i">+		@url = url
</a><a href="#h15-0-3" id="h15-0-3" class="i">+		@waiting_cb = {}
</a><a href="#h15-0-4" id="h15-0-4" class="i">+		@connect()
</a><a href="#h15-0-5" id="h15-0-5" class="i">+		@next_message_id = 1
</a><a href="#h15-0-6" id="h15-0-6" class="i">+		@init()
</a><a href="#h15-0-7" id="h15-0-7" class="i">+
</a><a href="#h15-0-8" id="h15-0-8" class="i">+
</a><a href="#h15-0-9" id="h15-0-9" class="i">+	init: -&gt;
</a><a href="#h15-0-10" id="h15-0-10" class="i">+		@
</a><a href="#h15-0-11" id="h15-0-11" class="i">+
</a><a href="#h15-0-12" id="h15-0-12" class="i">+
</a><a href="#h15-0-13" id="h15-0-13" class="i">+	connect: -&gt;
</a><a href="#h15-0-14" id="h15-0-14" class="i">+		@target = window.parent
</a><a href="#h15-0-15" id="h15-0-15" class="i">+		window.addEventListener(&quot;message&quot;, @onMessage, false) 
</a><a href="#h15-0-16" id="h15-0-16" class="i">+		@cmd(&quot;innerReady&quot;)
</a><a href="#h15-0-17" id="h15-0-17" class="i">+
</a><a href="#h15-0-18" id="h15-0-18" class="i">+
</a><a href="#h15-0-19" id="h15-0-19" class="i">+	onMessage: (e) =&gt;
</a><a href="#h15-0-20" id="h15-0-20" class="i">+		message = e.data
</a><a href="#h15-0-21" id="h15-0-21" class="i">+		cmd = message.cmd
</a><a href="#h15-0-22" id="h15-0-22" class="i">+		if cmd == &quot;response&quot;
</a><a href="#h15-0-23" id="h15-0-23" class="i">+			if @waiting_cb[message.to]?
</a><a href="#h15-0-24" id="h15-0-24" class="i">+				@waiting_cb[message.to](message.result)
</a><a href="#h15-0-25" id="h15-0-25" class="i">+			else
</a><a href="#h15-0-26" id="h15-0-26" class="i">+				@log &quot;Websocket callback not found:&quot;, message
</a><a href="#h15-0-27" id="h15-0-27" class="i">+		else if cmd == &quot;wrapperReady&quot; # Wrapper inited later
</a><a href="#h15-0-28" id="h15-0-28" class="i">+			@cmd(&quot;innerReady&quot;)
</a><a href="#h15-0-29" id="h15-0-29" class="i">+		else if cmd == &quot;ping&quot;
</a><a href="#h15-0-30" id="h15-0-30" class="i">+			@response message.id, &quot;pong&quot;
</a><a href="#h15-0-31" id="h15-0-31" class="i">+		else if cmd == &quot;wrapperOpenedWebsocket&quot;
</a><a href="#h15-0-32" id="h15-0-32" class="i">+			@onOpenWebsocket()
</a><a href="#h15-0-33" id="h15-0-33" class="i">+		else if cmd == &quot;wrapperClosedWebsocket&quot;
</a><a href="#h15-0-34" id="h15-0-34" class="i">+			@onCloseWebsocket()
</a><a href="#h15-0-35" id="h15-0-35" class="i">+		else
</a><a href="#h15-0-36" id="h15-0-36" class="i">+			@route cmd, message
</a><a href="#h15-0-37" id="h15-0-37" class="i">+
</a><a href="#h15-0-38" id="h15-0-38" class="i">+
</a><a href="#h15-0-39" id="h15-0-39" class="i">+	route: (cmd, message) =&gt;
</a><a href="#h15-0-40" id="h15-0-40" class="i">+		@log &quot;Unknown command&quot;, message
</a><a href="#h15-0-41" id="h15-0-41" class="i">+
</a><a href="#h15-0-42" id="h15-0-42" class="i">+
</a><a href="#h15-0-43" id="h15-0-43" class="i">+	response: (to, result) -&gt;
</a><a href="#h15-0-44" id="h15-0-44" class="i">+		@send {&quot;cmd&quot;: &quot;response&quot;, &quot;to&quot;: to, &quot;result&quot;: result}
</a><a href="#h15-0-45" id="h15-0-45" class="i">+
</a><a href="#h15-0-46" id="h15-0-46" class="i">+
</a><a href="#h15-0-47" id="h15-0-47" class="i">+	cmd: (cmd, params={}, cb=null) -&gt;
</a><a href="#h15-0-48" id="h15-0-48" class="i">+		@send {&quot;cmd&quot;: cmd, &quot;params&quot;: params}, cb
</a><a href="#h15-0-49" id="h15-0-49" class="i">+
</a><a href="#h15-0-50" id="h15-0-50" class="i">+
</a><a href="#h15-0-51" id="h15-0-51" class="i">+	send: (message, cb=null) -&gt;
</a><a href="#h15-0-52" id="h15-0-52" class="i">+		message.id = @next_message_id
</a><a href="#h15-0-53" id="h15-0-53" class="i">+		@next_message_id += 1
</a><a href="#h15-0-54" id="h15-0-54" class="i">+		@target.postMessage(message, &quot;*&quot;)
</a><a href="#h15-0-55" id="h15-0-55" class="i">+		if cb
</a><a href="#h15-0-56" id="h15-0-56" class="i">+			@waiting_cb[message.id] = cb
</a><a href="#h15-0-57" id="h15-0-57" class="i">+
</a><a href="#h15-0-58" id="h15-0-58" class="i">+
</a><a href="#h15-0-59" id="h15-0-59" class="i">+	log: (args...) -&gt;
</a><a href="#h15-0-60" id="h15-0-60" class="i">+		console.log &quot;[ZeroFrame]&quot;, args...
</a><a href="#h15-0-61" id="h15-0-61" class="i">+
</a><a href="#h15-0-62" id="h15-0-62" class="i">+
</a><a href="#h15-0-63" id="h15-0-63" class="i">+	onOpenWebsocket: =&gt;
</a><a href="#h15-0-64" id="h15-0-64" class="i">+		@log &quot;Websocket open&quot;
</a><a href="#h15-0-65" id="h15-0-65" class="i">+
</a><a href="#h15-0-66" id="h15-0-66" class="i">+
</a><a href="#h15-0-67" id="h15-0-67" class="i">+	onCloseWebsocket: =&gt;
</a><a href="#h15-0-68" id="h15-0-68" class="i">+		@log &quot;Websocket close&quot;
</a><a href="#h15-0-69" id="h15-0-69" class="i">+
</a><a href="#h15-0-70" id="h15-0-70" class="i">+
</a><a href="#h15-0-71" id="h15-0-71" class="i">+
</a><a href="#h15-0-72" id="h15-0-72" class="i">+window.ZeroFrame = ZeroFrame
</a></pre>
</div>
</body>
</html>
